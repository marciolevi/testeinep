<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ Cronograma Revalida/Enamed 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>

/* Sauda√ß√£o Montserrat + m√£ozinha animada */
#greeting-message {
  font-family: 'Montserrat', sans-serif !important;
  font-size: 28px !important;
  font-weight: 700 !important;
  color: #3B82F6 !important; /* Azul tecnol√≥gico */
  letter-spacing: -0.5px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin: 0;
}

.wave {
  display: inline-block;
  animation: wave-animation 2s infinite;
  transform-origin: 70% 70%;
  font-size: 1.1em;
}

@keyframes wave-animation {
  0% { transform: rotate(0deg); }
  10% { transform: rotate(14deg); }
  20% { transform: rotate(-8deg); }
  30% { transform: rotate(14deg); }
  40% { transform: rotate(-4deg); }
  50% { transform: rotate(10deg); }
  60%, 100% { transform: rotate(0deg); }
}

        /* =================================================================================
   CRONOGRAMA REVALIDA 2025 - CSS MODERNO E TECNOL√ìGICO
   Design inspirado em dashboards de apps modernos com visual clean e profissional
   VERS√ÉO COM AJUSTES DE TAMANHO E PROPOR√á√ÉO
   ================================================================================= */

/* Estilos da tela de login - NOVA VERS√ÉO BONITA */
#auth-container {
    min-height: 100vh;
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #0f172a 0%, #581c87 25%, #0f172a 50%, #1e1b4b 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

/* Background Elements */
#auth-container::before {
    content: '';
    position: absolute;
    inset: 0;
}

.blob-1 {
    position: absolute;
    top: 0;
    left: -1rem;
    width: 18rem;
    height: 18rem;
    background: #8b5cf6;
    border-radius: 50%;
    mix-blend-mode: multiply;
    filter: blur(40px);
    opacity: 0.2;
    animation: blob 7s infinite;
}

.blob-2 {
    position: absolute;
    top: 0;
    right: -1rem;
    width: 18rem;
    height: 18rem;
    background: #3b82f6;
    border-radius: 50%;
    mix-blend-mode: multiply;
    filter: blur(40px);
    opacity: 0.2;
    animation: blob 7s infinite;
    animation-delay: 2s;
}

.blob-3 {
    position: absolute;
    bottom: -2rem;
    left: 5rem;
    width: 18rem;
    height: 18rem;
    background: #ec4899;
    border-radius: 50%;
    mix-blend-mode: multiply;
    filter: blur(40px);
    opacity: 0.2;
    animation: blob 7s infinite;
    animation-delay: 4s;
}

@keyframes blob {
    0% {
        transform: translate(0px, 0px) scale(1);
    }
    33% {
        transform: translate(30px, -50px) scale(1.1);
    }
    66% {
        transform: translate(-20px, 20px) scale(0.9);
    }
    100% {
        transform: translate(0px, 0px) scale(1);
    }
}

.grid-overlay {
    position: absolute;
    inset: 0;
    opacity: 0.05;
    background-image: 
        linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
}

.content-container {
    position: relative;
    z-index: 10;
    width: 100%;
    max-width: 96rem;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: 3rem;
    align-items: center;
}

@media (min-width: 1024px) {
    .content-container {
        grid-template-columns: 1fr 1fr;
    }
}

/* Left side - Marketing Content */
.marketing-content {
    display: none;
    color: white;
}

@media (min-width: 1024px) {
    .marketing-content {
        display: block;
    }
}

.brand-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.brand-icon {
    width: 3rem;
    height: 3rem;
    background: linear-gradient(135deg, #60a5fa 0%, #8b5cf6 100%);
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.brand-icon i {
    font-size: 1.25rem;
    color: white;
}

.brand-title {
    font-size: 2.25rem;
    font-weight: 900;
    background: linear-gradient(90deg, #60a5fa 0%, #8b5cf6 50%, #ec4899 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.brand-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.125rem;
}

.features-list {
    margin-bottom: 2rem;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.feature-icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.feature-icon.green {
    background: rgba(34, 197, 94, 0.2);
    color: #4ade80;
}

.feature-icon.blue {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
}

.feature-icon.purple {
    background: rgba(139, 92, 246, 0.2);
    color: #a78bfa;
}

.feature-icon.orange {
    background: rgba(249, 115, 22, 0.2);
    color: #fb923c;
}

.feature-title {
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: 0.25rem;
}

.feature-description {
    color: rgba(255, 255, 255, 0.6);
}

.stats-section {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 1.875rem;
    font-weight: 900;
}

.stat-number.blue {
    color: #60a5fa;
}

.stat-number.purple {
    color: #a78bfa;
}

.stat-number.pink {
    color: #f472b6;
}

.stat-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
}

/* Auth Form */
.auth-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.auth-form-wrapper {
    width: 100%;
    max-width: 28rem;
}

.auth-toggle {
    margin-bottom: 1.5rem; /* Reduzido */
}

.toggle-container {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
    border-radius: 1rem;
    padding: 0.5rem;
    display: flex;
}

.toggle-button {
    flex: 1;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.toggle-button.active {
    background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.toggle-button.inactive {
    color: rgba(255, 255, 255, 0.7);
}

.toggle-button.inactive:hover {
    color: white;
}

.auth-form {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(40px);
    border-radius: 1.5rem;
    padding: 1.5rem; /* Reduzido */
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.form-header {
    text-align: center;
    margin-bottom: 1.5rem; /* Reduzido */
}

.form-icon {
    width: 3.5rem; /* Reduzido */
    height: 3.5rem; /* Reduzido */
    background: linear-gradient(135deg, #60a5fa 0%, #8b5cf6 100%);
    border-radius: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
}

.form-icon i {
    font-size: 1.5rem;
    color: white;
}

.auth-form h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
}

.form-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem; /* Reduzido */
}

.form-fields {
    margin-bottom: 1.5rem;
}

.field-group {
    position: relative;
    margin-bottom: 1.25rem; /* Reduzido */
}

#username-group {
    display: none; /* Come√ßa oculto */
}

.field-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255, 255, 255, 0.5);
    pointer-events: none;
}

.auth-form input {
    width: 100%;
    padding: 0.9rem 1rem 0.9rem 3rem; /* Reduzido */
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    color: white;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(12px);
}

.auth-form input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.auth-form input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2), 0 8px 16px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.08);
}

.auth-form button {
    width: 100%;
    background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    border: none;
    padding: 0.9rem 1.5rem; /* Reduzido */
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.auth-form button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.auth-form button:hover::before {
    left: 100%;
}

.auth-form button:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.2);
    background: linear-gradient(90deg, #2563eb 0%, #7c3aed 100%);
}

.auth-form button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.loading-spinner {
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.form-footer {
    margin-top: 1.5rem; /* Reduzido */
    text-align: center;
}

.auth-form p {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
}

.auth-form a {
    color: #60a5fa;
    background: none;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: color 0.2s;
    margin-left: 0.25rem;
    text-decoration: none;
}

.auth-form a:hover {
    color: #3b82f6;
    text-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
}

.security-badge {
    margin-top: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.75rem;
    gap: 0.5rem;
}

/* Mobile Features */
.mobile-features {
    display: block;
    margin-top: 2rem;
}

@media (min-width: 1024px) {
    .mobile-features {
        display: none;
    }
}

.mobile-features-title {
    text-align: center;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: 1rem;
}

.mobile-features-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.mobile-feature-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
    border-radius: 0.75rem;
    padding: 1rem;
    text-align: center;
}

.mobile-feature-card i {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.mobile-feature-card i.blue {
    color: #60a5fa;
}

.mobile-feature-card i.yellow {
    color: #fbbf24;
}

.mobile-feature-card i.green {
    color: #4ade80;
}

.mobile-feature-card i.purple {
    color: #a78bfa;
}

.mobile-feature-card p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.875rem;
    font-weight: 500;
}

/* Estilos do app principal */
#app-container {
    display: none;
}

/* Vari√°veis CSS modernas - Sistema de cores tecnol√≥gico */
:root {
    /* Cores principais */
    --primary-50: #eff6ff;
    --primary-100: #dbeafe;
    --primary-200: #bfdbfe;
    --primary-300: #93c5fd;
    --primary-400: #60a5fa;
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --primary-800: #1e40af;
    --primary-900: #1e3a8a;
    
    /* Cores secund√°rias */
    --secondary-50: #f0f9ff;
    --secondary-100: #e0f2fe;
    --secondary-200: #bae6fd;
    --secondary-300: #7dd3fc;
    --secondary-400: #38bdf8;
    --secondary-500: #0ea5e9;
    --secondary-600: #0284c7;
    --secondary-700: #0369a1;
    --secondary-800: #075985;
    --secondary-900: #0c4a6e;
    
    /* Cores de acento */
    --accent-50: #fdf4ff;
    --accent-100: #fae8ff;
    --accent-200: #f5d0fe;
    --accent-300: #f0abfc;
    --accent-400: #e879f9;
    --accent-500: #d946ef;
    --accent-600: #c026d3;
    --accent-700: #a21caf;
    --accent-800: #86198f;
    --accent-900: #701a75;
    
    /* Cores de sistema */
    --success-50: #f0fdf4;
    --success-500: #10b981;
    --success-600: #059669;
    --warning-50: #fffbeb;
    --warning-500: #f59e0b;
    --warning-600: #d97706;
    --error-50: #fef2f2;
    --error-500: #ef4444;
    --error-600: #dc2626;
    --info-50: #ecfeff;
    --info-500: #06b6d4;
    --info-600: #0891b2;
    
    /* Cores neutras */
    --neutral-50: #f8fafc;
    --neutral-100: #f1f5f9;
    --neutral-200: #e2e8f0;
    --neutral-300: #cbd5e1;
    --neutral-400: #94a3b8;
    --neutral-500: #64748b;
    --neutral-600: #475569;
    --neutral-700: #334155;
    --neutral-800: #1e293b;
    --neutral-900: #0f172a;
    
    /* Aplica√ß√£o das cores */
    --primary-color: var(--primary-600);
    --primary-light: var(--primary-400);
    --primary-dark: var(--primary-700);
    --secondary-color: var(--secondary-500);
    --accent-color: var(--accent-500);
    --background-color: var(--neutral-50);
    --background-secondary: var(--neutral-100);
    --card-background: #ffffff;
    --text-color: var(--neutral-800);
    --text-secondary: var(--neutral-600);
    --border-color: var(--neutral-200);
    --success-color: var(--success-500);
    --warning-color: var(--warning-500);
    --danger-color: var(--error-500);
    --info-color: var(--info-500);
    --xp-color: var(--accent-600);
    
    /* Dimens√µes (AJUSTADAS) */
    --sidebar-width: 260px;
    --sidebar-collapsed-width: 70px;
    --header-height: 55px; /* Reduzido */
    
    /* Bordas e raios */
    --border-radius-sm: 6px;
    --border-radius: 10px;
    --border-radius-lg: 16px;
    --border-radius-xl: 20px;
    
    /* Sombras */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    
    /* Transi√ß√µes */
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme=dark] {
    --background-color: var(--neutral-900);
    --background-secondary: var(--neutral-800);
    --card-background: var(--neutral-800);
    --text-color: var(--neutral-100);
    --text-secondary: var(--neutral-400);
    --border-color: var(--neutral-700);
    --primary-color: var(--primary-400);
    --primary-light: var(--primary-300);
    --primary-dark: var(--primary-500);
    --secondary-color: var(--secondary-400);
    --accent-color: var(--accent-400);
    --xp-color: var(--accent-400);
    --success-50: rgba(16, 185, 129, 0.1);
    --error-50: rgba(239, 68, 68, 0.1);
    --info-50: rgba(6, 182, 212, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-size: 0.9rem; /* Reduzido de 1rem */
    font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
    transition: var(--transition);
    overflow-x: hidden;
    line-height: 1.5; /* Reduzido */
    font-weight: 400;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Header moderno e tecnol√≥gico (AJUSTADO) */
.header-fixed {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border-color);
    z-index: 1000;
    padding: 8px 20px; /* Reduzido */
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition);
    min-height: var(--header-height);
    box-shadow: var(--shadow-sm);
}

[data-theme=dark] .header-fixed {
    background: rgba(15, 23, 42, 0.8);
    border-bottom-color: var(--border-color);
}

.header-fixed.sidebar-open {
    left: var(--sidebar-width);
}

.header-fixed.sidebar-collapsed {
    left: var(--sidebar-collapsed-width);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 12px; /* Reduzido de 16px */
}

.header-center {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px; /* Reduzido */
    margin: 0 16px; /* Reduzido de 24px */
}

.header-right {
    display: flex;
    align-items: center;
    gap: 10px; /* Reduzido */
}

.header-title {
    font-size: 1.2rem; /* Reduzido */
    font-weight: 900;
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-500) 50%, var(--accent-600) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.05em;
    text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
}

.motivational-quote {
    font-size: 0.8rem; /* Reduzido de 0.9rem */
    font-style: italic;
    color: var(--text-secondary);
    text-align: center;
    max-width: 350px; /* Reduzido de 400px */
    opacity: 0.9;
}

.user-profile-header {
    display: flex;
    align-items: center;
    gap: 10px; /* Reduzido */
    background: var(--card-background);
    padding: 6px 12px; /* Reduzido */
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    backdrop-filter: blur(10px);
    transition: var(--transition);
}

.user-profile-header:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.xp-bar-container {
    width: 100px; /* Reduzido de 120px */
    height: 6px; /* Reduzido */
    background: var(--background-secondary);
    border-radius: 6px;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.xp-bar-fill {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, var(--accent-500) 0%, var(--primary-500) 50%, var(--secondary-500) 100%);
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: inherit;
    position: relative;
    overflow: hidden;
}

.xp-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.user-level {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--xp-color);
}

.study-streak {
    font-size: 0.9rem; /* Reduzido */
    color: var(--warning-500);
    font-weight: 700; /* Reduzido de 800 */
    display: flex;
    align-items: center;
    gap: 4px; /* Reduzido de 6px */
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
    padding: 6px 10px; /* Reduzido */
    border-radius: var(--border-radius);
    border: 1px solid rgba(245, 158, 11, 0.3);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
}

.study-streak::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, #ff6b35, #f7931e, #ffcc02, #ff6b35);
    background-size: 400% 400%;
    animation: gradientShift 3s ease infinite;
    border-radius: inherit;
    z-index: -1;
    opacity: 0.3;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

/* Bot√µes modernos com efeitos tecnol√≥gicos (AJUSTADO) */
.btn {
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
    color: white;
    border: none;
    padding: 10px 18px; /* Reduzido */
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 0.9rem; /* Reduzido */
    font-weight: 600;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* Reduzido */
    box-shadow: var(--shadow-md);
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
    text-decoration: none;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-xl);
    background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-800) 100%);
}

.btn:active {
    transform: translateY(-1px);
}

.btn-toggle {
    background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.btn-toggle:hover {
    background: linear-gradient(135deg, var(--warning-600) 0%, var(--warning-500) 100%);
    box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, var(--error-500) 0%, var(--error-600) 100%);
    font-size: 0.8rem; /* Reduzido */
    padding: 8px 14px; /* Reduzido */
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
    background: linear-gradient(135deg, var(--error-600) 0%, var(--error-500) 100%);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
}

.btn-info {
    background: linear-gradient(135deg, var(--info-500) 0%, var(--info-600) 100%);
}
.btn-info:hover {
    background: linear-gradient(135deg, var(--info-600) 0%, var(--info-500) 100%);
}

.btn-success {
    background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
}
.btn-success:hover {
    background: linear-gradient(135deg, var(--success-600) 0%, var(--success-500) 100%);
}


.btn-ia {
    padding: 6px 10px; /* Reduzido */
    font-size: 0.75rem; /* Reduzido */
    background: linear-gradient(135deg, var(--accent-600) 0%, var(--accent-500) 100%);
    color: white;
    border: none;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    transition: var(--transition);
    box-shadow: 0 2px 8px rgba(212, 70, 239, 0.3);
    font-weight: 600;
}

.btn-ia:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 70, 239, 0.4);
}

/* Sidebar moderna e elegante (AJUSTADO) */
.sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: var(--sidebar-width);
    height: 100vh;
    background: linear-gradient(180deg, var(--card-background) 0%, rgba(255, 255, 255, 0.95) 100%);
    backdrop-filter: blur(20px);
    border-right: 1px solid var(--border-color);
    transform: translateX(-100%);
    transition: var(--transition);
    z-index: 999;
    overflow-y: auto;
    padding: 80px 0 24px; /* Ajustado */
    box-shadow: var(--shadow-2xl);
}

[data-theme=dark] .sidebar {
    background: linear-gradient(180deg, var(--card-background) 0%, rgba(30, 41, 59, 0.95) 100%);
}

.sidebar.open {
    transform: translateX(0);
}

.sidebar.collapsed {
    width: var(--sidebar-collapsed-width);
    transform: translateX(0);
}

.sidebar-content {
    padding: 20px; /* Reduzido */
}

.sidebar.collapsed .sidebar-content {
    padding: 16px 10px; /* Reduzido */
}

.sidebar-menu {
    list-style: none;
}

.sidebar-menu li {
    margin-bottom: 4px; /* Reduzido */
}

.sidebar-menu a {
    display: flex;
    align-items: center;
    padding: 12px 16px; /* Reduzido */
    color: var(--text-color);
    text-decoration: none;
    border-radius: var(--border-radius);
    transition: var(--transition);
    gap: 14px; /* Reduzido */
    font-weight: 500;
    position: relative;
    overflow: hidden;
    font-size: 0.9rem; /* Reduzido */
}

.sidebar-menu a::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--accent-600) 100%);
    opacity: 0;
    transition: var(--transition);
    z-index: -1;
}

.sidebar-menu a:hover::before {
    opacity: 1;
}

.sidebar-menu a:hover {
    color: white;
    transform: translateX(6px);
    box-shadow: var(--shadow-lg);
}

.sidebar-menu i {
    font-size: 1.1rem; /* Reduzido */
    width: 24px; /* Reduzido */
    text-align: center;
    flex-shrink: 0;
    transition: var(--transition);
}

.sidebar-menu a:hover i {
    transform: scale(1.1);
}

.sidebar.collapsed .sidebar-menu span {
    display: none;
}

.sidebar.collapsed .sidebar-menu a {
    justify-content: center;
    padding: 12px; /* Reduzido */
}

/* Conte√∫do principal (AJUSTADO) */
.main-content {
    padding-top: calc(var(--header-height) + 40px); /* Aumentado para evitar sobreposi√ß√£o */
    margin-left: 0;
    padding-left: 24px; /* Reduzido de 32px */
    padding-right: 24px; /* Reduzido de 32px */
    padding-bottom: 24px; /* Reduzido de 32px */
    transition: var(--transition);
    min-height: 100vh;
}

.main-content.sidebar-open {
    margin-left: var(--sidebar-width);
}

.main-content.sidebar-collapsed {
    margin-left: var(--sidebar-collapsed-width);
}

.content-section {
    display: none;
}

.content-section.active {
    display: block;
    animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px); /* Reduzido */
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Cards e estat√≠sticas com design tecnol√≥gico (AJUSTADO) */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Reduzido */
    gap: 20px; /* Reduzido de 28px */
    margin-bottom: 32px; /* Reduzido de 40px */
}

.stat-card {
    background: var(--card-background);
    padding: 20px; /* Reduzido */
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
    text-align: center;
    transition: var(--transition);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-600) 0%, var(--secondary-500) 50%, var(--accent-600) 100%);
}

.stat-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
    opacity: 0;
    transition: var(--transition);
    pointer-events: none;
}

.stat-card:hover {
    transform: translateY(-6px) scale(1.02); /* Reduzido */
    box-shadow: var(--shadow-2xl);
}

.stat-card:hover::after {
    opacity: 1;
}

.stat-card h3 {
    color: var(--text-color);
    font-size: 0.95rem; /* Reduzido */
    margin-bottom: 12px; /* Reduzido */
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* Reduzido de 10px */
    opacity: 0.9;
}

.stat-card .value {
    font-size: 2.5rem; /* Reduzido */
    font-weight: 900;
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-500) 50%, var(--accent-600) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 12px 0; /* Reduzido */
    line-height: 1;
    letter-spacing: -0.02em;
}

.stat-card small {
    color: var(--text-secondary);
    font-size: 0.85rem; /* Reduzido */
    font-weight: 500;
}

/* Conquistas com design moderno (AJUSTADO) */
.achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* Reduzido */
    gap: 24px; /* Reduzido */
}

.achievement-category {
    background: var(--card-background);
    border-radius: var(--border-radius-xl);
    padding: 24px; /* Reduzido */
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.achievement-category::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at top right, rgba(212, 70, 239, 0.05) 0%, transparent 50%);
    opacity: 0;
    transition: var(--transition);
}

.achievement-category:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-2xl);
}

.achievement-category:hover::before {
    opacity: 1;
}

.achievement-category h3 {
    color: var(--primary-600);
    margin-bottom: 20px; /* Reduzido */
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 12px; /* Reduzido */
    font-weight: 800;
    font-size: 1.2rem; /* Reduzido */
    letter-spacing: -0.02em;
}

.achievement-item {
    display: flex;
    align-items: center;
    gap: 16px; /* Reduzido */
    padding: 16px 0; /* Reduzido */
    border-bottom: 1px solid var(--border-color);
    transition: var(--transition);
    opacity: 0.4;
    border-radius: var(--border-radius);
}

.achievement-item:last-child {
    border-bottom: none;
}

.achievement-item.unlocked {
    opacity: 1;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(212, 70, 239, 0.05) 100%);
    padding: 16px; /* Reduzido */
    margin: 10px 0; /* Reduzido */
    border: 1px solid rgba(59, 130, 246, 0.2);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
}

.achievement-item.unlocked::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(135deg, var(--primary-600), var(--accent-600), var(--success-500), var(--warning-500));
    background-size: 400% 400%;
    animation: gradientShift 4s ease infinite;
    border-radius: inherit;
    z-index: -2;
    opacity: 0.3;
}

.achievement-icon {
    font-size: 2.5rem; /* Reduzido */
    color: var(--text-secondary);
    width: 60px; /* Reduzido */
    text-align: center;
    transition: var(--transition);
}

.achievement-item.unlocked .achievement-icon {
    color: var(--primary-600);
    transform: scale(1.2);
    text-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
}

.achievement-details h4 {
    margin: 0;
    font-size: 1.1rem; /* Reduzido */
    font-weight: 700;
    color: var(--text-color);
    letter-spacing: -0.02em;
}

.achievement-details p {
    margin: 4px 0 0; /* Reduzido */
    font-size: 0.9rem; /* Reduzido */
    color: var(--text-secondary);
    line-height: 1.5;
}

.achievement-details .unlock-date {
    font-size: 0.8rem;
    font-style: italic;
    color: var(--success-600);
    margin-top: 8px; /* Reduzido */
    font-weight: 600;
}

/* Gr√°ficos com design moderno (AJUSTADO) */
.chart-container {
    background: var(--card-background);
    padding: 24px; /* Reduzido */
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
    margin-bottom: 32px; /* Reduzido */
    position: relative;
    height: 320px; /* Reduzido */
    border: 1px solid var(--border-color);
    transition: var(--transition);
    backdrop-filter: blur(10px);
}

.chart-container:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-2xl);
}

.chart-container h3 {
    text-align: center;
    margin-bottom: 24px; /* Reduzido */
    font-size: 1.2rem; /* Reduzido */
    color: var(--text-color);
    font-weight: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    letter-spacing: -0.02em;
}

/* Se√ß√µes de controle (AJUSTADO) */
.controls-section {
    background: var(--card-background);
    padding: 24px; /* Reduzido */
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
    margin-bottom: 32px; /* Reduzido */
    border: 1px solid var(--border-color);
    transition: var(--transition);
    backdrop-filter: blur(10px);
}

.controls-section:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-2xl);
}

.controls-section h2,
.controls-section h3 {
    color: var(--text-color);
    margin-bottom: 20px; /* Reduzido */
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 12px; /* Reduzido */
    letter-spacing: -0.02em;
}

.controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Reduzido */
    gap: 24px; /* Reduzido */
    align-items: end;
}

/* Inputs modernos com design tecnol√≥gico (AJUSTADO) */
.search-box, .filter-select, .config-input {
    width: 100%;
    padding: 12px 18px; /* Reduzido */
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 0.95rem; /* Reduzido */
    background: var(--background-color);
    color: var(--text-color);
    transition: var(--transition);
    outline: none;
    font-weight: 500;
}

.search-box:focus, .filter-select:focus, .config-input:focus {
    border-color: var(--primary-600);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    transform: translateY(-2px);
    background: var(--card-background);
}

.config-form {
    display: grid;
    gap: 16px;
    margin-top: 16px;
}

.config-group {
    display: flex;
    flex-direction: column;
    gap: 8px; /* Reduzido */
}

.config-group label {
    font-weight: 700;
    color: var(--text-color);
    font-size: 0.9rem; /* Reduzido */
    letter-spacing: -0.01em;
}

.config-hint {
    font-size: 0.8rem; /* Reduzido */
    color: var(--text-secondary);
    opacity: 0.8;
    font-style: italic;
}

/* Semanas com design elegante (AJUSTADO) */
.week-section {
    background: var(--card-background);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
    margin-bottom: 24px; /* Reduzido */
    overflow: hidden;
    transition: var(--transition);
    border: 1px solid var(--border-color);
    backdrop-filter: blur(10px);
}

.week-section:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-2xl);
}

.week-header {
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-500) 100%);
    color: white;
    padding: 20px 24px; /* Reduzido */
    font-size: 1.2rem; /* Reduzido */
    font-weight: 800;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: var(--transition);
    letter-spacing: -0.02em;
}

.week-header:hover {
    background: linear-gradient(135deg, var(--primary-700) 0%, var(--secondary-600) 100%);
}

.week-content {
    padding: 0;
    max-height: 2000px;
    overflow: hidden;
    transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-x: auto;
}

.week-content.collapsed {
    max-height: 0;
}

.week-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 0.9rem; /* Reduzido */
}

.week-table th {
    background: var(--background-secondary);
    color: var(--text-color);
    padding: 16px 18px; /* Reduzido */
    text-align: left;
    font-weight: 800;
    font-size: 0.85rem; /* Reduzido */
    border-right: 1px solid var(--border-color);
    letter-spacing: 0.02em;
    text-transform: uppercase;
}

.week-table td {
    padding: 16px 18px; /* Reduzido */
    border-bottom: 1px solid var(--border-color);
    border-right: 1px solid var(--border-color);
    vertical-align: top;
    word-wrap: break-word;
    overflow-wrap: break-word;
    transition: var(--transition);
}

.week-table tr:hover {
    background: rgba(59, 130, 246, 0.04);
}

.topic-row {
    display: flex;
    align-items: center;
    gap: 12px; /* Reduzido */
    margin-bottom: 10px; /* Reduzido */
    padding: 10px; /* Reduzido */
    border-radius: var(--border-radius);
    transition: var(--transition);
    background: var(--background-color);
    border: 1px solid transparent;
}

.topic-row:hover {
    background: rgba(59, 130, 246, 0.05);
    border-color: rgba(59, 130, 246, 0.2);
    transform: translateX(4px);
}

.topic-row:last-child {
    margin-bottom: 0;
}

.topic-checkbox {
    transform: scale(1.3); /* Reduzido */
    cursor: pointer;
    flex-shrink: 0;
    accent-color: var(--primary-600);
    transition: var(--transition);
}

.topic-checkbox:checked {
    filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.4));
}

.topic-text {
    flex-grow: 1;
    transition: var(--transition);
    font-weight: 600;
    color: var(--text-color);
    font-size: 0.9rem; /* Adicionado */
}

.topic-text.completed {
    /* text-decoration: line-through; */ /* LINHA ALTERADA */
    opacity: 0.6;
    color: var(--success-600);
}

/* Badges de √°rea com design moderno (AJUSTADO) */
.area-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px; /* Reduzido */
    border-radius: 20px;
    font-size: 0.7rem; /* Reduzido */
    font-weight: 800;
    color: white;
    flex-shrink: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
}

.area-badge:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.area-preventiva { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.area-pediatria { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
.area-ginecologia { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
.area-obstetricia { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
.area-clinica { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
.area-cirurgia { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.area-psiquiatria { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
.area-revisao { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }
.area-rest { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }

.rest-day {
    background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
    font-style: italic;
    text-align: center;
    color: #9a3412;
    font-weight: 700;
    font-size: 1rem; /* Reduzido */
    letter-spacing: 0.02em;
}

[data-theme=dark] .rest-day {
    background: linear-gradient(135deg, #451a03 0%, #7c2d12 100%);
    color: #fed7aa;
}

/* Modais modernos (AJUSTADO) */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(12px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.4s ease;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--card-background);
    padding: 32px; /* Reduzido */
    border-radius: var(--border-radius-xl);
    max-width: 500px; /* Reduzido */
    width: 90%;
    text-align: center;
    box-shadow: var(--shadow-2xl);
    animation: modalSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border-color);
    position: relative;
    backdrop-filter: blur(20px);
}

.modal-content h3 {
    color: var(--text-color);
    margin-bottom: 16px; /* Reduzido */
    font-size: 1.4rem; /* Reduzido */
    font-weight: 800;
    letter-spacing: -0.02em;
}

.modal-content p {
    color: var(--text-secondary);
    margin-bottom: 24px; /* Reduzido */
    line-height: 1.6; /* Reduzido */
    font-size: 1rem; /* Reduzido */
}

@keyframes modalSlideIn {
    0% {
        transform: translateY(-50px) scale(0.9); /* Reduzido */
        opacity: 0;
    }
    100% {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

/* Bot√µes de dificuldade com design tecnol√≥gico (AJUSTADO) */
.difficulty-buttons {
    display: flex;
    gap: 16px; /* Reduzido */
    justify-content: center;
    margin-top: 24px; /* Reduzido */
    flex-wrap: wrap;
}

.difficulty-btn {
    padding: 14px 24px; /* Reduzido */
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 800;
    font-size: 1rem; /* Reduzido */
    transition: var(--transition);
    min-width: 120px; /* Reduzido */
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
}

.difficulty-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.difficulty-btn:hover::before {
    left: 100%;
}

.difficulty-easy {
    background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
    color: white;
}

.difficulty-medium {
    background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
    color: white;
}

.difficulty-hard {
    background: linear-gradient(135deg, var(--error-500) 0%, var(--error-600) 100%);
    color: white;
}

.difficulty-btn:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: var(--shadow-xl);
}

.confirmation-buttons {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin-top: 28px;
}

.btn-confirm {
    background: linear-gradient(135deg, var(--error-500) 0%, var(--error-600) 100%);
}

.btn-cancel {
    background: linear-gradient(135deg, var(--neutral-500) 0%, var(--neutral-600) 100%);
    color: white;
}

/* Notifica√ß√µes com design moderno (AJUSTADO) */
.achievement-notification {
    position: fixed;
    bottom: -200px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
    color: #92400e;
    padding: 20px 28px; /* Reduzido */
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-2xl);
    display: flex;
    align-items: center;
    gap: 16px; /* Reduzido */
    z-index: 9999;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 700;
    max-width: 420px; /* Reduzido */
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px);
}

.achievement-notification.show {
    bottom: 32px;
    transform: translateX(-50%) scale(1);
    opacity: 1;
}

.achievement-notification i {
    font-size: 2rem; /* Reduzido */
    color: #92400e;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

.achievement-notification h4 {
    margin: 0;
    font-size: 1.1rem; /* Reduzido */
    color: #92400e;
    font-weight: 800;
}

.achievement-notification p {
    margin: 4px 0 0; /* Reduzido */
    font-size: 0.9rem; /* Reduzido */
    opacity: 0.9;
    font-weight: 600;
}

/* Progress bars modernos */
.progress-bar {
    background: var(--background-secondary);
    border-radius: 10px;
    height: 10px; /* Reduzido */
    overflow: hidden;
    margin-top: 12px; /* Reduzido */
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-600) 0%, var(--secondary-500) 50%, var(--accent-600) 100%);
    border-radius: inherit;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
    animation: shimmer 2.5s infinite;
}

/* Listas de progresso (AJUSTADO) */
.progress-list {
    background: var(--card-background);
    padding: 24px; /* Reduzido */
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
    margin-bottom: 24px; /* Reduzido */
    border: 1px solid var(--border-color);
    transition: var(--transition);
    backdrop-filter: blur(10px);
}

.progress-list:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-2xl);
}

.progress-list h4 {
    color: var(--text-color);
    margin-bottom: 20px; /* Reduzido */
    display: flex;
    align-items: center;
    gap: 12px; /* Reduzido */
    font-weight: 800;
    font-size: 1.1rem; /* Reduzido */
    letter-spacing: -0.02em;
}

.topic-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px; /* Reduzido */
    border-bottom: 1px solid var(--border-color);
    transition: var(--transition);
    border-radius: var(--border-radius);
    margin-bottom: 6px;
    background: var(--background-color);
}

.topic-item:hover {
    background: rgba(59, 130, 246, 0.05);
    transform: translateX(6px);
    border-color: rgba(59, 130, 246, 0.2);
}

.topic-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.days-badge {
    background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-600) 100%);
    color: white;
    padding: 6px 12px; /* Reduzido */
    border-radius: 20px;
    font-size: 0.8rem; /* Reduzido */
    font-weight: 800;
    min-width: 65px; /* Reduzido */
    text-align: center;
    box-shadow: var(--shadow-sm);
}

.days-badge.warning {
    background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
}

.days-badge.danger {
    background: linear-gradient(135deg, var(--error-500) 0%, var(--error-600) 100%);
}

/* Performance table moderna (AJUSTADO) */
.performance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 24px; /* Reduzido */
    font-size: 0.9rem; /* Reduzido */
    background: var(--card-background);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
}

.performance-table th,
.performance-table td {
    padding: 14px 16px; /* Reduzido */
    border-bottom: 1px solid var(--border-color);
    text-align: left;
}

.performance-table th {
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-500) 100%);
    color: white;
    font-weight: 800;
    font-size: 0.85rem; /* Reduzido */
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.performance-table tr {
    transition: var(--transition);
}

.performance-table tr:hover {
    background: rgba(59, 130, 246, 0.05);
    transform: scale(1.01);
}

.performance-table .percentage-col {
    font-weight: 800;
    font-size: 1rem; /* Reduzido */
}

.performance-table .percentage-col.good {
    color: var(--success-600);
}

.performance-table .percentage-col.medium {
    color: var(--warning-600);
}

.performance-table .percentage-col.bad {
    color: var(--error-600);
}


/* Styles for new Performance IA section */
.tabs-container {
    display: flex;
    gap: 10px;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 24px;
}
.tab-button {
    padding: 12px 20px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    position: relative;
    transition: var(--transition-fast);
}
.tab-button::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100%;
    height: 2px;
    background: var(--primary-color);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}
.tab-button.active {
    color: var(--primary-color);
}
.tab-button.active::after {
    transform: scaleX(1);
}
.tab-button i {
    margin-right: 8px;
}
.tab-content {
    display: none;
    animation: fadeInUp 0.5s;
}
.tab-content.active {
    display: block;
}
.ia-display-area {
    background: var(--background-color);
    padding: 24px;
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--border-color);
    min-height: 250px;
    margin-top: 10px;
}

/* Question Styles */
.question-header {
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}
.question-case {
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 20px;
    white-space: pre-wrap;
}
.question-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.option-label {
    display: block;
    padding: 14px;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: var(--transition-fast);
}
.option-label:hover {
    background: rgba(59, 130, 246, 0.05);
    border-color: var(--primary-color);
}
.option-label.selected {
    background: var(--primary-100);
    border-color: var(--primary-color);
}
.option-label:has(input:checked) {
    background: var(--primary-100);
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px var(--primary-color);
}

[data-theme=dark] .option-label:has(input:checked) {
     background: var(--neutral-700);
     border-color: var(--primary-color);
}
.option-radio {
    display: none;
}
.feedback-area {
    margin-top: 20px;
    padding: 12px;
    border-radius: var(--border-radius);
    font-weight: 600;
    animation: fadeInUp 0.3s;
}
.feedback-area.correct {
    background: var(--success-50);
    color: var(--success-600);
    border: 1px solid var(--success-500);
}
.feedback-area.incorrect {
    background: var(--error-50);
    color: var(--error-600);
    border: 1px solid var(--error-500);
}
.commentary-area {
    margin-top: 16px;
    padding: 16px;
    background: var(--info-50);
    border: 1px solid var(--info-500);
    color: var(--info-600);
    border-radius: var(--border-radius);
    font-size: 0.9rem;
    line-height: 1.6;
    white-space: pre-wrap;
}
[data-theme=dark] .commentary-area {
    color: var(--neutral-100);
}
.ia-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
}

/* Flashcard Styles */
.flashcard {
    perspective: 1000px;
    min-height: 200px;
    cursor: pointer;
    background-color: transparent;
    border: none;
    width: 100%;
}
.flashcard-inner {
    position: relative;
    width: 100%;
    min-height: 200px;
    text-align: center;
    transition: transform 0.6s;
    transform-style: preserve-3d;
}
.flashcard.flipped .flashcard-inner {
    transform: rotateY(180deg);
}
.flashcard-front, .flashcard-back {
    position: absolute;
    width: 100%;
    height: 100%;
    min-height: 200px;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    font-size: 1.2rem;
    border-radius: var(--border-radius-lg);
    background: var(--background-secondary);
}
.flashcard-back {
    transform: rotateY(180deg);
    font-size: 1rem;
    font-weight: 400;
    line-height: 1.6;
    align-items: flex-start;
    text-align: left;
    white-space: pre-wrap;
}
.flashcard-controls {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 20px;
}
.flashcard-controls .btn {
    min-width: 150px;
}

#generate-question-btn, #generate-flashcard-btn {
    white-space: nowrap;
}


/* Pomodoro com design tecnol√≥gico (AJUSTADO) */
.pomodoro-section {
    background: var(--card-background);
    padding: 32px; /* Reduzido */
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
    margin-bottom: 32px; /* Reduzido */
    text-align: center;
    border: 1px solid var(--border-color);
    transition: var(--transition);
    backdrop-filter: blur(10px);
}

.pomodoro-section:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-2xl);
}

.pomodoro-display {
    font-size: 4rem; /* Reduzido */
    font-weight: 900;
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-500) 50%, var(--accent-600) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 32px 0; /* Reduzido */
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    letter-spacing: 4px; /* Reduzido */
    text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
}

.pomodoro-controls {
    display: flex;
    gap: 16px; /* Reduzido */
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 28px; /* Reduzido */
}

.pomodoro-settings {
    display: flex;
    gap: 20px; /* Reduzido */
    justify-content: center;
    margin-top: 28px; /* Reduzido */
    flex-wrap: wrap;
}

.pomodoro-settings > div {
    display: flex;
    flex-direction: column;
    gap: 8px; /* Reduzido */
    align-items: center;
}

.pomodoro-settings label {
    font-weight: 700;
    color: var(--text-color);
    font-size: 0.9rem; /* Reduzido */
    letter-spacing: -0.01em;
}

.pomodoro-settings input {
    width: 80px; /* Reduzido */
    padding: 10px; /* Reduzido */
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    text-align: center;
    background: var(--background-color);
    color: var(--text-color);
    font-weight: 700;
    transition: var(--transition);
    font-size: 1rem;
}

.pomodoro-settings input:focus {
    border-color: var(--primary-600);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

/* CHATBOT M√âDICO com design futur√≠stico (AJUSTADO) */
.medical-chatbot {
    position: fixed;
    bottom: 24px; /* Reduzido */
    right: 24px; /* Reduzido */
    z-index: 2000; /* Aumentado de 1500 para garantir visibilidade */
    font-family: inherit;
}

.chatbot-toggle {
    width: 60px; /* Reduzido */
    height: 60px; /* Reduzido */
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent-600) 0%, var(--accent-500) 100%);
    border: none;
    color: white;
    font-size: 1.6rem; /* Reduzido */
    cursor: pointer;
    box-shadow: var(--shadow-xl);
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.chatbot-toggle::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
    opacity: 0;
    transition: var(--transition);
}

.chatbot-toggle:hover::before {
    opacity: 1;
}

.chatbot-toggle:hover {
    transform: scale(1.1) translateY(-4px);
    box-shadow: var(--shadow-2xl);
}

.chatbot-toggle.active {
    background: linear-gradient(135deg, var(--error-500) 0%, var(--error-600) 100%);
    box-shadow: 0 8px 32px rgba(239, 68, 68, 0.5);
}

.chatbot-container {
    position: absolute;
    bottom: 80px; /* Reduzido */
    right: 0;
    width: 350px; /* Reduzido de 380px */
    height: 500px; /* Reduzido de 550px */
    background: var(--card-background);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-2xl);
    display: none;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--border-color);
    backdrop-filter: blur(20px);
}

.chatbot-container.active {
    display: flex;
    animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.chatbot-header {
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%); /* Mudado para cores do cronograma */
    color: white;
    padding: 15px 20px; /* Reduzido de 28px */
    font-size: 0.9rem; /* Adicionado para reduzir o tamanho da fonte */
    text-align: center;
    position: relative;
    flex-shrink: 0; /* CORRE√á√ÉO */
}

.chatbot-header h3 {
    margin: 0;
    font-size: 1.1rem; /* Reduzido */
    font-weight: 700; /* Reduzido de 800 */
    letter-spacing: -0.02em;
}

.chatbot-header p {
    margin: 4px 0 0 0; /* Reduzido */
    font-size: 0.8rem; /* Reduzido */
    opacity: 0.9;
    font-weight: 500;
}

.chatbot-close {
    position: absolute;
    top: 12px; /* Reduzido */
    right: 12px; /* Reduzido */
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 1.2rem; /* Reduzido */
    cursor: pointer;
    opacity: 0.8;
    width: 28px; /* Reduzido */
    height: 28px; /* Reduzido */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
    backdrop-filter: blur(10px);
}

/* ===== CHATBOT MODERNO E INTEGRADO ===== */

/* Container principal do chatbot */
.medical-chatbot {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    font-family: inherit;
}

/* Container da conversa */
.chatbot-container {
    position: absolute;
    bottom: 70px;
    right: 0;
    width: 380px;
    height: 500px;
    background: var(--card-background);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-2xl);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px) scale(0.95);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(20px);
    overflow: hidden;
}

.chatbot-container.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
}

/* Header do chatbot */
.chatbot-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
    color: white;
    padding: 16px 20px;
    border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    position: relative;
    overflow: hidden;
}

.chatbot-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: chatbot-header-shine 3s infinite;
}

@keyframes chatbot-header-shine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.chatbot-header h3 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0 0 4px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    z-index: 1;
}

.chatbot-header p {
    font-size: 0.85rem;
    opacity: 0.9;
    margin: 0;
    position: relative;
    z-index: 1;
}

.chatbot-close {
    position: absolute;
    top: 12px;
    right: 16px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 2;
}

.chatbot-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

/* √Årea de mensagens */
.chat-messages {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    background: var(--background-color);
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

[data-theme=dark] .chat-messages::-webkit-scrollbar-thumb {
    background: var(--neutral-600);
}

/* Mensagens */
.message {
    display: flex;
    flex-direction: column;
    max-width: 85%;
    animation: chatbot-message-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes chatbot-message-in {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    align-self: flex-end;
    align-items: flex-end;
}

.message.bot {
    align-self: flex-start;
    align-items: flex-start;
}

.message-bubble {
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 0.9rem;
    line-height: 1.4;
    word-wrap: break-word;
    position: relative;
    max-width: 100%;
}

.message.user .message-bubble {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
    color: white;
    border-bottom-right-radius: 6px;
    box-shadow: var(--shadow-md);
}

.message.bot .message-bubble {
    background: var(--card-background);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 6px;
    box-shadow: var(--shadow-sm);
}

[data-theme=dark] .message.bot .message-bubble {
    background: var(--neutral-800);
    border-color: var(--neutral-700);
}

.message-time {
    font-size: 0.7rem;
    color: var(--text-secondary);
    margin-top: 4px;
    opacity: 0.7;
}

/* Indicador de digita√ß√£o */
.typing-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 18px;
    border-bottom-left-radius: 6px;
    max-width: 85%;
    align-self: flex-start;
    box-shadow: var(--shadow-sm);
}

.typing-indicator.active {
    display: flex;
    animation: chatbot-message-in 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme=dark] .typing-indicator {
    background: var(--neutral-800);
    border-color: var(--neutral-700);
}

.typing-indicator span {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dot {
    width: 6px;
    height: 6px;
    background: var(--primary-color);
    border-radius: 50%;
    animation: chatbot-typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes chatbot-typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* T√≥picos r√°pidos */
.quick-topics {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
}

.quick-topic {
    padding: 6px 12px;
    background: var(--background-secondary);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-color);
    font-weight: 500;
    white-space: nowrap;
}

.quick-topic:hover {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
    color: white;
    border-color: transparent;
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

[data-theme=dark] .quick-topic {
    background: var(--neutral-700);
    border-color: var(--neutral-600);
}

/* Campo de entrada */
.chat-input-container {
    padding: 16px;
    border-top: 1px solid var(--border-color);
    background: var(--card-background);
    border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
}

[data-theme=dark] .chat-input-container {
    background: var(--neutral-800);
    border-top-color: var(--neutral-700);
}

.chat-input-wrapper {
    display: flex;
    gap: 8px;
    align-items: flex-end;
    background: var(--background-color);
    border: 2px solid var(--border-color);
    border-radius: 24px;
    padding: 4px;
    transition: all 0.2s ease;
}

.chat-input-wrapper:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

[data-theme=dark] .chat-input-wrapper {
    background: var(--neutral-700);
    border-color: var(--neutral-600);
}

.chat-input {
    flex: 1;
    padding: 10px 16px;
    border: none;
    background: transparent;
    color: var(--text-color);
    font-size: 0.9rem;
    resize: none;
    max-height: 80px;
    min-height: 20px;
    outline: none;
    font-family: inherit;
    line-height: 1.4;
}

.chat-input::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
}

.chat-send {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
    border: none;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
}

.chat-send::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
}

.chat-send:hover::before {
    transform: translateX(100%);
}

.chat-send:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
}

.chat-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.chat-send i {
    font-size: 0.9rem;
    position: relative;
    z-index: 1;
}

/* Bot√£o toggle do chatbot */
.chatbot-toggle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
    border: none;
    color: white;
    font-size: 1.4rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
}

.chatbot-toggle::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
    transform: translateX(-100%);
    transition: transform 0.5s ease;
}

.chatbot-toggle:hover::before {
    transform: translateX(100%);
}

.chatbot-toggle:hover {
    transform: scale(1.1);
    box-shadow: var(--shadow-xl);
}

.chatbot-toggle.active {
    transform: rotate(180deg);
}

.chatbot-toggle i {
    position: relative;
    z-index: 1;
    transition: transform 0.3s ease;
}

.chatbot-toggle.active i {
    transform: rotate(180deg);
}

/* Mensagem de erro */
.error-message {
    background: linear-gradient(135deg, var(--error-50) 0%, #fecaca 100%);
    color: var(--error-600);
    padding: 12px 16px;
    border-radius: 18px;
    border-bottom-left-radius: 6px;
    font-size: 0.85rem;
    max-width: 85%;
    border: 1px solid #fca5a5;
    align-self: flex-start;
    box-shadow: var(--shadow-sm);
}

[data-theme=dark] .error-message {
    background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
    color: #fca5a5;
    border-color: #991b1b;
}

/* Responsividade */
@media (max-width: 768px) {
    .medical-chatbot {
        bottom: 16px;
        right: 16px;
    }
    
    .chatbot-container {
        width: calc(100vw - 32px);
        max-width: 350px;
        height: 450px;
        bottom: 70px;
        right: 0;
    }
    
    .chatbot-toggle {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
    }
    
    .chat-messages {
        padding: 12px;
    }
    
    .chat-input-container {
        padding: 12px;
    }
}

/* GAMIFICA√á√ÉO com design tecnol√≥gico (AJUSTADO) */
.level-container {
    display: flex;
    align-items: center;
    gap: 12px; /* Reduzido */
    margin-bottom: 8px; /* Reduzido */
}

.level-avatar {
    font-size: 1.5rem; /* Reduzido */
    width: 40px; /* Reduzido */
    height: 40px; /* Reduzido */
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--accent-600) 0%, var(--accent-500) 100%);
    border-radius: 50%;
    color: white;
    border: 3px solid rgba(255, 255, 255, 0.2);
    box-shadow: var(--shadow-lg);
    transition: var(--transition);
}

.level-avatar:hover {
    transform: scale(1.1);
}

.level-progress {
    flex-grow: 1;
}

.level-info {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 4px; /* Reduzido */
    font-weight: 500;
}

.level-badge {
    background: linear-gradient(135deg, var(--accent-600) 0%, var(--accent-500) 100%);
    color: white;
    padding: 4px 10px; /* Reduzido */
    border-radius: 16px;
    font-size: 0.7rem; /* Reduzido */
    font-weight: 800;
    display: inline-block;
    margin-left: 8px; /* Reduzido */
    box-shadow: var(--shadow-sm);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.level-up-animation {
    animation: levelUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes levelUp {
    0% { transform: scale(1); }
    30% { transform: scale(1.3) rotate(10deg); }
    60% { transform: scale(1.1) rotate(-5deg); }
    100% { transform: scale(1.2) rotate(0deg); }
}

.level-up-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-background);
    padding: 32px; /* Reduzido */
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-2xl);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: center;
    max-width: 360px; /* Reduzido */
    width: 90%;
    border: 1px solid var(--border-color);
    backdrop-filter: blur(20px);
}

.level-up-notification.show {
    opacity: 1;
    animation: celebrationPulse 0.8s ease;
}

@keyframes celebrationPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    25% { transform: translate(-50%, -50%) scale(1.05); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
    75% { transform: translate(-50%, -50%) scale(1.05); }
}

.level-up-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px; /* Reduzido */
}

.level-up-content h3 {
    color: var(--primary-600);
    margin: 0;
    font-size: 1.4rem; /* Reduzido */
    font-weight: 900;
    letter-spacing: -0.02em;
}

.level-up-content h4 {
    color: var(--text-color);
    margin: 0;
    font-size: 1.2rem; /* Reduzido */
    font-weight: 700;
    letter-spacing: -0.02em;
}

.level-up-content p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.9rem; /* Reduzido */
    font-weight: 500;
}

/* Responsividade aprimorada */
@media (max-width: 1200px) {
    .header-center {
        display: none;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .header-fixed {
        left: 0 !important;
        padding: 12px 16px; /* Reduzido */
        flex-direction: column;
        min-height: auto;
        gap: 12px; /* Reduzido */
    }
    
    .header-left,
    .header-right {
        width: 100%;
        justify-content: space-between;
    }
    
    .header-center {
        display: flex;
        width: 100%;
        order: -1;
        margin: 12px 0;
    }
    
    .user-profile-header {
        width: 100%;
        justify-content: center;
        gap: 12px; /* Reduzido */
        padding: 8px 12px; /* Reduzido */
    }
    
    .xp-bar-container {
        width: 120px; /* Reduzido */
        height: 6px; /* Reduzido */
    }
    
    .sidebar {
        width: 100%;
        transform: translateX(-100%);
    }
    
    .sidebar.open {
        transform: translateX(0);
        width: 280px; /* Reduzido */
    }
    
    .sidebar.collapsed {
        transform: translateX(-100%);
    }
    
    .main-content.sidebar-open,
    .main-content.sidebar-collapsed {
        margin-left: 0;
    }
    
    .main-content {
        padding-top: 180px; /* Ajustado para o header mobile maior */
        padding-left: 16px; /* Reduzido */
        padding-right: 16px; /* Reduzido */
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 16px; /* Reduzido */
    }
    
    .controls-grid {
        grid-template-columns: 1fr;
    }
    .config-form {
        grid-template-columns: 1fr;
    }
    
    .pomodoro-controls,
    .difficulty-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .week-table {
        font-size: 0.8rem; /* Reduzido */
    }
    
    .week-table th,
    .week-table td {
        padding: 12px 10px; /* Reduzido */
    }
    
    .chatbot-container {
        width: 100vw;
        height: 100vh;
        bottom: 0;
        right: 0;
        border-radius: 0;
        position: fixed;
    }
    
    .medical-chatbot {
        bottom: 20px;
        right: 20px;
    }
    
    .chatbot-toggle {
        width: 55px; /* Reduzido */
        height: 55px; /* Reduzido */
        font-size: 1.5rem; /* Reduzido */
    }
    
    .auth-form {
        padding: 24px; /* Reduzido */
        margin: 20px;
    }
    
    .achievements-grid {
        grid-template-columns: 1fr;
        gap: 16px; /* Reduzido */
    }
    
    .achievement-category {
        padding: 20px; /* Reduzido */
    }
    
    .chart-container {
        padding: 20px; /* Reduzido */
        height: 280px; /* Reduzido */
    }
    
    .controls-section {
        padding: 20px; /* Reduzido */
    }
    
    .pomodoro-section {
        padding: 28px; /* Reduzido */
    }
    
    .pomodoro-display {
        font-size: 3rem; /* Reduzido */
        letter-spacing: 3px;
    }
}

@media (max-width: 480px) {
    .header-title {
        font-size: 1.2rem; /* Reduzido */
    }
    
    .pomodoro-display {
        font-size: 2.5rem; /* Reduzido */
    }
    
    .stat-card .value {
        font-size: 2.5rem; /* Reduzido */
    }
    
    .achievement-icon {
        font-size: 2.2rem; /* Reduzido */
        width: 50px; /* Reduzido */
    }
    
    .difficulty-buttons {
        flex-direction: column;
        align-items: stretch;
    }
    
    .difficulty-btn {
        width: 100%;
        margin-bottom: 10px;
    }
}

/* Scrollbar personalizada moderna */
::-webkit-scrollbar {
    width: 8px; /* Reduzido */
}

::-webkit-scrollbar-track {
    background: var(--background-color);
    border-radius: 6px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--secondary-500) 100%);
    border-radius: 6px;
    transition: var(--transition);
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--primary-700) 0%, var(--secondary-600) 100%);
}

/* Grupos de revis√£o modernos (AJUSTADO) */
.review-group {
    background: var(--card-background);
    padding: 24px; /* Reduzido */
    border-radius: var(--border-radius-lg);
    margin-bottom: 20px; /* Reduzido */
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
    transition: var(--transition);
    backdrop-filter: blur(10px);
}

.review-group:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-2xl);
}

.review-group h4 {
    color: var(--primary-600);
    margin-bottom: 16px; /* Reduzido */
    display: flex;
    align-items: center;
    gap: 10px; /* Reduzido */
    font-weight: 800;
    font-size: 1.1rem; /* Reduzido */
    letter-spacing: -0.02em;
}

.review-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 18px; /* Reduzido */
    border-bottom: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: 8px; /* Reduzido */
    transition: var(--transition);
    background: var(--background-color);
}

.review-item:hover {
    background: rgba(59, 130, 246, 0.05);
    transform: translateX(6px);
    border-color: rgba(59, 130, 246, 0.2);
}

.review-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.review-info {
    flex-grow: 1;
}

.review-info strong {
    color: var(--text-color);
    font-weight: 700;
    font-size: 1rem; /* Reduzido */
    letter-spacing: -0.01em;
}

.review-info div {
    color: var(--text-secondary);
    font-size: 0.85rem; /* Reduzido */
    margin-top: 4px; /* Reduzido */
    font-weight: 500;
}

.review-actions {
    display: flex;
    gap: 12px; /* Reduzido */
    align-items: center;
}

.review-due {
    font-weight: 800;
    padding: 6px 14px; /* Reduzido */
    border-radius: 16px;
    font-size: 0.8rem; /* Reduzido */
    min-width: 80px; /* Reduzido */
    text-align: center;
    box-shadow: var(--shadow-sm);
}

.review-due.urgent {
    background: linear-gradient(135deg, var(--error-500) 0%, var(--error-600) 100%);
    color: white;
}

.review-due.soon {
    background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
    color: white;
}

.review-due:not(.urgent):not(.soon) {
    background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
    color: white;
}

/* Lista de temas customizados */
.custom-theme-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 18px; /* Reduzido */
    border-radius: var(--border-radius);
    background: var(--background-color);
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    transition: var(--transition);
}

.custom-theme-item:hover {
    background: rgba(59, 130, 246, 0.05);
    transform: translateX(6px);
    border-color: rgba(59, 130, 246, 0.2);
}

.custom-theme-item span {
    display: flex;
    align-items: center;
    gap: 12px; /* Reduzido */
    font-weight: 600;
}

/* Efeitos especiais para elementos interativos */
.btn, .difficulty-btn, .chatbot-toggle, .topic-checkbox {
    position: relative;
    overflow: hidden;
}

/* Display de tempo de estudo (AJUSTADO) */
#study-time-display {
    background: rgba(6, 182, 212, 0.1);
    padding: 8px 14px; /* Reduzido */
    border-radius: var(--border-radius);
    border: 1px solid rgba(6, 182, 212, 0.3);
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
    letter-spacing: 1px;
    box-shadow: var(--shadow-sm);
    backdrop-filter: blur(10px);
    font-size: 0.9rem; /* Adicionado */
}

/* Grupo de formul√°rios de configura√ß√£o */
.config-form-group {
    display: flex;
    gap: 16px;
    align-items: flex-end;
    background: var(--background-color);
    padding: 20px;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
}

.config-form-group > div {
    flex-grow: 1;
}

.config-form-group .btn {
    white-space: nowrap;
    min-width: 140px;
}

/* Estados de foco melhorados */
*:focus {
    outline: 2px solid var(--primary-600);
    outline-offset: 2px;
}

button:focus, input:focus, select:focus, textarea:focus {
    outline: none;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

/* Estados disabled melhorados */
button:disabled, input:disabled, select:disabled, textarea:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    filter: grayscale(20%);
}

/* Transi√ß√µes suaves para mudan√ßas de tema */
*, *::before, *::after {
    transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
}

/* Melhorias na tipografia (AJUSTADO) */
h1, h2, h3, h4, h5, h6 {
    font-weight: 800;
    line-height: 1.2;
    letter-spacing: -0.025em;
}

h1 { font-size: 2.2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.5rem; }
h4 { font-size: 1.25rem; }
h5 { font-size: 1.1rem; }
h6 { font-size: 1rem; }

/* Anima√ß√µes de carregamento */
@keyframes skeletonPulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.4;
    }
}

.loading {
    animation: skeletonPulse 1.5s ease-in-out infinite;
}

/* Efeitos especiais para checkboxes */
.topic-checkbox:checked {
    transform: scale(1.3); /* Reduzido */
    filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.4));
}

/* Melhorias finais nos elementos pequenos */
.expand-weeks-btn {
    margin-bottom: 24px;
    background: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-600) 100%);
}

/* Fade-in class para anima√ß√µes */
.fade-in {
    animation: fadeInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== SISTEMA DE CARREGAMENTO IA MODERNO ===== */

/* Anima√ß√£o do spinner moderno */
@keyframes ai-spinner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Anima√ß√£o dos pontos pulsantes */
@keyframes ai-dots {
    0%, 20% { opacity: 0; }
    50% { opacity: 1; }
    80%, 100% { opacity: 0; }
}

/* Anima√ß√£o de fade-in suave */
@keyframes ai-fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Anima√ß√£o de fade-out suave */
@keyframes ai-fade-out {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
}

/* Container principal do carregamento */
.ai-loading-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 20px;
    animation: ai-fade-in 0.3s ease-out;
    transition: all 0.3s ease-out;
}

.ai-loading-container.fade-out {
    animation: ai-fade-out 0.3s ease-out;
}

/* Spinner moderno */
.ai-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid var(--border-color);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: ai-spinner 1s linear infinite;
    flex-shrink: 0;
}

[data-theme=dark] .ai-spinner {
    border-color: var(--neutral-600);
    border-top-color: var(--primary-color);
}

/* Texto do carregamento */
.ai-loading-text {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Pontos animados */
.ai-loading-dots {
    display: inline-flex;
    gap: 2px;
}

.ai-loading-dots span {
    width: 4px;
    height: 4px;
    background-color: var(--primary-color);
    border-radius: 50%;
    animation: ai-dots 1.4s infinite ease-in-out;
}

.ai-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.ai-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
.ai-loading-dots span:nth-child(3) { animation-delay: 0s; }

/* Barra de progresso simulada */
.ai-progress-bar {
    width: 100%;
    height: 3px;
    background-color: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 12px;
    position: relative;
}

[data-theme=dark] .ai-progress-bar {
    background-color: var(--neutral-700);
}

.ai-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    border-radius: 2px;
    width: 0%;
    transition: width 0.3s ease-out;
    position: relative;
    overflow: hidden;
}

.ai-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: ai-progress-shimmer 2s infinite;
}

@keyframes ai-progress-shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* √çcone de IA moderno */
.ai-icon {
    width: 20px;
    height: 20px;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
}

.ai-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
    animation: ai-icon-shine 3s infinite;
}

@keyframes ai-icon-shine {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Varia√ß√µes de estilo para diferentes tipos de carregamento */
.ai-loading-container.resumo .ai-icon {
    background: linear-gradient(135deg, #10b981, #059669);
}

.ai-loading-container.questoes .ai-icon {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

.ai-loading-container.flashcards .ai-icon {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.ai-loading-container.ranking .ai-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

/* Responsividade */
@media (max-width: 768px) {
    .ai-loading-container {
        flex-direction: column;
        gap: 8px;
        padding: 16px;
    }
    
    .ai-loading-text {
        font-size: 0.9rem;
        text-align: center;
    }
    
    .ai-spinner {
        width: 20px;
        height: 20px;
        border-width: 2px;
    }
}

/* Manter compatibilidade com o c√≥digo antigo */
.loading-hourglass {
    display: none; /* Ocultar o antigo */
}

@keyframes hourglass-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(180deg); }
}

/* Estilo do modal do flashcard IA */
#ia-flashcard-modal .modal-content {
  max-height: 80vh; /* 80% da altura da tela */
  overflow-y: auto; /* Habilita scroll vertical quando necess√°rio */
  padding: 20px;
  text-align: left;
}

#ia-resumo {
  white-space: pre-wrap; /* Mant√©m quebras de linha e formata√ß√£o */
  max-height: 60vh; /* Altura m√°xima antes do scroll */
  overflow-y: auto;
  padding: 10px;
  background-color: var(--card-background);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  margin: 15px 0;
}

/* Pulse class para elementos especiais */
.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
    100% {
        transform: scale(1);
    }
}

/* ESTILOS PARA A NOVA ABA DE RANKING */
.ranking-table tr.current-user-row {
    background-color: var(--primary-100);
    font-weight: bold;
}

[data-theme=dark] .ranking-table tr.current-user-row {
    background-color: var(--neutral-700);
    color: var(--primary-300);
}

.ranking-table tr.current-user-row:hover {
    background: var(--primary-200) !important;
}

[data-theme=dark] .ranking-table tr.current-user-row:hover {
    background: var(--neutral-600) !important;
}

.comparison-card-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
}
    </style>
</head>
<body>
    <div id="auth-container">
        <div class="blob-1"></div>
        <div class="blob-2"></div>
        <div class.blob-3"></div>
        
        <div class="grid-overlay"></div>

        <div class="content-container">
            <div class="marketing-content">
                <div class="header-section">
                    <div class="brand-header">
                        <div class="brand-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div>
                            <h1 class="brand-title">Cronograma Revalida 2025</h1>
                            <p class="brand-subtitle">Sua jornada m√©dica come√ßa aqui</p>
                        </div>
                    </div>
                    
                    <div class="features-list">
                        <div class="feature-item">
                            <div class="feature-icon green">
                                <i class="fas fa-check"></i>
                            </div>
                            <div>
                                <h3 class="feature-title">Organize seus estudos com intelig√™ncia</h3>
                                <p class="feature-description">Cronograma personalizado para sua aprova√ß√£o</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon blue">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div>
                                <h3 class="feature-title">IA especializada em medicina</h3>
                                <p class="feature-description">Chatbot m√©dico para esclarecer d√∫vidas</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon purple">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div>
                                <h3 class="feature-title">Sistema de gamifica√ß√£o</h3>
                                <p class="feature-description">Conquistas e n√≠veis para manter motiva√ß√£o</p>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon orange">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div>
                                <h3 class="feature-title">Acesse de qualquer lugar</h3>
                                <p class="feature-description">Sincroniza√ß√£o autom√°tica na nuvem</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-section">
                    <div class="stat-item">
                        <div class="stat-number blue">500+</div>
                        <div class="stat-label">Temas M√©dicos</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number purple">95%</div>
                        <div class="stat-label">Taxa de Aprova√ß√£o</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number pink">24/7</div>
                        <div class="stat-label">Acesso Total</div>
                    </div>
                </div>
            </div>

            <div class="auth-container">
                <div class="auth-form-wrapper">
                    
                    <div class="auth-toggle">
                        <div class="toggle-container">
                            <button id="login-toggle" class="toggle-button active">
                                <i class="fas fa-sign-in-alt"></i>
                                Entrar
                            </button>
                            <button id="signup-toggle" class="toggle-button inactive">
                                <i class="fas fa-user-plus"></i>
                                Cadastrar
                            </button>
                        </div>
                    </div>

                    <div class="auth-form">
                        <div class="form-header">
                            <div class="form-icon">
                                <i id="form-icon" class="fas fa-stethoscope"></i>
                            </div>
                            <h2 id="auth-title" class="form-title">Bem-vindo de volta!</h2>
                            <p id="form-subtitle" class="form-subtitle">Continue seus estudos de onde parou</p>
                        </div>

                        <div class="form-fields">
                             <div class="field-group" id="username-group">
                                <div class="field-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <input
                                    type="text"
                                    id="username"
                                    class="form-input"
                                    placeholder="Seu nome de usu√°rio"
                                />
                            </div>

                            <div class="field-group">
                                <div class="field-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <input
                                    type="email"
                                    id="email"
                                    class="form-input"
                                    placeholder="Seu e-mail"
                                    required
                                />
                            </div>

                            <div class="field-group">
                                <div class="field-icon">
                                    <i class="fas fa-lock"></i>
                                </div>
                                <input
                                    type="password"
                                    id="password"
                                    class="form-input"
                                    placeholder="Sua senha"
                                    required
                                />
                            </div>

                            <button id="auth-button" class="submit-button">
                                <i id="submit-icon" class="fas fa-sign-in-alt"></i>
                                <span id="submit-text">Entrar</span>
                            </button>
                        </div>

                        <div class="form-footer">
                            <p id="auth-switch">
                                <span id="footer-text">N√£o tem uma conta?</span>
                                <a id="switch-to-signup">Cadastre-se</a>
                            </p>
                        </div>

                        <div class="security-badge">
                            <i class="fas fa-shield-alt"></i>
                            <span>Seus dados est√£o protegidos com criptografia de ponta</span>
                        </div>
                    </div>

                    <div class="mobile-features">
                        <div class="mobile-features-title">
                            <h3>Por que escolher nossa plataforma?</h3>
                        </div>
                        <div class="mobile-features-grid">
                            <div class="mobile-feature-card">
                                <i class="fas fa-brain blue"></i>
                                <p>IA M√©dica</p>
                            </div>
                            <div class="mobile-feature-card">
                                <i class="fas fa-trophy yellow"></i>
                                <p>Gamifica√ß√£o</p>
                            </div>
                            <div class="mobile-feature-card">
                                <i class="fas fa-clock green"></i>
                                <p>Pomodoro</p>
                            </div>
                            <div class="mobile-feature-card">
                                <i class="fas fa-chart-line purple"></i>
                                <p>Analytics</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header class="header-fixed" id="header">
            <div class="header-left">
                <button class="btn" id="menu-toggle"><i class="fas fa-bars"></i></button>
                <div class="header-title">Revalida 2025</div>
            </div>
            <div class="header-center">
                 <div class="user-profile-header">
                    <div id="study-streak" class="study-streak" title="Dias de estudo consecutivos"><i class="fas fa-fire"></i> <span id="streak-count">0</span></div>
                    <div class="user-level" id="user-level"></div>
                    <div class="xp-bar-container" title="Pontos de Experi√™ncia"><div id="xp-bar-fill" class="xp-bar-fill"></div></div>
                </div>
            </div>
            <div class="header-right">
        <div id="study-time-display" title="Tempo total de estudo" style="font-weight: 600; color: var(--accent-color);">
            ‚è±Ô∏è 00:00:00
        </div>
        <button class="btn btn-toggle" id="theme-toggle" title="Alternar Modo Escuro/Claro">
            <i class="fas fa-moon"></i>
        </button>
        <button class="btn" id="minimalist-toggle" title="Modo Minimalista">
            <i class="fas fa-compress"></i>
        </button>
        <button class="btn btn-danger" id="logout-btn" title="Sair">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
        </header>

        <nav class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <ul class="sidebar-menu">
                    <li><a href="#" data-section="stats"><i class="fas fa-chart-bar"></i><span>Estat√≠sticas</span></a></li>
                    <li><a href="#" data-section="achievements"><i class="fas fa-trophy"></i><span>Conquistas</span></a></li>
                    <li><a href="#" data-section="weeks"><i class="fas fa-calendar"></i><span>Semanas</span></a></li>
		<li><a href="#" data-section="ranking"><i class="fas fa-trophy"></i><span>Ranking</span></a></li> 
                    <li><a href="#" data-section="performance"><i class="fas fa-chart-line"></i><span>Desempenho por Quest√µes</span></a></li>
                    <li><a href="#" data-section="analysis"><i class="fas fa-binoculars"></i><span>An√°lise e Previs√µes</span></a></li>
                    <li><a href="#" data-section="progress"><i class="fas fa-tasks"></i><span>Progresso</span></a></li>
                    <li><a href="#" data-section="pomodoro"><i class="fas fa-clock"></i><span>Pomodoro</span></a></li>
                    <li><a href="#" data-section="review"><i class="fas fa-brain"></i><span>Revis√£o</span></a></li>
                    <li><a href="#" data-section="settings"><i class="fas fa-cog"></i><span>Configura√ß√µes</span></a></li>
                    <li><a href="#" id="reset-progress"><i class="fas fa-trash"></i><span>Resetar</span></a></li>
                </ul>
            </div>
        </nav>

        <main class="main-content" id="main-content">
            <section id="stats-section" class="content-section active">
                
                <!-- Sauda√ß√£o personalizada e frase motivacional -->
                <div id="greeting-container" style="text-align: center; margin: 10px 0 20px 0;">
                    <h2 id="greeting-message"></h2>
                    <p id="motivational-quote" style="font-style: italic; color: var(--text-secondary); margin: 6px 0 0 0; opacity: 0; transition: opacity 0.8s;"></p>
                </div>

                <div class="stats-grid fade-in">
                    <div class="stat-card"><h3><i class="fas fa-check-circle"></i> Temas Conclu√≠dos</h3><div class="value" id="completed-count">0</div><div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div><small id="progress-percentage">0%</small></div>
                    <div class="stat-card"><h3><i class="fas fa-calendar-day"></i> Dias Restantes</h3><div class="value" id="days-left">0</div><small>at√© a data da prova</small></div>
                    <div class="stat-card"><h3><i class="fas fa-redo"></i> Revis√µes Pendentes</h3><div class="value" id="reviews-pending">0</div><small>temas para revisar</small></div>
                    <div class="stat-card"><h3><i class="fas fa-star"></i> Dificuldade M√©dia</h3><div class="value" id="avg-difficulty">-</div><small>dos temas conclu√≠dos</small></div>
                </div>
                <div class="chart-container fade-in"><h3><i class="fas fa-tasks"></i> Conclus√£o por Mat√©ria (%)</h3><canvas id="graficoPorMateria"></canvas></div>
                <div class="chart-container fade-in"><h3><i class="fas fa-chart-line"></i> Desempenho M√©dio por √Årea (%)</h3><canvas id="graficoDesempenhoPorArea"></canvas></div>
            </section>

            <section id="achievements-section" class="content-section"><h2 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-trophy"></i> Suas Conquistas</h2><div class="achievements-grid" id="achievements-grid"></div></section>
            
            <section id="ranking-section" class="content-section">
                <h2 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-trophy"></i> Ranking da Plataforma</h2>
                
                <!-- Controle de Participa√ß√£o no Ranking -->
                <div class="controls-section fade-in" style="margin-bottom: 20px;">
                    <h3><i class="fas fa-user-cog"></i> Participa√ß√£o no Ranking</h3>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <button class="btn" id="toggle-ranking-participation" style="background: var(--secondary-color);">
                            <i class="fas fa-eye-slash"></i>
                            <span id="ranking-participation-text">Participar do Ranking</span>
                        </button>
                        <p class="config-hint" style="margin: 0; flex: 1; min-width: 200px;">
                            <span id="ranking-participation-description">
                                Voc√™ n√£o est√° participando do ranking p√∫blico. Clique no bot√£o para aparecer na classifica√ß√£o.
                            </span>
                        </p>
                    </div>
                </div>

                <div id="ranking-comparison-container" class="stats-grid fade-in" style="margin-bottom: 20px;">
                    </div>
                <div class="controls-section fade-in">
                    <h3><i class="fas fa-users"></i> Classifica√ß√£o Geral</h3>
                    <div id="ranking-content-area">
                        <div id="ranking-table-container" style="overflow-x: auto;">
                            </div>
                    </div>
                </div>
            </section>

            <section id="performance-section" class="content-section">
                <div class="controls-section fade-in">
                    <h2><i class="fas fa-chart-line"></i> Pratique seu conhecimento com IA</h2>
                    <p>Teste seus conhecimentos com flashcards e quest√µes geradas por intelig√™ncia artificial para registrar seu progresso automaticamente.</p>
                    
                    <div class="tabs-container" id="performance-tabs">
                        <button class="tab-button active" data-tab="questions"><i class="fas fa-question-circle"></i> Quest√µes</button>
                        <button class="tab-button" data-tab="flashcards"><i class="fas fa-clone"></i> Flashcards</button>
                    </div>
            
                    <div id="performance-content-container">
                        <div class="tab-content active" id="tab-content-questions">
                            <div class="config-form" style="grid-template-columns: 2fr 1fr 1fr 1fr; align-items: flex-end;">
                                <div class="config-group">
                                    <label for="perf-topic-select-questions">Tema Relacionado:</label>
                                    <select id="perf-topic-select-questions" class="config-input"></select>
                                </div>
                                <div class="config-group">
                                    <label for="perf-difficulty-questions">Dificuldade:</label>
                                    <select id="perf-difficulty-questions" class="config-input">
                                        <option value="F√°cil">F√°cil</option>
                                        <option value="M√©dia" selected>M√©dia</option>
                                        <option value="Dif√≠cil">Dif√≠cil</option>
                                    </select>
                                </div>
                                <div class="config-group">
                                    <label for="perf-quantity-questions">N¬∫ Quest√µes:</label>
                                    <input type="number" id="perf-quantity-questions" class="config-input" value="1" min="1" max="5">
                                </div>
                                <button class="btn" id="generate-question-btn"><i class="fas fa-cogs"></i> Gerar</button>
                            </div>
                            <div id="question-display-area" class="ia-display-area">
                                <p class="config-hint" style="text-align: center;">Selecione as op√ß√µes acima e clique em "Gerar" para come√ßar.</p>
                            </div>
                        </div>
            
                        <div class="tab-content" id="tab-content-flashcards">
                             <div class="config-form" style="grid-template-columns: 2fr 1fr 1fr 1fr; align-items: flex-end;">
                                <div class="config-group">
                                    <label for="perf-topic-select-flashcards">Tema Relacionado:</label>
                                    <select id="perf-topic-select-flashcards" class="config-input"></select>
                                </div>
                                <div class="config-group">
                                    <label for="perf-difficulty-flashcards">Dificuldade:</label>
                                    <select id="perf-difficulty-flashcards" class="config-input">
                                        <option value="F√°cil">F√°cil</option>
                                        <option value="M√©dia" selected>M√©dia</option>
                                        <option value="Dif√≠cil">Dif√≠cil</option>
                                    </select>
                                </div>
                                <div class="config-group">
                                    <label for="perf-quantity-flashcards">N¬∫ Flashcards:</label>
                                    <input type="number" id="perf-quantity-flashcards" class="config-input" value="1" min="1" max="5">
                                </div>
                                <button class="btn" id="generate-flashcard-btn"><i class="fas fa-cogs"></i> Gerar</button>
                            </div>
                            <div id="flashcard-display-area" class="ia-display-area">
                                <p class="config-hint" style="text-align: center;">Selecione as op√ß√µes e clique em "Gerar" para come√ßar.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="controls-section fade-in" style="margin-top: 20px;">
                    <h3><i class="fas fa-history"></i> Hist√≥rico de Registros</h3>
                    <div id="performance-history-container" style="overflow-x: auto;">
                        <p class="config-hint" style="text-align: center;">Nenhum registro de desempenho ainda.</p>
                    </div>
                </div>
            </section>
            
            <section id="analysis-section" class="content-section">
                <h2 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-binoculars"></i> An√°lise e Previs√µes</h2>
                
                <!-- Gr√°fico: Progresso Real vs. Esperado -->
                <div class="chart-container fade-in">
                    <h3><i class="fas fa-chart-area"></i> Progresso Real vs. Esperado</h3>
                    <canvas id="progress-chart-new"></canvas>
                </div>

                <!-- Card: Estimativa de Conclus√£o -->
                <div class="stats-grid fade-in">
                    <div class="stat-card">
                        <h3><i class="fas fa-calendar-alt"></i> Estimativa de Conclus√£o</h3>
                        <p id="completion-estimate-new" style="font-size: 1.1rem; color: var(--text-color); margin-top: 15px;">üìÖ Calculando...</p>
                        <small style="color: var(--text-secondary);">Com base no seu ritmo dos √∫ltimos 7 dias</small>
                    </div>

                    <!-- Card: Dica da IA -->
                    <div class="stat-card" style="background: var(--info-50); border: 1px solid var(--info-500);">
                        <h3><i class="fas fa-lightbulb" style="color: var(--info-500);"></i> Dica da IA</h3>
                        <p id="ai-tip-new" style="font-size: 1rem; color: var(--info-600); margin-top: 15px;">üí° Analisando seus dados para gerar uma sugest√£o...</p>
                    </div>
                </div>

                <!-- Gr√°fico: √Åreas Fortes e Fracas -->
                <div class="chart-container fade-in">
                    <h3><i class="fas fa-signal"></i> Desempenho por Tema</h3>
                    <canvas id="topics-chart-new"></canvas>
                    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 10px; font-size: 0.8rem;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 12px; height: 12px; background-color: #4ade80; border-radius: 2px;"></span> > 75%
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 12px; height: 12px; background-color: #facc15; border-radius: 2px;"></span> 50-74%
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="width: 12px; height: 12px; background-color: #f87171; border-radius: 2px;"></span> < 50%
                        </div>
                    </div>
                </div>
            </section>

            <section id="progress-section" class="content-section"><h2 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-tasks"></i> Progresso por Mat√©ria</h2><div id="progress-lists"></div></section>
            <section id="pomodoro-section" class="content-section"><div class="pomodoro-section fade-in"><h3><i class="fas fa-clock"></i> Timer Pomodoro</h3><div class="pomodoro-display" id="pomodoro-display">25:00</div><div class="pomodoro-controls"><button class="btn" id="pomodoro-start"><i class="fas fa-play"></i> Iniciar</button><button class="btn" id="pomodoro-pause"><i class="fas fa-pause"></i> Pausar</button><button class="btn" id="pomodoro-reset"><i class="fas fa-stop"></i> Resetar</button></div><div class="pomodoro-settings"><div><label>Foco (min):</label><input type="number" id="focus-time" value="25" min="1" max="60"></div><div><label>Pausa (min):</label><input type="number" id="break-time" value="5" min="1" max="30"></div></div></div></section>
            <section id="review-section" class="content-section"><div class="controls-section fade-in"><h3><i class="fas fa-brain"></i> Revis√µes Futuras</h3><div id="future-reviews-container"></div></div></section>
            <section id="settings-section" class="content-section"><div class="controls-section fade-in"><h3><i class="fas fa-cog"></i> Configura√ß√µes</h3><div class="config-form" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"><div class="config-group"><label for="start-date">Data de In√≠cio:</label><input type="date" id="start-date" class="config-input"></div><div class="config-group"><label for="exam-date">Data da Prova:</label><input type="date" id="exam-date" class="config-input"></div><div class="config-group"><label for="max-topics-day">M√°x. Temas/Dia:</label><input type="number" id="max-topics-day" class="config-input" value="5" min="1" max="10"></div></div><div style="margin-top: 30px; border-top: 2px solid var(--border-color); padding-top: 20px;"><h4><i class="fas fa-plus-circle"></i> Adicionar Temas Personalizados</h4><div class="config-form-group" style="margin-top: 15px;"><div class="config-group"><label for="custom-theme-name">Nome do Tema:</label><input type="text" id="custom-theme-name" class="config-input" placeholder="Ex: Revis√£o de ECG"></div><div class="config-group"><label for="custom-theme-area">√Årea:</label><select id="custom-theme-area" class="config-input"><option value="preventiva">Preventiva</option><option value="pediatria">Pediatria</option><option value="ginecologia">Ginecologia</option><option value="obstetricia">Obstetr√≠cia</option><option value="clinica">Cl√≠nica</option><option value="cirurgia">Cirurgia</option><option value="psiquiatria">Psiquiatria</option><option value="revisao">Revis√£o</option></select></div><button class="btn" id="add-custom-theme-btn"><i class="fas fa-plus"></i> Add</button></div><div id="custom-themes-list" style="margin-top: 20px;"></div></div><button class="btn" id="apply-config" style="margin-top: 30px; background-color: var(--primary-color); padding: 15px 25px; font-size: 1.1em; width: 100%;"><i class="fas fa-save"></i> Salvar e Atualizar Cronograma</button></div></section>
            <section id="weeks-section" class="content-section"><div class="controls-section fade-in"><div class="controls-grid"><div><label for="search-box">üîç Buscar tema:</label><input type="text" id="search-box" class="search-box" placeholder="Digite o nome do tema..."></div><div><label for="area-filter">üè• Filtrar por √°rea:</label><select id="area-filter" class="filter-select"><option value="all">Todas as √°reas</option><option value="preventiva">Preventiva</option><option value="pediatria">Pediatria</option><option value="ginecologia">Ginecologia</option><option value="obstetricia">Obstetr√≠cia</option><option value="clinica">Cl√≠nica</option><option value="cirurgia">Cirurgia</option><option value="psiquiatria">Psiquiatria</option><option value="revisao">Revis√£o</option></select></div></div></div><button class="btn expand-weeks-btn" id="expand-weeks" style="display: none;"><i class="fas fa-expand"></i> Mostrar todas as semanas</button><div id="weeks"></div></section>
        </main>

        <div class="medical-chatbot">
            <div class="chatbot-container" id="chatbot-container">
                <div class="chatbot-header">
                    <button class="chatbot-close" id="chatbot-close">√ó</button>
                    <h3>üß† IA M√©dica Revalida</h3>
                    <p>Seu assistente de estudos especializado</p>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot">
                        <div class="message-bubble">
                            üëã Ol√°! Sou sua IA especializada em Revalida/Enamed. Posso te ajudar com:
                            <br><br>
                            ‚Ä¢ Resumos t√©cnicos de qualquer tema
                            ‚Ä¢ Explica√ß√µes did√°ticas 
                            ‚Ä¢ Perguntas de fixa√ß√£o
                            ‚Ä¢ Dicas de estudo por √°rea
                            <br><br>
                            Como posso te ajudar hoje?
                        </div>
                        <div class="message-time">Agora</div>
                    </div>
                    
                    <div class="quick-topics">
                        <div class="quick-topic" data-topic="Resumo de Hipertens√£o Arterial">Hipertens√£o</div>
                        <div class="quick-topic" data-topic="Diabetes Mellitus principais pontos">Diabetes</div>
                        <div class="quick-topic" data-topic="Infarto Agudo do Mioc√°rdio tratamento">IAM</div>
                        <div class="quick-topic" data-topic="Pneumonia diagn√≥stico">Pneumonia</div>
                        <div class="quick-topic" data-topic="Anemia ferropriva pediatria">Anemia</div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typing-indicator">
                    <span>üß† IA pensando</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chat-input" 
                            placeholder="Digite sua pergunta para o assistente..."
                            rows="1"
                        ></textarea>
                        <button class="chat-send" id="chat-send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <button class="chatbot-toggle" id="chatbot-toggle">
                <i class="fas fa-brain"></i>
            </button>
        </div>

        <div class="modal" id="difficulty-modal"><div class="modal-content"><h3>Como foi estudar este tema?</h3><p>Avalie a dificuldade para melhorar suas revis√µes:</p><div class="difficulty-buttons"><button class="difficulty-btn difficulty-easy" data-difficulty="easy">üòä F√°cil</button><button class="difficulty-btn difficulty-medium" data-difficulty="medium">üòê M√©dio</button><button class="difficulty-btn difficulty-hard" data-difficulty="hard">üò∞ Dif√≠cil</button></div></div></div>
        <div class="modal" id="confirmation-modal"><div class="modal-content"><h3>‚ö†Ô∏è Confirmar Reset</h3><p>Tem certeza que deseja resetar todo o progresso e configura√ß√µes? Isso inclui suas conquistas!</p><p><strong>Esta a√ß√£o n√£o pode ser desfeita!</strong></p><div class="confirmation-buttons"><button class="btn btn-confirm" id="confirm-reset"><i class="fas fa-trash"></i> Sim, Resetar</button><button class="btn btn-cancel" id="cancel-reset"><i class="fas fa-times"></i> Cancelar</button></div></div></div>
        <div id="achievement-notification" class="achievement-notification"><i id="achievement-icon" class="fas fa-trophy"></i><div><h4 id="achievement-title">Conquista Desbloqueada!</h4><p id="achievement-desc">Descri√ß√£o da conquista.</p></div></div>

   <div class="modal" id="ia-flashcard-modal">
  <div class="modal-content">
    <h3 id="ia-flashcard-title"></h3>
    <div id="ia-resumo"></div>
    <button class="btn btn-cancel" onclick="hideModal('ia-flashcard-modal')">Fechar</button>
  </div>
</div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://oczcyffaolkokunxgdzf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jemN5ZmZhb2xrb2t1bnhnZHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNzcwMDMsImV4cCI6MjA2OTc1MzAwM30.MUzZw2yJeuLqlmOoCPrTZEf1XjfNOK-JkF-Hz_EerEk';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let isSignUp = false;

        // =================================================================================
        // DADOS E ESTADO DA APLICA√á√ÉO
        // =================================================================================
        const defaultState = {
            sidebarOpen: false,
            sidebarCollapsed: false,
            minimalistMode: false,
            darkMode: false,
            pomodoroRunning: false,
            pomodoroTime: 25 * 60,
            pomodoroInterval: null,
            currentPomodoroType: 'focus',
            currentDifficultyTopic: null,
            currentSection: 'stats',
            charts: {
                completionBySubject: null,
                performanceByArea: null,
                progressChart: null,
                performanceByTopicChart: null
            },
            completedTopics: {},
            topicDifficulties: {},
            lastReviewDates: {},
            customThemes: [], 
            performanceLog: [],
            // Estado da se√ß√£o de desempenho
            performanceTab: 'questions',
            currentIAQuestions: [],
            currentIAFlashcards: [],
            currentQuestionIndex: 0,
            currentFlashcardIndex: 0,
            userProfile: {
                username: 'Convidado',
                xp: 0,
                level: 0,
                unlockedAchievements: {},
                lastStudyDate: null,
                studyStreak: 0,
                completedPomodoros: 0,
                totalStudyTimeSeconds: 0,
                show_in_ranking: false
            },
            scheduleConfig: {
                startDate: '2025-08-11',
                examDate: '2025-10-19',
                maxTopicsPerDay: 4
            },
            allTopicsFlat: [],
            studyTimerInterval: null,
            rankingSubscription: null
        };
        
        let appState = JSON.parse(JSON.stringify(defaultState));

        const originalScheduleData = [// SEMANA 1 - INTRODU√á√ÉO √ÄS √ÅREAS
// SEGUNDA - CL√çNICA M√âDICA (Temas b√°sicos)
{theme:"Hipertens√£o Arterial Sist√™mica",area:"clinica"},
{theme:"Diabetes - diagn√≥stico e classifica√ß√£o",area:"clinica"},
{theme:"Cefaleia",area:"clinica"},
{theme:"Lombalgia",area:"clinica"},

// TER√áA - PEDIATRIA (Fundamentos)
{theme:"Puericultura",area:"pediatria"},
{theme:"Dist√∫rbios do crescimento e desenvolvimento",area:"pediatria"},
{theme:"Avalia√ß√£o neonatal",area:"pediatria"},
{theme:"Triagem neonatal",area:"pediatria"},

// QUARTA - GINECO-OBSTETR√çCIA (Base)
{theme:"Assist√™ncia pr√©-natal",area:"obstetricia"},
{theme:"Planejamento familiar",area:"ginecologia"},
{theme:"Amenorreia",area:"ginecologia"},
{theme:"Sangramento Uterino Anormal",area:"ginecologia"},

// QUINTA - CIRURGIA (Emerg√™ncias)
{theme:"Abdome agudo - apendicite",area:"cirurgia"},
{theme:"Trauma - atendimento inicial e vias a√©reas",area:"cirurgia"},
{theme:"T√©cnica cir√∫rgica e Corpo estranho",area:"cirurgia"},
{theme:"H√©rnias",area:"cirurgia"},

// SEXTA - MEDICINA PREVENTIVA (SUS e B√°sico)
{theme:"SUS",area:"preventiva"},
{theme:"Aten√ß√£o B√°sica",area:"preventiva"},
{theme:"Sa√∫de da Fam√≠lia",area:"preventiva"},
{theme:"Indicadores de Sa√∫de",area:"preventiva"},

// SEMANA 2 - APROFUNDAMENTO
// SEGUNDA - CL√çNICA M√âDICA (Cardio-Pneumo)
{theme:"S√≠ndrome Coronariana Aguda",area:"clinica"},
{theme:"Insufici√™ncia card√≠aca",area:"clinica"},
{theme:"Arritmias",area:"clinica"},
{theme:"Pneumonia",area:"clinica"},
{theme:"Asma",area:"clinica"},

// TER√áA - PEDIATRIA (Respirat√≥rio e Infeccioso)
{theme:"Pneumonia na inf√¢ncia",area:"pediatria"},
{theme:"Bronquiolite",area:"pediatria"},
{theme:"IVAS",area:"pediatria"},
{theme:"Doen√ßas Exantem√°ticas",area:"pediatria"},
{theme:"Desconforto respirat√≥rio do rec√©m-nascido",area:"pediatria"},

// QUARTA - GINECO-OBSTETR√çCIA (Patologias Gestacionais)
{theme:"S√≠ndromes hipertensivas da gesta√ß√£o",area:"obstetricia"},
{theme:"Diabetes na gesta√ß√£o",area:"obstetricia"},
{theme:"HIV e gesta√ß√£o",area:"obstetricia"},
{theme:"Infec√ß√£o urin√°ria na gesta√ß√£o",area:"obstetricia"},
{theme:"TORCH e S√≠filis",area:"obstetricia"},

// QUINTA - CIRURGIA (Abdome Agudo)
{theme:"Abdome agudo - pancreatite aguda",area:"cirurgia"},
{theme:"Abdome agudo - diverticulite",area:"cirurgia"},
{theme:"Abdome agudo obstrutivo",area:"cirurgia"},
{theme:"Abdome agudo perfurativo, vascular e hemorr√°gico",area:"cirurgia"},

// SEXTA - MEDICINA PREVENTIVA (Vigil√¢ncia)
{theme:"Vigil√¢ncia Epidemiol√≥gica e Epidemias",area:"preventiva"},
{theme:"Dengue",area:"preventiva"},
{theme:"Chikungunya, Zika e Febre amarela",area:"preventiva"},
{theme:"Vacinas",area:"preventiva"},

// SEMANA 3 - ESPECIALIZA√á√ÉO
// SEGUNDA - CL√çNICA M√âDICA (End√≥crino-Metab√≥lico)
{theme:"Diabetes - tratamento",area:"clinica"},
{theme:"Diabetes - complica√ß√µes",area:"clinica"},
{theme:"Hipotireoidismo",area:"clinica"},
{theme:"Hipertireoidismo",area:"clinica"},
{theme:"Dislipidemia",area:"clinica"},

// TER√áA - PEDIATRIA (Gastro-Urin√°rio)
{theme:"Diarreia e desidrata√ß√£o",area:"pediatria"},
{theme:"Constipa√ß√£o na inf√¢ncia",area:"pediatria"},
{theme:"ITU na inf√¢ncia",area:"pediatria"},
{theme:"Icter√≠cia neonatal",area:"pediatria"},
{theme:"Desnutri√ß√£o e obesidade",area:"pediatria"},

// QUARTA - GINECO-OBSTETR√çCIA (Hemorragias)
{theme:"Hemorragias da primeira metade da gesta√ß√£o",area:"obstetricia"},
{theme:"Hemorragias da segunda metade da gesta√ß√£o",area:"obstetricia"},
{theme:"Hemorragia p√≥s-parto e distocias",area:"obstetricia"},
{theme:"Rotura prematura de membranas",area:"obstetricia"},

// QUINTA - CIRURGIA (Trauma)
{theme:"Trauma - TCE e TRM",area:"cirurgia"},
{theme:"Trauma tor√°cico",area:"cirurgia"},
{theme:"Trauma abdominal",area:"cirurgia"},
{theme:"Trauma cervical e p√©lvico",area:"cirurgia"},

// SEXTA - MEDICINA PREVENTIVA (Doen√ßas Transmiss√≠veis)
{theme:"Tuberculose",area:"preventiva"},
{theme:"Hansen√≠ase",area:"preventiva"},
{theme:"HIV/AIDS",area:"preventiva"},
{theme:"Hepatites virais",area:"preventiva"},

// SEMANA 4 - CONSOLIDA√á√ÉO
// SEGUNDA - CL√çNICA M√âDICA (Neurol√≥gico)
{theme:"AVC",area:"clinica"},
{theme:"Epilepsia e convuls√£o febril",area:"clinica"},
{theme:"Doen√ßa de Parkinson",area:"clinica"},
{theme:"Meningite",area:"clinica"},

// TER√áA - PEDIATRIA (Especialidades)
{theme:"Cardiopatias cong√™nitas",area:"pediatria"},
{theme:"Prematuridade",area:"pediatria"},
{theme:"Reanima√ß√£o Neonatal",area:"pediatria"},
{theme:"Febre reum√°tica",area:"pediatria"},

// QUARTA - GINECO-OBSTETR√çCIA (Parto e Puerp√©rio)
{theme:"Mecanismo de parto e assist√™ncia cl√≠nica",area:"obstetricia"},
{theme:"Puerp√©rio",area:"obstetricia"},
{theme:"Aleitamento materno",area:"obstetricia"},
{theme:"Vitalidade Fetal",area:"obstetricia"},

// QUINTA - CIRURGIA (Perioperat√≥rio)
{theme:"Perioperat√≥rio - exames, medicamentos, seguran√ßa",area:"cirurgia"},
{theme:"Perioperat√≥rio - antibi√≥tico e infec√ß√£o de s√≠tio cir√∫rgico",area:"cirurgia"},
{theme:"Anestesia",area:"cirurgia"},
{theme:"Doa√ß√£o de √≥rg√£os e morte encef√°lica",area:"cirurgia"},

// SEXTA - MEDICINA PREVENTIVA (√âtica e Legisla√ß√£o)
{theme:"√âtica M√©dica - aspectos gerais",area:"preventiva"},
{theme:"√âtica M√©dica - sigilo m√©dico e informa√ß√µes m√©dicas",area:"preventiva"},
{theme:"Declara√ß√£o de √≥bito",area:"preventiva"},
{theme:"Medicina do Trabalho",area:"preventiva"},

// SEMANA 5 - REVIS√ÉO E APROFUNDAMENTO
// SEGUNDA - CL√çNICA M√âDICA (Gastro-Hepato)
{theme:"Doen√ßa do refluxo gastroesof√°gico",area:"clinica"},
{theme:"Doen√ßa inflamat√≥ria intestinal",area:"clinica"},
{theme:"S√≠ndrome do intestino irrit√°vel",area:"clinica"},
{theme:"Doen√ßas das vias biliares",area:"clinica"},

// TER√áA - PEDIATRIA (Cirurgia Pedi√°trica)
{theme:"Cirurgia pedi√°trica - urologia e gastro",area:"pediatria"},
{theme:"Doen√ßas cong√™nitas",area:"pediatria"},
{theme:"Maus tratos",area:"pediatria"},

// QUARTA - GINECO-OBSTETR√çCIA (Oncologia)
{theme:"C√¢ncer de colo de √∫tero e HPV",area:"ginecologia"},
{theme:"C√¢ncer de mama",area:"ginecologia"},
{theme:"C√¢ncer de ov√°rio",area:"ginecologia"},
{theme:"Doen√ßas Benignas da Mama",area:"ginecologia"},

// QUINTA - CIRURGIA (Especialidades)
{theme:"Cirurgia vascular",area:"cirurgia"},
{theme:"Cirurgia pl√°stica - queimados",area:"cirurgia"},
{theme:"Cirurgia pl√°stica - c√¢ncer de pele melanoma e n√£o melanoma",area:"cirurgia"},
{theme:"Urologia",area:"cirurgia"},

// SEXTA - MEDICINA PREVENTIVA (Parasitoses)
{theme:"Leishmaniose",area:"preventiva"},
{theme:"Leptospirose e mal√°ria",area:"preventiva"},
{theme:"Acidentes por animais pe√ßonhentos",area:"preventiva"},
{theme:"Raiva e t√©tano",area:"preventiva"},

// SEMANA 6 - SISTEMAS ESPEC√çFICOS
// SEGUNDA - CL√çNICA M√âDICA (Respirat√≥rio)
{theme:"DPOC",area:"clinica"},
{theme:"Crise de asma",area:"clinica"},
{theme:"O derrame pleural",area:"clinica"},
{theme:"Tromboembolia pulmonar",area:"clinica"},
{theme:"C√¢ncer de pulm√£o",area:"clinica"},

// TER√áA - PEDIATRIA (Restante)
{theme:"Epilepsia e convuls√£o febril",area:"pediatria"},

// QUARTA - GINECO-OBSTETR√çCIA (Ginecologia Geral)
{theme:"Doen√ßa inflamat√≥ria p√©lvica - DIP",area:"ginecologia"},
{theme:"Endometriose",area:"ginecologia"},
{theme:"S√≠ndrome dos ov√°rios polic√≠sticos",area:"ginecologia"},
{theme:"Patologias vulvares",area:"ginecologia"},
{theme:"Conte√∫do genital patol√≥gico",area:"ginecologia"},

// QUINTA - CIRURGIA (Oncologia)
{theme:"C√¢ncer de es√¥fago",area:"cirurgia"},
{theme:"Tumores de p√¢ncreas",area:"cirurgia"},
{theme:"Cirurgia da obesidade",area:"cirurgia"},

// SEXTA - MEDICINA PREVENTIVA (Complementar)
{theme:"Processo Sa√∫de-Doen√ßa",area:"preventiva"},
{theme:"Testes diagn√≥sticos e Estudos Epidemiol√≥gicos",area:"preventiva"},

// SEMANA 7 - SISTEMAS ESPECIAIS
// SEGUNDA - CL√çNICA M√âDICA (Hematologia)
{theme:"Anemia hipoproliferativas",area:"clinica"},
{theme:"Anemias hiperproliferativas",area:"clinica"},
{theme:"Neoplasias Hematol√≥gicas",area:"clinica"},
{theme:"Dist√∫rbios da hemostasia",area:"clinica"},

// TER√áA - PEDIATRIA (Vazio - usar para revis√£o)

// QUARTA - GINECO-OBSTETR√çCIA (Especialidades)
{theme:"Infertilidade",area:"ginecologia"},
{theme:"Toxoplasmose e gesta√ß√£o",area:"obstetricia"},
{theme:"Isoimuniza√ß√£o RH",area:"obstetricia"},
{theme:"Rela√ß√µes uterofetais",area:"obstetricia"},
{theme:"Restri√ß√£o de Crescimento Fetal",area:"obstetricia"},

// QUINTA - CIRURGIA (Ortopedia)
{theme:"Ortopedia e Trauma de extremidades",area:"cirurgia"},

// SEXTA - MEDICINA PREVENTIVA (Especialidades)
{theme:"Viol√™ncia sexual",area:"preventiva"},

// SEMANA 8 - COMPLEMENTARES
// SEGUNDA - CL√çNICA M√âDICA (Reumatologia)
{theme:"Artrite reumatoide",area:"clinica"},
{theme:"L√∫pus",area:"clinica"},
{theme:"Monoartrite aguda - gota e artrite infecciosa",area:"clinica"},
{theme:"Fibromialgia",area:"clinica"},

// TER√áA - PEDIATRIA (Vazio - revis√£o)

// QUARTA - GINECO-OBSTETR√çCIA (Vazio - revis√£o)

// QUINTA - CIRURGIA (Especialidades)
{theme:"Otorrinolaringologia",area:"cirurgia"},
{theme:"Doen√ßas orificiais",area:"cirurgia"},

// SEXTA - MEDICINA PREVENTIVA (Finais)
{theme:"Intoxica√ß√µes ex√≥genas",area:"preventiva"},
{theme:"Cuidados paliativos",area:"preventiva"},

// SEMANA 9 - COMPLEMENTARES
// SEGUNDA - CL√çNICA M√âDICA (Nefrologia/Urologia)
{theme:"Infec√ß√£o do trato urin√°rio",area:"clinica"},
{theme:"Doen√ßas glomerulares",area:"clinica"},
{theme:"IRA",area:"clinica"},
{theme:"HTA secund√°ria",area:"clinica"},

// TER√áA-SEXTA (√Åreas restantes e revis√£o)
// SEGUNDA - CL√çNICA M√âDICA (End√≥crino)
{theme:"N√≥dulo e C√¢ncer de Tireoide",area:"clinica"},

// SEGUNDA - CL√çNICA M√âDICA (Cardiologia)
{theme:"Valvulopatia",area:"clinica"},

// SEGUNDA - CL√çNICA M√âDICA (Emerg√™ncia)
{theme:"Sepse",area:"clinica"},
{theme:"PBLS e PALS",area:"clinica"},

// SEGUNDA - CL√çNICA M√âDICA (Psiquiatria)
{theme:"Psiquiatria geral",area:"clinica"},
{theme:"Transtornos do Humor",area:"clinica"},

// SEGUNDA - CL√çNICA M√âDICA (Geriatria)
{theme:"Geriatria",area:"clinica"},

// SEGUNDA - CL√çNICA M√âDICA (IST)
{theme:"IST - √∫lceras genitais",area:"clinica"}];

        // =================================================================================
        // L√ìGICA DE AUTENTICA√á√ÉO E DADOS (CORRIGIDA E ROBUSTA)
        // =================================================================================

        async function saveAllData() {
            if (!currentUser) return;
            const dataToSave = {
                id: currentUser.id,
                user_id: currentUser.id,
                completed_topics: appState.completedTopics,
                topic_difficulties: appState.topicDifficulties,
                last_review_dates: appState.lastReviewDates,
                custom_themes: appState.customThemes,
                performance_log: appState.performanceLog,
                user_profile: appState.userProfile,
                schedule_config: appState.scheduleConfig,
                dark_mode: appState.darkMode,
                minimalist_mode: appState.minimalistMode,
                show_in_ranking: appState.userProfile.show_in_ranking
            };
            try {
                const { error } = await supabase.from('user_data').upsert(dataToSave, { onConflict: 'id' }); 
                if (error) throw error;
            } catch (error) {
                console.error('Erro ao salvar dados no Supabase:', error);
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            try {
                const { data, error } = await supabase.from('user_data').select('*').eq('user_id', currentUser.id).single();
                if (error && error.code !== 'PGRST116') { throw error; }
                if (data) {
                    appState.completedTopics = data.completed_topics || {};
                    appState.topicDifficulties = data.topic_difficulties || {};
                    appState.lastReviewDates = data.last_review_dates || {};
                    appState.customThemes = data.custom_themes || [];
                    appState.performanceLog = data.performance_log || [];
                    appState.userProfile = { ...defaultState.userProfile, ...data.user_profile };
                    
                    // Carregar o campo show_in_ranking do banco de dados
                    if (data.show_in_ranking !== undefined) {
                        appState.userProfile.show_in_ranking = data.show_in_ranking;
                    }
                    
                    if (currentUser.user_metadata?.username && !appState.userProfile.username) {
                        appState.userProfile.username = currentUser.user_metadata.username;
                    }
                    appState.scheduleConfig = data.schedule_config || defaultState.scheduleConfig;
                    appState.darkMode = data.dark_mode || false;
                    appState.minimalistMode = data.minimalist_mode || false;
                } else {
                    appState.userProfile.username = currentUser.user_metadata?.username || 'Novo Usu√°rio';
                    await saveAllData();
                }
            } catch (error) {
                console.error('Erro ao carregar dados do Supabase:', error);
                alert('N√£o foi poss√≠vel carregar seus dados. Tente recarregar a p√°gina.');
            }
        }
        
        function showAuth() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
        }
        
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session?.user) {
                currentUser = session.user;
                await loadUserData();
                showApp();
                initializeApp();
            } else {
                showAuth();
            }
        }

        function toggleAuthMode(toSignUp) {
            isSignUp = toSignUp;
            const usernameGroup = document.getElementById('username-group');
            document.getElementById('login-toggle').classList.toggle('active', !isSignUp);
            document.getElementById('login-toggle').classList.toggle('inactive', isSignUp);
            document.getElementById('signup-toggle').classList.toggle('active', isSignUp);
            document.getElementById('signup-toggle').classList.toggle('inactive', !isSignUp);
            if(isSignUp) {
                usernameGroup.style.display = 'block';
                document.getElementById('auth-title').textContent = 'Crie sua Conta';
                document.getElementById('form-subtitle').textContent = 'Comece sua jornada para a aprova√ß√£o';
                document.getElementById('submit-text').textContent = 'Cadastrar';
                document.getElementById('submit-icon').className = 'fas fa-user-plus';
                document.getElementById('footer-text').textContent = 'J√° tem uma conta?';
                document.getElementById('switch-to-signup').textContent = 'Fa√ßa login';
                document.getElementById('switch-to-signup').onclick = () => toggleAuthMode(false);
            } else {
                usernameGroup.style.display = 'none';
                document.getElementById('auth-title').textContent = 'Bem-vindo de volta!';
                document.getElementById('form-subtitle').textContent = 'Continue seus estudos de onde parou';
                document.getElementById('submit-text').textContent = 'Entrar';
                document.getElementById('submit-icon').className = 'fas fa-sign-in-alt';
                document.getElementById('footer-text').textContent = 'N√£o tem uma conta?';
                document.getElementById('switch-to-signup').textContent = 'Cadastre-se';
                document.getElementById('switch-to-signup').onclick = () => toggleAuthMode(true);
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            if (!email || !password || (isSignUp && !username)) {
                alert('Preencha todos os campos obrigat√≥rios.');
                return;
            }
            try {
                let authResponse;
                if (isSignUp) {
                    authResponse = await supabase.auth.signUp({ 
                        email, 
                        password,
                        options: { data: { username: username } }
                    });
                    if(authResponse.error) throw authResponse.error;
                    alert('Cadastro realizado! Verifique seu e-mail para confirmar a conta e depois fa√ßa o login.');
                    toggleAuthMode(false);
                } else {
                    authResponse = await supabase.auth.signInWithPassword({ email, password });
                    if(authResponse.error) throw authResponse.error;
                    currentUser = authResponse.data.user;
                    await loadUserData();
                    showApp();
                    initializeApp();
                }
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function handleLogout() {
            stopPersistentStudyTimer();
            if (appState.rankingSubscription) {
                supabase.removeChannel(appState.rankingSubscription);
                appState.rankingSubscription = null;
            }
            // await saveAllData(); //
            await supabase.auth.signOut();
            currentUser = null;
            appState = JSON.parse(JSON.stringify(defaultState)); 
            window.location.reload(); 
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('login-toggle').onclick = () => toggleAuthMode(false);
            document.getElementById('signup-toggle').onclick = () => toggleAuthMode(true);
            document.getElementById('auth-button').addEventListener('click', handleAuth);
            document.getElementById('switch-to-signup').onclick = () => toggleAuthMode(true);
            document.getElementById('email').addEventListener('keypress', (e) => e.key === 'Enter' && handleAuth());
            document.getElementById('password').addEventListener('keypress', (e) => e.key === 'Enter' && handleAuth());
            document.getElementById('username').addEventListener('keypress', (e) => e.key === 'Enter' && handleAuth());
            checkAuth();
        });


        // =================================================================================
        // SCRIPT COMPLETO DO CRONOGRAMA
        // =================================================================================
        
        // =================================================================================
        // CONFIGURA√á√ÉO DAS APIS DE IA
        // =================================================================================
        
        // --- API GERAL (Chatbot, Resumos, Flashcards) ---
        const GEMINI_API_KEY = 'AIzaSyBtGkKLxXBnr2ro-qGR3J2-feq5W4HKKwk';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // --- API EXCLUSIVA PARA O BANCO DE QUEST√ïES (NOVA) ---
        const QUESTOES_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
        const QUESTOES_API_KEY = "AIzaSyA_aUiFy96DBlH7947IlPb2LPuy4pnGK0U";

        // =================================================================================
        // FIM DA CONFIGURA√á√ÉO DAS APIS
        // =================================================================================

        const motivationalQuotes = ["Cada p√°gina estudada √© um passo mais perto do seu sonho de m√©dico! üíâ", "Voc√™ √© mais forte do que qualquer desafio do Revalida! üöÄ", "Foco e determina√ß√£o: voc√™ vai conquistar o Enamed! ü©∫", "A jornada √© longa, mas sua dedica√ß√£o √© imbat√≠vel! üåü", "Estude com paix√£o, voc√™ est√° moldando o futuro da sa√∫de! ‚ù§Ô∏è"];

        const medicalChatbot = {
            isOpen: false,
            conversationHistory: [],
            async sendMessage(prompt) {
                try {
                    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{"parts": [{"text": prompt}]}],
                            generationConfig: { temperature: 0.5, maxOutputTokens: 2048 }
                        })
                    });
                    if (!response.ok) throw new Error(`Erro na API: ${response.status}`);
                    const data = await response.json();
                    return data?.candidates?.[0]?.content?.parts?.[0]?.text || "Desculpe, n√£o consegui processar sua pergunta. Tente novamente.";
                } catch (error) {
                    console.error('Erro na chamada da API Gemini (Geral):', error);
                    return `ERRO: ${error.message}`;
                }
            },
            async handleUserMessage(message) {
                if (!message.trim()) return;
                
                // Limpa o input e ajusta altura
                const input = document.getElementById('chat-input');
                input.value = '';
                this.adjustTextareaHeight();
                
                // Adiciona mensagem do usu√°rio com anima√ß√£o
                this.addMessage(message, true);
                
                // Mostra indicador de digita√ß√£o
                this.showTyping();
                
                // Desabilita bot√£o de envio
                const sendBtn = document.getElementById('chat-send');
                sendBtn.disabled = true;
                
                try {
                    const prompt = `Voc√™ √© Dr. Mentor Revalida, um residente R3 experiente e mentor para o Revalida/Enamed 2025.

PERFIL E COMPET√äNCIAS:
- Domina os 150 temas mais cobrados; distribui√ß√£o: Cl√≠nica M√©dica 30%, Pediatria 20%, GO 18%, Cirurgia 15%, Preventiva 17%.
- Especialista em quest√µes objetivas e casos cl√≠nicos, com condutas baseadas nos protocolos brasileiros (MS, SBP, FEBRASGO, SBC).
- Contextualiza sempre para o SUS e realidade brasileira.

METODOLOGIA DE RESPOSTA:
1. üß† CONCEITO-CHAVE ‚Äì 1 a 2 frases diretas.
2. ü©∫ DIAGN√ìSTICO/CONDUTA ‚Äì Algoritmo pr√°tico passo a passo.
3. üìå PONTO FREQUENTE NA PROVA ‚Äì O que a banca mais cobra.
4. üí° DICA DE MEMORIZA√á√ÉO ‚Äì Mnem√¥nico ou associa√ß√£o √∫til.

√ÅREAS-ALVO:
- CM: HAS, DM, SCA, AVC, pneumonia, DPOC, cefaleia.
- CR: Abdome agudo, trauma, perioperat√≥rio, h√©rnias.
- PED: Puericultura, pneumonia infantil, diarreia, crescimento.
- GO: Pr√©-natal, s√≠ndromes hipertensivas, hemorragias, parto.
- PRE: SUS, aten√ß√£o b√°sica, vigil√¢ncia, dengue, vacinas.

PADR√ïES DE LINGUAGEM:
- Direto e objetivo.
- Priorizar condutas pr√°ticas.
- Mencionar valores de refer√™ncia quando relevante.
- Basear-se sempre em protocolos brasileiros oficiais.

TIPOS DE INTERA√á√ÉO:
- D√∫vida conceitual: foco na prova.
- Caso cl√≠nico: conduta passo-a-passo.
- Revis√£o: resumos esquem√°ticos.
- Quest√µes: racioc√≠nio da correta e dos erros.

ALERTAS:
- Se a pergunta for vaga, responder: "Qual tema espec√≠fico ou cen√°rio cl√≠nico voc√™ quer revisar?"
- Adaptar respostas ao tema atual do cronograma.
- Nunca focar em curiosidades irrelevantes.
- Finalizar com: "Quer aprofundar algum ponto espec√≠fico deste tema?"

OBJETIVO FINAL:
Aprovar o candidato no Revalida/Enare 2025. Respostas devem ser cir√∫rgicas e estrat√©gicas. Pergunta: ${message}`;
                    const aiResponse = await this.sendMessage(prompt);
                    
                    // Esconde indicador de digita√ß√£o
                    this.hideTyping();
                    
                    // Adiciona resposta da IA com anima√ß√£o
                    this.addMessage(aiResponse, false);
                } catch (error) {
                    this.hideTyping();
                    this.addMessage("Desculpe, ocorreu um erro. Tente novamente.", false);
                } finally {
                    // Reabilita bot√£o de envio
                    sendBtn.disabled = false;
                }
            },
            addMessage(message, isUser = false) {
                const messageObj = { 
                    text: message, 
                    isUser, 
                    timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) 
                };
                this.conversationHistory.push(messageObj);
                this.renderMessage(messageObj);
                
                // Remove t√≥picos r√°pidos ap√≥s primeira mensagem do usu√°rio
                if (isUser && this.conversationHistory.filter(m => m.isUser).length === 1) {
                    const quickTopics = document.getElementById('chat-messages').querySelector('.quick-topics');
                    if (quickTopics) {
                        quickTopics.style.opacity = '0';
                        quickTopics.style.transform = 'translateY(-10px)';
                        setTimeout(() => quickTopics.remove(), 300);
                    }
                }
            },
            renderMessage(messageObj) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${messageObj.isUser ? 'user' : 'bot'}`;
                messageDiv.innerHTML = `
                    <div class="message-bubble">${messageObj.text.replace(/\n/g, '<br>')}</div>
                    <div class="message-time">${messageObj.timestamp}</div>
                `;
                
                // Adiciona com anima√ß√£o
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(20px)';
                messagesContainer.appendChild(messageDiv);
                
                // For√ßa reflow e anima
                messageDiv.offsetHeight;
                messageDiv.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
                
                // Rolagem suave para a √∫ltima mensagem
                this.scrollToBottom();
            },
            scrollToBottom() {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            },
            showTyping() { 
                const indicator = document.getElementById('typing-indicator');
                indicator.classList.add('active');
                this.scrollToBottom();
            },
            hideTyping() { 
                const indicator = document.getElementById('typing-indicator');
                indicator.classList.remove('active');
            },
            adjustTextareaHeight() { 
                const textarea = document.getElementById('chat-input'); 
                textarea.style.height = 'auto'; 
                textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px'; 
            },
            toggle() { 
                this.isOpen = !this.isOpen; 
                const container = document.getElementById('chatbot-container');
                const toggle = document.getElementById('chatbot-toggle');
                
                container.classList.toggle('active', this.isOpen); 
                toggle.classList.toggle('active', this.isOpen); 
                
                if (this.isOpen) { 
                    // Foca no input ap√≥s a anima√ß√£o
                    setTimeout(() => {
                        document.getElementById('chat-input').focus(); 
                    }, 300);
                    this.loadHistory(); 
                } 
            },
            loadHistory() {
                const container = document.getElementById('chat-messages');
                const firstMsg = container.querySelector('.message.bot');
                const quickTopics = container.querySelector('.quick-topics');
                
                container.innerHTML = '';
                
                // Recarrega mensagem inicial e t√≥picos r√°pidos
                if(firstMsg) container.appendChild(firstMsg);
                if(quickTopics && this.conversationHistory.filter(m => m.isUser).length === 0) {
                    container.appendChild(quickTopics);
                }
                
                // Recarrega hist√≥rico
                this.conversationHistory.forEach(msg => this.renderMessage(msg));
                
                // Rola para o final
                setTimeout(() => this.scrollToBottom(), 100);
            },
            init() {
                const toggle = document.getElementById('chatbot-toggle');
                const close = document.getElementById('chatbot-close');
                const sendBtn = document.getElementById('chat-send');
                const input = document.getElementById('chat-input');
                
                // Event listeners
                toggle.addEventListener('click', () => this.toggle());
                close.addEventListener('click', () => this.toggle());
                sendBtn.addEventListener('click', () => this.handleUserMessage(input.value.trim()));
                
                // Enter para enviar (Shift+Enter para nova linha)
                input.addEventListener('keydown', (e) => { 
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        this.handleUserMessage(input.value.trim()); 
                    } 
                });
                
                // Auto-resize do textarea
                input.addEventListener('input', () => this.adjustTextareaHeight());
                
                // T√≥picos r√°pidos
                document.querySelectorAll('.quick-topic').forEach(topic => {
                    topic.addEventListener('click', () => {
                        this.handleUserMessage(topic.dataset.topic);
                    });
                });
                
                // Placeholder din√¢mico
                this.updatePlaceholder();
            },
            updatePlaceholder() {
                const input = document.getElementById('chat-input');
                const placeholders = [
                    "Digite sua pergunta para o assistente...",
                    "Pergunte sobre qualquer tema m√©dico...",
                    "Como posso te ajudar nos estudos?",
                    "Qual sua d√∫vida sobre medicina?"
                ];
                
                let currentIndex = 0;
                setInterval(() => {
                    if (!this.isOpen || input === document.activeElement) return;
                    input.placeholder = placeholders[currentIndex];
                    currentIndex = (currentIndex + 1) % placeholders.length;
                }, 3000);
            }
        };

        const studentLevels = [
            { title: "Estudante Iniciante", avatar: "üë∂", xpRequired: 0 }, { title: "Interno Virtual", avatar: "üë®‚Äç‚öïÔ∏è", xpRequired: 100 },
            { title: "R1 Cl√≠nico", avatar: "üë©‚Äç‚öïÔ∏è", xpRequired: 200 }, { title: "R2 Cir√∫rgico", avatar: "üßë‚Äç‚öïÔ∏è", xpRequired: 350 },
            { title: "R3 Especialista", avatar: "üë®‚Äçüî¨", xpRequired: 550 }, { title: "Especialista J√∫nior", avatar: "üë©‚Äçüî¨", xpRequired: 800 },
            { title: "Especialista Pleno", avatar: "üë®‚Äçüéì", xpRequired: 1100 }, { title: "Mestre em Medicina", avatar: "üë©‚Äçüéì", xpRequired: 1500 },
            { title: "Professor Doutor", avatar: "üë®‚Äçüè´", xpRequired: 2000 }, { title: "Chefe de Servi√ßo", avatar: "üë©‚Äçüè´", xpRequired: 2600 },
            { title: "Lenda M√©dica", avatar: "ü¶∏", xpRequired: 3300 }
        ];
        const XP_VALUES = { completeTopic: 15, dailyStreak: 5, pomodoroComplete: 3, performanceEntry: 10, achievementUnlocked: 50 };

        const achievements = {
            clinicoRaiz: { title: "Cl√≠nico Raiz", description: "Finalizou todos os temas de Cl√≠nica M√©dica.", icon: "fas fa-stethoscope", category: "area", check: (s) => checkAreaCompletion(s, 'clinica') },
            goWarrior: { title: "GO Warrior", description: "Finalizou Ginecologia e Obstetr√≠cia.", icon: "fas fa-baby-carriage", category: "area", check: (s) => checkAreaCompletion(s, 'ginecologia') && checkAreaCompletion(s, 'obstetricia') },
            miniCirurgiao: { title: "Mini-Cirurgi√£o", description: "Completou os temas de Cirurgia Geral.", icon: "fas fa-scalpel", category: "area", check: (s) => checkAreaCompletion(s, 'cirurgia') },
            pediatraMirim: { title: "Pediatra Mirim", description: "Concluiu todos os temas de Pediatria.", icon: "fas fa-child", category: "area", check: (s) => checkAreaCompletion(s, 'pediatria') },
            mestrePreventiva: { title: "Mestre da Preventiva", description: "Terminou os temas de Sa√∫de Coletiva.", icon: "fas fa-users", category: "area", check: (s) => checkAreaCompletion(s, 'preventiva') },
            psiquiatraHonorario: { title: "Psiquiatra Honor√°rio", description: "Finalizou os temas de Psiquiatria.", icon: "fas fa-brain", category: "area", check: (s) => checkAreaCompletion(s, 'psiquiatria') },
            leaoSimulado: { title: "Le√£o de Simulado", description: "Fez 5 registros de simulado/quest√µes.", icon: "fas fa-award", category: "produtividade", check: (s) => s.performanceLog.length >= 5 },
            focoTotal: { title: "Foco Total", description: "Usou o Pomodoro por 10 ciclos completos.", icon: "fas fa-clock", category: "produtividade", check: (s) => s.userProfile.completedPomodoros >= 10 },
            modoTurbo: { title: "Modo Turbo", description: "Estudou todos os dias √∫teis da semana.", icon: "fas fa-bolt", category: "produtividade", check: () => checkWeekdayStreak() },
            chatbotExplorer: { title: "Explorador IA", description: "Fez 10 perguntas para a IA m√©dica.", icon: "fas fa-robot", category: "produtividade", check: () => medicalChatbot.conversationHistory.filter(m => m.isUser).length >= 10 },
            streak1: { title: "Primeiro Passo", description: "1¬∫ dia consecutivo de estudo.", icon: "fas fa-shoe-prints", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 1 },
            streak5: { title: "5 Dias no Ritmo", description: "Cinco dias seguidos estudando.", icon: "fas fa-fire", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 5 },
            streak14: { title: "Study Beast", description: "14 dias seguidos sem falhar.", icon: "fas fa-meteor", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 14 },
            streak30: { title: "Insano do Revalida", description: "30 dias de estudo consecutivos.", icon: "fas fa-crown", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 30 },
            semanaPerfeita: { title: "Semana Perfeita", description: "Cumpriu 100% da meta da semana atual.", icon: "fas fa-check-double", category: "metas", check: () => checkCurrentWeekCompletion() },
            comecouNaSegunda: { title: "Come√ßou na Segunda", description: "Iniciou a jornada numa segunda-feira.", icon: "fas fa-calendar-day", category: "secretas", check: (s) => new Date(s.scheduleConfig.startDate + "T12:00:00Z").getUTCDay() === 1 },
            vaiComTudo: { title: "Vai com Tudo!", description: "Estudou e fez simulado no mesmo dia.", icon: "fas fa-bomb", category: "secretas", check: (s) => checkStudyAndSimuladoToday(s) }
        };

        function prepareAllTopics() { appState.allTopicsFlat = [...originalScheduleData, ...appState.customThemes]; }
        function regenerateAndRenderSchedule() { prepareAllTopics(); const studyDays = getStudyDays(appState.scheduleConfig.startDate, appState.scheduleConfig.examDate); const distributionResult = distributeTopics(appState.allTopicsFlat, studyDays, appState.scheduleConfig.maxTopicsPerDay); const newSchedule = buildNewSchedule(distributionResult.distributedDays); generateDynamicWeeks(newSchedule); updateAllStatsAndCharts(); }
        function getStudyDays(startDateStr, endDateStr) { const studyDays = []; let currentDate = new Date(`${startDateStr}T12:00:00Z`); const endDate = new Date(`${endDateStr}T12:00:00Z`); while (currentDate <= endDate) { if (currentDate.getUTCDay() !== 0) { studyDays.push(new Date(currentDate)); } currentDate.setUTCDate(currentDate.getUTCDate() + 1); } return studyDays; }
        function distributeTopics(topics, studyDays, maxTopicsPerDay) { let topicIndex = 0; const distributedDays = []; for (let dayIndex = 0; dayIndex < studyDays.length; dayIndex++) { const weekIndex = Math.floor(dayIndex / 6); const topicsForThisDay = Math.min(weekIndex + 1, maxTopicsPerDay); const assignedTopics = []; if (topicIndex < topics.length) { for (let i = 0; i < topicsForThisDay && topicIndex < topics.length; i++) { assignedTopics.push(topics[topicIndex]); topicIndex++; } } distributedDays.push({ date: studyDays[dayIndex], topics: assignedTopics }); } const finalDays = distributedDays.filter(d => d.topics.length > 0); return { distributedDays: finalDays }; }
        function buildNewSchedule(distributedDays) { if (!distributedDays || distributedDays.length === 0) return []; const newSchedule = []; let weekChunk = []; distributedDays.sort((a, b) => a.date - b.date); for (const day of distributedDays) { if (weekChunk.length > 0 && day.date.getUTCDay() === 1) { newSchedule.push(weekChunk); weekChunk = []; } weekChunk.push(day); } if (weekChunk.length > 0) newSchedule.push(weekChunk); return newSchedule.map((weekDays, index) => { const dayMap = new Map(weekDays.map(d => [d.date.getUTCDay(), d])); let firstDayOfWeek = new Date(weekDays[0].date); let dayOfWeek = firstDayOfWeek.getUTCDay(); if (dayOfWeek === 0) dayOfWeek = 7; firstDayOfWeek.setUTCDate(firstDayOfWeek.getUTCDate() - (dayOfWeek - 1)); const fullWeekDays = []; for (let i = 1; i <= 7; i++) { const currentDay = new Date(firstDayOfWeek); currentDay.setUTCDate(firstDayOfWeek.getUTCDate() + i - 1); const dayData = dayMap.get(currentDay.getUTCDay()); if (currentDay.getUTCDay() === 0) { fullWeekDays.push({ date: currentDay, themes: [{ theme: 'DESCANSO', area: 'rest' }], isRest: true }); } else { fullWeekDays.push({ date: currentDay, themes: dayData ? dayData.topics : [], isRest: false }); } } const weekStartDate = fullWeekDays[0].date; const weekEndDate = fullWeekDays[5].date; return { week: index + 1, title: `Semana ${index + 1}: ${formatDate(weekStartDate)} - ${formatDate(weekEndDate)}`, days: fullWeekDays }; }); }

        function addXp(points, source = 'generic') {
            const oldLevel = getUserLevel();
            appState.userProfile.xp += points;
            const newLevel = getUserLevel();
            if (newLevel > oldLevel) {
                appState.userProfile.level = newLevel;
                showLevelUpNotification(newLevel);
                addXp(newLevel * 10, 'level-up');
            }
            updateHeaderUI();
        }
        function getUserLevel() { for (let i = studentLevels.length - 1; i >= 0; i--) { if (appState.userProfile.xp >= studentLevels[i].xpRequired) return i; } return 0; }
        function showLevelUpNotification(newLevel) { const levelData = studentLevels[newLevel]; const notification = document.createElement('div'); notification.className = 'level-up-notification'; notification.innerHTML = `<div class="level-up-content"><div class="level-avatar">${levelData.avatar}</div><h3>üéâ Level Up!</h3><h4>${levelData.title}</h4><p>${appState.userProfile.username}, voc√™ alcan√ßou um novo patamar!</p><small>Pr√≥ximo n√≠vel em ${studentLevels[newLevel+1]?.xpRequired - appState.userProfile.xp || '---'} XP</small></div>`; document.body.appendChild(notification); setTimeout(() => { notification.classList.add('show'); setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 500); }, 3000); }, 100); }
        function updateHeaderUI() {
            const currentLevel = getUserLevel();
            const levelData = studentLevels[currentLevel];
            const nextLevel = currentLevel < studentLevels.length - 1 ? studentLevels[currentLevel + 1] : null;
            const progressPercentage = nextLevel ? Math.round(((appState.userProfile.xp - levelData.xpRequired) / (nextLevel.xpRequired - levelData.xpRequired)) * 100) : 100;
            const userLevelHTML = `<div class="level-container"><div class="level-avatar">${levelData.avatar}</div><div><div>${levelData.title} <span class="level-badge">N√≠vel ${currentLevel}</span></div><div class="level-info">${appState.userProfile.username || 'Usu√°rio'}</div></div></div>`;
            document.getElementById('user-level').innerHTML = userLevelHTML;
            document.getElementById('xp-bar-fill').style.width = `${progressPercentage}%`;
            document.getElementById('xp-bar-fill').parentElement.title = `${appState.userProfile.xp} XP (${progressPercentage}% para o pr√≥ximo n√≠vel)`;
            document.getElementById('streak-count').textContent = appState.userProfile.studyStreak;
        }
        function unlockAchievement(key) { if (!appState.userProfile.unlockedAchievements[key]) { addXp(XP_VALUES.achievementUnlocked, 'achievement'); appState.userProfile.unlockedAchievements[key] = new Date().toISOString(); showAchievementNotification(achievements[key]); if (appState.currentSection === 'achievements') renderAchievementsPage(); } }
        function checkAllAchievements(eventData = null) { for (const key in achievements) { if (!appState.userProfile.unlockedAchievements[key]) { if (achievements[key].check(appState, eventData)) unlockAchievement(key); } } saveAllData(); }
        function renderAchievementsPage() { const container = document.getElementById('achievements-grid'); if (!container) return; const categories = { area: [], produtividade: [], consistencia: [], metas: [], revisao: [], secretas: [] }; for (const key in achievements) categories[achievements[key].category].push({ key, ...achievements[key] }); container.innerHTML = Object.keys(categories).map(catKey => { if (categories[catKey].length === 0) return ''; const categoryName = catKey.charAt(0).toUpperCase() + catKey.slice(1); const itemsHtml = categories[catKey].map(item => { const unlocked = appState.userProfile.unlockedAchievements[item.key]; const unlockedDate = unlocked ? `Desbloqueado em: ${new Date(unlocked).toLocaleDateString('pt-BR')}` : ''; return `<div class="achievement-item ${unlocked ? 'unlocked' : ''}" title="${item.description}"><i class="achievement-icon ${item.icon}"></i><div class="achievement-details"><h4>${item.title}</h4><p>${item.description}</p><p class="unlock-date">${unlockedDate}</p></div></div>`; }).join(''); return `<div class="achievement-category"><h3>${categoryName}</h3>${itemsHtml}</div>`; }).join(''); }
        function checkAreaCompletion(state, area) { const topicsOfArea = state.allTopicsFlat.filter(t => t.area === area); if (topicsOfArea.length === 0) return false; return topicsOfArea.every(t => state.completedTopics[t.theme]); }
        function checkWeekdayStreak() { const today = new Date(); if (today.getDay() === 0 || today.getDay() === 6) return false; const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay() + 1); let studiedDays = new Set(); Object.values(appState.lastReviewDates).forEach(d => { const studyDate = new Date(d); if (studyDate >= weekStart && studyDate <= today) studiedDays.add(studyDate.getDay()); }); return studiedDays.size >= today.getDay(); }
        function checkCurrentWeekCompletion() { const today = new Date(); const weekNum = Math.floor((today - new Date(appState.scheduleConfig.startDate)) / (1000 * 60 * 60 * 24 * 7)) + 1; const schedule = buildNewSchedule(distributeTopics(appState.allTopicsFlat, getStudyDays(appState.scheduleConfig.startDate, appState.scheduleConfig.examDate), appState.scheduleConfig.maxTopicsPerDay).distributedDays); const weekData = schedule.find(w => w.week === weekNum); if (!weekData) return false; return weekData.days.every(d => { if (d.isRest) return true; return d.themes.every(t => appState.completedTopics[t.theme]); }); }
        function checkStudyAndSimuladoToday(state) { const todayStr = new Date().toISOString().split('T')[0]; const studiedToday = Object.values(state.lastReviewDates).some(d => d.startsWith(todayStr)); const simuladoToday = state.performanceLog.some(p => p.date === todayStr); return studiedToday && simuladoToday; }
        
        function toggleSidebar() { appState.sidebarOpen = !appState.sidebarOpen; appState.sidebarCollapsed = false; document.getElementById('sidebar').classList.toggle('open'); document.getElementById('main-content').classList.toggle('sidebar-open'); document.getElementById('header').classList.toggle('sidebar-open'); }
        function toggleTheme() { appState.darkMode = !appState.darkMode; document.documentElement.setAttribute('data-theme', appState.darkMode ? 'dark' : ''); saveAllData(); document.querySelector('#theme-toggle i').className = appState.darkMode ? 'fas fa-sun' : 'fas fa-moon'; updateAllStatsAndCharts(); }
        function toggleMinimalistMode() { appState.minimalistMode = !appState.minimalistMode; document.body.classList.toggle('minimalist-mode', appState.minimalistMode); saveAllData(); document.querySelector('#minimalist-toggle i').className = appState.minimalistMode ? 'fas fa-expand' : 'fas fa-compress'; }
        function showModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function hideModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
        
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            const section = document.getElementById(`${sectionId}-section`);
            if (section) {
                section.classList.add('active');
                appState.currentSection = sectionId;
                if (sectionId === 'stats') updateAllStatsAndCharts();
                else if (sectionId === 'achievements') renderAchievementsPage();
                else if (sectionId === 'ranking') renderRankingPage();
                else if (sectionId === 'performance') initializePerformanceSection();
                else if (sectionId === 'analysis') renderAnalysisPage();
                else if (sectionId === 'progress') updateProgressLists();
                else if (sectionId === 'review') updateFutureReviews();
            }
            window.scrollTo(0, 0);
        }

        function updateAllStatsAndCharts() { updateStats(); updateStatusIcons(); if (appState.currentSection === 'stats' || document.getElementById('stats-section').classList.contains('active')) { createCompletionChart(); createPerformanceByAreaChart(); } }
        function showAchievementNotification(achievement) { const n = document.getElementById('achievement-notification'); n.querySelector('#achievement-icon').className = achievement.icon; n.querySelector('#achievement-title').textContent = achievement.title; n.querySelector('#achievement-desc').textContent = achievement.description; n.classList.add('show'); setTimeout(() => n.classList.remove('show'), 4000); }
        function updateStudyStreak() { const today = new Date().toDateString(); const lastStudyDate = appState.userProfile.lastStudyDate; if (lastStudyDate !== today) { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); if (lastStudyDate === yesterday.toDateString()) { appState.userProfile.studyStreak++; } else { appState.userProfile.studyStreak = 1; } appState.userProfile.lastStudyDate = today; addXp(XP_VALUES.dailyStreak, 'streak'); } }

        
        // --- Sauda√ß√£o personalizada e frase motivacional (integrada ao fluxo de auth) ---
        function showGreetingAndQuote(user) {
            const greetingMessage = document.getElementById('greeting-message');
            const motivationalQuote = document.getElementById('motivational-quote');
            if (!greetingMessage || !motivationalQuote) return;

            const username = user?.user_metadata?.username || 'Estudante';

            const hour = new Date().getHours();
            let greeting;
            if (hour < 12) {
                greeting = `Bom dia, ${username}! Que bom te ver aqui.`;
            } else if (hour < 18) {
                greeting = `Boa tarde, ${username}! Que bom te ver aqui.`;
            } else {
                greeting = `Boa noite, ${username}! Que bom te ver aqui.`;
            }

            const quotes = [
                'A const√¢ncia supera a intensidade.',
'Cada p√°gina estudada √© um passo a mais para sua aprova√ß√£o.',
'Acredite no processo, n√£o apenas no resultado.',
'Estudar hoje √© colher amanh√£.',
'Seu futuro depende do que voc√™ faz agora.',
'O imposs√≠vel √© apenas o poss√≠vel que ainda n√£o foi tentado.',
'Voc√™ √© mais forte do que pensa.',
'Persist√™ncia transforma sonhos em realidade.',
'Pequenos avan√ßos di√°rios criam grandes vit√≥rias.',
'A disciplina de hoje √© a liberdade de amanh√£.',
'Cada erro √© uma oportunidade de aprender.',
'O conhecimento √© o √∫nico investimento que nunca perde valor.',
'Sua dedica√ß√£o hoje ser√° sua celebra√ß√£o amanh√£.',
'A medicina √© voca√ß√£o, a revalida √© apenas um passo.',
'Transforme press√£o em combust√≠vel para seus sonhos.',
'O cansa√ßo de hoje √© a conquista de amanh√£.',
'Voc√™ n√£o est√° apenas estudando, est√° construindo seu futuro.',
'A pr√°tica constante leva √† perfei√ß√£o.',
'Cada simulado √© uma prepara√ß√£o para a vit√≥ria.',
'Acredite em si mesmo, voc√™ chegou at√© aqui por m√©rito.',
'O tempo investido em estudos nunca √© tempo perdido.',
'Sua determina√ß√£o √© maior que qualquer obst√°culo.',
'A jornada √© dif√≠cil, mas a recompensa vale a pena.',
'Conhecimento √© poder, aplica√ß√£o √© sucesso.',
'Voc√™ est√° mais perto do que imagina.',
'A excel√™ncia n√£o √© um ato, mas um h√°bito.',
'Cada dia de estudo te aproxima do jaleco branco.',
'Foco no objetivo, n√£o nos obst√°culos.',
'Sua resili√™ncia √© sua maior for√ßa.',
'A diferen√ßa entre o poss√≠vel e imposs√≠vel est√° na sua vontade.',
'Estudar √© plantar hoje para colher para sempre.',
'Voc√™ n√£o est√° competindo com outros, est√° superando a si mesmo.',
'A prepara√ß√£o elimina a sorte da equa√ß√£o.',
'Seu esfor√ßo silencioso gerar√° aplausos estrondosos.',
'A medicina brasileira precisa do seu conhecimento.',
'Transforme ansiedade em energia para estudar.',
'Cada conceito dominado √© uma vit√≥ria conquistada.',
'Voc√™ √© capaz de mais do que imagina.',
'A revalida n√£o mede sua intelig√™ncia, mas sua prepara√ß√£o.',
'Confie no processo, os resultados vir√£o.',
'Sua hist√≥ria de supera√ß√£o come√ßa agora.',
'O sucesso √© a soma de pequenos esfor√ßos repetidos diariamente.',
'Voc√™ j√° provou ser capaz, agora √© s√≥ confirmar.',
'A paci√™ncia e a persist√™ncia s√£o suas melhores aliadas.',
'Cada revis√£o te deixa mais forte e preparado.',
'Seu diploma est√° esperando por voc√™ do outro lado do esfor√ßo.',
'A medicina √© arte e ci√™ncia, voc√™ domina ambas.',
'Acredite: voc√™ n√£o chegou at√© aqui para desistir agora.',
'Sua aprova√ß√£o n√£o √© quest√£o de se, mas de quando.',
'O conhecimento que voc√™ constr√≥i hoje salvar√° vidas amanh√£.'
            ];

            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];

            greetingMessage.innerHTML = `<span class="wave">üëã</span> ${greeting}`;
            motivationalQuote.textContent = randomQuote;
            motivationalQuote.style.opacity = "0";
            setTimeout(() => {
                motivationalQuote.style.opacity = "1";
            }, 50);
        }

        function initializeApp() {
            if (appState.darkMode) { document.documentElement.setAttribute('data-theme', 'dark'); document.querySelector('#theme-toggle i').className = 'fas fa-sun'; }
            if(appState.minimalistMode) { document.body.classList.add('minimalist-mode'); document.querySelector('#minimalist-toggle i').className = 'fas fa-expand'; }
            
            document.getElementById('start-date').value = appState.scheduleConfig.startDate;
            document.getElementById('exam-date').value = appState.scheduleConfig.examDate;
            document.getElementById('max-topics-day').value = appState.scheduleConfig.maxTopicsPerDay;
            
            initializeEventListeners();
            setupRankingSubscription(); // INICIA A ESCUTA DO RANKING EM TEMPO REAL

            prepareAllTopics();
            regenerateAndRenderSchedule();
            resetPomodoro();
            startPersistentStudyTimer();
            medicalChatbot.init();
            updateHeaderUI();
            checkAllAchievements({ type: 'load' });
            renderAchievementsPage();
            showSection('stats');
            if (currentUser) { showGreetingAndQuote(currentUser); }
        }

        function initializeEventListeners() {
            document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('minimalist-toggle').addEventListener('click', toggleMinimalistMode);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('pomodoro-start').addEventListener('click', startPomodoro);
            document.getElementById('pomodoro-pause').addEventListener('click', pausePomodoro);
            document.getElementById('pomodoro-reset').addEventListener('click', resetPomodoro);
            document.getElementById('toggle-ranking-participation').addEventListener('click', toggleRankingParticipation);
            document.querySelectorAll('.sidebar-menu a[data-section]').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showSection(link.dataset.section); }); });
            document.getElementById('reset-progress').addEventListener('click', () => showModal('confirmation-modal'));
            document.getElementById('confirm-reset').addEventListener('click', async () => { if (currentUser) { await supabase.from('user_data').delete().eq('id', currentUser.id); } handleLogout(); });
            document.getElementById('cancel-reset').addEventListener('click', () => hideModal('confirmation-modal'));
            document.getElementById('apply-config').addEventListener('click', applyConfigurations);
            document.getElementById('add-custom-theme-btn').addEventListener('click', addCustomTheme);
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const difficulty = this.dataset.difficulty;
                    if (appState.currentDifficultyTopic) {
                        appState.topicDifficulties[appState.currentDifficultyTopic] = difficulty;
                        checkAllAchievements({ type: 'difficulty', topic: appState.currentDifficultyTopic });
                        updateAllStatsAndCharts();
                        saveAllData();
                    }
                    hideModal('difficulty-modal');
                });
            });
        }
        
        function startPersistentStudyTimer() {
    const display = document.getElementById('study-time-display');
    function formatTime(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        // A linha dos segundos foi removida daqui.
        return `‚è±Ô∏èTempo Estudado ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }
            if(display) display.textContent = formatTime(appState.userProfile.totalStudyTimeSeconds);
            if(appState.studyTimerInterval) clearInterval(appState.studyTimerInterval);
            appState.studyTimerInterval = setInterval(() => {
                appState.userProfile.totalStudyTimeSeconds++;
                if(display) display.textContent = formatTime(appState.userProfile.totalStudyTimeSeconds);
                if (appState.userProfile.totalStudyTimeSeconds % 60 === 0) { saveAllData(); }
            }, 1000);
        }
        
        function stopPersistentStudyTimer() {
             if(appState.studyTimerInterval) clearInterval(appState.studyTimerInterval);
        }

        function getAreaName(area) { const names = { preventiva: "Preventiva", pediatria: "Pediatria", ginecologia: "Ginecologia", obstetricia: "Obstetr√≠cia", clinica: "Cl√≠nica", cirurgia: "Cirurgia", psiquiatria: "Psiquiatria", revisao: "Revis√£o", rest: "Off" }; return names[area] || "Geral"; }
        function getAreaIcon(area) { const icons = { preventiva: "fas fa-users", pediatria: "fas fa-baby", ginecologia: "fas fa-venus", obstetricia: "fas fa-baby-carriage", clinica: "fas fa-stethoscope", cirurgia: "fas fa-scalpel", psiquiatria: "fas fa-brain", revisao: "fas fa-star", rest: "fas fa-couch" }; return icons[area] || "fas fa-book-medical"; }
        function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return ""; const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); }
        
        function addTopicEventListeners() {
            document.querySelectorAll('.topic-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const topic = this.dataset.topic;
                    const isChecked = this.checked;
                    document.querySelectorAll(`input.topic-checkbox[data-topic="${topic}"]`).forEach(box => { box.checked = isChecked; box.closest('.topic-row').querySelector('.topic-text').classList.toggle('completed', isChecked); });
                    if (isChecked) {
                        appState.completedTopics[topic] = true;
                        appState.lastReviewDates[topic] = new Date().toISOString();
                        showModal('difficulty-modal');
                        appState.currentDifficultyTopic = topic;
                        addXp(XP_VALUES.completeTopic, 'topic-complete');
                        updateStudyStreak();
                    } else {
                        delete appState.completedTopics[topic];
                        delete appState.lastReviewDates[topic];
                        delete appState.topicDifficulties[topic];
                    }
                    checkAllAchievements({ type: 'completion', topic: topic });
                    updateAllStatsAndCharts();
                    saveAllData();
                });
            });
        }
        
        function generateDynamicWeeks(schedule) {
            const weeksContainer = document.getElementById('weeks');
            weeksContainer.innerHTML = '';
            if (!schedule || schedule.length === 0) { weeksContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum cronograma para exibir.</p>'; return; }
            const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            schedule.forEach(week => {
                const weekElement = document.createElement('div');
                weekElement.className = 'week-section fade-in';
                const maxThemesInWeek = Math.max(0, ...week.days.map(d => d.isRest ? 0 : (d.themes ? d.themes.length : 0)));
                let tableHeaderHTML = `<thead><tr><th>Dia</th>${maxThemesInWeek > 0 ? Array.from({length: maxThemesInWeek}, (_, i) => `<th>Tema ${i + 1}</th>`).join('') : `<th>Atividade</th>`}</tr></thead>`;
                let tableBodyHTML = '<tbody>';
                week.days.forEach(day => {
                    if (day.isRest) { tableBodyHTML += `<tr class="rest-day"><td colspan="${1 + Math.max(1, maxThemesInWeek)}">${day.themes[0].theme}</td></tr>`; }
                    else {
                        tableBodyHTML += `<tr><td><b>${dayNames[day.date.getUTCDay()]}</b><br>${formatDate(day.date)}</td>`;
                        if (maxThemesInWeek > 0) {
                            if (day.themes.length === 0) { tableBodyHTML += `<td colspan="${maxThemesInWeek}"><i>Dia livre</i></td>`; }
                            else { for (let i = 0; i < maxThemesInWeek; i++) {
                                const topic = day.themes ? day.themes[i] : null;
                                if (topic) {
                                    const topicId = (topic.theme + i).replace(/[^a-zA-Z0-9]/g, "");
                                    tableBodyHTML += `<td><div class="topic-row" data-topic-area="${topic.area}"><input type="checkbox" class="topic-checkbox" id="chk-${topicId}" ${appState.completedTopics[topic.theme] ? "checked" : ""} data-topic="${topic.theme}"><label for="chk-${topicId}" class="topic-text-label"><span class="topic-text ${appState.completedTopics[topic.theme] ? "completed" : ""}">${topic.theme}</span><div class="area-badge area-${topic.area}">${getAreaName(topic.area)}</div></label><button class="btn-ia" onclick="gerarResumoIA('${topic.theme}')">ü§ñ Resumo IA</button></div></td>`;
                                } else { tableBodyHTML += '<td>-</td>'; }
                            }}
                        } else { tableBodyHTML += `<td><i>Dia livre</i></td>`; }
                        tableBodyHTML += '</tr>';
                    }
                });
                tableBodyHTML += '</tbody>';
                weekElement.innerHTML = `<div class="week-header"><span>${week.title}</span><i class="fas fa-chevron-down"></i></div><div class="week-content"><table class="week-table">${tableHeaderHTML}${tableBodyHTML}</table></div>`;
                weeksContainer.appendChild(weekElement);
                weekElement.querySelector('.week-header').addEventListener('click', function () { this.nextElementSibling.classList.toggle('collapsed'); this.querySelector('i').className = this.nextElementSibling.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-down'; });
            });
            addTopicEventListeners();
            updateStatusIcons();
        }
        
        async function gerarResumoIA(tema) {
          const modal = document.getElementById('ia-flashcard-modal');
          const titleElement = document.getElementById('ia-flashcard-title');
          const contentElement = document.getElementById('ia-resumo');
          titleElement.textContent = tema;
          iniciarCarregamentoResumo(contentElement);
          showModal('ia-flashcard-modal');
          const prompt = `Crie um resumo estrat√©gico de ${tema} para leitura pr√©-estudo no Revalida 2025. 

## ESTRUTURA OBRIGAT√ìRIA (m√°ximo 6 linhas):

**DEFINI√á√ÉO:** O que √© em 1 frase objetiva

**EPIDEMIOLOGIA/CAUSA:** Principais fatores (idade, sexo, causas mais comuns)

**QUADRO CL√çNICO:** 3-4 sintomas/sinais mais importantes

**DIAGN√ìSTICO:** Exame padr√£o-ouro ou crit√©rios diagn√≥sticos

**TRATAMENTO:** Primeira linha de tratamento/conduta inicial

**ALERTA PROVA:** O que a banca MAIS cobra sobre este tema

## DIRETRIZES:
- Use terminologia m√©dica precisa
- Cite valores de refer√™ncia quando relevante
- Foque em CONDUTAS pr√°ticas, n√£o fisiopatologia
- Mencione protocolos brasileiros (MS/SBP/FEBRASGO quando aplic√°vel)
- Priorize informa√ß√µes de ALTA FREQU√äNCIA na prova
- Seja CONCISO - cada palavra deve agregar valor

## CONTEXTO:
Este resumo ser√° lido em 30-60 segundos antes do estudo aprofundado do tema. O objetivo √© ativar conhecimentos pr√©vios e criar um "mapa mental" para o estudo posterior.

Termine sempre com: "**FOCO REVALIDA:** [aspecto mais cobrado na prova]"`;
          const resposta = await medicalChatbot.sendMessage(prompt);
          completarProgresso(contentElement);
          pararCarregamentoIA(contentElement, () => {
            contentElement.innerHTML = `<div style="white-space: pre-wrap;">${resposta}</div>`;
          });
        }

        function startPomodoro() { if (!appState.pomodoroRunning) { appState.pomodoroRunning = true; appState.pomodoroInterval = setInterval(updatePomodoro, 1000); document.getElementById('pomodoro-start').disabled = true; document.getElementById('pomodoro-pause').disabled = false; } }
        function pausePomodoro() { if (appState.pomodoroRunning) { clearInterval(appState.pomodoroInterval); appState.pomodoroRunning = false; document.getElementById('pomodoro-start').disabled = false; document.getElementById('pomodoro-pause').disabled = true; } }
        function resetPomodoro() { const isFocus = appState.currentPomodoroType === 'focus'; pausePomodoro(); const time = parseInt(document.getElementById(isFocus ? 'focus-time' : 'break-time').value) || (isFocus ? 25 : 5); appState.pomodoroTime = time * 60; updatePomodoroDisplay(); document.getElementById('pomodoro-start').disabled = false; document.getElementById('pomodoro-pause').disabled = true; }
        function updatePomodoro() { appState.pomodoroTime--; updatePomodoroDisplay(); if (appState.pomodoroTime < 0) { if (appState.currentPomodoroType === 'focus') { appState.userProfile.completedPomodoros++; addXp(XP_VALUES.pomodoroComplete, 'pomodoro'); appState.currentPomodoroType = 'break'; alert('Foco finalizado! Hora da pausa.'); } else { appState.currentPomodoroType = 'focus'; alert('Pausa finalizada! Hora de focar.'); } checkAllAchievements(); resetPomodoro(); saveAllData(); } }
        function updatePomodoroDisplay() { const minutes = Math.floor(appState.pomodoroTime / 60); const seconds = appState.pomodoroTime % 60; document.getElementById('pomodoro-display').textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`; }
        function updateStats() { prepareAllTopics(); const totalTopics = appState.allTopicsFlat.filter(t => t.area !== 'rest' && t.area !== 'revisao').length; const completedCount = Object.keys(appState.completedTopics).length; const percentage = totalTopics > 0 ? Math.round((completedCount / totalTopics) * 100) : 0; document.getElementById('completed-count').textContent = completedCount; document.getElementById('progress-fill').style.width = `${percentage}%`; document.getElementById('progress-percentage').textContent = `${percentage}% de ${totalTopics} temas`; updateCountdown(); updateAverageDifficulty(); }
        function updateCountdown() { const examDate = new Date(`${appState.scheduleConfig.examDate}T12:00:00Z`); const diffDays = Math.ceil((examDate - new Date()) / (1000 * 60 * 60 * 24)); document.getElementById('days-left').textContent = diffDays > 0 ? diffDays : 0; }
        function updateAverageDifficulty() { const difficulties = Object.values(appState.topicDifficulties); if (difficulties.length === 0) { document.getElementById('avg-difficulty').textContent = '-'; return; } const difficultyMap = { easy: 1, medium: 2, hard: 3 }; const avg = difficulties.reduce((sum, diff) => sum + difficultyMap[diff], 0) / difficulties.length; document.getElementById('avg-difficulty').textContent = avg < 1.5 ? 'F√°cil' : avg < 2.5 ? 'M√©dio' : 'Dif√≠cil'; }
        function updateStatusIcons() { document.querySelectorAll('.topic-checkbox').forEach(checkbox => { const topic = checkbox.dataset.topic; const isCompleted = appState.completedTopics[topic]; checkbox.checked = isCompleted; checkbox.closest('.topic-row').querySelector('.topic-text').classList.toggle('completed', isCompleted); }); }
        
        function createCompletionChart() {
            const ctx = document.getElementById('graficoPorMateria')?.getContext('2d');
            if (!ctx || !document.getElementById('stats-section').classList.contains('active')) return;
            if (appState.charts.completionBySubject) appState.charts.completionBySubject.destroy();
            const data = {};
            const areas = ['preventiva', 'pediatria', 'ginecologia', 'obstetricia', 'clinica', 'cirurgia', 'psiquiatria', 'revisao'];
            areas.forEach(area => { data[area] = { total: 0, feitos: 0, cor: getComputedStyle(document.documentElement).getPropertyValue(`--area-${area}`).trim() || '#607D8B', nome: getAreaName(area) }; });
            appState.allTopicsFlat.forEach(topic => { if (data[topic.area]) { data[topic.area].total++; if (appState.completedTopics[topic.theme]) data[topic.area].feitos++; } });
            const labels = [], porcentagens = [], cores = [];
            for (let key in data) { if (data[key].total > 0) { labels.push(data[key].nome); porcentagens.push(Math.round((data[key].feitos / data[key].total) * 100)); cores.push(data[key].cor); } }
            const isDarkMode = appState.darkMode;
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
            const tickColor = isDarkMode ? '#f5f5f5' : '#666';
            appState.charts.completionBySubject = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '% Conclu√≠do', data: porcentagens, backgroundColor: cores, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { y: { ticks: { color: tickColor }, grid: { display: false } }, x: { beginAtZero: true, max: 100, ticks: { color: tickColor, callback: val => `${val}%` }, grid: { color: gridColor } } } } });
        }
        
        // =================================================================================
        // === BLOCO DA API DE QUEST√ïES (L√ìGICA SEPARADA) ===
        // =================================================================================
        
        /**
         * Fun√ß√£o dedicada para chamar a API de gera√ß√£o de quest√µes.
         * Utiliza as constantes QUESTOES_API_URL e QUESTOES_API_KEY.
         * @param {string} prompt - O prompt completo para a gera√ß√£o da quest√£o.
         * @returns {Promise<string>} O texto da resposta da IA.
         */
        async function callQuestoesAPI(prompt) {
            try {
                const response = await fetch(`${QUESTOES_API_URL}?key=${QUESTOES_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{"parts": [{"text": prompt}]}],
                        generationConfig: { temperature: 0.5, maxOutputTokens: 2048 }
                    })
                });
                if (!response.ok) {
                    throw new Error(`Erro na API de Quest√µes: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                const responseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!responseText) {
                     throw new Error("A API de Quest√µes retornou uma resposta vazia.");
                }
                return responseText;
            } catch (error) {
                console.error('Erro na chamada da API de Quest√µes:', error);
                // Propaga o erro para ser tratado na fun√ß√£o que a chamou.
                throw error;
            }
        }
        
        /**
         * Fun√ß√£o principal que orquestra a gera√ß√£o de quest√µes.
         * Agora utiliza a `callQuestoesAPI` dedicada.
         */
        async function generateQuestions() {
            const topicSelect = document.getElementById('perf-topic-select-questions');
            const topic = topicSelect.value;
            const difficulty = document.getElementById('perf-difficulty-questions').value;
            const quantity = document.getElementById('perf-quantity-questions').value;
            const displayArea = document.getElementById('question-display-area');
            const generateBtn = document.getElementById('generate-question-btn');
            
            const topicInfo = appState.allTopicsFlat.find(t => t.theme === topic);
            const areaKey = topicInfo ? topicInfo.area : 'clinica';
            const specialtyName = getAreaName(areaKey);
            
            generateBtn.disabled = true;
            iniciarCarregamentoQuestoes(displayArea, quantity);

            const prompt = createQuestionPrompt(specialtyName, difficulty, topic, quantity);
            
            try {
                // MODIFICA√á√ÉO PRINCIPAL: Chamando a API de quest√µes isolada.
                const rawResponse = await callQuestoesAPI(prompt);
                
                appState.currentIAQuestions = parseIAQuestionResponse(rawResponse, topic || specialtyName, areaKey);
                completarProgresso(displayArea);
                if (appState.currentIAQuestions.length > 0) {
                    appState.currentQuestionIndex = 0;
                    pararCarregamentoIA(displayArea, () => {
                        displayQuestion(appState.currentQuestionIndex);
                    });
                } else {
                    throw new Error("A IA n√£o retornou quest√µes no formato esperado.");
                }
            } catch (error) {
                console.error("Erro ao gerar quest√£o pela API dedicada:", error);
                // MODIFICA√á√ÉO: Tratamento de erro espec√≠fico para a API de quest√µes.
                pararCarregamentoIA(displayArea, () => {
                    displayArea.innerHTML = `<p class="feedback-area incorrect">N√£o foi poss√≠vel gerar quest√µes no momento. Tente novamente mais tarde.</p>`;
                });
            } finally {
                generateBtn.disabled = false;
            }
        }
        
        // As fun√ß√µes abaixo (createQuestionPrompt, parseIAQuestionResponse, etc.) 
        // s√£o mantidas como est√£o, pois a l√≥gica interna n√£o muda, apenas a fonte dos dados.
        
        // =================================================================================
        // === FIM DO BLOCO DA API DE QUEST√ïES ===
        // =================================================================================


        // --- START: PERFORMANCE SECTION LOGIC (REVISED AND FIXED) ---

        function initializePerformanceSection() {
            populatePerformanceTopicSelects();
            renderPerformanceHistory();
            createPerformanceByAreaChart();
            
            const tabsContainer = document.getElementById('performance-tabs');
            if (!tabsContainer.dataset.initialized) {
                tabsContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.tab-button')) {
                        handleTabClick(e.target.closest('.tab-button'));
                    }
                });
                document.getElementById('generate-question-btn').addEventListener('click', generateQuestions);
                document.getElementById('generate-flashcard-btn').addEventListener('click', generateFlashcards);
                tabsContainer.dataset.initialized = 'true';
            }
        }

        function handleTabClick(clickedTab) {
            const tabName = clickedTab.dataset.tab;
            appState.performanceTab = tabName;

            document.querySelectorAll('#performance-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#performance-content-container .tab-content').forEach(content => content.classList.remove('active'));

            clickedTab.classList.add('active');
            document.getElementById(`tab-content-${tabName}`).classList.add('active');
        }

        function populatePerformanceTopicSelects() {
            const selects = [document.getElementById('perf-topic-select-questions'), document.getElementById('perf-topic-select-flashcards')];
            if (!selects[0] || selects[0].options.length > 1) return;

            const areas = {};
            appState.allTopicsFlat.forEach(topic => {
                if (topic.area === 'rest') return;
                if (!areas[topic.area]) areas[topic.area] = [];
                areas[topic.area].push(topic.theme);
            });

            const fragment = document.createDocumentFragment();
            fragment.appendChild(new Option('Escolha um tema espec√≠fico (opcional)', ''));

            for (const areaId in areas) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = getAreaName(areaId).toUpperCase();
                areas[areaId].sort().forEach(themeName => {
                    optgroup.appendChild(new Option(themeName, themeName));
                });
                fragment.appendChild(optgroup);
            }
            
            selects.forEach(select => {
                select.innerHTML = '';
                select.appendChild(fragment.cloneNode(true));
            });
        }
        
        function savePerformanceEntry(entryData) {
            if (isNaN(entryData.attempted) || isNaN(entryData.correct)) {
                console.error("Dados de desempenho inv√°lidos:", entryData);
                return;
            }

            const topicToUpdate = entryData.topic;
            const existingEntry = appState.performanceLog.find(entry => entry.topic === topicToUpdate);

            if (existingEntry) {
                existingEntry.attempted += entryData.attempted;
                existingEntry.correct += entryData.correct;
                existingEntry.date = new Date().toISOString().split('T')[0];
            } else {
                appState.performanceLog.push({
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    ...entryData
                });
            }
            renderPerformanceHistory();
            createPerformanceByAreaChart();
            addXp(XP_VALUES.performanceEntry, 'performance');
            updateStudyStreak();
            checkAllAchievements({ type: 'simulado' });
            saveAllData();
        }
        
        function createQuestionPrompt(specialty, difficulty, topic, quantity) {
            const topicInstruction = topic ? `Com foco espec√≠fico no tema: "${topic}".` : '';
            return `Voc√™ √© um especialista em provas do Revalida INEP e ENAMED INEP, com foco em racioc√≠nio cl√≠nico e condutas no contexto do SUS. Gere exatamente ${quantity} quest√£o(√µes) de m√∫ltipla escolha, com 5 alternativas (A, B, C, D, E), com o seguinte padr√£o: Formato oficial do Revalida INEP: caso cl√≠nico contextualizado com paciente atendido no SUS. Utilize nomes brasileiros fict√≠cios. Insira dados objetivos e subjetivos, exame f√≠sico e exames complementares quando necess√°rio. Enunciado claro e direto, com comando t√≠pico da banca. A dificuldade deve ser: ${difficulty}. O conte√∫do deve ser da especialidade: ${specialty}. ${topicInstruction} As quest√µes devem seguir as diretrizes cl√≠nicas brasileiras. Proibido usar pegadinhas. Cada quest√£o deve conter: [CASO CL√çNICO COMPLETO] A) [Alternativa A] B) [Alternativa B] C) [Alternativa C] D) [Alternativa D] E) [Alternativa E] Gabarito: [Letra da correta] Coment√°rio: [Explica√ß√£o clara da resposta correta e justificativa das erradas.] Separe cada quest√£o com "---" (tr√™s h√≠fens).`;
        }

        function createFlashcardPrompt(specialty, difficulty, topic, quantity) {
            const topicInstruction = topic ? `Com foco espec√≠fico no tema: "${topic}".` : '';
            return `Voc√™ √© um especialista em criar flashcards de revis√£o para o Revalida INEP. REGRAS: 1. Gere exatamente ${quantity} flashcard(s). 2. A √°rea √© **${specialty}**. A dificuldade deve ser **${difficulty}**. ${topicInstruction} 3. Crie um "frente" com uma pergunta direta ou cen√°rio cl√≠nico. 4. Crie um "verso" com a resposta objetiva e explica√ß√£o. 5. Separe cada flashcard com "---". ESTRUTURA DE SA√çDA OBRIGAT√ìRIA para CADA flashcard: Frente: [Texto da frente] Verso: [Texto do verso] ---`;
        }
        
        function parseIAQuestionResponse(text, topic, areaKey) {
            const questions = text.split('---').filter(q => q.trim() !== '');
            return questions.map(qText => {
                const caseMatch = qText.match(/^(.*?)(?=A\))/s);
                const optionsMatch = qText.match(/A\)(.*?)B\)(.*?)C\)(.*?)D\)(.*?)E\)(.*?)(?=Gabarito:)/s);
                const answerMatch = qText.match(/Gabarito:\s*([A-E])/);
                const commentaryMatch = qText.match(/Coment√°rio:\s*(.*)/s);

                if (!caseMatch || !optionsMatch || !answerMatch || !commentaryMatch) return null;
                
                return {
                    case: caseMatch[1].trim(),
                    options: {
                        A: optionsMatch[1].trim(), B: optionsMatch[2].trim(),
                        C: optionsMatch[3].trim(), D: optionsMatch[4].trim(),
                        E: optionsMatch[5].trim()
                    },
                    answer: answerMatch[1].trim(),
                    commentary: commentaryMatch[1].trim(),
                    topic: topic,
                    area: areaKey
                };
            }).filter(Boolean);
        }

        function parseIAFlashcardResponse(text, topic) {
            const flashcards = text.split('---').filter(f => f.trim() !== '');
            return flashcards.map(fText => {
                const frontMatch = fText.match(/Frente:\s*(.*)/);
                const backMatch = fText.match(/Verso:\s*(.*)/s);
                if (!frontMatch || !backMatch) return null;
                return {
                    front: frontMatch[1].trim(),
                    back: backMatch[1].trim(),
                    topic: topic
                };
            }).filter(Boolean);
        }
        
        function displayQuestion(index) {
            const q = appState.currentIAQuestions[index];
            const displayArea = document.getElementById('question-display-area');
            let optionsHTML = '';
            for (const key in q.options) {
                optionsHTML += `<label class="option-label"><input type="radio" name="questionOption" value="${key}" class="option-radio"><strong>${key})</strong> ${q.options[key]}</label>`;
            }

            displayArea.innerHTML = `
                <div class="question-header">Quest√£o ${index + 1} de ${appState.currentIAQuestions.length} | Tema: ${q.topic}</div>
                <div class="question-case">${q.case.replace(/\n/g, '<br>')}</div>
                <div class="question-options" id="question-options">${optionsHTML}</div>
                <div class="ia-navigation">
                    <button class="btn" id="submit-answer-btn"><i class="fas fa-check"></i> Confirmar</button>
                    <div id="feedback-area" style="margin: 0;"></div>
                </div>
                <div id="commentary-container" style="display: none; margin-top: 15px;"></div>
            `;
            document.getElementById('submit-answer-btn').addEventListener('click', () => submitAnswer(index));
        }

        function submitAnswer(index) {
            const selectedOption = document.querySelector('input[name="questionOption"]:checked');
            if (!selectedOption) {
                alert('Por favor, selecione uma alternativa para continuar.');
                return;
            }
            
            const q = appState.currentIAQuestions[index];
            const isCorrect = selectedOption.value === q.answer;
            const feedbackArea = document.getElementById('feedback-area');
            
            feedbackArea.innerHTML = isCorrect ? `‚úÖ Correto!` : `‚ùå Incorreto. A resposta √© ${q.answer}.`;
            feedbackArea.className = `feedback-area ${isCorrect ? 'correct' : 'incorrect'}`;
            
            document.querySelectorAll('input[name="questionOption"]').forEach(input => {
                input.disabled = true;
                if(input.value === q.answer) input.parentElement.classList.add('correct');
                if(input.checked && !isCorrect) input.parentElement.classList.add('incorrect');
            });
            document.getElementById('submit-answer-btn').style.display = 'none';

            const commentaryContainer = document.getElementById('commentary-container');
            commentaryContainer.innerHTML = `<button class="btn btn-info" id="show-commentary-btn"><i class="fas fa-comment-dots"></i> Ver Coment√°rio</button>`;
            commentaryContainer.style.display = 'block';

            document.getElementById('show-commentary-btn').addEventListener('click', () => {
                commentaryContainer.innerHTML = `<div class="commentary-area">${q.commentary.replace(/\n/g, '<br>')}</div>`;
                setupNextButton(index, 'question');
            });

            savePerformanceEntry({ 
                topic: q.topic, 
                area: q.area, 
                attempted: 1, 
                correct: isCorrect ? 1 : 0 
            });
        }

        // =================================================================================
        // === FUN√á√ÉO DE FLASHCARDS MODIFICADA PARA USAR A API DE QUEST√ïES ===
        // =================================================================================
        
        async function generateFlashcards() {
            const topicSelect = document.getElementById('perf-topic-select-flashcards');
            const topicInfo = appState.allTopicsFlat.find(t => t.theme === topicSelect.value);
            const specialty = topicInfo ? getAreaName(topicInfo.area) : 'Cl√≠nica M√©dica';
            const topic = topicSelect.value;
            const difficulty = document.getElementById('perf-difficulty-flashcards').value;
            const quantity = document.getElementById('perf-quantity-flashcards').value;
            const displayArea = document.getElementById('flashcard-display-area');
            const generateBtn = document.getElementById('generate-flashcard-btn');

            generateBtn.disabled = true;
            iniciarCarregamentoFlashcards(displayArea, quantity);

            const prompt = createFlashcardPrompt(specialty, difficulty, topic, quantity);
            try {
                // MUDAN√áA: Flashcards agora usam a mesma API de quest√µes
                const rawResponse = await callQuestoesAPI(prompt);
                appState.currentIAFlashcards = parseIAFlashcardResponse(rawResponse, topic || specialty);
                completarProgresso(displayArea);
                if (appState.currentIAFlashcards.length > 0) {
                    appState.currentFlashcardIndex = 0;
                    pararCarregamentoIA(displayArea, () => {
                        displayFlashcard(appState.currentFlashcardIndex);
                    });
                } else {
                    throw new Error("A API de quest√µes n√£o retornou flashcards no formato esperado.");
                }
            } catch(error) {
                console.error("Erro ao gerar flashcard via API de quest√µes:", error);
                pararCarregamentoIA(displayArea, () => {
                    displayArea.innerHTML = `<p class="feedback-area incorrect">Erro ao gerar flashcard. Verifique sua conex√£o e tente novamente.</p>`;
                });
            } finally {
                generateBtn.disabled = false;
            }
        }
        
        function displayFlashcard(index) {
            const f = appState.currentIAFlashcards[index];
            const displayArea = document.getElementById('flashcard-display-area');
            displayArea.innerHTML = `
                <div class="question-header">Flashcard ${index + 1} de ${appState.currentIAFlashcards.length} | Tema: ${f.topic}</div>
                <div class="flashcard" id="flashcard">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <span>${f.front.replace(/\n/g, '<br>')}</span>
                            <small style="position: absolute; bottom: 10px; opacity: 0.6;">Clique para virar</small>
                        </div>
                        <div class="flashcard-back"><p>${f.back.replace(/\n/g, '<br>')}</p></div>
                    </div>
                </div>
                <div class="ia-navigation" id="flashcard-controls" style="display: none;"></div>
            `;
            const flashcard = document.getElementById('flashcard');
            flashcard.addEventListener('click', () => {
                flashcard.classList.add('flipped');
                const controls = document.getElementById('flashcard-controls');
                controls.style.display = 'flex';
                controls.innerHTML = `
                    <button class="btn btn-danger" id="flashcard-not-remembered"><i class="fas fa-times"></i> N√£o Lembrei</button>
                    <button class="btn btn-success" id="flashcard-remembered"><i class="fas fa-check"></i> Lembrei</button>
                `;
                document.getElementById('flashcard-remembered').addEventListener('click', () => recordFlashcardResult(index, true));
                document.getElementById('flashcard-not-remembered').addEventListener('click', () => recordFlashcardResult(index, false));
            }, { once: true });
        }
        
        function recordFlashcardResult(index, remembered) {
            const resultText = remembered ? '√ìtimo, voc√™ lembrou!' : 'Sem problemas, continue revisando!';
            document.getElementById('flashcard-controls').innerHTML = `<p class="feedback-area ${remembered ? 'correct' : 'incorrect'}">${resultText}</p>`;
            setupNextButton(index, 'flashcard');
        }

        function setupNextButton(index, type) {
            const container = type === 'question' ? document.getElementById('commentary-container') : document.getElementById('flashcard-controls');
            const items = type === 'question' ? appState.currentIAQuestions : appState.currentIAFlashcards;
            const nextFunc = type === 'question' ? displayQuestion : displayFlashcard;

            if (index < items.length - 1) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn';
                nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Pr√≥ximo';
                nextBtn.onclick = () => nextFunc(index + 1);
                
                let existingNav = container.parentNode.querySelector('.ia-navigation');
                if(!existingNav) {
                    existingNav = document.getElementById('flashcard-controls');
                }
                
                const feedback = existingNav.querySelector('.feedback-area');
                if (feedback) {
                    existingNav.appendChild(nextBtn);
                } else {
                     container.appendChild(nextBtn);
                }
            }
        }
        
        function createPerformanceByAreaChart() {
            const ctx = document.getElementById('graficoDesempenhoPorArea')?.getContext('2d');
            if (!ctx) return;
            if (appState.charts.performanceByArea) appState.charts.performanceByArea.destroy();
            
            const perfData = {};
            const areas = ['preventiva', 'pediatria', 'ginecologia', 'obstetricia', 'clinica', 'cirurgia', 'psiquiatria', 'revisao'];
            areas.forEach(area => {
                perfData[area] = { attempted: 0, correct: 0, cor: getComputedStyle(document.documentElement).getPropertyValue(`--area-${area}`).trim() || '#607D8B', nome: getAreaName(area) };
            });

            appState.performanceLog.forEach(entry => {
                if (entry.area && perfData[entry.area]) { 
                    perfData[entry.area].attempted += entry.attempted;
                    perfData[entry.area].correct += entry.correct;
                }
            });
            
            const labels = [], porcentagens = [], cores = [];
            for (let key in perfData) {
                if (perfData[key].attempted > 0) {
                    labels.push(perfData[key].nome);
                    porcentagens.push(Math.round((perfData[key].correct / perfData[key].attempted) * 100));
                    cores.push(perfData[key].cor);
                }
            }
            
            if (labels.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = "16px Roboto";
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                ctx.textAlign = "center";
                ctx.fillText("Nenhum dado de desempenho para exibir.", ctx.canvas.width / 2, 50);
                return;
            }

            const isDarkMode = appState.darkMode;
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
            const tickColor = isDarkMode ? '#f5f5f5' : '#666';
            appState.charts.performanceByArea = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: '% de Acerto', data: porcentagens, backgroundColor: cores, borderRadius: 5 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: tickColor, callback: val => `${val}%` }, grid: { color: gridColor } },
                        x: { ticks: { color: tickColor }, grid: { display: false } }
                    }
                }
            });
        }
        
        function updateProgressLists() { const container = document.getElementById('progress-lists'); if (!container) return; const areas = {}; prepareAllTopics(); for (const topicName in appState.completedTopics) { const topicDetails = appState.allTopicsFlat.find(t => t.theme === topicName); if (topicDetails) { const area = topicDetails.area; if (!areas[area]) areas[area] = { name: getAreaName(area), icon: getAreaIcon(area), topics: [] }; const daysPassed = Math.floor((new Date() - new Date(appState.lastReviewDates[topicName])) / 864e5); areas[area].topics.push({ name: topicName, daysPassed }); } } let html = ''; for (const areaId in areas) { const area = areas[areaId]; if (area.topics.length === 0) continue; area.topics.sort((a, b) => a.daysPassed - b.daysPassed); const topicsHtml = area.topics.map(topic => `<li class="topic-item"><span>${topic.name}</span> <span class="days-badge ${topic.daysPassed > 14 ? 'danger' : topic.daysPassed > 7 ? 'warning' : ''}">${topic.daysPassed} dias</span></li>`).join(''); html += `<div class="progress-list"><h4><i class="${area.icon}"></i> ${getAreaName(areaId)}</h4><ul>${topicsHtml}</ul></div>`; } container.innerHTML = html || '<p style="text-align: center; padding: 20px;">Nenhum tema conclu√≠do ainda.</p>'; }
        function updateFutureReviews() { const container = document.getElementById('future-reviews-container'); if (!container) return; const now = new Date(); const urgent = [], soon = [], scheduled = []; let pendingCount = 0; if (Object.keys(appState.completedTopics).length === 0) { container.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum tema para revisar.</p>'; document.getElementById('reviews-pending').textContent = '0'; return; } for (const topic in appState.completedTopics) { if (!appState.lastReviewDates[topic]) continue; const lastReview = new Date(appState.lastReviewDates[topic]); const difficulty = appState.topicDifficulties[topic] || 'medium'; const interval = { easy: 15, medium: 7, hard: 3 }[difficulty] || 7; const daysUntil = interval - Math.floor((now - lastReview) / 864e5); const item = { topic, difficulty, daysUntil, lastReview: formatDate(lastReview) }; if (daysUntil <= 0) { item.status = `Atrasada ${Math.abs(daysUntil)}d`; item.statusClass = 'urgent'; urgent.push(item); pendingCount++; } else if (daysUntil <= 3) { item.status = `Em ${daysUntil}d`; item.statusClass = 'soon'; soon.push(item); } else { item.status = `Em ${daysUntil}d`; scheduled.push(item); } } document.getElementById('reviews-pending').textContent = pendingCount; const renderGroup = (title, icon, reviews) => { if (reviews.length === 0) return ''; return `<div class="review-group"><h4><i class="${icon}"></i> ${title} (${reviews.length})</h4>${reviews.map(r => `<div class="review-item"><div class="review-info"><strong>${r.topic}</strong><div>√öltima revis√£o: ${r.lastReview}</div></div><div class="review-actions"><span class="review-due ${r.statusClass}">${r.status}</span><button class="btn" onclick="markAsReviewed('${r.topic.replace(/'/g, "\\'")}')"><i class="fas fa-check"></i> Revisado</button></div></div>`).join('')}</div>`; }; container.innerHTML = `${renderGroup('Atrasadas', 'fas fa-exclamation-triangle', urgent)}${renderGroup('Pr√≥ximas', 'fas fa-hourglass-half', soon)}${renderGroup('Programadas', 'fas fa-calendar-check', scheduled)}` || '<p style="text-align: center;">Nenhuma revis√£o programada.</p>'; }

        function renderPerformanceHistory() {
            const container = document.getElementById('performance-history-container');
            if (!container) return;
            if (appState.performanceLog.length === 0) {
                container.innerHTML = '<p class="config-hint" style="text-align: center;">Nenhum registro.</p>';
                return;
            }
            let tableHTML = `<table class="performance-table"><thead><tr><th>Data</th><th>Tema/√Årea</th><th>Quest√µes</th><th>Acertos</th><th>%</th><th>A√ß√µes</th></tr></thead><tbody>`;
            [...appState.performanceLog].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                const areaName = entry.area ? getAreaName(entry.area) : 'N/A';
                const percentage = Math.round((entry.correct / entry.attempted) * 100);
                let percClass = percentage >= 80 ? 'good' : (percentage < 60 ? 'bad' : 'medium');
                tableHTML += `<tr><td>${new Date(entry.date + 'T12:00:00Z').toLocaleDateString('pt-BR')}</td><td>${entry.topic}<br><small>${areaName}</small></td><td>${entry.attempted}</td><td>${entry.correct}</td><td class="percentage-col ${percClass}">${percentage}%</td><td><button class="btn btn-danger" onclick="deletePerformanceEntry(${entry.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function deletePerformanceEntry(id) {
            if (!confirm('Tem certeza que deseja remover este registro?')) return;
            appState.performanceLog = appState.performanceLog.filter(entry => entry.id !== id);
            renderPerformanceHistory();
            createPerformanceByAreaChart();
            saveAllData();
        }

        function applyConfigurations() { const startDate = document.getElementById('start-date').value; const examDate = document.getElementById('exam-date').value; const maxTopicsPerDay = parseInt(document.getElementById('max-topics-day').value); if (!startDate || !examDate || isNaN(maxTopicsPerDay) || new Date(startDate) >= new Date(examDate)) { alert('Verifique as configura√ß√µes.'); return; } appState.scheduleConfig = { startDate, examDate, maxTopicsPerDay }; regenerateAndRenderSchedule(); alert('Cronograma atualizado!'); showSection('weeks'); saveAllData(); }
        function addCustomTheme() { const nameInput = document.getElementById('custom-theme-name'); const themeName = nameInput.value.trim(); const themeArea = document.getElementById('custom-theme-area').value; if (!themeName || [...originalScheduleData, ...appState.customThemes].some(t => t.theme.toLowerCase() === themeName.toLowerCase())) { alert('Nome inv√°lido ou j√° existe.'); return; } appState.customThemes.push({ theme: themeName, area: themeArea }); nameInput.value = ""; renderCustomThemesList(); saveAllData(); }
        function removeCustomTheme(themeNameToRemove) { appState.customThemes = appState.customThemes.filter(theme => theme.theme !== themeNameToRemove); renderCustomThemesList(); saveAllData(); }
        function renderCustomThemesList() { const list = document.getElementById('custom-themes-list'); list.innerHTML = appState.customThemes.length === 0 ? '<p class="config-hint">Nenhum tema personalizado.</p>' : '<h5>Seus Temas:</h5>'; appState.customThemes.forEach(theme => { const item = document.createElement('div'); item.className = 'custom-theme-item'; item.innerHTML = `<span><span class="area-badge area-${theme.area}">${getAreaName(theme.area)}</span> ${theme.theme}</span> <button class="btn btn-danger" data-theme-name="${theme.theme}"><i class="fas fa-times"></i></button>`; list.appendChild(item); item.querySelector('button').addEventListener('click', () => removeCustomTheme(theme.theme)); }); }
        
        window.markAsReviewed = function (topic) {
            appState.lastReviewDates[topic] = new Date().toISOString();
            if (appState.currentSection === 'review') updateFutureReviews();
            addXp(5);
            updateStudyStreak();
            checkAllAchievements({ type: 'review', topic });
            saveAllData();
        };

        // =================================================================================
        // SE√á√ÉO DE AN√ÅLISE E PREVIS√ïES
        // =================================================================================

        function renderAnalysisPage() {
            if (appState.charts.progressChart) appState.charts.progressChart.destroy();
            if (appState.charts.performanceByTopicChart) appState.charts.performanceByTopicChart.destroy();
            loadAnalysisDataNew();
        }

        // =================================================================================
        // NOVA L√ìGICA DA ABA "AN√ÅLISE E PREVIS√ïES"
        // =================================================================================

        async function loadAnalysisDataNew() {
            // 1. Buscar dados do usu√°rio e logs de performance
            const { startDate, examDate } = appState.scheduleConfig;
            const allTopicsCount = appState.allTopicsFlat.filter(t => t.area !== 'rest' && t.area !== 'revisao').length;
            
            // Simular dados do Supabase usando o estado local
            const userData = {
                meta_total: allTopicsCount,
                start_date: startDate
            };

            const performanceLogs = appState.performanceLog.map(log => ({
                created_at: log.date,
                total_completed: 1, // Cada log representa 1 tema conclu√≠do
                topic: log.topic,
                correct: log.correct > 0
            }));

            // --- C√°lculos Locais ---

            // 2. Progresso Real vs. Esperado
            const totalConcluido = Object.keys(appState.completedTopics).length;
            const startDateObj = new Date(startDate);
            const today = new Date();
            const daysSinceStart = Math.max(1, Math.ceil((today - startDateObj) / (1000 * 60 * 60 * 24)));
            const totalDays = Math.ceil((new Date(examDate) - startDateObj) / (1000 * 60 * 60 * 24));
            const metaDiaria = totalDays > 0 ? allTopicsCount / totalDays : 0;
            const progressoEsperado = metaDiaria * daysSinceStart;

            renderProgressChartNew(daysSinceStart, startDateObj, totalConcluido, progressoEsperado, metaDiaria);

            // 3. Estimativa de Conclus√£o
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            // Calcular progresso dos √∫ltimos 7 dias
            const recentCompletions = Object.keys(appState.lastReviewDates).filter(topic => {
                const completionDate = new Date(appState.lastReviewDates[topic]);
                return completionDate > sevenDaysAgo;
            });

            const dailyProgress = recentCompletions.length / 7;
            
            const restante = allTopicsCount - totalConcluido;
            const completionEstimateElement = document.getElementById('completion-estimate-new');
            
            if (dailyProgress > 0 && restante > 0) {
                const daysToFinish = Math.ceil(restante / dailyProgress);
                const completionDate = new Date();
                completionDate.setDate(today.getDate() + daysToFinish);
                completionEstimateElement.textContent = `üìÖ Com seu ritmo atual (${dailyProgress.toFixed(1)} por dia), voc√™ terminar√° em ${completionDate.toLocaleDateString('pt-BR')}`;
            } else if (restante <= 0) {
                completionEstimateElement.textContent = 'üéâ Parab√©ns! Voc√™ concluiu todos os temas!';
            } else {
                completionEstimateElement.textContent = 'üìÖ Continue estudando para calcular a previs√£o.';
            }

            // 4. √Åreas mais fortes e mais fracas
            const topics = {};
            appState.performanceLog.forEach(log => {
                if (!topics[log.topic]) {
                    topics[log.topic] = { correct: 0, total: 0 };
                }
                topics[log.topic].total += log.attempted;
                topics[log.topic].correct += log.correct;
            });

            const topicRates = Object.entries(topics).map(([topic, data]) => ({
                topic,
                rate: data.total > 0 ? (data.correct / data.total) * 100 : 0
            })).filter(item => item.rate > 0);

            renderTopicsChartNew(topicRates);

            // --- Integra√ß√£o com IA ---

            // 5. Gerar JSON e chamar a IA
            const metrics = {
                media_diaria: dailyProgress,
                meta_total: allTopicsCount,
                total_concluido: totalConcluido,
                taxas_por_tema: topicRates.reduce((obj, item) => ({ ...obj, [item.topic]: item.rate }), {}),
                previsao_conclusao: completionEstimateElement.textContent.split('em ')[1] || 'N/A'
            };

            getAIRecommendationNew(metrics);
        }

       function renderProgressChartNew(daysSinceStart, startDate, totalConcluido, progressoEsperado, metaDiaria) {
    const ctx = document.getElementById('progress-chart-new').getContext('2d');
    const labels = Array.from({ length: daysSinceStart }, (_, i) => `Dia ${i + 1}`);
    const realData = [];
    const expectedData = [];

    // Criar mapa de temas √∫nicos conclu√≠dos por dia
    const topicsByDay = {};
    Object.keys(appState.lastReviewDates).forEach(topic => {
        const dateKey = new Date(appState.lastReviewDates[topic]).toISOString().split("T")[0];
        if (!topicsByDay[dateKey]) topicsByDay[dateKey] = new Set();
        topicsByDay[dateKey].add(topic);
    });

    let cumulativeReal = 0;
    for (let i = 0; i < daysSinceStart; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        const dayKey = currentDate.toISOString().split("T")[0];

        if (topicsByDay[dayKey]) {
            cumulativeReal += topicsByDay[dayKey].size;
        }

        realData.push(cumulativeReal);
        expectedData.push(metaDiaria * (i + 1));
    }

    const isDarkMode = appState.darkMode;
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
    const tickColor = isDarkMode ? '#f5f5f5' : '#666';

    if (appState.charts.progressChart) {
        appState.charts.progressChart.destroy();
    }

    appState.charts.progressChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Progresso Real',
                    data: realData,
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Progresso Esperado',
                    data: expectedData,
                    borderColor: 'rgba(234, 179, 8, 1)',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } },
                x: { ticks: { color: tickColor }, grid: { display: false } }
            },
            plugins: { legend: { labels: { color: tickColor } } }
        }
    });
}
        function renderTopicsChartNew(topicRates) {
            if (topicRates.length === 0) {
                const canvas = document.getElementById('topics-chart-new');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = "16px Roboto";
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                ctx.textAlign = "center";
                ctx.fillText("Fa√ßa quest√µes para ver seu desempenho por tema.", canvas.width / 2, canvas.height / 2);
                return;
            }

            const ctx = document.getElementById('topics-chart-new').getContext('2d');
            const labels = topicRates.map(t => t.topic.length > 20 ? t.topic.substring(0, 20) + '...' : t.topic);
            const data = topicRates.map(t => t.rate);
            const backgroundColors = data.map(rate => {
                if (rate > 75) return 'rgba(74, 222, 128, 0.7)'; // Verde
                if (rate >= 50) return 'rgba(250, 204, 21, 0.7)'; // Amarelo
                return 'rgba(248, 113, 113, 0.7)'; // Vermelho
            });

            const isDarkMode = appState.darkMode;
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
            const tickColor = isDarkMode ? '#f5f5f5' : '#666';

            appState.charts.performanceByTopicChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Taxa de Acerto (%)',
                        data: data,
                        backgroundColor: backgroundColors
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: { 
                                color: tickColor,
                                callback: function(value) {
                                    return value + '%';
                                }
                            }, 
                            grid: { color: gridColor } 
                        },
                        y: { ticks: { color: tickColor }, grid: { display: false } }
                    }
                }
            });
        }

        async function getAIRecommendationNew(metrics) {
            const aiTipElement = document.getElementById('ai-tip-new');
            try {
                // Usar a mesma API j√° configurada no projeto
                const prompt = `Analise os dados e forne√ßa uma recomenda√ß√£o objetiva e motivadora para melhorar o desempenho do estudante, incluindo estrat√©gias e foco nos temas mais fracos. Responda com no m√°ximo 3 frases. JSON: ${JSON.stringify(metrics)}`;

                // Usar a fun√ß√£o existente do chatbot
                const response = await callChatbotAPI(prompt);
                
                if (response && response.trim()) {
                    aiTipElement.textContent = response.trim();
                } else {
                    throw new Error('Resposta vazia da API');
                }

            } catch (error) {
                console.error('Erro ao obter dica da IA:', error);
                aiTipElement.textContent = 'üí° Sem sugest√£o no momento. Continue estudando!';
            }
        }

        function renderProgressVsExpectedChart() {
    const { startDate, examDate } = appState.scheduleConfig;
    const allTopicsCount = appState.allTopicsFlat.filter(t => t.area !== 'rest' && t.area !== 'revisao').length;

    // Criar mapa de temas √∫nicos por data
    const topicsByDay = {};
    Object.keys(appState.lastReviewDates).forEach(topic => {
        const dateKey = appState.lastReviewDates[topic].split('T')[0];
        if (!topicsByDay[dateKey]) topicsByDay[dateKey] = new Set();
        topicsByDay[dateKey].add(topic);
    });

    const start = new Date(`${startDate}T12:00:00Z`);
    const end = new Date();

    if (start > end || allTopicsCount === 0 || Object.keys(topicsByDay).length < 1) {
        const canvas = document.getElementById('graficoProgressoRealEsperado');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = "16px Roboto";
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
        ctx.textAlign = "center";
        ctx.fillText("Comece a estudar para vermos sua progress√£o aqui.", canvas.width / 2, 50);
        document.getElementById('completion-estimate-text').textContent = 'Estude para calcularmos seu ritmo.';
        return;
    }

    const labels = [];
    const realProgressData = [];
    const expectedProgressData = [];
    let cumulativeCompleted = 0;

    const totalDays = (new Date(`${examDate}T12:00:00Z`) - start) / (1000 * 60 * 60 * 24);
    const expectedDailyProgress = totalDays > 0 ? allTopicsCount / totalDays : 0;

    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateString = d.toISOString().split('T')[0];
        labels.push(formatDate(new Date(dateString + 'T12:00:00Z')));

        if (topicsByDay[dateString]) {
            cumulativeCompleted += topicsByDay[dateString].size;
        }

        realProgressData.push(cumulativeCompleted);
        const daysFromStart = (d - start) / (1000 * 60 * 60 * 24) + 1;
        expectedProgressData.push(Math.round(daysFromStart * expectedDailyProgress));
    }

    calculateCompletionEstimate(cumulativeCompleted, start);

    const ctx = document.getElementById('graficoProgressoRealEsperado').getContext('2d');
    const isDarkMode = appState.darkMode;
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
    const tickColor = isDarkMode ? '#f5f5f5' : '#666';

    if (appState.charts.progressChart) {
        appState.charts.progressChart.destroy();
    }

    appState.charts.progressChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Progresso Real',
                data: realProgressData,
                borderColor: 'var(--primary-color)',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                fill: true,
                tension: 0.3
            }, {
                label: 'Progresso Esperado',
                data: expectedProgressData,
                borderColor: 'var(--warning-color)',
                borderDash: [5, 5],
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: tickColor }, grid: { color: gridColor } },
                x: { ticks: { color: tickColor }, grid: { display: false } }
            },
            plugins: { legend: { labels: { color: tickColor } } }
        }
    });
}

        function calculateCompletionEstimate(totalCompleted, startDate) {
            const today = new Date();
            const daysStudied = Math.max(1, (today - startDate) / (1000 * 60 * 60 * 24));
            const averageRate = totalCompleted / daysStudied;
            const allTopicsCount = appState.allTopicsFlat.filter(t => t.area !== 'rest' && t.area !== 'revisao').length;
            const remainingTopics = allTopicsCount - totalCompleted;
            const estimateTextElem = document.getElementById('completion-estimate-text');

            if (averageRate > 0 && remainingTopics > 0) {
                const daysNeeded = Math.ceil(remainingTopics / averageRate);
                const completionDate = new Date();
                completionDate.setDate(today.getDate() + daysNeeded);
                estimateTextElem.innerHTML = `üìÖ Com seu ritmo atual (<strong>${averageRate.toFixed(1)} temas/dia</strong>), voc√™ terminar√° em <strong>${formatDate(completionDate)}</strong>.`;
            } else if (remainingTopics <= 0) {
                estimateTextElem.innerHTML = `üéâ <strong>Parab√©ns!</strong> Voc√™ concluiu todos os temas!`;
            } else {
                estimateTextElem.textContent = 'Continue estudando para vermos uma previs√£o.';
            }
        }

        function renderPerformanceByTopicChart() {
            const performanceByTopic = {};
            if (appState.performanceLog.length === 0) {
                const canvas = document.getElementById('graficoDesempenhoPorTema');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = "16px Roboto";
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                ctx.textAlign = "center";
                ctx.fillText("Fa√ßa quest√µes na aba 'Desempenho por Quest√µes' para ver suas estat√≠sticas.", canvas.width / 2, 50);
                document.getElementById('strategic-focus-text').textContent = 'Responda a quest√µes para receber sugest√µes.';
                return;
            }

            appState.performanceLog.forEach(log => {
                if (!performanceByTopic[log.topic]) {
                    performanceByTopic[log.topic] = { correct: 0, attempted: 0 };
                }
                performanceByTopic[log.topic].correct += log.correct;
                performanceByTopic[log.topic].attempted += log.attempted;
            });

            const topicData = Object.keys(performanceByTopic).map(topic => {
                const { correct, attempted } = performanceByTopic[topic];
                const percentage = attempted > 0 ? (correct / attempted) * 100 : 0;
                return { topic, percentage, attempted };
            }).filter(item => item.attempted > 0).sort((a, b) => a.percentage - b.percentage);

            if (topicData.length === 0) return;

            const worstTopic = topicData[0];
            document.getElementById('strategic-focus-text').innerHTML = `üí° Sugest√£o: concentre-se em revisar '<strong>${worstTopic.topic}</strong>' para melhorar seu desempenho.`;
            
            const labels = topicData.map(d => d.topic);
            const data = topicData.map(d => d.percentage);
            const backgroundColors = data.map(p => {
                if (p < 50) return 'rgba(239, 68, 68, 0.7)';
                if (p < 75) return 'rgba(245, 158, 11, 0.7)';
                return 'rgba(16, 185, 129, 0.7)';
            });

            const ctx = document.getElementById('graficoDesempenhoPorTema').getContext('2d');
            const isDarkMode = appState.darkMode;
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
            const tickColor = isDarkMode ? '#f5f5f5' : '#666';

            appState.charts.performanceByTopicChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% de Acerto',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, max: 100, ticks: { color: tickColor, callback: value => value + '%' }, grid: { color: gridColor } },
                        y: { ticks: { color: tickColor }, grid: { display: false } }
                    }
                }
            });
        }

        // =================================================================================
        // SE√á√ÉO DE RANKING
        // =================================================================================

        // Fun√ß√£o para alternar participa√ß√£o no ranking
        async function toggleRankingParticipation() {
            if (!currentUser) return;
            
            const button = document.getElementById('toggle-ranking-participation');
            const buttonText = document.getElementById('ranking-participation-text');
            const buttonIcon = button.querySelector('i');
            const description = document.getElementById('ranking-participation-description');
            
            // Desabilitar bot√£o durante a opera√ß√£o
            button.disabled = true;
            buttonText.textContent = 'Atualizando...';
            
            try {
                // Alternar o valor atual
                const newValue = !appState.userProfile.show_in_ranking;
                
                // Atualizar no Supabase
                const { error } = await supabase
                    .from('user_data')
                    .update({ show_in_ranking: newValue })
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                // Atualizar estado local
                appState.userProfile.show_in_ranking = newValue;
                
                // Atualizar interface
                updateRankingParticipationUI();
                
                // Recarregar ranking se estiver na aba
                if (appState.currentSection === 'ranking') {
                    renderRankingPage();
                }
                
                // Salvar dados localmente
                saveAllData();
                
                // Mostrar feedback
                const message = newValue ? 
                    '‚úÖ Agora voc√™ aparece no ranking p√∫blico!' : 
                    'üîí Voc√™ saiu do ranking p√∫blico.';
                
                showToast(message);
                
            } catch (error) {
                console.error('Erro ao atualizar participa√ß√£o no ranking:', error);
                showToast('‚ùå Erro ao atualizar. Tente novamente.');
            } finally {
                button.disabled = false;
            }
        }
        
        // Fun√ß√£o para atualizar a interface do bot√£o de participa√ß√£o
        function updateRankingParticipationUI() {
            const button = document.getElementById('toggle-ranking-participation');
            const buttonText = document.getElementById('ranking-participation-text');
            const buttonIcon = button.querySelector('i');
            const description = document.getElementById('ranking-participation-description');
            
            if (!button) return; // Elemento pode n√£o existir ainda
            
            if (appState.userProfile.show_in_ranking) {
                buttonText.textContent = 'Sair do Ranking';
                buttonIcon.className = 'fas fa-eye-slash';
                button.style.background = 'var(--warning-color)';
                description.textContent = 'Voc√™ est√° participando do ranking p√∫blico. Clique no bot√£o para sair da classifica√ß√£o.';
            } else {
                buttonText.textContent = 'Participar do Ranking';
                buttonIcon.className = 'fas fa-eye';
                button.style.background = 'var(--secondary-color)';
                description.textContent = 'Voc√™ n√£o est√° participando do ranking p√∫blico. Clique no bot√£o para aparecer na classifica√ß√£o.';
            }
        }
        
        // Fun√ß√£o para mostrar toast de feedback
        function showToast(message) {
            // Criar elemento de toast se n√£o existir
            let toast = document.getElementById('ranking-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'ranking-toast';
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: var(--card-background);
                    color: var(--text-color);
                    padding: 12px 20px;
                    border-radius: var(--border-radius);
                    box-shadow: var(--shadow-lg);
                    border: 1px solid var(--border-color);
                    z-index: 2001;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    max-width: 300px;
                    font-size: 0.9rem;
                `;
                document.body.appendChild(toast);
            }
            
            toast.textContent = message;
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 3000);
        }

        function setupRankingSubscription() {
            if (appState.rankingSubscription) return;
            appState.rankingSubscription = supabase.channel('public:user_data')
              .on('postgres_changes', { event: '*', schema: 'public', table: 'user_data' }, payload => {
                if (appState.currentSection === 'ranking') {
                  renderRankingPage();
                }
              })
              .subscribe();
        }

        async function renderRankingPage() {
            // Atualizar UI do bot√£o de participa√ß√£o
            updateRankingParticipationUI();
            
            const tableContainer = document.getElementById('ranking-table-container');
            const comparisonContainer = document.getElementById('ranking-comparison-container');
            
            // Se o usu√°rio n√£o est√° participando, mostrar mensagem especial
            if (!appState.userProfile.show_in_ranking) {
                tableContainer.innerHTML = `
                    <div class="config-hint" style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-eye-slash" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-color); margin-bottom: 15px;">Voc√™ n√£o est√° participando do ranking</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            Para ver o ranking e aparecer na classifica√ß√£o, clique no bot√£o "Participar do Ranking" acima.
                        </p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">
                            Sua privacidade √© importante! Voc√™ pode entrar e sair do ranking a qualquer momento.
                        </p>
                    </div>
                `;
                comparisonContainer.innerHTML = '';
                return;
            }
            
            iniciarCarregamentoRanking(tableContainer);
            comparisonContainer.innerHTML = '';

            try {
                const { data, error } = await supabase
                    .from('user_data')
                    .select('user_id, user_profile, performance_log');

                if (error) throw error;
                if (!data || data.length < 2) {
                    pararCarregamentoIA(tableContainer, () => {
                        tableContainer.innerHTML = `<p class="config-hint" style="text-align: center;">Chame seus amigos para a plataforma! O ranking aparecer√° quando houver mais competidores.</p>`;
                    });
                    return;
                }
                
                const processedData = data.map(user => {
                    const profile = user.user_profile || {};
                    const performanceLog = user.performance_log || [];
                    const totalQuestions = performanceLog.reduce((sum, item) => sum + (item.attempted || 0), 0);
                    return {
                        userId: user.user_id,
                        username: profile.username || 'An√¥nimo',
                        xp: profile.xp || 0,
                        questionsAnswered: totalQuestions
                    };
                }).sort((a, b) => b.xp - a.xp);

                pararCarregamentoIA(tableContainer, () => {
                    displayRankingTable(processedData);
                    displayComparisonStats(processedData);
                });

            } catch (error) {
                console.error('Erro ao buscar dados do ranking:', error);
                pararCarregamentoIA(tableContainer, () => {
                    tableContainer.innerHTML = `<p class="feedback-area incorrect">N√£o foi poss√≠vel carregar o ranking. Tente novamente mais tarde.</p>`;
                });
            }
        }

        function displayRankingTable(users) {
            const container = document.getElementById('ranking-table-container');
            let tableHTML = `<table class="performance-table ranking-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Usu√°rio</th>
                        <th>XP</th>
                        <th>Quest√µes</th>
                    </tr>
                </thead>
                <tbody>`;
            
            users.forEach((user, index) => {
                const isCurrentUser = user.userId === currentUser.id;
                const rowClass = isCurrentUser ? 'current-user-row' : '';
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td>${user.username}</td>
                        <td>${user.xp}</td>
                        <td>${user.questionsAnswered}</td>
                    </tr>`;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function displayComparisonStats(users) {
            const container = document.getElementById('ranking-comparison-container');
            const currentUserData = users.find(u => u.userId === currentUser.id);
            if (!currentUserData) return;

            const totalXp = users.reduce((sum, u) => sum + u.xp, 0);
            const totalQuestions = users.reduce((sum, u) => sum + u.questionsAnswered, 0);
            const avgXp = users.length > 0 ? (totalXp / users.length).toFixed(0) : 0;
            const avgQuestions = users.length > 0 ? (totalQuestions / users.length).toFixed(0) : 0;

            container.innerHTML = `
                <div class="stat-card">
                    <h3><i class="fas fa-star"></i> Seu XP vs. M√©dia</h3>
                    <div class="comparison-card-value">${currentUserData.xp}</div>
                    <small>M√©dia da plataforma: ${avgXp}</small>
                </div>
                <div class="stat-card">
                    <h3><i class="fas fa-question-circle"></i> Suas Quest√µes vs. M√©dia</h3>
                    <div class="comparison-card-value">${currentUserData.questionsAnswered}</div>
                    <small>M√©dia da plataforma: ${avgQuestions}</small>
                </div>
            `;
        }

        // ===== SISTEMA DE CARREGAMENTO IA MODERNO =====
        
        /**
         * Inicia o carregamento com anima√ß√£o moderna
         * @param {HTMLElement} elemento - Elemento onde ser√° exibido o carregamento
         * @param {string} texto - Texto a ser exibido
         * @param {string} tipo - Tipo de carregamento (resumo, questoes, flashcards, ranking)
         * @param {boolean} comProgresso - Se deve mostrar barra de progresso
         */
        function iniciarCarregamentoIA(elemento, texto, tipo = 'resumo', comProgresso = true) {
            if (!elemento) return;
            
            // Remove qualquer carregamento anterior
            pararCarregamentoIA(elemento);
            
            // Cria o HTML do carregamento moderno
            const loadingHTML = `
                <div class="ai-loading-container ${tipo}" data-loading="true">
                    <div class="ai-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="ai-spinner"></div>
                    <div class="ai-loading-text">
                        ${texto}
                        <div class="ai-loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    ${comProgresso ? `
                        <div class="ai-progress-bar">
                            <div class="ai-progress-fill" data-progress="0"></div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            elemento.innerHTML = loadingHTML;
            
            // Inicia a simula√ß√£o de progresso se solicitado
            if (comProgresso) {
                simularProgresso(elemento);
            }
        }
        
        /**
         * Para o carregamento com fade-out suave
         * @param {HTMLElement} elemento - Elemento com o carregamento
         * @param {function} callback - Fun√ß√£o a ser executada ap√≥s o fade-out
         */
        function pararCarregamentoIA(elemento, callback = null) {
            if (!elemento) return;
            
            const loadingContainer = elemento.querySelector('.ai-loading-container[data-loading="true"]');
            if (!loadingContainer) {
                if (callback) callback();
                return;
            }
            
            // Adiciona classe de fade-out
            loadingContainer.classList.add('fade-out');
            
            // Remove ap√≥s a anima√ß√£o
            setTimeout(() => {
                if (callback) {
                    callback();
                } else {
                    // Se n√£o h√° callback, apenas remove o carregamento
                    if (loadingContainer.parentNode === elemento) {
                        elemento.innerHTML = '';
                    }
                }
            }, 300);
        }
        
        /**
         * Simula progresso da barra
         * @param {HTMLElement} elemento - Elemento com a barra de progresso
         */
        function simularProgresso(elemento) {
            const progressFill = elemento.querySelector('.ai-progress-fill');
            if (!progressFill) return;
            
            let progresso = 0;
            const intervalo = setInterval(() => {
                progresso += Math.random() * 15 + 5; // Incremento aleat√≥rio entre 5-20%
                
                if (progresso >= 95) {
                    progresso = 95; // Para em 95% at√© a resposta chegar
                    clearInterval(intervalo);
                }
                
                progressFill.style.width = `${progresso}%`;
                progressFill.setAttribute('data-progress', progresso);
            }, 200 + Math.random() * 300); // Intervalo aleat√≥rio entre 200-500ms
            
            // Armazena o intervalo para poder limpar depois
            elemento.setAttribute('data-progress-interval', intervalo);
        }
        
        /**
         * Completa o progresso (vai para 100%)
         * @param {HTMLElement} elemento - Elemento com a barra de progresso
         */
        function completarProgresso(elemento) {
            const progressFill = elemento.querySelector('.ai-progress-fill');
            if (!progressFill) return;
            
            // Limpa o intervalo de simula√ß√£o
            const intervalo = elemento.getAttribute('data-progress-interval');
            if (intervalo) {
                clearInterval(parseInt(intervalo));
                elemento.removeAttribute('data-progress-interval');
            }
            
            // Completa o progresso
            progressFill.style.width = '100%';
            progressFill.setAttribute('data-progress', '100');
        }
        
        // ===== FUN√á√ïES DE CONVENI√äNCIA =====
        
        /**
         * Carregamento espec√≠fico para resumo IA
         */
        function iniciarCarregamentoResumo(elemento) {
            iniciarCarregamentoIA(elemento, 'Gerando resumo com IA', 'resumo', true);
        }
        
        /**
         * Carregamento espec√≠fico para quest√µes IA
         */
        function iniciarCarregamentoQuestoes(elemento, quantidade) {
            const texto = `Gerando ${quantidade} quest√£o${quantidade > 1 ? '√µes' : ''} com IA`;
            iniciarCarregamentoIA(elemento, texto, 'questoes', true);
        }
        
        /**
         * Carregamento espec√≠fico para flashcards IA
         */
        function iniciarCarregamentoFlashcards(elemento, quantidade) {
            const texto = `Gerando ${quantidade} flashcard${quantidade > 1 ? 's' : ''} com IA`;
            iniciarCarregamentoIA(elemento, texto, 'flashcards', true);
        }
        
        /**
         * Carregamento espec√≠fico para ranking
         */
        function iniciarCarregamentoRanking(elemento) {
            iniciarCarregamentoIA(elemento, 'Carregando ranking', 'ranking', false);
        }
        document.addEventListener('contextmenu', e => e.preventDefault());
    </script>
</body>
</html>
