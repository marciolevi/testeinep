<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📅 Cronograma Revalida/Enamed 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--primary-color:#4CAF50;--secondary-color:#FFC107;--accent-color:#2196F3;--background-color:#f8f9fa;--card-background:#fff;--text-color:#333;--border-color:#e0e0e0;--shadow-color:rgba(0,0,0,.1);--success-color:#4CAF50;--warning-color:#FFC107;--danger-color:#F44336;--info-color:#2196F3;--xp-color:#9C27B0;--sidebar-width:280px;--sidebar-collapsed-width:70px}
        [data-theme=dark]{--primary-color:#66BB6A;--secondary-color:#FFD54F;--accent-color:#64B5F6;--background-color:#1a1a1a;--card-background:#2d2d2d;--text-color:#f5f5f5;--border-color:#404040;--shadow-color:rgba(0,0,0,.3);--xp-color:#BA68C8}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Roboto',sans-serif;background-color:var(--background-color);color:var(--text-color);transition:all .3s ease;overflow-x:hidden}
        
        /* --- ESTILOS DA TELA DE LOGIN --- */
        .login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--primary-color),var(--accent-color));z-index:10000;display:flex;align-items:center;justify-content:center;transition:opacity .5s ease,visibility .5s ease;opacity:1;visibility:visible}
        .login-overlay.hidden{opacity:0;visibility:hidden;pointer-events:none}
        .login-container{background:var(--card-background);border-radius:20px;box-shadow:0 20px 60px var(--shadow-color);padding:40px;width:90%;max-width:450px;text-align:center;animation:loginSlideIn .5s ease}
        @keyframes loginSlideIn{0%{transform:translateY(-50px);opacity:0}100%{transform:translateY(0);opacity:1}}
        .login-header{margin-bottom:30px}
        .login-header h1{color:var(--primary-color);font-size:2rem;margin-bottom:10px}
        .login-header p{color:var(--text-color);opacity:.8;font-size:1.1rem}
        .login-tabs{display:flex;margin-bottom:30px;border-radius:12px;background:var(--background-color);padding:4px}
        .login-tab{flex:1;padding:12px;border:none;background:transparent;color:var(--text-color);cursor:pointer;border-radius:8px;transition:all .3s ease;font-weight:500}
        .login-tab.active{background:var(--card-background);color:var(--primary-color);box-shadow:0 2px 8px var(--shadow-color)}
        .login-form{display:none}
        .login-form.active{display:block}
        .form-group{margin-bottom:20px;text-align:left}
        .form-group label{display:block;margin-bottom:8px;font-weight:500;color:var(--text-color)}
        .form-input{width:100%;padding:15px;border:2px solid var(--border-color);border-radius:12px;font-size:1rem;background:var(--background-color);color:var(--text-color);transition:border-color .3s ease}
        .form-input:focus{outline:none;border-color:var(--primary-color)}
        .login-btn{width:100%;padding:15px;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .3s ease;margin-bottom:15px}
        .btn-primary{background:var(--primary-color);color:#fff}
        .btn-primary:hover{background:#45a049;transform:translateY(-2px)}
        .btn-google{background:#4285f4;color:#fff;display:flex;align-items:center;justify-content:center;gap:10px}
        .btn-google:hover{background:#357ae8;transform:translateY(-2px)}
        .login-divider{margin:25px 0;position:relative;text-align:center;color:var(--text-color);opacity:.6}
        .login-divider::before{content:'';position:absolute;top:50%;left:0;right:0;height:1px;background:var(--border-color)}
        .login-divider span{background:var(--card-background);padding:0 15px}
        .login-error{background:#ffebee;color:#c62828;padding:12px;border-radius:8px;margin-bottom:20px;display:none}
        [data-theme=dark] .login-error{background:#4d1f1f;color:#ff6b6b}
        .login-loading{display:none;margin:20px 0}
        .loading-spinner{width:40px;height:40px;border:4px solid var(--border-color);border-top:4px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

        /* --- RESTANTE DOS ESTILOS (gamer.html) --- */
        .header-fixed{position:fixed;top:0;left:0;right:0;background-color:var(--card-background);box-shadow:0 2px 10px var(--shadow-color);z-index:1000;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;transition:all .3s ease;min-height:80px}
        .header-fixed.sidebar-open{left:var(--sidebar-width)}
        .header-fixed.sidebar-collapsed{left:var(--sidebar-collapsed-width)}
        .header-left{display:flex;align-items:center;gap:15px}
        .header-center{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;margin:0 15px}
        .header-right{display:flex;align-items:center;gap:15px}
        .header-title{font-size:1.5em;font-weight:700;color:var(--primary-color)}
        .user-info{display:flex;align-items:center;gap:10px;font-size:.9rem}
        .user-avatar{width:30px;height:30px;border-radius:50%;background:var(--xp-color);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
        .logout-btn{background:var(--danger-color);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:.8rem;transition:all .3s ease}
        .logout-btn:hover{background:#d32f2f;transform:translateY(-1px)}
        .user-profile-header{display:flex;align-items:center;gap:15px}
        .xp-bar-container{width:150px;height:12px;background-color:var(--border-color);border-radius:6px;overflow:hidden;position:relative}
        .xp-bar-fill{width:0%;height:100%;background-color:var(--xp-color);transition:width .5s ease}
        .study-streak{font-size:1.2em;color:#FF9800;font-weight:700;display:flex;align-items:center;gap:5px}
        .btn{background-color:var(--accent-color);color:#fff;border:none;padding:10px 15px;border-radius:8px;cursor:pointer;font-size:.9em;transition:all .3s ease;display:flex;align-items:center;gap:5px}
        .btn:hover{background-color:#1976D2;transform:translateY(-2px)}
        .btn-toggle{background-color:var(--secondary-color);color:#333}
        .btn-toggle:hover{background-color:#F57F17}
        .btn-danger{background-color:var(--danger-color);font-size:.8em;padding:4px 8px}
        .btn-ia{padding:5px 10px;font-size:.75em;background-color:var(--xp-color);color:white;border:none;border-radius:6px;cursor:pointer}
        .sidebar{position:fixed;top:0;left:0;width:var(--sidebar-width);height:100vh;background-color:var(--card-background);box-shadow:2px 0 10px var(--shadow-color);transform:translateX(-100%);transition:transform .3s ease;z-index:999;overflow-y:auto;padding:80px 0 20px}
        .sidebar.open{transform:translateX(0)}
        .sidebar.collapsed{width:var(--sidebar-collapsed-width);transform:translateX(0)}
        .sidebar-content{padding:20px}
        .sidebar.collapsed .sidebar-content{padding:10px}
        .sidebar-menu{list-style:none}
        .sidebar-menu li{margin-bottom:10px}
        .sidebar-menu a{display:flex;align-items:center;padding:12px 15px;color:var(--text-color);text-decoration:none;border-radius:8px;transition:all .3s ease;gap:12px}
        .sidebar-menu a:hover{background-color:var(--primary-color);color:#fff}
        .sidebar-menu i{font-size:1.2em;width:20px;text-align:center}
        .sidebar.collapsed .sidebar-menu span{display:none}
        .sidebar.collapsed .sidebar-menu a{justify-content:center;padding:12px 10px}
        .main-content{padding-top:100px;margin-left:0;padding:100px 20px 20px;transition:margin-left .3s ease}
        .main-content.sidebar-open{margin-left:var(--sidebar-width)}
        .main-content.sidebar-collapsed{margin-left:var(--sidebar-collapsed-width)}
        .content-section{display:none}
        .content-section.active{display:block}
        .achievements-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
        .achievement-category{background-color:var(--card-background);border-radius:12px;padding:20px;box-shadow:0 4px 15px var(--shadow-color)}
        .achievement-category h3{color:var(--primary-color);margin-bottom:15px;border-bottom:2px solid var(--border-color);padding-bottom:10px}
        .achievement-item{display:flex;align-items:center;gap:15px;padding:10px 0;border-bottom:1px solid var(--border-color);transition:all .3s ease;opacity:.5}
        .achievement-item:last-child{border-bottom:none}
        .achievement-item.unlocked{opacity:1}
        .achievement-icon{font-size:2.2em;color:var(--secondary-color);width:50px;text-align:center}
        .achievement-item.unlocked .achievement-icon{color:var(--primary-color)}
        .achievement-details h4{margin:0;font-size:1.1em}
        .achievement-details p{margin:2px 0 0;font-size:.9em;color:var(--text-color);opacity:.8}
        .achievement-details .unlock-date{font-size:.8em;font-style:italic;color:var(--success-color)}
        .achievement-notification{position:fixed;bottom:-120px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--secondary-color),#FFB300);color:#111;padding:15px 25px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.3);display:flex;align-items:center;gap:15px;z-index:9999;transition:all .5s ease-in-out;font-weight:500}
        .achievement-notification.show{bottom:20px;transform:translateX(-50%) scale(1);opacity:1}
        .achievement-notification i{font-size:1.8em}
        .chart-container{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:30px;position:relative;height:280px}
        .chart-container h3{text-align:center;margin-bottom:15px;font-size:1.2em;color:var(--primary-color)}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);text-align:center;transition:transform .3s ease}
        .stat-card:hover{transform:translateY(-5px)}
        .stat-card h3{color:var(--primary-color);font-size:1.2em;margin-bottom:10px}
        .stat-card .value{font-size:2.5em;font-weight:700;color:var(--accent-color);margin:10px 0}
        .progress-bar{background-color:var(--border-color);border-radius:10px;height:8px;overflow:hidden;margin-top:10px}
        .progress-fill{height:100%;background-color:var(--primary-color);border-radius:10px;transition:width .5s ease}
        .progress-list{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:20px}
        .progress-list h4{color:var(--primary-color);margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .topic-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border-color);transition:background-color .3s ease}
        .topic-item:hover{background-color:rgba(76,175,80,.1)}
        .topic-item:last-child{border-bottom:none}
        .custom-theme-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background-color:var(--background-color);margin-bottom:8px}
        .days-badge{background-color:var(--accent-color);color:#fff;padding:4px 8px;border-radius:12px;font-size:.8em;font-weight:700}
        .days-badge.warning{background-color:var(--warning-color);color:#333}
        .days-badge.danger{background-color:var(--danger-color)}
        .controls-section{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:30px}
        .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;align-items:center}
        .search-box,.filter-select,.config-input{width:100%;padding:12px;border:2px solid var(--border-color);border-radius:8px;font-size:1em;background-color:var(--background-color);color:var(--text-color);transition:border-color .3s ease}
        .search-box:focus,.filter-select:focus,.config-input:focus{outline:none;border-color:var(--primary-color)}
        .config-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:20px}
        .config-form-group{display:flex;gap:10px;align-items:flex-end}
        .config-form-group>div{flex-grow:1}
        .config-group{display:flex;flex-direction:column;gap:8px}
        .config-group label{font-weight:500;color:var(--primary-color)}
        .config-hint{font-size:.8em;color:var(--text-color);opacity:.7}
        .performance-table{width:100%;border-collapse:collapse;margin-top:20px;font-size:.9em}
        .performance-table th,.performance-table td{padding:12px;border-bottom:1px solid var(--border-color);text-align:left}
        .performance-table th{background-color:var(--primary-color);color:#fff}
        .performance-table tr:hover{background-color:rgba(76,175,80,.1)}
        .performance-table .percentage-col{font-weight:700}
        .performance-table .percentage-col.good{color:var(--success-color)}
        .performance-table .percentage-col.medium{color:var(--warning-color)}
        .performance-table .percentage-col.bad{color:var(--danger-color)}
        .pomodoro-section{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:30px;text-align:center}
        .pomodoro-display{font-size:3em;font-weight:700;color:var(--accent-color);margin:20px 0;font-family:'Courier New',monospace}
        .pomodoro-controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:20px}
        .pomodoro-settings{display:flex;gap:15px;justify-content:center;margin-top:15px;flex-wrap:wrap}
        .pomodoro-settings input{width:80px;padding:8px;border:2px solid var(--border-color);border-radius:6px;text-align:center;background-color:var(--background-color);color:var(--text-color)}
        .week-section{background-color:var(--card-background);border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:30px;overflow:hidden;transition:all .3s ease}
        .week-header{background:linear-gradient(135deg,var(--primary-color),#66BB6A);color:#fff;padding:20px;font-size:1.4em;font-weight:700;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .3s ease}
        .week-header:hover{background:linear-gradient(135deg,#388E3C,var(--primary-color))}
        .week-content{padding:0;max-height:2000px;overflow:hidden;transition:max-height .5s ease-in-out;overflow-x:auto}
        .week-content.collapsed{max-height:0}
        .week-table{width:100%;border-collapse:collapse;table-layout:fixed}
        .week-table th{background-color:var(--primary-color);color:#fff;padding:15px 8px;text-align:left;font-weight:600;font-size:.9em}
        .week-table td{padding:15px 8px;border-bottom:1px solid var(--border-color);vertical-align:top;word-wrap:break-word;overflow-wrap:break-word}
        .week-table tr:hover{background-color:rgba(76,175,80,.1)}
        .topic-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
        .topic-row:last-child{margin-bottom:0}
        .topic-checkbox{transform:scale(1.3);cursor:pointer;flex-shrink:0}
        .topic-text{flex-grow:1;transition:all .3s ease}
        .topic-text.completed{text-decoration:line-through;opacity:.7}
        td .topic-icons{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;height:100%}
        .area-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:.8em;font-weight:700;color:#fff;display:flex;align-items:center;gap:5px;flex-shrink:0}
        .area-preventiva{background-color:#4CAF50}.area-pediatria{background-color:#2196F3}.area-ginecologia{background-color:#9C27B0}.area-obstetricia{background-color:#673AB7}.area-clinica{background-color:#F44336}.area-cirurgia{background-color:#FF9800}.area-psiquiatria{background-color:#795548}.area-revisao{background-color:#607D8B}.area-rest{background-color:#9E9E9E}
        .rest-day{background-color:#FFF3E0;font-style:italic;text-align:center}
        [data-theme=dark] .rest-day{background-color:#3E2723}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:2000;justify-content:center;align-items:center}
        .modal.active{display:flex}
        .modal-content{background-color:var(--card-background);padding:30px;border-radius:15px;max-width:500px;width:90%;text-align:center;box-shadow:0 10px 30px var(--shadow-color);animation:modalSlideIn .3s ease}
        @keyframes modalSlideIn{0%{transform:translateY(-50px);opacity:0}100%{transform:translateY(0);opacity:1}}
        .difficulty-buttons{display:flex;gap:15px;justify-content:center;margin-top:20px}
        .difficulty-btn{padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:all .3s ease}
        .difficulty-easy{background-color:#4CAF50;color:#fff}
        .difficulty-medium{background-color:#FF9800;color:#fff}
        .difficulty-hard{background-color:#F44336;color:#fff}
        .difficulty-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
        .confirmation-buttons{display:flex;gap:15px;justify-content:center;margin-top:20px}
        .btn-confirm{background-color:var(--danger-color)}
        .btn-cancel{background-color:var(--border-color);color:var(--text-color)}
        @media (max-width:992px){.header-center{display:none}}
        @media (max-width:768px){.header-fixed{left:0!important;padding:10px 15px;flex-wrap:wrap;min-height:auto;gap:10px}.header-left,.header-right{width:100%;justify-content:space-between}.header-center{display:flex;width:100%;order:-1;margin:5px 0}.user-profile-header{width:100%;justify-content:center;gap:10px}.xp-bar-container{width:120px;height:10px}.sidebar{width:100%;transform:translateX(-100%)}.sidebar.open{transform:translateX(0);width:280px}.sidebar.collapsed{transform:translateX(-100%)}.main-content.sidebar-open{margin-left:0}.main-content.sidebar-collapsed{margin-left:0}.main-content{padding-top:120px;padding-left:15px;padding-right:15px}.stats-grid{grid-template-columns:1fr}.controls-grid,.config-form,.config-form-group{grid-template-columns:1fr;flex-direction:column;align-items:stretch}.config-form-group .btn{width:100%;justify-content:center}.performance-table{font-size:.8em}.performance-table th,.performance-table td{padding:8px 4px}.pomodoro-controls,.difficulty-buttons{flex-direction:column;align-items:center}.week-table{font-size:.8em}.week-table th,.week-table td{padding:8px 4px}.topic-row{flex-direction:column;align-items:flex-start}td .topic-icons{flex-direction:row;justify-content:space-around;width:100%;margin-top:10px}}
        .fade-in{animation:fadeIn .5s ease}@keyframes fadeIn{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
        .pulse{animation:pulse 2s infinite}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
        ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--background-color)}::-webkit-scrollbar-thumb{background:var(--primary-color);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#388E3C}
        .review-group{background-color:var(--card-background);padding:15px;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 10px var(--shadow-color)}
        .review-group h4{color:var(--primary-color);margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .review-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border-color)}
        .review-item:last-child{border-bottom:none}
        .review-info{flex-grow:1}
        .review-actions{display:flex;gap:10px}
        .review-due{font-weight:700}
        .review-due.urgent{color:var(--danger-color)}
        .review-due.soon{color:var(--warning-color)}
        .medical-chatbot{position:fixed;bottom:20px;right:20px;z-index:1500;font-family:'Roboto',sans-serif}
        .chatbot-toggle{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--xp-color),#8E24AA);border:none;color:white;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 20px rgba(156,39,176,.3);transition:all .3s ease;display:flex;align-items:center;justify-content:center}
        .chatbot-toggle:hover{transform:scale(1.1);box-shadow:0 6px 25px rgba(156,39,176,.5)}
        .chatbot-toggle.active{background:linear-gradient(135deg,#FF5722,#F44336)}
        .chatbot-container{position:absolute;bottom:80px;right:0;width:400px;height:600px;background:var(--card-background);border-radius:20px;box-shadow:0 20px 60px var(--shadow-color);display:none;flex-direction:column;overflow:hidden;border:2px solid var(--border-color)}
        .chatbot-container.active{display:flex}
        .chatbot-header{background:linear-gradient(135deg,var(--xp-color),#8E24AA);color:white;padding:20px;text-align:center;position:relative}
        .chatbot-header h3{margin:0;font-size:1.2rem;font-weight:600}
        .chatbot-header p{margin:5px 0 0;font-size:.9rem;opacity:.9}
        .chatbot-close{position:absolute;top:15px;right:15px;background:none;border:none;color:white;font-size:1.2rem;cursor:pointer;opacity:.8}
        .chatbot-close:hover{opacity:1}
        .chat-messages{flex:1;padding:20px;overflow-y:auto;background:var(--background-color)}
        .message{margin-bottom:15px;max-width:85%}
        .message.user{margin-left:auto;text-align:right}
        .message.bot{margin-right:auto}
        .message-bubble{padding:12px 16px;border-radius:18px;font-size:.9rem;line-height:1.4;word-wrap:break-word}
        .message.user .message-bubble{background:var(--xp-color);color:white;border-bottom-right-radius:5px}
        .message.bot .message-bubble{background:var(--card-background);color:var(--text-color);border:1px solid var(--border-color);border-bottom-left-radius:5px}
        .message-time{font-size:.7rem;opacity:.7;margin-top:5px}
        .typing-indicator{display:none;align-items:center;gap:8px;padding:12px 16px;background:var(--card-background);border:1px solid var(--border-color);border-radius:18px;border-bottom-left-radius:5px;margin-bottom:15px;max-width:85%}
        .typing-indicator.active{display:flex}
        .typing-dots{display:flex;gap:4px}
        .typing-dot{width:8px;height:8px;background:var(--xp-color);border-radius:50%;animation:typingAnimation 1.4s infinite ease-in-out}
        .typing-dot:nth-child(1){animation-delay:-.32s}
        .typing-dot:nth-child(2){animation-delay:-.16s}
        @keyframes typingAnimation{0%,80%,100%{transform:scale(0);opacity:.5}40%{transform:scale(1);opacity:1}}
        .chat-input-container{padding:20px;border-top:2px solid var(--border-color);background:var(--card-background)}
        .chat-input-wrapper{display:flex;gap:10px;align-items:flex-end}
        .chat-input{flex:1;padding:12px 16px;border:2px solid var(--border-color);border-radius:25px;background:var(--background-color);color:var(--text-color);font-size:.9rem;resize:none;max-height:100px;min-height:44px;outline:none;transition:border-color .3s ease}
        .chat-input:focus{border-color:var(--xp-color)}
        .chat-send{width:44px;height:44px;border-radius:50%;background:var(--xp-color);border:none;color:white;font-size:1.1rem;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center}
        .chat-send:hover:not(:disabled){background:#8E24AA;transform:scale(1.05)}
        .chat-send:disabled{opacity:.5;cursor:not-allowed}
        .quick-topics{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px}
        .quick-topic{padding:6px 12px;background:var(--card-background);border:1px solid var(--border-color);border-radius:15px;font-size:.8rem;cursor:pointer;transition:all .3s ease;color:var(--text-color)}
        .quick-topic:hover{background:var(--xp-color);color:white;border-color:var(--xp-color)}
        @media (max-width:768px){.chatbot-container{width:100vw;height:100vh;bottom:0;right:0;border-radius:0;position:fixed}.medical-chatbot{bottom:10px;right:10px}.chatbot-toggle{width:50px;height:50px;font-size:1.3rem}}
        .level-container{display:flex;align-items:center;gap:10px;margin-bottom:5px}
        .level-avatar{font-size:1.8em;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--xp-color);border-radius:50%;color:white}
        .level-info{font-size:.8em;color:var(--text-color);opacity:.8;margin-top:3px}
        .level-badge{background:linear-gradient(135deg,var(--xp-color),#8E24AA);color:white;padding:3px 8px;border-radius:12px;font-size:.7em;font-weight:700;display:inline-block;margin-left:5px}
    </style>
</head>
<body>
    <div class="login-overlay" id="login-overlay">
        <div class="login-container">
            <div class="login-header"><h1>🩺 Revalida 2025</h1><p>Sua plataforma de estudos médicos</p></div>
            <div class="login-tabs">
                <button class="login-tab active" id="login-tab">Entrar</button>
                <button class="login-tab" id="register-tab">Cadastrar</button>
            </div>
            <div class="login-error" id="login-error"></div>
            <form class="login-form active" id="login-form">
                <div class="form-group"><label for="login-email">E-mail:</label><input type="email" id="login-email" class="form-input" placeholder="seu@email.com" required></div>
                <div class="form-group"><label for="login-password">Senha:</label><input type="password" id="login-password" class="form-input" placeholder="Sua senha" required></div>
                <button type="submit" class="login-btn btn-primary"><i class="fas fa-sign-in-alt"></i> Entrar</button>
            </form>
            <form class="login-form" id="register-form">
                <div class="form-group"><label for="register-name">Nome:</label><input type="text" id="register-name" class="form-input" placeholder="Seu nome completo" required></div>
                <div class="form-group"><label for="register-email">E-mail:</label><input type="email" id="register-email" class="form-input" placeholder="seu@email.com" required></div>
                <div class="form-group"><label for="register-password">Senha:</label><input type="password" id="register-password" class="form-input" placeholder="Mínimo 6 caracteres" required minlength="6"></div>
                <div class="form-group"><label for="register-confirm-password">Confirmar Senha:</label><input type="password" id="register-confirm-password" class="form-input" placeholder="Repita sua senha" required></div>
                <button type="submit" class="login-btn btn-primary"><i class="fas fa-user-plus"></i> Criar Conta</button>
            </form>
            <div class="login-divider"><span>ou</span></div>
            <button class="login-btn btn-google" id="google-login"><i class="fab fa-google"></i> Continuar com Google</button>
            <div class="login-loading" id="login-loading"><div class="loading-spinner"></div><p>Aguarde...</p></div>
        </div>
    </div>

    <header class="header-fixed" id="header">
        <div class="header-left">
            <button class="btn" id="menu-toggle"><i class="fas fa-bars"></i></button>
            <div class="header-title">Revalida 2025</div>
        </div>
        <div class="header-center">
             <div class="user-profile-header">
                <div id="study-streak" class="study-streak" title="Dias de estudo consecutivos"><i class="fas fa-fire"></i> <span id="streak-count">0</span></div>
                <div class="user-level" id="user-level"></div>
                <div class="xp-bar-container" title="Pontos de Experiência"><div id="xp-bar-fill" class="xp-bar-fill"></div></div>
            </div>
        </div>
        <div class="header-right">
             <div class="user-info">
                <div id="user-avatar" class="user-avatar">U</div>
                <span id="user-name">Usuário</span>
            </div>
            <button class="btn btn-toggle" id="theme-toggle" title="Alternar Modo Escuro/Claro"><i class="fas fa-moon"></i></button>
            <button class="btn" id="minimalist-toggle" title="Modo Minimalista"><i class="fas fa-compress"></i></button>
            <button class="btn logout-btn" id="logout-btn" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li><a href="#" data-section="stats"><i class="fas fa-chart-bar"></i><span>Estatísticas</span></a></li>
                <li><a href="#" data-section="achievements"><i class="fas fa-trophy"></i><span>Conquistas</span></a></li>
                <li><a href="#" data-section="performance"><i class="fas fa-chart-line"></i><span>Desempenho</span></a></li>
                <li><a href="#" data-section="progress"><i class="fas fa-tasks"></i><span>Progresso</span></a></li>
                <li><a href="#" data-section="pomodoro"><i class="fas fa-clock"></i><span>Pomodoro</span></a></li>
                <li><a href="#" data-section="review"><i class="fas fa-brain"></i><span>Revisão</span></a></li>
                <li><a href="#" data-section="weeks"><i class="fas fa-calendar"></i><span>Semanas</span></a></li>
                <li><a href="#" data-section="settings"><i class="fas fa-cog"></i><span>Configurações</span></a></li>
                <li><a href="#" id="reset-progress"><i class="fas fa-trash"></i><span>Resetar</span></a></li>
            </ul>
        </div>
    </nav>
    
    <main class="main-content" id="main-content">
        <section id="stats-section" class="content-section active">
            <div class="stats-grid fade-in">
                <div class="stat-card"><h3><i class="fas fa-check-circle"></i> Temas Concluídos</h3><div class="value" id="completed-count">0</div><div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div><small id="progress-percentage">0%</small></div>
                <div class="stat-card"><h3><i class="fas fa-calendar-day"></i> Dias Restantes</h3><div class="value" id="days-left">0</div><small>até a data da prova</small></div>
                <div class="stat-card"><h3><i class="fas fa-redo"></i> Revisões Pendentes</h3><div class="value" id="reviews-pending">0</div><small>temas para revisar</small></div>
                <div class="stat-card"><h3><i class="fas fa-star"></i> Dificuldade Média</h3><div class="value" id="avg-difficulty">-</div><small>dos temas concluídos</small></div>
            </div>
            <div class="chart-container fade-in"><h3><i class="fas fa-tasks"></i> Conclusão por Matéria (%)</h3><canvas id="graficoPorMateria"></canvas></div>
            <div class="chart-container fade-in"><h3><i class="fas fa-chart-line"></i> Desempenho Médio por Área (%)</h3><canvas id="graficoDesempenhoPorArea"></canvas></div>
        </section>
        <section id="achievements-section" class="content-section"><h2 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-trophy"></i> Suas Conquistas</h2><div class="achievements-grid" id="achievements-grid"></div></section>
        <section id="performance-section" class="content-section">
            <div class="controls-section fade-in"><h2><i class="fas fa-chart-line"></i> Registro de Desempenho</h2><p>Anote aqui seus resultados em simulados e listas de exercícios.</p>
                <div class="config-form" style="align-items: flex-end;">
                    <div class="config-group"><label for="perf-date">Data:</label><input type="date" id="perf-date" class="config-input"></div>
                    <div class="config-group" style="flex-grow: 2;"><label for="perf-topic-select">Tema Relacionado:</label><select id="perf-topic-select" class="config-input"></select></div>
                    <div class="config-group"><label for="perf-questions-attempted">Questões:</label><input type="number" id="perf-questions-attempted" class="config-input" min="1" placeholder="Ex: 50"></div>
                    <div class="config-group"><label for="perf-questions-correct">Acertos:</label><input type="number" id="perf-questions-correct" class="config-input" min="0" placeholder="Ex: 42"></div>
                    <button class="btn" id="save-performance-entry" style="padding: 12px 20px;"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </div>
            <div class="controls-section fade-in" style="margin-top: 20px;"><h3><i class="fas fa-history"></i> Histórico de Registros</h3><div id="performance-history-container" style="overflow-x: auto;"></div></div>
        </section>
        <section id="progress-section" class="content-section"><h2 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-tasks"></i> Progresso por Matéria</h2><div id="progress-lists"></div></section>
        <section id="pomodoro-section" class="content-section"><div class="pomodoro-section fade-in"><h3><i class="fas fa-clock"></i> Timer Pomodoro</h3><div class="pomodoro-display" id="pomodoro-display">25:00</div><div class="pomodoro-controls"><button class="btn" id="pomodoro-start"><i class="fas fa-play"></i> Iniciar</button><button class="btn" id="pomodoro-pause"><i class="fas fa-pause"></i> Pausar</button><button class="btn" id="pomodoro-reset"><i class="fas fa-stop"></i> Resetar</button></div><div class="pomodoro-settings"><div><label>Foco (min):</label><input type="number" id="focus-time" value="25" min="1" max="60"></div><div><label>Pausa (min):</label><input type="number" id="break-time" value="5" min="1" max="30"></div></div></div></section>
        <section id="review-section" class="content-section"><div class="controls-section fade-in"><h3><i class="fas fa-brain"></i> Revisões Futuras</h3><div id="future-reviews-container"></div></div></section>
        <section id="settings-section" class="content-section"><div class="controls-section fade-in"><h3><i class="fas fa-cog"></i> Configurações</h3><div class="config-form"><div class="config-group"><label for="start-date">Data de Início:</label><input type="date" id="start-date" class="config-input"></div><div class="config-group"><label for="exam-date">Data da Prova:</label><input type="date" id="exam-date" class="config-input"></div><div class="config-group"><label for="max-topics-day">Máx. Temas/Dia:</label><input type="number" id="max-topics-day" class="config-input" value="5" min="1" max="10"></div></div><div style="margin-top: 30px; border-top: 2px solid var(--border-color); padding-top: 20px;"><h4><i class="fas fa-plus-circle"></i> Adicionar Temas Personalizados</h4><div class="config-form-group" style="margin-top: 15px;"><div class="config-group"><label for="custom-theme-name">Nome do Tema:</label><input type="text" id="custom-theme-name" class="config-input" placeholder="Ex: Revisão de ECG"></div><div class="config-group"><label for="custom-theme-area">Área:</label><select id="custom-theme-area" class="config-input"><option value="preventiva">Preventiva</option><option value="pediatria">Pediatria</option><option value="ginecologia">Ginecologia</option><option value="obstetricia">Obstetrícia</option><option value="clinica">Clínica</option><option value="cirurgia">Cirurgia</option><option value="psiquiatria">Psiquiatria</option><option value="revisao">Revisão</option></select></div><button class="btn" id="add-custom-theme-btn"><i class="fas fa-plus"></i> Add</button></div><div id="custom-themes-list" style="margin-top: 20px;"></div></div><button class="btn" id="apply-config" style="margin-top: 30px; background-color: var(--primary-color); padding: 15px 25px; font-size: 1.1em; width: 100%;"><i class="fas fa-save"></i> Salvar e Atualizar Cronograma</button></div></section>
        <section id="weeks-section" class="content-section"><div class="controls-section fade-in"><div class="controls-grid"><div><label for="search-box">🔍 Buscar tema:</label><input type="text" id="search-box" class="search-box" placeholder="Digite o nome do tema..."></div><div><label for="area-filter">🏥 Filtrar por área:</label><select id="area-filter" class="filter-select"><option value="all">Todas as áreas</option><option value="preventiva">Preventiva</option><option value="pediatria">Pediatria</option><option value="ginecologia">Ginecologia</option><option value="obstetricia">Obstetrícia</option><option value="clinica">Clínica</option><option value="cirurgia">Cirurgia</option><option value="psiquiatria">Psiquiatria</option><option value="revisao">Revisão</option></select></div></div></div><button class="btn expand-weeks-btn" id="expand-weeks" style="display: none;"><i class="fas fa-expand"></i> Mostrar todas as semanas</button><div id="weeks"></div></section>
    </main>

    <div class="medical-chatbot">
        <div class="chatbot-container" id="chatbot-container">
            <div class="chatbot-header"><button class="chatbot-close" id="chatbot-close">×</button><h3>🧠 IA Médica Revalida</h3><p>Seu assistente de estudos especializado</p></div>
            <div class="chat-messages" id="chat-messages">
                <div class="message bot"><div class="message-bubble">👋 Olá! Sou sua IA especializada em Revalida/Enamed. Posso te ajudar com:<br><br>• Resumos técnicos de qualquer tema<br>• Explicações didáticas <br>• Perguntas de fixação<br>• Dicas de estudo por área<br><br>Como posso te ajudar hoje?</div><div class="message-time">Agora</div></div>
                <div class="quick-topics"><div class="quick-topic" data-topic="Resumo de Hipertensão Arterial">Hipertensão</div><div class="quick-topic" data-topic="Diabetes Mellitus principais pontos">Diabetes</div><div class="quick-topic" data-topic="Infarto Agudo do Miocárdio tratamento">IAM</div><div class="quick-topic" data-topic="Pneumonia diagnóstico">Pneumonia</div><div class="quick-topic" data-topic="Anemia ferropriva pediatria">Anemia</div></div>
            </div>
            <div class="typing-indicator" id="typing-indicator"><span>🧠 IA pensando</span><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>
            <div class="chat-input-container"><div class="chat-input-wrapper"><textarea class="chat-input" id="chat-input" placeholder="Digite sua pergunta sobre medicina..." rows="1"></textarea><button class="chat-send" id="chat-send"><i class="fas fa-paper-plane"></i></button></div></div>
        </div>
        <button class="chatbot-toggle" id="chatbot-toggle"><i class="fas fa-brain"></i></button>
    </div>

    <div class="modal" id="difficulty-modal"><div class="modal-content"><h3>Como foi estudar este tema?</h3><p>Avalie a dificuldade para melhorar suas revisões:</p><div class="difficulty-buttons"><button class="difficulty-btn difficulty-easy" data-difficulty="easy">😊 Fácil</button><button class="difficulty-btn difficulty-medium" data-difficulty="medium">😐 Médio</button><button class="difficulty-btn difficulty-hard" data-difficulty="hard">😰 Difícil</button></div></div></div>
    <div class="modal" id="confirmation-modal"><div class="modal-content"><h3>⚠️ Confirmar Reset</h3><p>Tem certeza que deseja resetar todo o progresso e configurações? Isso inclui suas conquistas!</p><p><strong>Esta ação não pode ser desfeita!</strong></p><div class="confirmation-buttons"><button class="btn btn-confirm" id="confirm-reset"><i class="fas fa-trash"></i> Sim, Resetar</button><button class="btn btn-cancel" id="cancel-reset"><i class="fas fa-times"></i> Cancelar</button></div></div></div>
    <div id="achievement-notification" class="achievement-notification"><i id="achievement-icon" class="fas fa-trophy"></i><div><h4 id="achievement-title">Conquista Desbloqueada!</h4><p id="achievement-desc">Descrição da conquista.</p></div></div>
    <div class="modal" id="ia-flashcard-modal"><div class="modal-content"><h3 id="ia-flashcard-title"></h3><p id="ia-resumo"></p><button class="btn btn-cancel" onclick="hideModal('ia-flashcard-modal')">Fechar</button></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =======================================================
        // 1. CONFIGURAÇÃO E LÓGICA DE AUTENTICAÇÃO FIREBASE
        // =======================================================
        const firebaseConfig = {
  apiKey: "AIzaSyBir93FINYYhBOnMCV0Qh2blD99r-ivOEQ",
  authDomain: "cronograma-b86f3.firebaseapp.com",
  projectId: "cronograma-b86f3",
  storageBucket: "cronograma-b86f3.firebasestorage.app",
  messagingSenderId: "914539081430",
  appId: "1:914539081430:web:e6ff59ae313ca01dd42377"
};

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // Elementos do DOM para Login/Registro
        const loginOverlay = document.getElementById('login-overlay');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const googleLoginBtn = document.getElementById('google-login');
        const logoutBtn = document.getElementById('logout-btn');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginError = document.getElementById('login-error');
        const loginLoading = document.getElementById('login-loading');
        const userNameDisplay = document.getElementById('user-name');
        const userAvatarDisplay = document.getElementById('user-avatar');

        const showLoading = (isLoading) => { loginLoading.style.display = isLoading ? 'block' : 'none'; };
        const showError = (message) => { loginError.textContent = message; loginError.style.display = 'block'; };
        const hideError = () => { loginError.style.display = 'none'; };

        // Event Listeners da UI de Login
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.classList.add('active');
            registerForm.classList.remove('active');
            hideError();
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.classList.add('active');
            loginForm.classList.remove('active');
            hideError();
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            hideError();
            showLoading(true);
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => showError("E-mail ou senha inválidos. Tente novamente."))
                .finally(() => showLoading(false));
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            hideError();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (password !== confirmPassword) return showError("As senhas não coincidem.");
            
            showLoading(true);
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Cria o perfil do usuário na coleção 'users'
                    db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                })
                .catch(error => {
                    if (error.code === 'auth/email-already-in-use') {
                        showError("Este e-mail já está cadastrado.");
                    } else {
                        showError("Erro ao criar conta. Verifique o e-mail ou tente novamente.");
                    }
                })
                .finally(() => showLoading(false));
        });
        
        googleLoginBtn.addEventListener('click', () => {
            hideError();
            showLoading(true);
            auth.signInWithPopup(googleProvider)
                .then(result => {
                    const user = result.user;
                    const userRef = db.collection('users').doc(user.uid);
                    // Cria o perfil do usuário apenas se ele não existir
                    return userRef.get().then(doc => {
                        if (!doc.exists) {
                            userRef.set({
                                name: user.displayName,
                                email: user.email,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    });
                })
                .catch(error => showError("Não foi possível fazer login com o Google."))
                .finally(() => showLoading(false));
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // =======================================================
        // 2. O "PORTEIRO" DA APLICAÇÃO - CONTROLE DE ESTADO DE AUTH
        // =======================================================
        auth.onAuthStateChanged(user => {
            if (user) {
                // ---- USUÁRIO LOGADO ----
                loginOverlay.classList.add('hidden'); // Esconde a tela de login

                // Pega dados do perfil do usuário da coleção 'users'
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userName = doc.data().name || "Usuário";
                        userNameDisplay.textContent = userName;
                        userAvatarDisplay.textContent = userName.charAt(0).toUpperCase();
                    }
                });

                // Carrega o progresso do usuário e inicia a aplicação principal
                loadUserProgressAndInitializeApp(user.uid);

            } else {
                // ---- USUÁRIO DESLOGADO ----
                loginOverlay.classList.remove('hidden'); // Mostra a tela de login
                // Limpa o conteúdo principal para evitar mostrar dados antigos
                document.getElementById('main-content').innerHTML = '';
            }
        });

        // =================================================================
        // 3. LÓGICA DE DADOS (FIRESTORE) E ESTADO GLOBAL
        // =================================================================
        
        // Objeto de estado global da aplicação
        let appState = {};

        // Função para CARREGAR os dados do Firestore e depois iniciar o app
        async function loadUserProgressAndInitializeApp(userId) {
            const docRef = db.collection('userProgress').doc(userId);
            const doc = await docRef.get();

            const defaultState = {
                sidebarOpen: false,
                sidebarCollapsed: false,
                minimalistMode: false,
                darkMode: false,
                pomodoroRunning: false,
                pomodoroTime: 25 * 60,
                pomodoroInterval: null,
                currentPomodoroType: 'focus',
                currentDifficultyTopic: null,
                currentSection: 'stats',
                charts: { completionBySubject: null, performanceByArea: null },
                completedTopics: {},
                topicDifficulties: {},
                lastReviewDates: {},
                customThemes: [], 
                performanceLog: [],
                userProfile: { xp: 0, level: 0, unlockedAchievements: {}, lastStudyDate: null, studyStreak: 0, completedPomodoros: 0 },
                scheduleConfig: { startDate: '2025-07-28', examDate: '2025-10-19', maxTopicsPerDay: 4 },
                allTopicsFlat: []
            };

            if (doc.exists) {
                const cloudData = doc.data();
                // Mescla os dados da nuvem com os padrões para evitar erros se algum campo faltar
                appState = {
                    ...defaultState,
                    ...cloudData,
                    // Garante que objetos aninhados também sejam mesclados corretamente
                    userProfile: { ...defaultState.userProfile, ...(cloudData.userProfile || {}) },
                    scheduleConfig: { ...defaultState.scheduleConfig, ...(cloudData.scheduleConfig || {}) },
                };
            } else {
                // Se o usuário não tem dados (primeiro login), usa o estado padrão
                appState = defaultState;
            }

            // Inicia a aplicação principal com o estado carregado ou padrão
            runMainApplication();
        }

        // Função para SALVAR todo o progresso no Firestore
        function saveProgressToFirestore() {
            const userId = auth.currentUser?.uid;
            if (!userId) return; // Não salva se não houver usuário

            // Seleciona apenas os dados que precisam ser persistidos na nuvem
            const dataToSave = {
                darkMode: appState.darkMode,
                minimalistMode: appState.minimalistMode,
                completedTopics: appState.completedTopics,
                topicDifficulties: appState.topicDifficulties,
                lastReviewDates: appState.lastReviewDates,
                customThemes: appState.customThemes,
                performanceLog: appState.performanceLog,
                userProfile: appState.userProfile,
                scheduleConfig: appState.scheduleConfig,
            };
            
            db.collection('userProgress').doc(userId).set(dataToSave, { merge: true })
                .catch(error => console.error("Erro ao salvar progresso no Firestore:", error));
        }


        // =================================================================
        // 4. LÓGICA PRINCIPAL DA APLICAÇÃO (ENCAPSULADA)
        // =================================================================
        function runMainApplication() {
            
            // DADOS E CONSTANTES DA APLICAÇÃO
            const originalScheduleData = [{theme:"Atenção Básica",area:"preventiva"},{theme:"Ética Médica (Aspectos gerais, sigilo)",area:"preventiva"},{theme:"SUS (Princípios, histórico, legislação)",area:"preventiva"},{theme:"Imunizações (Vacinas)",area:"preventiva"},{theme:"Epidemiologia (Indicadores, Vigilância, Estudos)",area:"preventiva"},{theme:"Assistência Pré-natal",area:"obstetricia"},{theme:"Rastreamentos (Câncer de colo, mama)",area:"preventiva"},{theme:"Planejamento familiar",area:"ginecologia"},{theme:"Conteúdo genital patológico (Vulvovaginites)",area:"ginecologia"},{theme:"Tuberculose",area:"clinica"},{theme:"Hanseníase",area:"clinica"},{theme:"Arboviroses (Dengue, Chikungunya, Zika)",area:"clinica"},{theme:"Leptospirose e Malária",area:"clinica"},{theme:"HIV/AIDS",area:"clinica"},{theme:"IST (Sífilis e Úlceras Genitais)",area:"ginecologia"},{theme:"Hipertensão Arterial Sistêmica (HAS)",area:"clinica"},{theme:"HTA Secundária",area:"clinica"},{theme:"Diabetes (Diagnóstico, classificação, tratamento)",area:"clinica"},{theme:"Dislipidemia",area:"clinica"},{theme:"Atendimento Inicial ao Politraumatizado (ABCDE)",area:"cirurgia"},{theme:"Trauma de Vias Aéreas",area:"cirurgia"},{theme:"Asma e Crise de Asma",area:"clinica"},{theme:"DPOC",area:"clinica"},{theme:"Puericultura",area:"pediatria"},{theme:"Aleitamento materno",area:"pediatria"},{theme:"Parto (Mecanismo e assistência)",area:"obstetricia"},{theme:"Relações uterofetais",area:"obstetricia"},{theme:"Hemorragias da 1ª metade da gestação",area:"obstetricia"},{theme:"Hemorragias da 2ª metade da gestação",area:"obstetricia"},{theme:"Síndromes Hipertensivas na Gestação",area:"obstetricia"},{theme:"Diabetes na Gestação",area:"obstetricia"},{theme:"Abdome Agudo (Apendicite)",area:"cirurgia"},{theme:"Abdome Agudo (Diverticulite)",area:"cirurgia"},{theme:"Puerpério e Hemorragia pós-parto",area:"obstetricia"},{theme:"Doenças Benignas da Mama",area:"ginecologia"},{theme:"Síndrome Coronariana Aguda",area:"clinica"},{theme:"Valvulopatias",area:"clinica"},{theme:"Arritmias",area:"clinica"},{theme:"Insuficiência Cardíaca",area:"clinica"},{theme:"Tromboembolia Pulmonar",area:"clinica"},{theme:"O derrame pleural",area:"clinica"},{theme:"Pneumonia",area:"clinica"},{theme:"Pneumonia na Infância",area:"pediatria"},{theme:"IVAS",area:"pediatria"},{theme:"Bronquiolite",area:"pediatria"},{theme:"Diarreia e Desidratação",area:"pediatria"},{theme:"Constipação na infância",area:"pediatria"},{theme:"Parasitoses Intestinais",area:"pediatria"},{theme:"Violência Doméstica e Sexual",area:"preventiva"},{theme:"Maus tratos",area:"preventiva"},{theme:"Ética: Declaração de Óbito",area:"preventiva"},{theme:"Abdome Agudo Obstrutivo",area:"cirurgia"},{theme:"Hérnias da parede abdominal",area:"cirurgia"},{theme:"Doenças orificiais",area:"cirurgia"},{theme:"Abdome Agudo Perfurativo, Vascular, Hemorrágico",area:"cirurgia"},{theme:"Pancreatite Aguda",area:"cirurgia"},{theme:"Cirurgia Pediátrica (Urologia, Gastro)",area:"cirurgia"},{theme:"Doenças congênitas",area:"pediatria"},{theme:"Trauma Torácico",area:"cirurgia"},{theme:"Trauma Abdominal",area:"cirurgia"},{theme:"Trauma Cervical e Pélvico",area:"cirurgia"},{theme:"TCE e TRM",area:"cirurgia"},{theme:"Ortopedia e Trauma de Extremidades",area:"cirurgia"},{theme:"Lombalgia",area:"clinica"},{theme:"Hepatites Virais",area:"clinica"},{theme:"Icterícia Neonatal",area:"pediatria"},{theme:"Doenças das vias biliares",area:"cirurgia"},{theme:"Doença do Refluxo Gastroesofágico",area:"clinica"},{theme:"Úlcera Péptica e H. pylori",area:"clinica"},{theme:"Câncer de Esôfago",area:"cirurgia"},{theme:"Doença Inflamatória Intestinal",area:"clinica"},{theme:"Síndrome do Intestino Irritável",area:"clinica"},{theme:"Câncer Colorretal",area:"cirurgia"},{theme:"Infecções e Gestação (TORCH, Sífilis, Toxoplasmose)",area:"obstetricia"},{theme:"HIV e gestação",area:"obstetricia"},{theme:"Triagem Neonatal (Teste do Pezinho)",area:"pediatria"},{theme:"Avaliação Neonatal",area:"pediatria"},{theme:"Reanimação Neonatal",area:"pediatria"},{theme:"Hipotireoidismo e Hipertireoidismo",area:"clinica"},{theme:"Nódulo e Câncer de Tireoide",area:"clinica"},{theme:"Anemias Carenciais (Ferropriva)",area:"clinica"},{theme:"Anemias Hemolíticas",area:"clinica"},{theme:"Neoplasias Hematológicas",area:"clinica"},{theme:"Doenças Exantemáticas",area:"pediatria"},{theme:"Meningites",area:"pediatria"},{theme:"Febre Reumática",area:"clinica"},{theme:"Ética: Medicina do Trabalho",area:"preventiva"},{theme:"Processo Saúde-Doença",area:"preventiva"},{theme:"Cuidados Paliativos",area:"preventiva"},{theme:"Transtornos do Humor",area:"psiquiatria"},{theme:"Transtornos de Ansiedade",area:"psiquiatria"},{theme:"Psiquiatria Geral",area:"psiquiatria"},{theme:"Doença Inflamatória Pélvica (DIP)",area:"ginecologia"},{theme:"Sangramento Uterino Anormal",area:"ginecologia"},{theme:"Amenorreia",area:"ginecologia"},{theme:"Câncer de Ovário",area:"ginecologia"},{theme:"Endometriose",area:"ginecologia"},{theme:"Síndrome dos Ovários Policísticos",area:"ginecologia"},{theme:"Infecção do Trato Urinário (ITU)",area:"clinica"},{theme:"ITU na Gestação",area:"obstetricia"},{theme:"ITU na Infância",area:"pediatria"},{theme:"Injúria Renal Aguda (IRA)",area:"clinica"},{theme:"Doenças Glomerulares",area:"clinica"},{theme:"Urologia geral",area:"cirurgia"},{theme:"Câncer de Próstata",area:"cirurgia"},{theme:"Cirurgia de Obesidade",area:"cirurgia"},{theme:"Cirurgia Vascular",area:"cirurgia"},{theme:"Revisão de Altíssima Prevalência (Preventiva)",area:"revisao"},{theme:"Revisão de Altíssima Prevalência (Clínica)",area:"revisao"},{theme:"Revisão de Altíssima Prevalência (Cirurgia)",area:"revisao"},{theme:"Revisão de Altíssima Prevalência (G.O./PEDS)",area:"revisao"},{theme:"Otorrinolaringologia",area:"cirurgia"},{theme:"Cefaleia",area:"clinica"},{theme:"Epilepsia e convulsão febril",area:"clinica"},{theme:"Doença de Parkinson",area:"clinica"},{theme:"Lúpus",area:"clinica"},{theme:"Artrite Reumatoide",area:"clinica"},{theme:"Fibromialgia",area:"clinica"},{theme:"SIMULADO COMPLETO 1",area:"revisao"},{theme:"Correção Detalhada do Simulado 1",area:"revisao"},{theme:"Revisão de Média Prevalência (Clínica)",area:"revisao"},{theme:"Revisão de Média Prevalência (Cirurgia/G.O.)",area:"revisao"},{theme:"Revisão de Média Prevalência (Peds/Preventiva)",area:"revisao"},{theme:"Intoxicações exógenas",area:"clinica"},{theme:"Acidentes por Animais Peçonhentos",area:"clinica"},{theme:"Queimados",area:"cirurgia"},{theme:"Raiva e tétano",area:"preventiva"},{theme:"Doação de órgãos e morte encefálica",area:"preventiva"},{theme:"Geriatria",area:"clinica"},{theme:"Perioperatório - exames, medicamentos, segurança",area:"cirurgia"},{theme:"Técnica cirúrgica e Corpo estranho",area:"cirurgia"},{theme:"Distúrbios da hemostasia",area:"clinica"},{theme:"SIMULADO COMPLETO 2",area:"revisao"},{theme:"Correção Detalhada do Simulado 2",area:"revisao"},{theme:"Revisão por Fraqueza (Simulados)",area:"revisao"},{theme:"Revisão por Fraqueza (Questões)",area:"revisao"},{theme:"Infertilidade",area:"ginecologia"},{theme:"Prematuridade",area:"pediatria"},{theme:"Restrição de Crescimento Fetal",area:"obstetricia"},{theme:"Vitalidade Fetal",area:"obstetricia"},{theme:"Rotura prematura de membranas",area:"obstetricia"},{theme:"Revisão Geral Rápida (Resumos e Flashcards)",area:"revisao"},{theme:"Revisão Leve (Fórmulas, escores, algoritmos)",area:"revisao"},{theme:"SIMULADO COMPLETO 3 (Opcional)",area:"revisao"},{theme:"Correção Detalhada do Simulado 3",area:"revisao"},{theme:"Anestesia",area:"cirurgia"},{theme:"Cirurgia plástica - câncer de pele melanoma e não melanoma",area:"cirurgia"},{theme:"Sepse",area:"clinica"},{theme:"Monoartrite aguda - gota e artrite infecciosa",area:"clinica"},{theme:"Leishmaniose",area:"clinica"},{theme:"PBLS e PALS",area:"pediatria"},{theme:"Desconforto respiratório do recém-nascido",area:"pediatria"},{theme:"Distúrbios do crescimento e desenvolvimento",area:"pediatria"},{theme:"Cardiopatias congênitas",area:"pediatria"},{theme:"Isoimunização RH",area:"obstetricia"},{theme:"Patologias vulvares",area:"ginecologia"},{theme:"Saúde da Família",area:"preventiva"},{theme:"Desnutrição e obesidade",area:"clinica"},{theme:"Tumores de pâncreas",area:"cirurgia"},{theme:"Revisão Final: Pontos fracos e temas de alta prevalência",area:"revisao"},{theme:"Revisão Final: Mais pontos fracos e temas de alta prevalência",area:"revisao"},{theme:"Revisão Leve: Confiança no processo",area:"revisao"},{theme:"Descanso e Organização",area:"revisao"},{theme:"DESCANSO TOTAL",area:"revisao"}];

            // CONFIGURAÇÃO DO CHATBOT MÉDICO
            const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // SUBSTITUA PELA SUA API KEY DO GEMINI
            const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
            const medicalChatbot = {
                isOpen: false,
                conversationHistory: JSON.parse(localStorage.getItem('chatbotHistory')) || [],
                systemPrompt: "Você é um assistente de estudos para a prova de residência médica Revalida. Responda de forma objetiva, didática e direta ao ponto, como um colega experiente. Foco total em conteúdo médico relevante para a prova.",
                async sendMessage(userMessage){try{const e=await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:this.systemPrompt+"\n\nPergunta do usuário: "+userMessage}]}],generationConfig:{temperature:.7,maxOutputTokens:800}})});if(!e.ok)throw new Error(`Erro na API: ${e.status}`);const t=await e.json();return t?.candidates?.[0]?.content?.parts?.[0]?.text||"Desculpe, não consegui processar sua pergunta. Tente novamente."}catch(e){return console.error("Erro na chamada da API Gemini:",e),"Erro de conexão com a IA. Verifique sua internet e tente novamente."}},
                saveHistory(){localStorage.setItem('chatbotHistory',JSON.stringify(this.conversationHistory))},
                addMessage(e,t=!1){const s={text:e,isUser:t,timestamp:(new Date).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})};this.conversationHistory.push(s),this.saveHistory(),this.renderMessage(s)},
                renderMessage(e){const t=document.getElementById("chat-messages"),s=document.createElement("div");s.className=`message ${e.isUser?"user":"bot"}`,s.innerHTML=`\n            <div class="message-bubble">\n                ${e.text.replace(/\n/g,"<br>")}\n            </div>\n            <div class="message-time">${e.timestamp}</div>\n        `,e.isUser&&1===this.conversationHistory.filter(e=>e.isUser).length&&t.querySelector(".quick-topics")?.remove(),t.appendChild(s),t.scrollTop=t.scrollHeight},
                showTyping(){document.getElementById("typing-indicator").classList.add("active");const e=document.getElementById("chat-messages");e.scrollTop=e.scrollHeight},
                hideTyping(){document.getElementById("typing-indicator").classList.remove("active")},
                async handleUserMessage(e){if(e.trim()){this.addMessage(e,!0),this.showTyping();const t=await this.sendMessage(e);this.hideTyping(),this.addMessage(t,!1),document.getElementById("chat-input").value="",this.adjustTextareaHeight()}},
                adjustTextareaHeight(){const e=document.getElementById("chat-input");e.style.height="auto",e.style.height=Math.min(e.scrollHeight,100)+"px"},
                toggle(){this.isOpen=!this.isOpen;const e=document.getElementById("chatbot-container"),t=document.getElementById("chatbot-toggle");e.classList.toggle("active",this.isOpen),t.classList.toggle("active",this.isOpen),this.isOpen&&(document.getElementById("chat-input").focus(),this.loadHistory())},
                loadHistory(){const e=document.getElementById("chat-messages"),t=e.querySelector(".message.bot"),s=e.querySelector(".quick-topics");e.innerHTML="",t&&e.appendChild(t),s&&0===this.conversationHistory.filter(e=>e.isUser).length&&e.appendChild(s),this.conversationHistory.forEach(e=>{this.renderMessage(e)})},
                init(){const e=document.getElementById("chatbot-toggle"),t=document.getElementById("chatbot-close"),s=document.getElementById("chat-send"),o=document.getElementById("chat-input");e.addEventListener("click",()=>this.toggle()),t.addEventListener("click",()=>this.toggle()),s.addEventListener("click",()=>{const e=o.value.trim();e&&this.handleUserMessage(e)}),o.addEventListener("keydown",e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=o.value.trim();t&&this.handleUserMessage(t)}}),o.addEventListener("input",()=>this.adjustTextareaHeight()),document.querySelectorAll(".quick-topic").forEach(e=>{e.addEventListener("click",()=>{this.handleUserMessage(e.dataset.topic)})}),document.addEventListener("click",e=>{this.isOpen&&!e.target.closest(".medical-chatbot")&&this.toggle()})}
            };

            // GAMIFICAÇÃO: NÍVEIS E CONQUISTAS
            const studentLevels = [ { title: "Estudante Iniciante", avatar: "👶", xpRequired: 0 }, { title: "Interno Virtual", avatar: "👨‍⚕️", xpRequired: 100 }, { title: "R1 Clínico", avatar: "👩‍⚕️", xpRequired: 200 }, { title: "R2 Cirúrgico", avatar: "🧑‍⚕️", xpRequired: 350 }, { title: "R3 Especialista", avatar: "👨‍🔬", xpRequired: 550 }, { title: "Especialista Júnior", avatar: "👩‍🔬", xpRequired: 800 }, { title: "Mestre em Medicina", avatar: "👩‍🎓", xpRequired: 1500 }, { title: "Lenda Médica", avatar: "🦸", xpRequired: 3300 }];
            const XP_VALUES = { completeTopic: 15, dailyStreak: 5, pomodoroComplete: 3, performanceEntry: 20, achievementUnlocked: 50 };
            const achievements = {
                clinicoRaiz: { title: "Clínico Raiz", description: "Finalizou todos os temas de Clínica Médica.", icon: "fas fa-stethoscope", category: "area", check: (s) => checkAreaCompletion(s, 'clinica') },
                goWarrior: { title: "GO Warrior", description: "Finalizou Ginecologia e Obstetrícia.", icon: "fas fa-baby-carriage", category: "area", check: (s) => checkAreaCompletion(s, 'ginecologia') && checkAreaCompletion(s, 'obstetricia') },
                miniCirurgiao: { title: "Mini-Cirurgião", description: "Completou os temas de Cirurgia Geral.", icon: "fas fa-scalpel", category: "area", check: (s) => checkAreaCompletion(s, 'cirurgia') },
                pediatraMirim: { title: "Pediatra Mirim", description: "Concluiu todos os temas de Pediatria.", icon: "fas fa-child", category: "area", check: (s) => checkAreaCompletion(s, 'pediatria') },
                mestrePreventiva: { title: "Mestre da Preventiva", description: "Terminou os temas de Saúde Coletiva.", icon: "fas fa-users", category: "area", check: (s) => checkAreaCompletion(s, 'preventiva') },
                psiquiatraHonorario: { title: "Psiquiatra Honorário", description: "Finalizou os temas de Psiquiatria.", icon: "fas fa-brain", category: "area", check: (s) => checkAreaCompletion(s, 'psiquiatria') },
                leaoSimulado: { title: "Leão de Simulado", description: "Fez 5 registros de simulado/questões.", icon: "fas fa-award", category: "produtividade", check: (s) => s.performanceLog.length >= 5 },
                focoTotal: { title: "Foco Total", description: "Usou o Pomodoro por 10 ciclos completos.", icon: "fas fa-clock", category: "produtividade", check: (s) => s.userProfile.completedPomodoros >= 10 },
                chatbotExplorer: { title: "Explorador IA", description: "Fez 10 perguntas para a IA médica.", icon: "fas fa-robot", category: "produtividade", check: () => (JSON.parse(localStorage.getItem('chatbotHistory')) || []).filter(m => m.isUser).length >= 10 },
                streak5: { title: "5 Dias no Ritmo", description: "Cinco dias seguidos estudando.", icon: "fas fa-fire", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 5 },
                streak14: { title: "Study Beast", description: "14 dias seguidos sem falhar.", icon: "fas fa-meteor", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 14 },
            };

            // FUNÇÃO CENTRALIZADA PARA SALVAR E CHECAR CONQUISTAS
            function saveAndCheck(eventData = null) {
                checkAllAchievements(eventData);
                saveProgressToFirestore(); // A principal mudança é chamar a função de salvar no Firestore
            }

            // FUNÇÕES DE LÓGICA DO CRONOGRAMA
            function prepareAllTopics() { appState.allTopicsFlat = [...originalScheduleData, ...appState.customThemes]; }
            function regenerateAndRenderSchedule() { prepareAllTopics(); const studyDays = getStudyDays(appState.scheduleConfig.startDate, appState.scheduleConfig.examDate); const distributionResult = distributeTopics(appState.allTopicsFlat, studyDays, appState.scheduleConfig.maxTopicsPerDay); const newSchedule = buildNewSchedule(distributionResult.distributedDays); generateDynamicWeeks(newSchedule); updateAllStatsAndCharts(); }
            function getStudyDays(startDateStr, endDateStr) { const studyDays = []; let currentDate = new Date(`${startDateStr}T12:00:00Z`); const endDate = new Date(`${endDateStr}T12:00:00Z`); while (currentDate <= endDate) { if (currentDate.getUTCDay() !== 0) { studyDays.push(new Date(currentDate)); } currentDate.setUTCDate(currentDate.getUTCDate() + 1); } return studyDays; }
            function distributeTopics(topics, studyDays, maxTopicsPerDay) { let topicIndex = 0; const distributedDays = []; for (let dayIndex = 0; dayIndex < studyDays.length; dayIndex++) { const weekIndex = Math.floor(dayIndex / 6); const topicsForThisDay = Math.min(weekIndex + 1, maxTopicsPerDay); const assignedTopics = []; if (topicIndex < topics.length) { for (let i = 0; i < topicsForThisDay && topicIndex < topics.length; i++) { assignedTopics.push(topics[topicIndex]); topicIndex++; } } distributedDays.push({ date: studyDays[dayIndex], topics: assignedTopics }); } return { distributedDays: distributedDays.filter(d => d.topics.length > 0) }; }
            function buildNewSchedule(distributedDays) { if (!distributedDays || distributedDays.length === 0) return []; const newSchedule = []; let weekChunk = []; distributedDays.sort((a, b) => a.date - b.date); for (const day of distributedDays) { if (weekChunk.length > 0 && day.date.getUTCDay() === 1) { newSchedule.push(weekChunk); weekChunk = []; } weekChunk.push(day); } if (weekChunk.length > 0) newSchedule.push(weekChunk); return newSchedule.map((weekDays, index) => { const dayMap = new Map(weekDays.map(d => [d.date.getUTCDay(), d])); let firstDayOfWeek = new Date(weekDays[0].date); firstDayOfWeek.setUTCDate(firstDayOfWeek.getUTCDate() - (firstDayOfWeek.getUTCDay() - 1)); const fullWeekDays = []; for (let i = 1; i <= 7; i++) { const currentDay = new Date(firstDayOfWeek); currentDay.setUTCDate(firstDayOfWeek.getUTCDate() + i - 1); const dayData = dayMap.get(currentDay.getUTCDay()); if (currentDay.getUTCDay() === 0) { fullWeekDays.push({ date: currentDay, themes: [{ theme: 'DESCANSO', area: 'rest' }], isRest: true }); } else { fullWeekDays.push({ date: currentDay, themes: dayData ? dayData.topics : [], isRest: false }); } } const weekStartDate = fullWeekDays[0].date; const weekEndDate = fullWeekDays[5].date; return { week: index + 1, title: `Semana ${index + 1}: ${formatDate(weekStartDate)} - ${formatDate(weekEndDate)}`, days: fullWeekDays }; }); }

            // GAMIFICAÇÃO: LÓGICA E CHECAGEM
            function addXp(points, source = 'generic') { const oldLevel = getUserLevel(); appState.userProfile.xp += points; const newLevel = getUserLevel(); if (newLevel > oldLevel) { appState.userProfile.level = newLevel; showLevelUpNotification(newLevel); addXp(newLevel * 10, 'level-up'); } updateHeaderUI(); /* A chamada para salvar foi movida para saveAndCheck */ }
            function getUserLevel() { for (let i = studentLevels.length - 1; i >= 0; i--) { if (appState.userProfile.xp >= studentLevels[i].xpRequired) { return i; } } return 0; }
            function showLevelUpNotification(newLevel) { /* ... (código mantido) ... */ }
            function updateHeaderUI() { const currentLevel = getUserLevel(); const levelData = studentLevels[currentLevel]; const nextLevel = currentLevel < studentLevels.length - 1 ? studentLevels[currentLevel + 1] : null; const progressPercentage = nextLevel ? Math.round(((appState.userProfile.xp - levelData.xpRequired) / (nextLevel.xpRequired - levelData.xpRequired)) * 100) : 100; document.getElementById('user-level').innerHTML = `<div class="level-container"><div class="level-avatar">${levelData.avatar}</div><div><div>${levelData.title}</div><div class="level-badge">Nível ${currentLevel}</div></div></div>`; document.getElementById('xp-bar-fill').style.width = `${progressPercentage}%`; document.getElementById('xp-bar-fill').parentElement.title = `${appState.userProfile.xp} XP (${progressPercentage}% para o próximo nível)`; document.getElementById('streak-count').textContent = appState.userProfile.studyStreak; }
            function unlockAchievement(key) { if (!appState.userProfile.unlockedAchievements[key]) { addXp(XP_VALUES.achievementUnlocked, 'achievement'); appState.userProfile.unlockedAchievements[key] = new Date().toISOString(); showAchievementNotification(achievements[key]); if (appState.currentSection === 'achievements') { renderAchievementsPage(); } } }
            function showAchievementNotification(achievement) { const notification = document.getElementById('achievement-notification'); notification.querySelector('#achievement-icon').className = `${achievement.icon} fa-2x`; notification.querySelector('#achievement-title').textContent = achievement.title; notification.querySelector('#achievement-desc').textContent = achievement.description; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 5000); }
            function checkAllAchievements(eventData = null) { for (const key in achievements) { if (!appState.userProfile.unlockedAchievements[key]) { if (achievements[key].check(appState, eventData)) { unlockAchievement(key); } } } /* A chamada para salvar foi movida para saveAndCheck */ }
            function renderAchievementsPage() { const container = document.getElementById('achievements-grid'); if (!container) return; const categories = { area: [], produtividade: [], consistencia: [] }; for (const key in achievements) { categories[achievements[key].category].push({ key, ...achievements[key] }); } container.innerHTML = Object.keys(categories).map(catKey => { if (categories[catKey].length === 0) return ''; const categoryName = catKey.charAt(0).toUpperCase() + catKey.slice(1); const itemsHtml = categories[catKey].map(item => { const unlocked = appState.userProfile.unlockedAchievements[item.key]; const unlockedDate = unlocked ? `Desbloqueado em: ${new Date(unlocked).toLocaleDateString('pt-BR')}` : ''; return `<div class="achievement-item ${unlocked ? 'unlocked' : ''}" title="${item.description}"><i class="achievement-icon ${item.icon}"></i><div class="achievement-details"><h4>${item.title}</h4><p>${item.description}</p><p class="unlock-date">${unlockedDate}</p></div></div>`; }).join(''); return `<div class="achievement-category"><h3>${categoryName}</h3>${itemsHtml}</div>`; }).join(''); }
            function checkAreaCompletion(state, area) { const topicsOfArea = state.allTopicsFlat.filter(t => t.area === area); if (topicsOfArea.length === 0) return false; return topicsOfArea.every(t => state.completedTopics[t.theme]); }

            // UI GERAL E INTERAÇÕES
            function toggleSidebar() { appState.sidebarOpen = !appState.sidebarOpen; document.getElementById('sidebar').classList.toggle('open'); document.getElementById('main-content').classList.toggle('sidebar-open'); document.getElementById('header').classList.toggle('sidebar-open'); /* Não salvamos isso no Firestore */ }
            function toggleTheme() { appState.darkMode = !appState.darkMode; document.documentElement.setAttribute('data-theme', appState.darkMode ? 'dark' : ''); document.querySelector('#theme-toggle i').className = appState.darkMode ? 'fas fa-sun' : 'fas fa-moon'; saveProgressToFirestore(); updateAllStatsAndCharts(); }
            function toggleMinimalistMode() { appState.minimalistMode = !appState.minimalistMode; document.body.classList.toggle('minimalist-mode', appState.minimalistMode); document.querySelector('#minimalist-toggle i').className = appState.minimalistMode ? 'fas fa-expand' : 'fas fa-compress'; saveProgressToFirestore(); }
            function showModal(modalId) { document.getElementById(modalId).classList.add('active'); }
            function hideModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
            function showSection(sectionId) { document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active')); const section = document.getElementById(`${sectionId}-section`); if (section) { section.classList.add('active'); appState.currentSection = sectionId; } window.scrollTo(0, 0); if (sectionId === 'stats') updateAllStatsAndCharts(); if (sectionId === 'achievements') renderAchievementsPage(); if (sectionId === 'performance') { updateStats(); populatePerformanceTopicSelect(); renderPerformanceHistory(); } if (sectionId === 'progress') updateProgressLists(); if (sectionId === 'review') updateFutureReviews(); }
            function updateAllStatsAndCharts() { updateStats(); updateStatusIcons(); if (appState.currentSection === 'stats') { createCompletionChart(); createPerformanceByAreaChart(); } }
            
            // FUNÇÕES DE EVENTOS E LÓGICA
            function addTopicEventListeners() { document.querySelectorAll('.topic-checkbox').forEach(checkbox => { checkbox.addEventListener('change', function () { const topic = this.dataset.topic; const isChecked = this.checked; document.querySelectorAll(`input.topic-checkbox[data-topic="${topic}"]`).forEach(box => { const text = box.closest('.topic-row').querySelector('.topic-text'); box.checked = isChecked; text.classList.toggle('completed', isChecked); }); if (isChecked) { appState.completedTopics[topic] = true; appState.lastReviewDates[topic] = new Date().toISOString(); showModal('difficulty-modal'); appState.currentDifficultyTopic = topic; addXp(XP_VALUES.completeTopic, 'topic-complete'); updateStudyStreak(); } else { delete appState.completedTopics[topic]; delete appState.lastReviewDates[topic]; delete appState.topicDifficulties[topic]; } saveAndCheck({ type: 'completion', topic: topic }); updateAllStatsAndCharts(); }); }); }
            function updateStudyStreak() { const today = new Date().toISOString().slice(0, 10); const lastDate = appState.userProfile.lastStudyDate; if (!lastDate || lastDate !== today) { const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); if (lastDate === yesterday.toISOString().slice(0, 10)) { appState.userProfile.studyStreak++; addXp(XP_VALUES.dailyStreak * appState.userProfile.studyStreak, 'streak'); } else { appState.userProfile.studyStreak = 1; } appState.userProfile.lastStudyDate = today; } }
            function generateDynamicWeeks(schedule) { const weeksContainer = document.getElementById('weeks'); weeksContainer.innerHTML = ''; if (!schedule || schedule.length === 0) { weeksContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum cronograma para exibir.</p>'; return; } const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado']; schedule.forEach(week => { const weekElement = document.createElement('div'); weekElement.className = 'week-section fade-in'; const maxThemesInWeek = Math.max(0, ...week.days.map(d => d.isRest ? 0 : (d.themes ? d.themes.length : 0))); let tableHeaderHTML = `<thead><tr><th>Dia</th>${Array.from({length: maxThemesInWeek}, (_, i) => `<th>Tema ${i+1}</th>`).join('')}</tr></thead>`; let tableBodyHTML = '<tbody>'; week.days.forEach(day => { const dayName = dayNames[day.date.getUTCDay()]; if (day.isRest) { tableBodyHTML += `<tr class="rest-day"><td colspan="${1 + maxThemesInWeek}">${day.themes[0].theme}</td></tr>`; } else { tableBodyHTML += `<tr><td><b>${dayName}</b><br>${formatDate(day.date)}</td>`; if (day.themes.length > 0) { for (let i = 0; i < maxThemesInWeek; i++) { const topic = day.themes[i]; if (topic) { const topicId = (topic.theme + i).replace(/[^a-zA-Z0-9]/g, ""); tableBodyHTML += `<td><div class="topic-row"><input type="checkbox" class="topic-checkbox" id="chk-${topicId}" ${appState.completedTopics[topic.theme] ? "checked" : ""} data-topic="${topic.theme}"><label class="topic-text ${appState.completedTopics[topic.theme] ? "completed" : ""}" for="chk-${topicId}">${topic.theme}</label><span class="area-badge area-${topic.area}">${getAreaName(topic.area)}</span><button class="btn-ia" onclick="gerarFlashcardIA('${topic.theme.replace(/'/g, "\\'")}')">🤖 IA</button></div></td>`; } else { tableBodyHTML += '<td>-</td>'; } } } else { tableBodyHTML += `<td colspan="${maxThemesInWeek}"><i>Dia livre</i></td>`; } tableBodyHTML += '</tr>'; } }); tableBodyHTML += '</tbody>'; weekElement.innerHTML = `<div class="week-header"><span>${week.title}</span><i class="fas fa-chevron-down"></i></div><div class="week-content"><table class="week-table">${tableHeaderHTML}${tableBodyHTML}</table></div>`; weeksContainer.appendChild(weekElement); weekElement.querySelector('.week-header').addEventListener('click', function () { this.nextElementSibling.classList.toggle('collapsed'); this.querySelector('i').className = this.nextElementSibling.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-down'; }); }); addTopicEventListeners(); updateStatusIcons(); }
            
            // DEMAIS FUNÇÕES (mantidas)
            function getAreaName(area) { const names = { preventiva: "PREV", pediatria: "PED", ginecologia: "GIN", obstetricia: "OBS", clinica: "CLM", cirurgia: "CIR", psiquiatria: "PSI", revisao: "REV", rest: "Off" }; return names[area] || "Geral"; }
            function getAreaIcon(area) { const icons = { preventiva: "fas fa-users", pediatria: "fas fa-baby", ginecologia: "fas fa-venus", obstetricia: "fas fa-baby-carriage", clinica: "fas fa-stethoscope", cirurgia: "fas fa-scalpel", psiquiatria: "fas fa-brain", revisao: "fas fa-star", rest: "fas fa-couch" }; return icons[area] || "fas fa-book-medical"; }
            function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return ""; const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); }
            function startPomodoro(){if(!appState.pomodoroRunning){appState.pomodoroRunning=!0;appState.pomodoroInterval=setInterval(updatePomodoro,1e3);document.getElementById("pomodoro-start").disabled=!0;document.getElementById("pomodoro-pause").disabled=!1}}
            function pausePomodoro(){if(appState.pomodoroRunning){clearInterval(appState.pomodoroInterval);appState.pomodoroRunning=!1;document.getElementById("pomodoro-start").disabled=!1;document.getElementById("pomodoro-pause").disabled=!0}}
            function resetPomodoro(){const e="focus"===appState.currentPomodoroType;pausePomodoro();const t=parseInt(document.getElementById(e?"focus-time":"break-time").value)|| (e?25:5);appState.pomodoroTime=60*t,updatePomodoroDisplay(),document.getElementById("pomodoro-start").disabled=!1,document.getElementById("pomodoro-pause").disabled=!0}
            function updatePomodoro(){appState.pomodoroTime--,updatePomodoroDisplay(),appState.pomodoroTime<0&&("focus"===appState.currentPomodoroType?(appState.userProfile.completedPomodoros++,addXp(XP_VALUES.pomodoroComplete,"pomodoro"),appState.currentPomodoroType="break",alert("Foco finalizado! Hora da pausa.")):(appState.currentPomodoroType="focus",alert("Pausa finalizada! Hora de focar.")),saveAndCheck(),resetPomodoro())}
            function updatePomodoroDisplay() { const minutes = Math.floor(appState.pomodoroTime / 60); const seconds = appState.pomodoroTime % 60; document.getElementById('pomodoro-display').textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`; }
            function updateStats() { prepareAllTopics(); const totalTopics = appState.allTopicsFlat.filter(t => t.area !== 'rest' && t.area !== 'revisao').length; const completedCount = Object.keys(appState.completedTopics).length; const percentage = totalTopics > 0 ? Math.round((completedCount / totalTopics) * 100) : 0; document.getElementById('completed-count').textContent = completedCount; document.getElementById('progress-fill').style.width = `${percentage}%`; document.getElementById('progress-percentage').textContent = `${percentage}% de ${totalTopics} temas`; updateCountdown(); updateAverageDifficulty(); }
            function updateCountdown() { const examDate = new Date(`${appState.scheduleConfig.examDate}T12:00:00Z`); const today = new Date(); const diffTime = examDate - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); document.getElementById('days-left').textContent = diffDays > 0 ? diffDays : 0; }
            function updateAverageDifficulty() { const difficulties = Object.values(appState.topicDifficulties); if (difficulties.length === 0) { document.getElementById('avg-difficulty').textContent = '-'; return; } const difficultyMap = { easy: 1, medium: 2, hard: 3 }; const avg = difficulties.reduce((sum, diff) => sum + difficultyMap[diff], 0) / difficulties.length; document.getElementById('avg-difficulty').textContent = avg < 1.5 ? 'Fácil' : avg < 2.5 ? 'Médio' : 'Difícil'; }
            function updateStatusIcons() { document.querySelectorAll('.topic-checkbox').forEach(checkbox => { const topic = checkbox.dataset.topic; if (appState.completedTopics[topic]) { checkbox.checked = true; checkbox.closest('.topic-row').querySelector('.topic-text').classList.add('completed'); } else { checkbox.checked = false; checkbox.closest('.topic-row').querySelector('.topic-text').classList.remove('completed'); } }); }
            function createCompletionChart(){const t=document.getElementById("graficoPorMateria")?.getContext("2d");if(t&&document.getElementById("stats-section").classList.contains("active")){appState.charts.completionBySubject&&appState.charts.completionBySubject.destroy();const e={},a=["preventiva","pediatria","ginecologia","obstetricia","clinica","cirurgia","psiquiatria","revisao"];a.forEach(t=>{e[t]={total:0,feitos:0,cor:getComputedStyle(document.documentElement).getPropertyValue(`--area-${t}`).trim()||"#607D8B",nome:getAreaName(t)}}),appState.allTopicsFlat.forEach(t=>{e[t.area]&&(e[t.area].total++,appState.completedTopics[t.theme]&&e[t.area].feitos++)});const s=[],o=[],r=[];for(let t in e)e[t].total>0&&(s.push(e[t].nome),o.push(Math.round(e[t].feitos/e[t].total*100)),r.push(e[t].cor));const i=appState.darkMode,n=i?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.05)",l=i?"#f5f5f5":"#666";appState.charts.completionBySubject=new Chart(t,{type:"bar",data:{labels:s,datasets:[{label:"% Concluído",data:o,backgroundColor:r,borderRadius:5}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1}},scales:{y:{ticks:{color:l},grid:{display:!1}},x:{beginAtZero:!0,max:100,ticks:{color:l,callback:t=>`${t}%`},grid:{color:n}}}}})}}
            function createPerformanceByAreaChart() { /* ... (código mantido) ... */ }
            function updateProgressLists() { /* ... (código mantido) ... */ }
            function updateFutureReviews() { /* ... (código mantido) ... */ }
            function populatePerformanceTopicSelect() { const select = document.getElementById('perf-topic-select'); if (!select) return; const areas = {}; appState.allTopicsFlat.forEach(topic => { if (topic.area === 'rest') return; if (!areas[topic.area]) areas[topic.area] = []; areas[topic.area].push(topic.theme); }); select.innerHTML = '<option value="">Selecione um tema...</option>'; for (const areaId in areas) { const optgroup = document.createElement('optgroup'); optgroup.label = getAreaName(areaId).toUpperCase(); areas[areaId].sort().forEach(themeName => { const option = document.createElement('option'); option.value = themeName; option.textContent = themeName; optgroup.appendChild(option); }); select.appendChild(optgroup); } }
            function savePerformanceEntry() { const date = document.getElementById('perf-date').value; const topic = document.getElementById('perf-topic-select').value; const attempted = parseInt(document.getElementById('perf-questions-attempted').value); const correct = parseInt(document.getElementById('perf-questions-correct').value); if (!date || !topic || isNaN(attempted) || isNaN(correct) || correct > attempted || attempted <= 0) { alert('Preencha todos os campos corretamente.'); return; } const newEntry = { id: Date.now(), date, topic, attempted, correct }; appState.performanceLog.push(newEntry); addXp(XP_VALUES.performanceEntry, 'performance'); updateStudyStreak(); saveAndCheck({ type: 'simulado' }); renderPerformanceHistory(); document.getElementById('perf-topic-select').value = ""; document.getElementById('perf-questions-attempted').value = ""; document.getElementById('perf-questions-correct').value = ""; alert('Registro salvo!'); }
            function renderPerformanceHistory() { const container = document.getElementById('performance-history-container'); if (!container) return; if (appState.performanceLog.length === 0) { container.innerHTML = '<p class="config-hint" style="text-align: center; padding: 20px;">Nenhum registro de desempenho.</p>'; return; } let tableHTML = `<table class="performance-table"><thead><tr><th>Data</th><th>Tema</th><th>Área</th><th>Questões</th><th>Acertos</th><th>%</th><th>Ações</th></tr></thead><tbody>`; [...appState.performanceLog].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => { const topicDetails = appState.allTopicsFlat.find(t => t.theme === entry.topic); const area = topicDetails ? topicDetails.area : 'N/A'; const percentage = Math.round((entry.correct / entry.attempted) * 100); let percClass = percentage >= 80 ? 'good' : percentage < 60 ? 'bad' : 'medium'; tableHTML += `<tr><td>${formatDate(new Date(entry.date + 'T12:00:00Z'))}</td><td>${entry.topic}</td><td><span class="area-badge area-${area}">${getAreaName(area)}</span></td><td>${entry.attempted}</td><td>${entry.correct}</td><td class="percentage-col ${percClass}">${percentage}%</td><td><button class="btn btn-danger delete-perf-entry" data-id="${entry.id}"><i class="fas fa-trash"></i></button></td></tr>`; }); tableHTML += '</tbody></table>'; container.innerHTML = tableHTML; document.querySelectorAll('.delete-perf-entry').forEach(btn => { btn.addEventListener('click', function () { if (confirm('Tem certeza?')) { appState.performanceLog = appState.performanceLog.filter(entry => entry.id !== parseInt(this.dataset.id)); renderPerformanceHistory(); saveProgressToFirestore(); } }); }); }
            function applyConfigurations() { const startDate = document.getElementById('start-date').value; const examDate = document.getElementById('exam-date').value; const maxTopicsPerDay = parseInt(document.getElementById('max-topics-day').value); if (!startDate || !examDate || isNaN(maxTopicsPerDay) || new Date(startDate) >= new Date(examDate)) { alert('Verifique as configurações.'); return; } appState.scheduleConfig = { startDate, examDate, maxTopicsPerDay }; saveProgressToFirestore(); regenerateAndRenderSchedule(); alert('Cronograma atualizado!'); showSection('weeks'); }
            function addCustomTheme() { const nameInput = document.getElementById('custom-theme-name'); const themeName = nameInput.value.trim(); const themeArea = document.getElementById('custom-theme-area').value; if (!themeName) return alert('Digite o nome do tema.'); if ([...originalScheduleData, ...appState.customThemes].some(t => t.theme.toLowerCase() === themeName.toLowerCase())) return alert('Tema já existe.'); appState.customThemes.push({ theme: themeName, area: themeArea }); saveProgressToFirestore(); nameInput.value = ""; renderCustomThemesList(); }
            function removeCustomTheme(themeNameToRemove) { appState.customThemes = appState.customThemes.filter(theme => theme.theme !== themeNameToRemove); saveProgressToFirestore(); renderCustomThemesList(); }
            function renderCustomThemesList() { const list = document.getElementById('custom-themes-list'); list.innerHTML = '<h5>Seus Temas:</h5>'; if(appState.customThemes.length === 0) { list.innerHTML = '<p class="config-hint">Nenhum tema personalizado.</p>'; return; } appState.customThemes.forEach(theme => { const item = document.createElement('div'); item.className = 'custom-theme-item'; item.innerHTML = `<span><span class="area-badge area-${theme.area}">${getAreaName(theme.area)}</span> ${theme.theme}</span><button class="btn btn-danger" data-theme-name="${theme.theme}"><i class="fas fa-times"></i></button>`; item.querySelector('button').onclick = () => removeCustomTheme(theme.theme); list.appendChild(item); }); }
            window.markAsReviewed = function (topic) { appState.lastReviewDates[topic] = new Date().toISOString(); addXp(5); updateStudyStreak(); saveAndCheck({ type: 'review', topic: topic }); if (appState.currentSection === 'review') updateFutureReviews(); };
            window.gerarFlashcardIA = async function(tema) { /* ... (código mantido) ... */ }

            // INICIALIZAÇÃO DA INTERFACE DA APLICAÇÃO
            function initializeEventListeners() {
                document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
                document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
                document.getElementById('minimalist-toggle').addEventListener('click', toggleMinimalistMode);
                document.getElementById('pomodoro-start').addEventListener('click', startPomodoro);
                document.getElementById('pomodoro-pause').addEventListener('click', pausePomodoro);
                document.getElementById('pomodoro-reset').addEventListener('click', resetPomodoro);
                document.querySelectorAll('.sidebar-menu a[data-section]').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showSection(link.dataset.section); }); });
                document.getElementById('reset-progress').addEventListener('click', () => showModal('confirmation-modal'));
                document.getElementById('confirm-reset').addEventListener('click', () => { 
                    appState.completedTopics = {};
                    appState.topicDifficulties = {};
                    appState.lastReviewDates = {};
                    appState.performanceLog = [];
                    appState.userProfile = { xp: 0, level: 0, unlockedAchievements: {}, lastStudyDate: null, studyStreak: 0, completedPomodoros: 0 };
                    saveAndCheck({type: 'reset'});
                    hideModal('confirmation-modal');
                    regenerateAndRenderSchedule();
                    alert("Progresso resetado!");
                });
                document.getElementById('cancel-reset').addEventListener('click', () => hideModal('confirmation-modal'));
                document.getElementById('apply-config').addEventListener('click', applyConfigurations);
                document.getElementById('add-custom-theme-btn').addEventListener('click', addCustomTheme);
                document.getElementById('save-performance-entry').addEventListener('click', savePerformanceEntry);
                document.getElementById('search-box').addEventListener('input', (e) => filterWeeks(e.target.value, document.getElementById('area-filter').value));
                document.getElementById('area-filter').addEventListener('change', (e) => filterWeeks(document.getElementById('search-box').value, e.target.value));
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const difficulty = this.dataset.difficulty;
                        if (appState.currentDifficultyTopic) {
                            appState.topicDifficulties[appState.currentDifficultyTopic] = difficulty;
                            saveAndCheck({ type: 'difficulty', topic: appState.currentDifficultyTopic });
                            updateAllStatsAndCharts();
                        }
                        hideModal('difficulty-modal');
                    });
                });
            }

            function filterWeeks(searchTerm, areaFilter) {
                const term = searchTerm.toLowerCase();
                document.querySelectorAll('.week-section .topic-row').forEach(row => {
                    const topicText = row.querySelector('.topic-text').textContent.toLowerCase();
                    const topicArea = row.parentElement.parentElement.querySelector('.area-badge').classList[1].replace('area-', '');
                    
                    const matchesSearch = topicText.includes(term);
                    const matchesArea = areaFilter === 'all' || topicArea === areaFilter;

                    row.style.display = (matchesSearch && matchesArea) ? '' : 'none';
                });
            }

            // PONTO DE ENTRADA DA APLICAÇÃO APÓS LOGIN
            if (appState.darkMode) { document.documentElement.setAttribute('data-theme', 'dark'); document.querySelector('#theme-toggle i').className = 'fas fa-sun'; }
            if (appState.minimalistMode) { document.body.classList.toggle('minimalist-mode', true); document.querySelector('#minimalist-toggle i').className = 'fas fa-expand'; }
            document.getElementById('start-date').value = appState.scheduleConfig.startDate;
            document.getElementById('exam-date').value = appState.scheduleConfig.examDate;
            document.getElementById('max-topics-day').value = appState.scheduleConfig.maxTopicsPerDay;
            document.getElementById('perf-date').value = new Date().toISOString().split('T')[0];

            initializeEventListeners();
            medicalChatbot.init();
            prepareAllTopics();
            regenerateAndRenderSchedule();
            resetPomodoro();
            updateHeaderUI();
            renderCustomThemesList();
            checkAllAchievements({ type: 'load' });
            showSection('stats');
        } 
    });
    </script>
</body>
</html>
