<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ Cronograma Revalida/Enamed 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root{--primary-color:#4CAF50;--secondary-color:#FFC107;--accent-color:#2196F3;--background-color:#f8f9fa;--card-background:#fff;--text-color:#333;--border-color:#e0e0e0;--shadow-color:rgba(0,0,0,.1);--success-color:#4CAF50;--warning-color:#FFC107;--danger-color:#F44336;--info-color:#2196F3;--xp-color:#9C27B0;--sidebar-width:280px;--sidebar-collapsed-width:70px}
        [data-theme=dark]{--primary-color:#66BB6A;--secondary-color:#FFD54F;--accent-color:#64B5F6;--background-color:#1a1a1a;--card-background:#2d2d2d;--text-color:#f5f5f5;--border-color:#404040;--shadow-color:rgba(0,0,0,.3);--xp-color:#BA68C8}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Roboto',sans-serif;background-color:var(--background-color);color:var(--text-color);transition:all .3s ease;overflow-x:hidden}
        .header-fixed{position:fixed;top:0;left:0;right:0;background-color:var(--card-background);box-shadow:0 2px 10px var(--shadow-color);z-index:1000;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;transition:all .3s ease;min-height:80px}
        .header-fixed.sidebar-open{left:var(--sidebar-width)}
        .header-fixed.sidebar-collapsed{left:var(--sidebar-collapsed-width)}
        .header-left{display:flex;align-items:center;gap:15px}
        .header-center{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;margin:0 15px}
        .header-right{display:flex;align-items:center;gap:15px}
        .header-title{font-size:1.5em;font-weight:700;color:var(--primary-color)}
        .motivational-quote{font-size:.9em;font-style:italic;color:var(--accent-color)}
        .user-profile-header{display:flex;align-items:center;gap:15px}
        .xp-bar-container{width:150px;height:12px;background-color:var(--border-color);border-radius:6px;overflow:hidden;position:relative}
        .xp-bar-fill{width:0%;height:100%;background-color:var(--xp-color);transition:width .5s ease}
        .user-level{font-size:.9em;font-weight:500;color:var(--xp-color)}
        .study-streak{font-size:1.2em;color:#FF9800;font-weight:700;display:flex;align-items:center;gap:5px}
        .btn{background-color:var(--accent-color);color:#fff;border:none;padding:10px 15px;border-radius:8px;cursor:pointer;font-size:.9em;transition:all .3s ease;display:flex;align-items:center;gap:5px}
        .btn:hover{background-color:#1976D2;transform:translateY(-2px)}
        .btn-toggle{background-color:var(--secondary-color);color:#333}
        .btn-toggle:hover{background-color:#F57F17}
        .btn-danger{background-color:var(--danger-color);font-size:.8em;padding:4px 8px}
        .btn-ia {
          padding: 5px 10px;
          font-size: 0.75em;
          background-color: var(--xp-color);
          color: white;
          border: none;
          border-radius: 6px;
          cursor: pointer;
        }
        .sidebar{position:fixed;top:0;left:0;width:var(--sidebar-width);height:100vh;background-color:var(--card-background);box-shadow:2px 0 10px var(--shadow-color);transform:translateX(-100%);transition:transform .3s ease;z-index:999;overflow-y:auto;padding:80px 0 20px}
        .sidebar.open{transform:translateX(0)}
        .sidebar.collapsed{width:var(--sidebar-collapsed-width);transform:translateX(0)}
        .sidebar-content{padding:20px}
        .sidebar.collapsed .sidebar-content{padding:10px}
        .sidebar-menu{list-style:none}
        .sidebar-menu li{margin-bottom:10px}
        .sidebar-menu a{display:flex;align-items:center;padding:12px 15px;color:var(--text-color);text-decoration:none;border-radius:8px;transition:all .3s ease;gap:12px}
        .sidebar-menu a:hover{background-color:var(--primary-color);color:#fff}
        .sidebar-menu i{font-size:1.2em;width:20px;text-align:center}
        .sidebar.collapsed .sidebar-menu span{display:none}
        .sidebar.collapsed .sidebar-menu a{justify-content:center;padding:12px 10px}
        .main-content{padding-top:100px;margin-left:0;padding:100px 20px 20px;transition:margin-left .3s ease}
        .main-content.sidebar-open{margin-left:var(--sidebar-width)}
        .main-content.sidebar-collapsed{margin-left:var(--sidebar-collapsed-width)}
        .content-section{display:none}
        .content-section.active{display:block}
        .achievements-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
        .achievement-category{background-color:var(--card-background);border-radius:12px;padding:20px;box-shadow:0 4px 15px var(--shadow-color)}
        .achievement-category h3{color:var(--primary-color);margin-bottom:15px;border-bottom:2px solid var(--border-color);padding-bottom:10px}
        .achievement-item{display:flex;align-items:center;gap:15px;padding:10px 0;border-bottom:1px solid var(--border-color);transition:all .3s ease;opacity:.5}
        .achievement-item:last-child{border-bottom:none}
        .achievement-item.unlocked{opacity:1}
        .achievement-icon{font-size:2.2em;color:var(--secondary-color);width:50px;text-align:center}
        .achievement-item.unlocked .achievement-icon{color:var(--primary-color)}
        .achievement-details h4{margin:0;font-size:1.1em}
        .achievement-details p{margin:2px 0 0;font-size:.9em;color:var(--text-color);opacity:.8}
        .achievement-details .unlock-date{font-size:.8em;font-style:italic;color:var(--success-color)}
        .achievement-notification{position:fixed;bottom:-120px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--secondary-color),#FFB300);color:#111;padding:15px 25px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,.3);display:flex;align-items:center;gap:15px;z-index:9999;transition:all .5s ease-in-out;font-weight:500}
        .achievement-notification.show{bottom:20px;transform:translateX(-50%) scale(1);opacity:1}
        .achievement-notification i{font-size:1.8em}
        .chart-container{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:30px;position:relative;height:280px}
        .chart-container h3{text-align:center;margin-bottom:15px;font-size:1.2em;color:var(--primary-color)}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);text-align:center;transition:transform .3s ease}
        .stat-card:hover{transform:translateY(-5px)}
        .stat-card h3{color:var(--primary-color);font-size:1.2em;margin-bottom:10px}
        .stat-card .value{font-size:2.5em;font-weight:700;color:var(--accent-color);margin:10px 0}
        .progress-bar{background-color:var(--border-color);border-radius:10px;height:8px;overflow:hidden;margin-top:10px}
        .progress-fill{height:100%;background-color:var(--primary-color);border-radius:10px;transition:width .5s ease}
        .progress-list{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:20px}
        .progress-list h4{color:var(--primary-color);margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .topic-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border-color);transition:background-color .3s ease}
        .topic-item:hover{background-color:rgba(76,175,80,.1)}
        .topic-item:last-child{border-bottom:none}
        .custom-theme-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background-color:var(--background-color);margin-bottom:8px}
        .days-badge{background-color:var(--accent-color);color:#fff;padding:4px 8px;border-radius:12px;font-size:.8em;font-weight:700}
        .days-badge.warning{background-color:var(--warning-color);color:#333}
        .days-badge.danger{background-color:var(--danger-color)}
        .controls-section{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:30px}
        .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;align-items:center}
        .search-box,.filter-select,.config-input{width:100%;padding:12px;border:2px solid var(--border-color);border-radius:8px;font-size:1em;background-color:var(--background-color);color:var(--text-color);transition:border-color .3s ease}
        .search-box:focus,.filter-select:focus,.config-input:focus{outline:none;border-color:var(--primary-color)}
        .config-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:20px}
        .config-form-group{display:flex;gap:10px;align-items:flex-end}
        .config-form-group>div{flex-grow:1}
        .config-group{display:flex;flex-direction:column;gap:8px}
        .config-group label{font-weight:500;color:var(--primary-color)}
        .config-hint{font-size:.8em;color:var(--text-color);opacity:.7}
        .performance-table{width:100%;border-collapse:collapse;margin-top:20px;font-size:.9em}
        .performance-table th,.performance-table td{padding:12px;border-bottom:1px solid var(--border-color);text-align:left}
        .performance-table th{background-color:var(--primary-color);color:#fff}
        .performance-table tr:hover{background-color:rgba(76,175,80,.1)}
        .performance-table .percentage-col{font-weight:700}
        .performance-table .percentage-col.good{color:var(--success-color)}
        .performance-table .percentage-col.medium{color:var(--warning-color)}
        .performance-table .percentage-col.bad{color:var(--danger-color)}
        .pomodoro-section{background-color:var(--card-background);padding:20px;border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:30px;text-align:center}
        .pomodoro-display{font-size:3em;font-weight:700;color:var(--accent-color);margin:20px 0;font-family:'Courier New',monospace}
        .pomodoro-controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:20px}
        .pomodoro-settings{display:flex;gap:15px;justify-content:center;margin-top:15px;flex-wrap:wrap}
        .pomodoro-settings input{width:80px;padding:8px;border:2px solid var(--border-color);border-radius:6px;text-align:center;background-color:var(--background-color);color:var(--text-color)}
        .week-section{background-color:var(--card-background);border-radius:12px;box-shadow:0 4px 15px var(--shadow-color);margin-bottom:30px;overflow:hidden;transition:all .3s ease}
        .week-header{background:linear-gradient(135deg,var(--primary-color),#66BB6A);color:#fff;padding:20px;font-size:1.4em;font-weight:700;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .3s ease}
        .week-header:hover{background:linear-gradient(135deg,#388E3C,var(--primary-color))}
        .week-content{padding:0;max-height:2000px;overflow:hidden;transition:max-height .5s ease-in-out;overflow-x:auto}
        .week-content.collapsed{max-height:0}
        .week-table{width:100%;border-collapse:collapse;table-layout:fixed}
        .week-table th{background-color:var(--primary-color);color:#fff;padding:15px 8px;text-align:left;font-weight:600;font-size:.9em}
        .week-table td{padding:15px 8px;border-bottom:1px solid var(--border-color);vertical-align:top;word-wrap:break-word;overflow-wrap:break-word}
        .week-table tr:hover{background-color:rgba(76,175,80,.1)}
        .topic-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
        .topic-row:last-child{margin-bottom:0}
        .topic-checkbox{transform:scale(1.3);cursor:pointer;flex-shrink:0}
        .topic-text{flex-grow:1;transition:all .3s ease}
        .topic-text.completed{text-decoration:line-through;opacity:.7}
        td .topic-icons{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;height:100%}
        .area-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:.8em;font-weight:700;color:#fff;display:flex;align-items:center;gap:5px;flex-shrink:0}
        .area-preventiva{background-color:#4CAF50}.area-pediatria{background-color:#2196F3}.area-ginecologia{background-color:#9C27B0}.area-obstetricia{background-color:#673AB7}.area-clinica{background-color:#F44336}.area-cirurgia{background-color:#FF9800}.area-psiquiatria{background-color:#795548}.area-revisao{background-color:#607D8B}.area-rest{background-color:#9E9E9E}
        .rest-day{background-color:#FFF3E0;font-style:italic;text-align:center}
        [data-theme=dark] .rest-day{background-color:#3E2723}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:2000;justify-content:center;align-items:center}
        .modal.active{display:flex}
        .modal-content{background-color:var(--card-background);padding:30px;border-radius:15px;max-width:500px;width:90%;text-align:center;box-shadow:0 10px 30px var(--shadow-color);animation:modalSlideIn .3s ease}
        @keyframes modalSlideIn{0%{transform:translateY(-50px);opacity:0}100%{transform:translateY(0);opacity:1}}
        .difficulty-buttons{display:flex;gap:15px;justify-content:center;margin-top:20px}
        .difficulty-btn{padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:700;transition:all .3s ease}
        .difficulty-easy{background-color:#4CAF50;color:#fff}
        .difficulty-medium{background-color:#FF9800;color:#fff}
        .difficulty-hard{background-color:#F44336;color:#fff}
        .difficulty-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,.2)}
        .confirmation-buttons{display:flex;gap:15px;justify-content:center;margin-top:20px}
        .btn-confirm{background-color:var(--danger-color)}
        .btn-cancel{background-color:var(--border-color);color:var(--text-color)}
        @media (max-width:992px){.header-center{display:none}}
        @media (max-width:768px){.header-fixed{left:0!important;padding:10px 15px;flex-wrap:wrap;min-height:auto;gap:10px}.header-left,.header-right{width:100%;justify-content:space-between}.header-center{display:flex;width:100%;order:-1;margin:5px 0}.user-profile-header{width:100%;justify-content:center;gap:10px}.xp-bar-container{width:120px;height:10px}.sidebar{width:100%;transform:translateX(-100%)}.sidebar.open{transform:translateX(0);width:280px}.sidebar.collapsed{transform:translateX(-100%)}.main-content.sidebar-open{margin-left:0}.main-content.sidebar-collapsed{margin-left:0}.main-content{padding-top:120px;padding-left:15px;padding-right:15px}.stats-grid{grid-template-columns:1fr}.controls-grid,.config-form,.config-form-group{grid-template-columns:1fr;flex-direction:column;align-items:stretch}.config-form-group .btn{width:100%;justify-content:center}.performance-table{font-size:.8em}.performance-table th,.performance-table td{padding:8px 4px}.pomodoro-controls,.difficulty-buttons{flex-direction:column;align-items:center}.week-table{font-size:.8em}.week-table th,.week-table td{padding:8px 4px}.topic-row{flex-direction:column;align-items:flex-start}td .topic-icons{flex-direction:row;justify-content:space-around;width:100%;margin-top:10px}}
        .fade-in{animation:fadeIn .5s ease}@keyframes fadeIn{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
        .pulse{animation:pulse 2s infinite}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
        ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--background-color)}::-webkit-scrollbar-thumb{background:var(--primary-color);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#388E3C}
        
        /* Login Screen Styles */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .login-container.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .login-card {
            background: var(--card-background);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: slideUp 0.6s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .login-logo {
            font-size: 3em;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .login-title {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 30px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-color);
            opacity: 0.5;
        }
        
        .login-btn {
            background: linear-gradient(135deg, var(--primary-color), #66BB6A);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }
        
        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .google-btn {
            background: white;
            color: #333;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .google-btn:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-color);
            opacity: 0.5;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }
        
        .divider span {
            padding: 0 15px;
            font-size: 0.9em;
        }
        
        .auth-toggle {
            margin-top: 20px;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .auth-toggle a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: none;
        }
        
        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: none;
        }
        
        /* User info in header */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .logout-btn:hover {
            background: #d32f2f;
        }
        .review-group{background-color:var(--card-background);padding:15px;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 10px var(--shadow-color)}
        .review-group h4{color:var(--primary-color);margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .review-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border-color)}
        .review-item:last-child{border-bottom:none}
        .review-info{flex-grow:1}
        .review-actions{display:flex;gap:10px}
        .review-due{font-weight:700}
        .review-due.urgent{color:var(--danger-color)}
        .review-due.soon{color:var(--warning-color)}
        .shimmer {
          background: linear-gradient(to right, #e0e0e0 8%, #f0f0f0 18%, #e0e0e0 33%);
          background-size: 1000px 100%;
          animation: shimmer 1.2s infinite linear forwards;
          height: 1.2em;
          border-radius: 4px;
          margin-bottom: 10px;
        }

        @keyframes shimmer {
          0% { background-position: -1000px 0; }
          100% { background-position: 1000px 0; }
        }

        /* ESTILOS DO CHATBOT M√âDICO */
        .medical-chatbot {
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 1500;
          font-family: 'Roboto', sans-serif;
        }

        .chatbot-toggle {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--xp-color), #8E24AA);
          border: none;
          color: white;
          font-size: 1.5rem;
          cursor: pointer;
          box-shadow: 0 4px 20px rgba(156, 39, 176, 0.3);
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .chatbot-toggle:hover {
          transform: scale(1.1);
          box-shadow: 0 6px 25px rgba(156, 39, 176, 0.5);
        }

        .chatbot-toggle.active {
          background: linear-gradient(135deg, #FF5722, #F44336);
        }

        .chatbot-container {
          position: absolute;
          bottom: 80px;
          right: 0;
          width: 400px;
          height: 600px;
          background: var(--card-background);
          border-radius: 20px;
          box-shadow: 0 20px 60px var(--shadow-color);
          display: none;
          flex-direction: column;
          overflow: hidden;
          border: 2px solid var(--border-color);
        }

        .chatbot-container.active {
          display: flex;
        }

        .chatbot-header {
          background: linear-gradient(135deg, var(--xp-color), #8E24AA);
          color: white;
          padding: 20px;
          text-align: center;
          position: relative;
        }

        .chatbot-header h3 {
          margin: 0;
          font-size: 1.2rem;
          font-weight: 600;
        }

        .chatbot-header p {
          margin: 5px 0 0 0;
          font-size: 0.9rem;
          opacity: 0.9;
        }

        .chatbot-close {
          position: absolute;
          top: 15px;
          right: 15px;
          background: none;
          border: none;
          color: white;
          font-size: 1.2rem;
          cursor: pointer;
          opacity: 0.8;
        }

        .chatbot-close:hover {
          opacity: 1;
        }

        .chat-messages {
          flex: 1;
          padding: 20px;
          overflow-y: auto;
          background: var(--background-color);
        }

        .message {
          margin-bottom: 15px;
          max-width: 85%;
        }

        .message.user {
          margin-left: auto;
          text-align: right;
        }

        .message.bot {
          margin-right: auto;
        }

        .message-bubble {
          padding: 12px 16px;
          border-radius: 18px;
          font-size: 0.9rem;
          line-height: 1.4;
          word-wrap: break-word;
        }

        .message.user .message-bubble {
          background: var(--xp-color);
          color: white;
          border-bottom-right-radius: 5px;
        }

        .message.bot .message-bubble {
          background: var(--card-background);
          color: var(--text-color);
          border: 1px solid var(--border-color);
          border-bottom-left-radius: 5px;
        }

        .message-time {
          font-size: 0.7rem;
          opacity: 0.7;
          margin-top: 5px;
        }

        .typing-indicator {
          display: none;
          align-items: center;
          gap: 8px;
          padding: 12px 16px;
          background: var(--card-background);
          border: 1px solid var(--border-color);
          border-radius: 18px;
          border-bottom-left-radius: 5px;
          margin-bottom: 15px;
          max-width: 85%;
        }

        .typing-indicator.active {
          display: flex;
        }

        .typing-dots {
          display: flex;
          gap: 4px;
        }

        .typing-dot {
          width: 8px;
          height: 8px;
          background: var(--xp-color);
          border-radius: 50%;
          animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingAnimation {
          0%, 80%, 100% {
            transform: scale(0);
            opacity: 0.5;
          }
          40% {
            transform: scale(1);
            opacity: 1;
          }
        }

        .chat-input-container {
          padding: 20px;
          border-top: 2px solid var(--border-color);
          background: var(--card-background);
        }

        .chat-input-wrapper {
          display: flex;
          gap: 10px;
          align-items: flex-end;
        }

        .chat-input {
          flex: 1;
          padding: 12px 16px;
          border: 2px solid var(--border-color);
          border-radius: 25px;
          background: var(--background-color);
          color: var(--text-color);
          font-size: 0.9rem;
          resize: none;
          max-height: 100px;
          min-height: 44px;
          outline: none;
          transition: border-color 0.3s ease;
        }

        .chat-input:focus {
          border-color: var(--xp-color);
        }

        .chat-send {
          width: 44px;
          height: 44px;
          border-radius: 50%;
          background: var(--xp-color);
          border: none;
          color: white;
          font-size: 1.1rem;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .chat-send:hover:not(:disabled) {
          background: #8E24AA;
          transform: scale(1.05);
        }

        .chat-send:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .quick-topics {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          margin-bottom: 15px;
        }

        .quick-topic {
          padding: 6px 12px;
          background: var(--card-background);
          border: 1px solid var(--border-color);
          border-radius: 15px;
          font-size: 0.8rem;
          cursor: pointer;
          transition: all 0.3s ease;
          color: var(--text-color);
        }

        .quick-topic:hover {
          background: var(--xp-color);
          color: white;
          border-color: var(--xp-color);
        }

        .error-message {
          background: #FFEBEE;
          color: #C62828;
          padding: 12px 16px;
          border-radius: 18px;
          border-bottom-left-radius: 5px;
          font-size: 0.9rem;
          margin-bottom: 15px;
          max-width: 85%;
        }

        [data-theme=dark] .error-message {
          background: #4D1F1F;
          color: #FF6B6B;
        }

        @media (max-width: 768px) {
          .chatbot-container {
            width: 100vw;
            height: 100vh;
            bottom: 0;
            right: 0;
            border-radius: 0;
            position: fixed;
          }
          
          .medical-chatbot {
            bottom: 10px;
            right: 10px;
          }
          
          .chatbot-toggle {
            width: 50px;
            height: 50px;
            font-size: 1.3rem;
          }
        }

     /* NOVOS ESTILOS PARA GAMIFICA√á√ÉO */
.level-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
}

.level-avatar {
    font-size: 1.8em;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--xp-color);
    border-radius: 50%;
    color: white;
}

.level-progress {
    flex-grow: 1;
}

.level-info {
    font-size: 0.8em;
    color: var(--text-color);
    opacity: 0.8;
    margin-top: 3px;
}

.level-badge {
    background: linear-gradient(135deg, var(--xp-color), #8E24AA);
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7em;
    font-weight: bold;
    display: inline-block;
    margin-left: 5px;
}

.level-up-animation {
    animation: levelUp 0.5s ease;
    transform: scale(1.1);
}

@keyframes levelUp {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1.1); }
}

.level-up-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-background);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 30px var(--shadow-color);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease;
    text-align: center;
    max-width: 300px;
    width: 90%;
}

.level-up-notification.show {
    opacity: 1;
}

.level-up-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-logo">üìÖ</div>
            <h1 class="login-title">Cronograma Revalida</h1>
            <p class="login-subtitle">Fa√ßa login para sincronizar seu progresso</p>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <form class="login-form" id="authForm">
                <div class="form-group">
                    <input type="email" class="form-input" id="email" placeholder="Seu e-mail" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="password" placeholder="Sua senha" required>
                </div>
                <button type="submit" class="login-btn" id="authSubmitBtn">
                    <span id="authBtnText">Entrar</span>
                    <div class="loading-spinner" id="loadingSpinner"></div>
                </button>
            </form>
            
            <div class="divider">
                <span>ou</span>
            </div>
            
            <button class="login-btn google-btn" id="googleLoginBtn">
                <i class="fab fa-google"></i>
                Continuar com Google
            </button>
            
            <div class="auth-toggle">
                <span id="authToggleText">N√£o tem uma conta?</span>
                <a id="authToggleLink">Criar conta</a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
    <header class="header-fixed" id="header">
        <div class="header-left">
            <button class="btn" id="menu-toggle"><i class="fas fa-bars"></i></button>
            <div class="header-title">Revalida 2025</div>
        </div>
         <div class="header-right">
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">U</div>
                <span id="userEmail"></span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
            
            <div class="user-profile-header">>
                <div id="study-streak" class="study-streak" title="Dias de estudo consecutivos"><i class="fas fa-fire"></i> <span id="streak-count">0</span></div>
                <div class="user-level" id="user-level"></div>
                <div class="xp-bar-container" title="Pontos de Experi√™ncia"><div id="xp-bar-fill" class="xp-bar-fill"></div></div>
            </div>
        </div>
        <div class="header-right">
    <div id="study-time-display" title="Tempo total de estudo" style="font-weight: 600; color: var(--accent-color);">
        ‚è±Ô∏è 00:00:00
    </div>
    <button class="btn btn-toggle" id="theme-toggle" title="Alternar Modo Escuro/Claro">
        <i class="fas fa-moon"></i>
    </button>
    <button class="btn" id="minimalist-toggle" title="Modo Minimalista">
        <i class="fas fa-compress"></i>
    </button>
</div>
    </header>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li><a href="#" data-section="stats"><i class="fas fa-chart-bar"></i><span>Estat√≠sticas</span></a></li>
                <li><a href="#" data-section="achievements"><i class="fas fa-trophy"></i><span>Conquistas</span></a></li>
                <li><a href="#" data-section="performance"><i class="fas fa-chart-line"></i><span>Desempenho por Quest√µes</span></a></li>
                <li><a href="#" data-section="progress"><i class="fas fa-tasks"></i><span>Progresso</span></a></li>
                <li><a href="#" data-section="pomodoro"><i class="fas fa-clock"></i><span>Pomodoro</span></a></li>
                <li><a href="#" data-section="review"><i class="fas fa-brain"></i><span>Revis√£o</span></a></li>
                <li><a href="#" data-section="weeks"><i class="fas fa-calendar"></i><span>Semanas</span></a></li>
                <li><a href="#" data-section="settings"><i class="fas fa-cog"></i><span>Configura√ß√µes</span></a></li>
                <li><a href="#" id="reset-progress"><i class="fas fa-trash"></i><span>Resetar</span></a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content" id="main-content">
        <section id="stats-section" class="content-section active">
            <div class="stats-grid fade-in">
                <div class="stat-card"><h3><i class="fas fa-check-circle"></i> Temas Conclu√≠dos</h3><div class="value" id="completed-count">0</div><div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div><small id="progress-percentage">0%</small></div>
                <div class="stat-card"><h3><i class="fas fa-calendar-day"></i> Dias Restantes</h3><div class="value" id="days-left">0</div><small>at√© a data da prova</small></div>
                <div class="stat-card"><h3><i class="fas fa-redo"></i> Revis√µes Pendentes</h3><div class="value" id="reviews-pending">0</div><small>temas para revisar</small></div>
                <div class="stat-card"><h3><i class="fas fa-star"></i> Dificuldade M√©dia</h3><div class="value" id="avg-difficulty">-</div><small>dos temas conclu√≠dos</small></div>
            </div>
            <div class="chart-container fade-in"><h3><i class="fas fa-tasks"></i> Conclus√£o por Mat√©ria (%)</h3><canvas id="graficoPorMateria"></canvas></div>
            <div class="chart-container fade-in"><h3><i class="fas fa-chart-line"></i> Desempenho M√©dio por √Årea (%)</h3><canvas id="graficoDesempenhoPorArea"></canvas></div>
<div class="stat-card">
        </section>

        <section id="achievements-section" class="content-section"><h2 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-trophy"></i> Suas Conquistas</h2><div class="achievements-grid" id="achievements-grid"></div></section>
        
        <section id="performance-section" class="content-section">
            <div class="controls-section fade-in"><h2><i class="fas fa-chart-line"></i> Registro de Desempenho</h2><p>Anote aqui seus resultados em simulados e listas de exerc√≠cios.</p>
                <div class="config-form" style="align-items: flex-end;">
                    <div class="config-group"><label for="perf-date">Data:</label><input type="date" id="perf-date" class="config-input"></div>
                    <div class="config-group" style="flex-grow: 2;"><label for="perf-topic-select">Tema Relacionado:</label><select id="perf-topic-select" class="config-input"></select></div>
                    <div class="config-group"><label for="perf-questions-attempted">Quest√µes:</label><input type="number" id="perf-questions-attempted" class="config-input" min="1" placeholder="Ex: 50"></div>
                    <div class="config-group"><label for="perf-questions-correct">Acertos:</label><input type="number" id="perf-questions-correct" class="config-input" min="0" placeholder="Ex: 42"></div>
                    <button class="btn" id="save-performance-entry" style="padding: 12px 20px;"><i class="fas fa-save"></i> Salvar</button>
                </div>
    <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px;">
        <a href="https://app.hardworq.com.br/signin" target="_blank" class="btn" style="background-color: #6a1b9a; padding: 12px 20px;">
            <i class="fas fa-database"></i> HardWorq
        </a>
        <span style="font-size: 0.9em; color: var(--text-color);">
            Utilize o banco de quest√µes gratuitas do HardWorq
        </span>
    </div>
</div>
            <div class="controls-section fade-in" style="margin-top: 20px;"><h3><i class="fas fa-history"></i> Hist√≥rico de Registros</h3><div id="performance-history-container" style="overflow-x: auto;"></div></div>
        </section>
        
        <section id="progress-section" class="content-section"><h2 style="margin-bottom: 20px; color: var(--primary-color);"><i class="fas fa-tasks"></i> Progresso por Mat√©ria</h2><div id="progress-lists"></div></section>
        <section id="pomodoro-section" class="content-section"><div class="pomodoro-section fade-in"><h3><i class="fas fa-clock"></i> Timer Pomodoro</h3><div class="pomodoro-display" id="pomodoro-display">25:00</div><div class="pomodoro-controls"><button class="btn" id="pomodoro-start"><i class="fas fa-play"></i> Iniciar</button><button class="btn" id="pomodoro-pause"><i class="fas fa-pause"></i> Pausar</button><button class="btn" id="pomodoro-reset"><i class="fas fa-stop"></i> Resetar</button></div><div class="pomodoro-settings"><div><label>Foco (min):</label><input type="number" id="focus-time" value="25" min="1" max="60"></div><div><label>Pausa (min):</label><input type="number" id="break-time" value="5" min="1" max="30"></div></div></div></section>
        <section id="review-section" class="content-section"><div class="controls-section fade-in"><h3><i class="fas fa-brain"></i> Revis√µes Futuras</h3><div id="future-reviews-container"></div></div></section>
        <section id="settings-section" class="content-section"><div class="controls-section fade-in"><h3><i class="fas fa-cog"></i> Configura√ß√µes</h3><div class="config-form"><div class="config-group"><label for="start-date">Data de In√≠cio:</label><input type="date" id="start-date" class="config-input"></div><div class="config-group"><label for="exam-date">Data da Prova:</label><input type="date" id="exam-date" class="config-input"></div><div class="config-group"><label for="max-topics-day">M√°x. Temas/Dia:</label><input type="number" id="max-topics-day" class="config-input" value="5" min="1" max="10"></div></div><div style="margin-top: 30px; border-top: 2px solid var(--border-color); padding-top: 20px;"><h4><i class="fas fa-plus-circle"></i> Adicionar Temas Personalizados</h4><div class="config-form-group" style="margin-top: 15px;"><div class="config-group"><label for="custom-theme-name">Nome do Tema:</label><input type="text" id="custom-theme-name" class="config-input" placeholder="Ex: Revis√£o de ECG"></div><div class="config-group"><label for="custom-theme-area">√Årea:</label><select id="custom-theme-area" class="config-input"><option value="preventiva">Preventiva</option><option value="pediatria">Pediatria</option><option value="ginecologia">Ginecologia</option><option value="obstetricia">Obstetr√≠cia</option><option value="clinica">Cl√≠nica</option><option value="cirurgia">Cirurgia</option><option value="psiquiatria">Psiquiatria</option><option value="revisao">Revis√£o</option></select></div><button class="btn" id="add-custom-theme-btn"><i class="fas fa-plus"></i> Add</button></div><div id="custom-themes-list" style="margin-top: 20px;"></div></div><button class="btn" id="apply-config" style="margin-top: 30px; background-color: var(--primary-color); padding: 15px 25px; font-size: 1.1em; width: 100%;"><i class="fas fa-save"></i> Salvar e Atualizar Cronograma</button></div></section>
        <section id="weeks-section" class="content-section"><div class="controls-section fade-in"><div class="controls-grid"><div><label for="search-box">üîç Buscar tema:</label><input type="text" id="search-box" class="search-box" placeholder="Digite o nome do tema..."></div><div><label for="area-filter">üè• Filtrar por √°rea:</label><select id="area-filter" class="filter-select"><option value="all">Todas as √°reas</option><option value="preventiva">Preventiva</option><option value="pediatria">Pediatria</option><option value="ginecologia">Ginecologia</option><option value="obstetricia">Obstetr√≠cia</option><option value="clinica">Cl√≠nica</option><option value="cirurgia">Cirurgia</option><option value="psiquiatria">Psiquiatria</option><option value="revisao">Revis√£o</option></select></div></div></div><button class="btn expand-weeks-btn" id="expand-weeks" style="display: none;"><i class="fas fa-expand"></i> Mostrar todas as semanas</button><div id="weeks"></div></section>
    </main>

    <!-- CHATBOT M√âDICO -->
    <div class="medical-chatbot">
        <div class="chatbot-container" id="chatbot-container">
            <div class="chatbot-header">
                <button class="chatbot-close" id="chatbot-close">√ó</button>
                <h3>üß† IA M√©dica Revalida</h3>
                <p>Seu assistente de estudos especializado</p>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message bot">
                    <div class="message-bubble">
                        üëã Ol√°! Sou sua IA especializada em Revalida/Enamed. Posso te ajudar com:
                        <br><br>
                        ‚Ä¢ Resumos t√©cnicos de qualquer tema
                        ‚Ä¢ Explica√ß√µes did√°ticas 
                        ‚Ä¢ Perguntas de fixa√ß√£o
                        ‚Ä¢ Dicas de estudo por √°rea
                        <br><br>
                        Como posso te ajudar hoje?
                    </div>
                    <div class="message-time">Agora</div>
                </div>
                
                <div class="quick-topics">
                    <div class="quick-topic" data-topic="Resumo de Hipertens√£o Arterial">Hipertens√£o</div>
                    <div class="quick-topic" data-topic="Diabetes Mellitus principais pontos">Diabetes</div>
                    <div class="quick-topic" data-topic="Infarto Agudo do Mioc√°rdio tratamento">IAM</div>
                    <div class="quick-topic" data-topic="Pneumonia diagn√≥stico">Pneumonia</div>
                    <div class="quick-topic" data-topic="Anemia ferropriva pediatria">Anemia</div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                <span>üß† IA pensando</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chat-input" 
                        placeholder="Digite sua pergunta sobre medicina..."
                        rows="1"
                    ></textarea>
                    <button class="chat-send" id="chat-send">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <button class="chatbot-toggle" id="chatbot-toggle">
            <i class="fas fa-brain"></i>
        </button>
    </div>

    <div class="modal" id="difficulty-modal"><div class="modal-content"><h3>Como foi estudar este tema?</h3><p>Avalie a dificuldade para melhorar suas revis√µes:</p><div class="difficulty-buttons"><button class="difficulty-btn difficulty-easy" data-difficulty="easy">üòä F√°cil</button><button class="difficulty-btn difficulty-medium" data-difficulty="medium">üòê M√©dio</button><button class="difficulty-btn difficulty-hard" data-difficulty="hard">üò∞ Dif√≠cil</button></div></div></div>
    <div class="modal" id="confirmation-modal"><div class="modal-content"><h3>‚ö†Ô∏è Confirmar Reset</h3><p>Tem certeza que deseja resetar todo o progresso e configura√ß√µes? Isso inclui suas conquistas!</p><p><strong>Esta a√ß√£o n√£o pode ser desfeita!</strong></p><div class="confirmation-buttons"><button class="btn btn-confirm" id="confirm-reset"><i class="fas fa-trash"></i> Sim, Resetar</button><button class="btn btn-cancel" id="cancel-reset"><i class="fas fa-times"></i> Cancelar</button></div></div></div>
    <div id="achievement-notification" class="achievement-notification"><i id="achievement-icon" class="fas fa-trophy"></i><div><h4 id="achievement-title">Conquista Desbloqueada!</h4><p id="achievement-desc">Descri√ß√£o da conquista.</p></div></div>

<!-- Modal do Flashcard IA -->
<div class="modal" id="ia-flashcard-modal">
  <div class="modal-content">
    <h3 id="ia-flashcard-title"></h3>
    <p id="ia-resumo"></p>
    <button class="btn btn-cancel" onclick="hideModal('ia-flashcard-modal')">Fechar</button>
  </div>
</div>

    </div>
    <!-- End Main App -->

    <script>
// =================================================================================
// SISTEMA DE AUTENTICA√á√ÉO COM SUPABASE
// =================================================================================

// Supabase Configuration
const SUPABASE_URL = 'https://oczcyffaolkokunxgdzf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jemN5ZmZhb2xrb2t1bnhnZHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNzcwMDMsImV4cCI6MjA2OTc1MzAwM30.MUzZw2yJeuLqlmOoCPrTZEf1XjfNOK-JkF-Hz_EerEk';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Authentication State
let currentUser = null;
let isSignUp = false;

// Initialize Authentication
async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session) {
        currentUser = session.user;
        showMainApp();
        await loadUserData();
    } else {
        showLoginScreen();
    }
    
    // Listen for auth changes
    supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN') {
            currentUser = session.user;
            showMainApp();
            await loadUserData();
        } else if (event === 'SIGNED_OUT') {
            currentUser = null;
            showLoginScreen();
        }
    });
}

function showLoginScreen() {
    document.getElementById('loginContainer').classList.remove('hidden');
    document.getElementById('mainApp').style.display = 'none';
}

function showMainApp() {
    document.getElementById('loginContainer').classList.add('hidden');
    document.getElementById('mainApp').style.display = 'block';
    
    // Update user info in header
    if (currentUser) {
        const userEmail = document.getElementById('userEmail');
        const userAvatar = document.getElementById('userAvatar');
        
        userEmail.textContent = currentUser.email;
        userAvatar.textContent = currentUser.email.charAt(0).toUpperCase();
    }
    
    // Initialize the main app
    initializeApp();
}

// Authentication Functions
async function handleAuth(event) {
    event.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const submitBtn = document.getElementById('authSubmitBtn');
    const btnText = document.getElementById('authBtnText');
    const spinner = document.getElementById('loadingSpinner');
    
    // Show loading state
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    spinner.style.display = 'block';
    hideMessages();
    
    try {
        let result;
        
        if (isSignUp) {
            result = await supabase.auth.signUp({
                email: email,
                password: password
            });
            
            if (result.error) throw result.error;
            
            if (result.data.user && !result.data.session) {
                showMessage('Verifique seu e-mail para confirmar a conta!', 'success');
                return;
            }
        } else {
            result = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (result.error) throw result.error;
        }
        
    } catch (error) {
        console.error('Auth error:', error);
        showMessage(getErrorMessage(error.message), 'error');
    } finally {
        // Reset loading state
        submitBtn.disabled = false;
        btnText.style.display = 'block';
        spinner.style.display = 'none';
    }
}
async function loginWithGoogle() {
    try {
        // Para login com Google funcionar, voc√™ precisa configurar um URL p√∫blico
        // no painel do Supabase. Como estamos usando localhost, vamos desabilitar
        // temporariamente e mostrar uma mensagem explicativa.
        
        showMessage('Login com Google requer configura√ß√£o adicional. Para habilitar:\n\n1. Acesse o painel do Supabase\n2. V√° em Authentication ‚Üí Providers\n3. Configure o Google Provider\n4. Adicione um dom√≠nio p√∫blico v√°lido\n\nPor enquanto, use login com email/senha.', 'error');
        
        // C√≥digo original comentado:
        /*
        const { data, error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: window.location.origin
            }
        });
        
        if (error) throw error;
        */
        
    } catch (error) {
        console.error('Google login error:', error);
        showMessage('Erro ao fazer login com Google. Tente novamente.', 'error');
    }
}

async function logout() {
    try {
        if (currentUser) {
            await saveUserData(); // Salva os √∫ltimos dados antes de deslogar
        }
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        
        // Limpar o estado local e redirecionar para a tela de login
        currentUser = null;
        appState = { // Resetar appState para o estado inicial
            sidebarOpen: false,
            darkMode: false,
            minimalistMode: false,
            currentSection: 'schedule',
            scheduleConfig: { startDate: '2024-12-01', examDate: '2025-06-15', studyWeeks: 24, maxTopicsPerDay: 4 },
            completedTopics: {},
            topicDifficulties: {},
            lastReviewDates: {},
            userProfile: { xp: 0, level: 0, studyStreak: 0, lastStudyDate: null, completedPomodoros: 0, unlockedAchievements: {} },
            performanceLog: [],
            customThemes: [],
            allTopicsFlat: [],
            scheduleData: [],
            charts: {},
            pomodoro: { timer: null, duration: 25 * 60, remaining: 25 * 60, isRunning: false, isBreak: false, cycles: 0, completedSessions: 0 },
            sessionStartTime: null,
            totalStudyTime: 0,
            currentDifficultyTopic: null,
            chatHistory: [],
            chatInput: '',
            chatLoading: false,
            chatResponse: '',
            chatError: '',
            chatOpen: false,
            chatMessages: []
        };
        localStorage.clear(); // Limpa todo o localStorage
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('user-email-display').textContent = '';
        document.getElementById('user-xp-display').textContent = '';
        document.getElementById('user-level-display').textContent = '';
        document.getElementById('user-study-streak-display').textContent = '';
        document.getElementById('user-pomodoros-display').textContent = '';
        updateAllDisplays(); // Atualiza a UI para refletir o estado limpo

    } catch (error) {
        console.error('Logout error:', error);
        alert('Erro ao fazer logout. Tente novamente.');
    }
}

function toggleAuthMode() {
    isSignUp = !isSignUp;
    
    const title = document.querySelector('.login-title');
    const btnText = document.getElementById('authBtnText');
    const toggleText = document.getElementById('authToggleText');
    const toggleLink = document.getElementById('authToggleLink');
    
    if (isSignUp) {
        title.textContent = 'Criar Conta';
        btnText.textContent = 'Criar Conta';
        toggleText.textContent = 'J√° tem uma conta?';
        toggleLink.textContent = 'Fazer login';
    } else {
        title.textContent = 'Cronograma Revalida';
        btnText.textContent = 'Entrar';
        toggleText.textContent = 'N√£o tem uma conta?';
        toggleLink.textContent = 'Criar conta';
    }
    
    hideMessages();
}

function showMessage(message, type) {
    hideMessages();
    
    const messageEl = document.getElementById(type === 'error' ? 'errorMessage' : 'successMessage');
    messageEl.textContent = message;
    messageEl.style.display = 'block';
}

function hideMessages() {
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
}

function getErrorMessage(error) {
    const errorMessages = {
        'Invalid login credentials': 'E-mail ou senha incorretos',
        'User already registered': 'Este e-mail j√° est√° cadastrado',
        'Password should be at least 6 characters': 'A senha deve ter pelo menos 6 caracteres',
        'Invalid email': 'E-mail inv√°lido',
        'Email not confirmed': 'E-mail n√£o confirmado. Verifique sua caixa de entrada.'
    };
    
    return errorMessages[error] || 'Erro inesperado. Tente novamente.';
}

// Data Synchronization Functions
async function saveUserData() {
    if (!currentUser) {
        console.log('No current user, skipping save');
        return;
    }
    
    try {
        console.log('Preparing user data for save:', {
            completedTopics: appState.completedTopics,
            lastReviewDates: appState.lastReviewDates,
            userProfile: appState.userProfile
        });
        
        const userData = {
            user_id: currentUser.id,
            completed_topics: appState.completedTopics,
            topic_difficulties: appState.topicDifficulties,
            last_review_dates: appState.lastReviewDates,
            user_profile: appState.userProfile,
            performance_log: appState.performanceLog,
            schedule_config: appState.scheduleConfig,
            dark_mode: appState.darkMode,
            custom_themes: appState.customThemes || [],
            all_topics_flat: appState.allTopicsFlat || [],
            schedule_data: appState.scheduleData || [],
            updated_at: new Date().toISOString()
        };
        
        console.log('Sending data to Supabase:', userData);
        
        const { error } = await supabase
            .from('user_progress')
            .upsert(userData);
        
        if (error) {
            console.error('Supabase error:', error);
            throw error;
        }
        
        console.log('User data saved successfully to Supabase');
        
    } catch (error) {
        console.error('Error saving user data:', error);
        alert('Erro ao salvar dados na nuvem: ' + error.message);
    }
}

async function loadUserData() {
    if (!currentUser) return;
    
    try {
        const { data, error } = await supabase
            .from('user_progress')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
        
        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
            throw error;
        }
        
        if (data) {
            // Load saved data
            appState.completedTopics = data.completed_topics || {};
            appState.topicDifficulties = data.topic_difficulties || {};
            appState.lastReviewDates = data.last_review_dates || {};
            appState.userProfile = { ...appState.userProfile, ...data.user_profile };
            appState.performanceLog = data.performance_log || [];
            appState.scheduleConfig = { ...appState.scheduleConfig, ...data.schedule_config };
            appState.darkMode = data.dark_mode || false;
            appState.customThemes = data.custom_themes || [];
            appState.allTopicsFlat = data.all_topics_flat || [];
            appState.scheduleData = data.schedule_data || [];
            
            // Apply theme
            if (appState.darkMode) {
                document.body.setAttribute('data-theme', 'dark');
                const themeIcon = document.getElementById('theme-icon');
                if (themeIcon) themeIcon.className = 'fas fa-sun';
            }
            
            // Update UI and regenerate schedule with loaded data
            updateAllDisplays();
            generateSchedule(); // Regenerate schedule with loaded progress
            
            console.log('User data loaded successfully');
        }
        
    } catch (error) {
        console.error('Error loading user data:', error);
    }
}

// Event Listeners for Auth
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('authForm').addEventListener('submit', handleAuth);
    document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleLogin);
    document.getElementById('authToggleLink').addEventListener('click', toggleAuthMode);
    
    // Initialize authentication
    initAuth();
});

// Auto-save data periodically
setInterval(() => {
    if (currentUser) {
        saveUserData();
    }
}, 30000); // Save every 30 seconds

// Save data when page is about to unload
window.addEventListener('beforeunload', () => {
    if (currentUser) {
        saveUserData();
    }
});

// =================================================================================
// SCRIPT COMPLETO E CORRIGIDO + CHATBOT M√âDICO
// =================================================================================

// DADOS E ESTADO DA APLICA√á√ÉO
// ---------------------------------------------------------------------------------
const motivationalQuotes = ["Cada p√°gina estudada √© um passo mais perto do seu sonho de m√©dico! üíâ", "Voc√™ √© mais forte do que qualquer desafio do Revalida! üöÄ", "Foco e determina√ß√£o: voc√™ vai conquistar o Enamed! ü©∫", "A jornada √© longa, mas sua dedica√ß√£o √© imbat√≠vel! üåü", "Estude com paix√£o, voc√™ est√° moldando o futuro da sa√∫de! ‚ù§Ô∏è"];
const originalScheduleData = [{theme:"Aten√ß√£o B√°sica",area:"preventiva"},{theme:"√âtica M√©dica (Aspectos gerais, sigilo)",area:"preventiva"},{theme:"SUS (Princ√≠pios, hist√≥rico, legisla√ß√£o)",area:"preventiva"},{theme:"Imuniza√ß√µes (Vacinas)",area:"preventiva"},{theme:"Epidemiologia (Indicadores, Vigil√¢ncia, Estudos)",area:"preventiva"},{theme:"Assist√™ncia Pr√©-natal",area:"obstetricia"},{theme:"Rastreamentos (C√¢ncer de colo, mama)",area:"preventiva"},{theme:"Planejamento familiar",area:"ginecologia"},{theme:"Conte√∫do genital patol√≥gico (Vulvovaginites)",area:"ginecologia"},{theme:"Tuberculose",area:"clinica"},{theme:"Hansen√≠ase",area:"clinica"},{theme:"Arboviroses (Dengue, Chikungunya, Zika)",area:"clinica"},{theme:"Leptospirose e Mal√°ria",area:"clinica"},{theme:"HIV/AIDS",area:"clinica"},{theme:"IST (S√≠filis e √ölceras Genitais)",area:"ginecologia"},{theme:"Hipertens√£o Arterial Sist√™mica (HAS)",area:"clinica"},{theme:"HTA Secund√°ria",area:"clinica"},{theme:"Diabetes (Diagn√≥stico, classifica√ß√£o, tratamento)",area:"clinica"},{theme:"Dislipidemia",area:"clinica"},{theme:"Atendimento Inicial ao Politraumatizado (ABCDE)",area:"cirurgia"},{theme:"Trauma de Vias A√©reas",area:"cirurgia"},{theme:"Asma e Crise de Asma",area:"clinica"},{theme:"DPOC",area:"clinica"},{theme:"Puericultura",area:"pediatria"},{theme:"Aleitamento materno",area:"pediatria"},{theme:"Parto (Mecanismo e assist√™ncia)",area:"obstetricia"},{theme:"Rela√ß√µes uterofetais",area:"obstetricia"},{theme:"Hemorragias da 1¬™ metade da gesta√ß√£o",area:"obstetricia"},{theme:"Hemorragias da 2¬™ metade da gesta√ß√£o",area:"obstetricia"},{theme:"S√≠ndromes Hipertensivas na Gesta√ß√£o",area:"obstetricia"},{theme:"Diabetes na Gesta√ß√£o",area:"obstetricia"},{theme:"Abdome Agudo (Apendicite)",area:"cirurgia"},{theme:"Abdome Agudo (Diverticulite)",area:"cirurgia"},{theme:"Puerp√©rio e Hemorragia p√≥s-parto",area:"obstetricia"},{theme:"Doen√ßas Benignas da Mama",area:"ginecologia"},{theme:"S√≠ndrome Coronariana Aguda",area:"clinica"},{theme:"Valvulopatias",area:"clinica"},{theme:"Arritmias",area:"clinica"},{theme:"Insufici√™ncia Card√≠aca",area:"clinica"},{theme:"Tromboembolia Pulmonar",area:"clinica"},{theme:"O derrame pleural",area:"clinica"},{theme:"Pneumonia",area:"clinica"},{theme:"Pneumonia na Inf√¢ncia",area:"pediatria"},{theme:"IVAS",area:"pediatria"},{theme:"Bronquiolite",area:"pediatria"},{theme:"Diarreia e Desidrata√ß√£o",area:"pediatria"},{theme:"Constipa√ß√£o na inf√¢ncia",area:"pediatria"},{theme:"Parasitoses Intestinais",area:"pediatria"},{theme:"Viol√™ncia Dom√©stica e Sexual",area:"preventiva"},{theme:"Maus tratos",area:"preventiva"},{theme:"√âtica: Declara√ß√£o de √ìbito",area:"preventiva"},{theme:"Abdome Agudo Obstrutivo",area:"cirurgia"},{theme:"H√©rnias da parede abdominal",area:"cirurgia"},{theme:"Doen√ßas orificiais",area:"cirurgia"},{theme:"Abdome Agudo Perfurativo, Vascular, Hemorr√°gico",area:"cirurgia"},{theme:"Pancreatite Aguda",area:"cirurgia"},{theme:"Cirurgia Pedi√°trica (Urologia, Gastro)",area:"cirurgia"},{theme:"Doen√ßas cong√™nitas",area:"pediatria"},{theme:"Trauma Tor√°cico",area:"cirurgia"},{theme:"Trauma Abdominal",area:"cirurgia"},{theme:"Trauma Cervical e P√©lvico",area:"cirurgia"},{theme:"TCE e TRM",area:"cirurgia"},{theme:"Ortopedia e Trauma de Extremidades",area:"cirurgia"},{theme:"Lombalgia",area:"clinica"},{theme:"Hepatites Virais",area:"clinica"},{theme:"Icter√≠cia Neonatal",area:"pediatria"},{theme:"Doen√ßas das vias biliares",area:"cirurgia"},{theme:"Doen√ßa do Refluxo Gastroesof√°gico",area:"clinica"},{theme:"√ölcera P√©ptica e H. pylori",area:"clinica"},{theme:"C√¢ncer de Es√¥fago",area:"cirurgia"},{theme:"Doen√ßa Inflamat√≥ria Intestinal",area:"clinica"},{theme:"S√≠ndrome do Intestino Irrit√°vel",area:"clinica"},{theme:"C√¢ncer Colorretal",area:"cirurgia"},{theme:"Infec√ß√µes e Gesta√ß√£o (TORCH, S√≠filis, Toxoplasmose)",area:"obstetricia"},{theme:"HIV e gesta√ß√£o",area:"obstetricia"},{theme:"Triagem Neonatal (Teste do Pezinho)",area:"pediatria"},{theme:"Avalia√ß√£o Neonatal",area:"pediatria"},{theme:"Reanima√ß√£o Neonatal",area:"pediatria"},{theme:"Hipotireoidismo e Hipertireoidismo",area:"clinica"},{theme:"N√≥dulo e C√¢ncer de Tireoide",area:"clinica"},{theme:"Anemias Carenciais (Ferropriva)",area:"clinica"},{theme:"Anemias Hemol√≠ticas",area:"clinica"},{theme:"Neoplasias Hematol√≥gicas",area:"clinica"},{theme:"Doen√ßas Exantem√°ticas",area:"pediatria"},{theme:"Meningites",area:"pediatria"},{theme:"Febre Reum√°tica",area:"clinica"},{theme:"√âtica: Medicina do Trabalho",area:"preventiva"},{theme:"Processo Sa√∫de-Doen√ßa",area:"preventiva"},{theme:"Cuidados Paliativos",area:"preventiva"},{theme:"Transtornos do Humor",area:"psiquiatria"},{theme:"Transtornos de Ansiedade",area:"psiquiatria"},{theme:"Psiquiatria Geral",area:"psiquiatria"},{theme:"Doen√ßa Inflamat√≥ria P√©lvica (DIP)",area:"ginecologia"},{theme:"Sangramento Uterino Anormal",area:"ginecologia"},{theme:"Amenorreia",area:"ginecologia"},{theme:"C√¢ncer de Ov√°rio",area:"ginecologia"},{theme:"Endometriose",area:"ginecologia"},{theme:"S√≠ndrome dos Ov√°rios Polic√≠sticos",area:"ginecologia"},{theme:"Infec√ß√£o do Trato Urin√°rio (ITU)",area:"clinica"},{theme:"ITU na Gesta√ß√£o",area:"obstetricia"},{theme:"ITU na Inf√¢ncia",area:"pediatria"},{theme:"Inj√∫ria Renal Aguda (IRA)",area:"clinica"},{theme:"Doen√ßas Glomerulares",area:"clinica"},{theme:"Urologia geral",area:"cirurgia"},{theme:"C√¢ncer de Pr√≥stata",area:"cirurgia"},{theme:"Cirurgia de Obesidade",area:"cirurgia"},{theme:"Cirurgia Vascular",area:"cirurgia"},{theme:"Revis√£o de Alt√≠ssima Preval√™ncia (Preventiva)",area:"revisao"},{theme:"Revis√£o de Alt√≠ssima Preval√™ncia (Cl√≠nica)",area:"revisao"},{theme:"Revis√£o de Alt√≠ssima Preval√™ncia (Cirurgia)",area:"revisao"},{theme:"Revis√£o de Alt√≠ssima Preval√™ncia (G.O./PEDS)",area:"revisao"},{theme:"Otorrinolaringologia",area:"cirurgia"},{theme:"Cefaleia",area:"clinica"},{theme:"Epilepsia e convuls√£o febril",area:"clinica"},{theme:"Doen√ßa de Parkinson",area:"clinica"},{theme:"L√∫pus",area:"clinica"},{theme:"Artrite Reumatoide",area:"clinica"},{theme:"Fibromialgia",area:"clinica"},{theme:"SIMULADO COMPLETO 1",area:"revisao"},{theme:"Corre√ß√£o Detalhada do Simulado 1",area:"revisao"},{theme:"Revis√£o de M√©dia Preval√™ncia (Cl√≠nica)",area:"revisao"},{theme:"Revis√£o de M√©dia Preval√™ncia (Cirurgia/G.O.)",area:"revisao"},{theme:"Revis√£o de M√©dia Preval√™ncia (Peds/Preventiva)",area:"revisao"},{theme:"Intoxica√ß√µes ex√≥genas",area:"clinica"},{theme:"Acidentes por Animais Pe√ßonhentos",area:"clinica"},{theme:"Queimados",area:"cirurgia"},{theme:"Raiva e t√©tano",area:"preventiva"},{theme:"Doa√ß√£o de √≥rg√£os e morte encef√°lica",area:"preventiva"},{theme:"Geriatria",area:"clinica"},{theme:"Perioperat√≥rio - exames, medicamentos, seguran√ßa",area:"cirurgia"},{theme:"T√©cnica cir√∫rgica e Corpo estranho",area:"cirurgia"},{theme:"Dist√∫rbios da hemostasia",area:"clinica"},{theme:"SIMULADO COMPLETO 2",area:"revisao"},{theme:"Corre√ß√£o Detalhada do Simulado 2",area:"revisao"},{theme:"Revis√£o por Fraqueza (Simulados)",area:"revisao"},{theme:"Revis√£o por Fraqueza (Quest√µes)",area:"revisao"},{theme:"Infertilidade",area:"ginecologia"},{theme:"Prematuridade",area:"pediatria"},{theme:"Restri√ß√£o de Crescimento Fetal",area:"obstetricia"},{theme:"Vitalidade Fetal",area:"obstetricia"},{theme:"Rotura prematura de membranas",area:"obstetricia"},{theme:"Revis√£o Geral R√°pida (Resumos e Flashcards)",area:"revisao"},{theme:"Revis√£o Leve (F√≥rmulas, escores, algoritmos)",area:"revisao"},{theme:"SIMULADO COMPLETO 3 (Opcional)",area:"revisao"},{theme:"Corre√ß√£o Detalhada do Simulado 3",area:"revisao"},{theme:"Anestesia",area:"cirurgia"},{theme:"Cirurgia pl√°stica - c√¢ncer de pele melanoma e n√£o melanoma",area:"cirurgia"},{theme:"Sepse",area:"clinica"},{theme:"Monoartrite aguda - gota e artrite infecciosa",area:"clinica"},{theme:"Leishmaniose",area:"clinica"},{theme:"PBLS e PALS",area:"pediatria"},{theme:"Desconforto respirat√≥rio do rec√©m-nascido",area:"pediatria"},{theme:"Dist√∫rbios do crescimento e desenvolvimento",area:"pediatria"},{theme:"Cardiopatias cong√™nitas",area:"pediatria"},{theme:"Isoimuniza√ß√£o RH",area:"obstetricia"},{theme:"Patologias vulvares",area:"ginecologia"},{theme:"Sa√∫de da Fam√≠lia",area:"preventiva"},{theme:"Desnutri√ß√£o e obesidade",area:"clinica"},{theme:"Tumores de p√¢ncreas",area:"cirurgia"},{theme:"Revis√£o Final: Pontos fracos e temas de alta preval√™ncia",area:"revisao"},{theme:"Revis√£o Final: Mais pontos fracos e temas de alta preval√™ncia",area:"revisao"},{theme:"Revis√£o Leve: Confian√ßa no processo",area:"revisao"},{theme:"Descanso e Organiza√ß√£o",area:"revisao"},{theme:"DESCANSO TOTAL",area:"revisao"}];

const appState = {
    sidebarOpen: false,
    sidebarCollapsed: false,
    minimalistMode: localStorage.getItem('minimalistMode') === 'true',
    darkMode: localStorage.getItem('darkMode') === 'true',
    pomodoroRunning: false,
    pomodoroTime: 25 * 60,
    pomodoroInterval: null,
    currentPomodoroType: 'focus',
    currentDifficultyTopic: null,
    currentSection: 'stats',
    charts: {
        completionBySubject: null,
        performanceByArea: null
    },
    completedTopics: JSON.parse(localStorage.getItem('completedTopics')) || {},
    topicDifficulties: JSON.parse(localStorage.getItem('topicDifficulties')) || {},
    lastReviewDates: JSON.parse(localStorage.getItem('lastReviewDates')) || {},
    customThemes: JSON.parse(localStorage.getItem('customThemes')) || [], 
    performanceLog: JSON.parse(localStorage.getItem('performanceLog')) || [],
    userProfile: JSON.parse(localStorage.getItem('userProfile')) || {
        xp: 0,
        level: 0,
        unlockedAchievements: {},
        lastStudyDate: null,
        studyStreak: 0,
        completedPomodoros: 0,
    },
    scheduleConfig: JSON.parse(localStorage.getItem('scheduleConfig')) || {
        startDate: '2025-07-28',
        examDate: '2025-10-19',
        maxTopicsPerDay: 4
    },
    allTopicsFlat: []
};

// CONFIGURA√á√ÉO DO CHATBOT M√âDICO
// ---------------------------------------------------------------------------------
const GEMINI_API_KEY = 'AIzaSyBtGkKLxXBnr2ro-qGR3J2-feq5W4HKKwk';
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

const medicalChatbot = {
    isOpen: false,
    conversationHistory: JSON.parse(localStorage.getItem('chatbotHistory')) || [],
    
    systemPrompt: `Voc√™ √© um assistente de estudos especializado no Revalida e na pr√°tica m√©dica brasileira. Seu papel √© ajudar o usu√°rio com revis√µes r√°pidas, esquemas, perguntas de fixa√ß√£o e explica√ß√µes claras, sempre dentro do contexto do cronograma de estudos que ele est√° seguindo.

Sempre que o usu√°rio fizer uma pergunta, responda de forma objetiva e pr√°tica, como se fosse um colega de resid√™ncia experiente, mas did√°tico. Use linguagem acess√≠vel, evite floreios, e priorize a clareza.


Voc√™ deve dominar os temas do cronograma de estudos, incluindo:
- Cl√≠nica M√©dica (CM)
- Cirurgia (CR) 
- Pediatria (PED)
- Ginecologia e Obstetr√≠cia (GO)
- Medicina Preventiva e Sa√∫de P√∫blica (PRE)

Se o usu√°rio n√£o for claro, pe√ßa que ele diga o tema ou √°rea para ajudar melhor. Seja direto, mas respeitoso. Nada de ironia ou piadas internas.

Voc√™ est√° integrado a uma plataforma de estudos, ent√£o pense como parte do sistema, n√£o como um chatbot gen√©rico. Sempre responda com foco em ajudar o usu√°rio a se preparar para a prova do Revalida 2025.`,

    async sendMessage(userMessage) {
        try {
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-goog-api-key': GEMINI_API_KEY
                },
                body: JSON.stringify({
                    contents: [
                        {
                            parts: [
                                {
                                    text: this.systemPrompt + "\n\nPergunta do usu√°rio: " + userMessage
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 800,
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`Erro na API: ${response.status}`);
            }

            const data = await response.json();
            const aiResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || 
                              "Desculpe, n√£o consegui processar sua pergunta. Tente novamente.";
            
            return aiResponse;
        } catch (error) {
            console.error('Erro na chamada da API Gemini:', error);
            return "Erro de conex√£o com a IA. Verifique sua internet e tente novamente.";
        }
    },

    saveHistory() {
        localStorage.setItem('chatbotHistory', JSON.stringify(this.conversationHistory));
    },

    addMessage(message, isUser = false) {
        const messageObj = {
            text: message,
            isUser: isUser,
            timestamp: new Date().toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            })
        };
        
        this.conversationHistory.push(messageObj);
        this.saveHistory();
        this.renderMessage(messageObj);
    },

    renderMessage(messageObj) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageObj.isUser ? 'user' : 'bot'}`;
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${messageObj.text.replace(/\n/g, '<br>')}
            </div>
            <div class="message-time">${messageObj.timestamp}</div>
        `;
        
        // Remove quick topics se for a primeira mensagem do usu√°rio
        if (messageObj.isUser && this.conversationHistory.filter(m => m.isUser).length === 1) {
            const quickTopics = messagesContainer.querySelector('.quick-topics');
            if (quickTopics) quickTopics.remove();
        }
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    },

    showTyping() {
        document.getElementById('typing-indicator').classList.add('active');
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    },

    hideTyping() {
        document.getElementById('typing-indicator').classList.remove('active');
    },

    async handleUserMessage(message) {
        if (!message.trim()) return;
        
        // Adiciona mensagem do usu√°rio
        this.addMessage(message, true);
        
        // Mostra indicador de digita√ß√£o
        this.showTyping();
        
        // Processa resposta da IA
        const aiResponse = await this.sendMessage(message);
        
        // Esconde indicador e adiciona resposta
        this.hideTyping();
        this.addMessage(aiResponse, false);
        
        // Limpa input
        document.getElementById('chat-input').value = '';
        this.adjustTextareaHeight();
    },

    adjustTextareaHeight() {
        const textarea = document.getElementById('chat-input');
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    },

    toggle() {
        this.isOpen = !this.isOpen;
        const container = document.getElementById('chatbot-container');
        const toggle = document.getElementById('chatbot-toggle');
        
        container.classList.toggle('active', this.isOpen);
        toggle.classList.toggle('active', this.isOpen);
        
        if (this.isOpen) {
            document.getElementById('chat-input').focus();
            this.loadHistory();
        }
    },

    loadHistory() {
        const messagesContainer = document.getElementById('chat-messages');
        // Limpa mensagens existentes exceto a primeira e quick topics
        const firstMessage = messagesContainer.querySelector('.message.bot');
        const quickTopics = messagesContainer.querySelector('.quick-topics');
        messagesContainer.innerHTML = '';
        
        if (firstMessage) messagesContainer.appendChild(firstMessage);
        if (quickTopics && this.conversationHistory.filter(m => m.isUser).length === 0) {
            messagesContainer.appendChild(quickTopics);
        }
        
        // Carrega hist√≥rico
        this.conversationHistory.forEach(msg => {
            this.renderMessage(msg);
        });
    },

    init() {
        const toggle = document.getElementById('chatbot-toggle');
        const close = document.getElementById('chatbot-close');
        const sendBtn = document.getElementById('chat-send');
        const input = document.getElementById('chat-input');
        
        // Event listeners
        toggle.addEventListener('click', () => this.toggle());
        close.addEventListener('click', () => this.toggle());
        
        sendBtn.addEventListener('click', () => {
            const message = input.value.trim();
            if (message) this.handleUserMessage(message);
        });
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = input.value.trim();
                if (message) this.handleUserMessage(message);
            }
        });
        
        input.addEventListener('input', () => this.adjustTextareaHeight());
        
        // Quick topics
        document.querySelectorAll('.quick-topic').forEach(topic => {
            topic.addEventListener('click', () => {
                this.handleUserMessage(topic.dataset.topic);
            });
        });
        
        // Fecha chatbot ao clicar fora
        document.addEventListener('click', (e) => {
            if (this.isOpen && !e.target.closest('.medical-chatbot')) {
                this.toggle();
            }
        });
    }
};

// GAMIFICA√á√ÉO: N√çVEIS E CONQUISTAS
// ---------------------------------------------------------------------------------
const studentLevels = [
    { title: "Estudante Iniciante", avatar: "üë∂", xpRequired: 0, description: "Come√ßando sua jornada m√©dica" },
    { title: "Interno Virtual", avatar: "üë®‚Äç‚öïÔ∏è", xpRequired: 100, description: "Primeiros passos na pr√°tica cl√≠nica" },
    { title: "R1 Cl√≠nico", avatar: "üë©‚Äç‚öïÔ∏è", xpRequired: 200, description: "Resid√™ncia m√©dica - 1¬∫ ano" },
    { title: "R2 Cir√∫rgico", avatar: "üßë‚Äç‚öïÔ∏è", xpRequired: 350, description: "Resid√™ncia m√©dica - 2¬∫ ano" },
    { title: "R3 Especialista", avatar: "üë®‚Äçüî¨", xpRequired: 550, description: "Resid√™ncia m√©dica - 3¬∫ ano" },
    { title: "Especialista J√∫nior", avatar: "üë©‚Äçüî¨", xpRequired: 800, description: "Forma√ß√£o especializada completa" },
    { title: "Especialista Pleno", avatar: "üë®‚Äçüéì", xpRequired: 1100, description: "Experi√™ncia cl√≠nica consolidada" },
    { title: "Mestre em Medicina", avatar: "üë©‚Äçüéì", xpRequired: 1500, description: "Dom√≠nio da especialidade" },
    { title: "Professor Doutor", avatar: "üë®‚Äçüè´", xpRequired: 2000, description: "Compartilhando conhecimento" },
    { title: "Chefe de Servi√ßo", avatar: "üë©‚Äçüè´", xpRequired: 2600, description: "Lideran√ßa na √°rea m√©dica" },
    { title: "Lenda M√©dica", avatar: "ü¶∏", xpRequired: 3300, description: "Excel√™ncia e reconhecimento" }
];
const XP_VALUES = {
    completeTopic: 15,       // XP por completar um tema
    dailyStreak: 5,          // XP por manter sequ√™ncia de dias
    pomodoroComplete: 3,     // XP por ciclo pomodoro completo
    performanceEntry: 20,    // XP por registro de desempenho
    achievementUnlocked: 50  // XP por desbloquear conquista
};

const achievements = {
    clinicoRaiz: { title: "Cl√≠nico Raiz", description: "Finalizou todos os temas de Cl√≠nica M√©dica.", icon: "fas fa-stethoscope", category: "area", check: (s) => checkAreaCompletion(s, 'clinica') },
    goWarrior: { title: "GO Warrior", description: "Finalizou Ginecologia e Obstetr√≠cia.", icon: "fas fa-baby-carriage", category: "area", check: (s) => checkAreaCompletion(s, 'ginecologia') && checkAreaCompletion(s, 'obstetricia') },
    miniCirurgiao: { title: "Mini-Cirurgi√£o", description: "Completou os temas de Cirurgia Geral.", icon: "fas fa-scalpel", category: "area", check: (s) => checkAreaCompletion(s, 'cirurgia') },
    pediatraMirim: { title: "Pediatra Mirim", description: "Concluiu todos os temas de Pediatria.", icon: "fas fa-child", category: "area", check: (s) => checkAreaCompletion(s, 'pediatria') },
    mestrePreventiva: { title: "Mestre da Preventiva", description: "Terminou os temas de Sa√∫de Coletiva.", icon: "fas fa-users", category: "area", check: (s) => checkAreaCompletion(s, 'preventiva') },
    psiquiatraHonorario: { title: "Psiquiatra Honor√°rio", description: "Finalizou os temas de Psiquiatria.", icon: "fas fa-brain", category: "area", check: (s) => checkAreaCompletion(s, 'psiquiatria') },
    
    leaoSimulado: { title: "Le√£o de Simulado", description: "Fez 5 registros de simulado/quest√µes.", icon: "fas fa-award", category: "produtividade", check: (s) => s.performanceLog.length >= 5 },
    focoTotal: { title: "Foco Total", description: "Usou o Pomodoro por 10 ciclos completos.", icon: "fas fa-clock", category: "produtividade", check: (s) => s.userProfile.completedPomodoros >= 10 },
    modoTurbo: { title: "Modo Turbo", description: "Estudou todos os dias √∫teis da semana.", icon: "fas fa-bolt", category: "produtividade", check: () => checkWeekdayStreak() },
    chatbotExplorer: { title: "Explorador IA", description: "Fez 10 perguntas para a IA m√©dica.", icon: "fas fa-robot", category: "produtividade", check: () => (JSON.parse(localStorage.getItem('chatbotHistory')) || []).filter(m => m.isUser).length >= 10 },

    streak1: { title: "Primeiro Passo", description: "1¬∫ dia consecutivo de estudo.", icon: "fas fa-shoe-prints", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 1 },
    streak5: { title: "5 Dias no Ritmo", description: "Cinco dias seguidos estudando.", icon: "fas fa-fire", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 5 },
    streak14: { title: "Study Beast", description: "14 dias seguidos sem falhar.", icon: "fas fa-meteor", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 14 },
    streak30: { title: "Insano do Revalida", description: "30 dias de estudo consecutivos.", icon: "fas fa-crown", category: "consistencia", check: (s) => s.userProfile.studyStreak >= 30 },
    
    semanaPerfeita: { title: "Semana Perfeita", description: "Cumpriu 100% da meta da semana atual.", icon: "fas fa-check-double", category: "metas", check: () => checkCurrentWeekCompletion() },
    
    comecouNaSegunda: { title: "Come√ßou na Segunda", description: "Iniciou a jornada numa segunda-feira.", icon: "fas fa-calendar-day", category: "secretas", check: (s) => new Date(s.scheduleConfig.startDate + "T12:00:00Z").getUTCDay() === 1 },
    vaiComTudo: { title: "Vai com Tudo!", description: "Estudou e fez simulado no mesmo dia.", icon: "fas fa-bomb", category: "secretas", check: (s) => checkStudyAndSimuladoToday(s) }
};

// FUN√á√ïES DE L√ìGICA DO CRONOGRAMA
// ---------------------------------------------------------------------------------
function prepareAllTopics() {
    appState.allTopicsFlat = [...originalScheduleData, ...appState.customThemes];
}

function regenerateAndRenderSchedule() {
    prepareAllTopics();
    const studyDays = getStudyDays(appState.scheduleConfig.startDate, appState.scheduleConfig.examDate);
    const distributionResult = distributeTopics(appState.allTopicsFlat, studyDays, appState.scheduleConfig.maxTopicsPerDay);
    const newSchedule = buildNewSchedule(distributionResult.distributedDays);
    generateDynamicWeeks(newSchedule);
    updateAllStatsAndCharts();
}

function getStudyDays(startDateStr, endDateStr) {
    const studyDays = [];
    let currentDate = new Date(`${startDateStr}T12:00:00Z`);
    const endDate = new Date(`${endDateStr}T12:00:00Z`);
    while (currentDate <= endDate) {
        if (currentDate.getUTCDay() !== 0) { // Pula Domingos
            studyDays.push(new Date(currentDate));
        }
        currentDate.setUTCDate(currentDate.getUTCDate() + 1);
    }
    return studyDays;
}

function distributeTopics(topics, studyDays, maxTopicsPerDay) {
    let topicIndex = 0;
    const distributedDays = [];
    for (let dayIndex = 0; dayIndex < studyDays.length; dayIndex++) {
        const weekIndex = Math.floor(dayIndex / 6);
        const topicsForThisDay = Math.min(weekIndex + 1, maxTopicsPerDay);
        const assignedTopics = [];
        if (topicIndex < topics.length) {
            for (let i = 0; i < topicsForThisDay && topicIndex < topics.length; i++) {
                assignedTopics.push(topics[topicIndex]);
                topicIndex++;
            }
        }
        distributedDays.push({ date: studyDays[dayIndex], topics: assignedTopics });
    }
    const finalDays = distributedDays.filter(d => d.topics.length > 0);
    const remainingDays = distributedDays.filter(d => d.topics.length === 0).map(d => d.date);
    return { distributedDays: finalDays, remainingDays: remainingDays };
}

function buildNewSchedule(distributedDays) {
    if (!distributedDays || distributedDays.length === 0) return [];
    const newSchedule = [];
    let weekChunk = [];
    distributedDays.sort((a, b) => a.date - b.date);
    for (const day of distributedDays) {
        if (weekChunk.length > 0 && day.date.getUTCDay() === 1) { // Nova semana na Segunda
            newSchedule.push(weekChunk);
            weekChunk = [];
        }
        weekChunk.push(day);
    }
    if (weekChunk.length > 0) newSchedule.push(weekChunk);

    return newSchedule.map((weekDays, index) => {
        const dayMap = new Map(weekDays.map(d => [d.date.getUTCDay(), d]));
        let firstDayOfWeek = new Date(weekDays[0].date);
        let dayOfWeek = firstDayOfWeek.getUTCDay();
        if (dayOfWeek === 0) dayOfWeek = 7;
        firstDayOfWeek.setUTCDate(firstDayOfWeek.getUTCDate() - (dayOfWeek - 1));

        const fullWeekDays = [];
        for (let i = 1; i <= 7; i++) { // 1=Seg...7=Dom
            const currentDay = new Date(firstDayOfWeek);
            currentDay.setUTCDate(firstDayOfWeek.getUTCDate() + i - 1);
            const dayData = dayMap.get(currentDay.getUTCDay());
            if (currentDay.getUTCDay() === 0) { // Domingo
                fullWeekDays.push({ date: currentDay, themes: [{ theme: 'DESCANSO', area: 'rest' }], isRest: true });
            } else {
                fullWeekDays.push({ date: currentDay, themes: dayData ? dayData.topics : [], isRest: false });
            }
        }
        const weekStartDate = fullWeekDays[0].date;
        const weekEndDate = fullWeekDays[5].date;
        return {
            week: index + 1,
            title: `Semana ${index + 1}: ${formatDate(weekStartDate)} - ${formatDate(weekEndDate)}`,
            days: fullWeekDays
        };
    });
}

// GAMIFICA√á√ÉO: L√ìGICA E CHECAGEM
// ---------------------------------------------------------------------------------
function addXp(points, source = 'generic') {
    const oldLevel = getUserLevel();
    appState.userProfile.xp += points;
    
    // Verificar se subiu de n√≠vel
    const newLevel = getUserLevel();
    if (newLevel > oldLevel) {
        appState.userProfile.level = newLevel;
        showLevelUpNotification(newLevel);
        
        // XP b√¥nus por subir de n√≠vel
        addXp(newLevel * 10, 'level-up');
    }
    
    saveUserProfile();
    updateHeaderUI();
}

function getUserLevel() {
    for (let i = studentLevels.length - 1; i >= 0; i--) {
        if (appState.userProfile.xp >= studentLevels[i].xpRequired) {
            return i;
        }
    }
    return 0;
}

function showLevelUpNotification(newLevel) {
    const levelData = studentLevels[newLevel];
    const notification = document.createElement('div');
    notification.className = 'level-up-notification';
    notification.innerHTML = `
        <div class="level-up-content">
            <div class="level-avatar">${levelData.avatar}</div>
            <h3>üéâ Level Up!</h3>
            <h4>${levelData.title}</h4>
            <p>${levelData.description}</p>
            <small>Pr√≥ximo n√≠vel em ${studentLevels[newLevel+1]?.xpRequired - appState.userProfile.xp || '---'} XP</small>
        </div>
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 500);
        }, 3000);
    }, 100);
}

function updateHeaderUI() {
    const currentLevel = getUserLevel();
    const levelData = studentLevels[currentLevel];
    const nextLevel = currentLevel < studentLevels.length - 1 ? studentLevels[currentLevel + 1] : null;
    const xpToNextLevel = nextLevel ? nextLevel.xpRequired - appState.userProfile.xp : 0;
    const progressPercentage = nextLevel ? 
        Math.round(((appState.userProfile.xp - levelData.xpRequired) / (nextLevel.xpRequired - levelData.xpRequired)) * 100) : 
        100;
        
    document.getElementById('user-level').innerHTML = `
        <div class="level-container">
            <div class="level-avatar">${levelData.avatar}</div>
            <div>
                <div>${levelData.title}</div>
                <div class="level-info">${levelData.description}</div>
            </div>
            <div class="level-badge">N√≠vel ${currentLevel}</div>
        </div>
    `;
    
    document.getElementById('xp-bar-fill').style.width = `${progressPercentage}%`;
    document.getElementById('xp-bar-fill').parentElement.title = 
        `${appState.userProfile.xp} XP (${progressPercentage}% para o pr√≥ximo n√≠vel)`;
    document.getElementById('streak-count').textContent = appState.userProfile.studyStreak;
}

function unlockAchievement(key) {
    if (!appState.userProfile.unlockedAchievements[key]) {
        addXp(XP_VALUES.achievementUnlocked, 'achievement'); // Adicionado
        appState.userProfile.unlockedAchievements[key] = new Date().toISOString();
        showAchievementNotification(achievements[key]);
        if (appState.currentSection === 'achievements') {
            renderAchievementsPage();
        }
    }
}
function checkAllAchievements(eventData = null) {
    for (const key in achievements) {
        if (!appState.userProfile.unlockedAchievements[key]) {
            if (achievements[key].check(appState, eventData)) {
                unlockAchievement(key);
            }
        }
    }
    saveUserProfile();
}

function saveUserProfile() {
    localStorage.setItem('userProfile', JSON.stringify(appState.userProfile));
    updateHeaderUI();
}

function saveAndCheck(eventData = null) {
    // saveUserProfile(); // Removido, pois saveUserData j√° cuida disso
    checkAllAchievements(eventData);
}

function renderAchievementsPage() {
    const container = document.getElementById('achievements-grid');
    if (!container) return;
    const categories = { area: [], produtividade: [], consistencia: [], metas: [], revisao: [], secretas: [] };
    for (const key in achievements) {
        categories[achievements[key].category].push({ key, ...achievements[key] });
    }
    container.innerHTML = Object.keys(categories).map(catKey => {
        if (categories[catKey].length === 0) return '';
        const categoryName = catKey.charAt(0).toUpperCase() + catKey.slice(1);
        const itemsHtml = categories[catKey].map(item => {
            const unlocked = appState.userProfile.unlockedAchievements[item.key];
            const unlockedDate = unlocked ? `Desbloqueado em: ${new Date(unlocked).toLocaleDateString('pt-BR')}` : '';
            return `<div class="achievement-item ${unlocked ? 'unlocked' : ''}" title="${item.description}"><i class="achievement-icon ${item.icon}"></i><div class="achievement-details"><h4>${item.title}</h4><p>${item.description}</p><p class="unlock-date">${unlockedDate}</p></div></div>`;
        }).join('');
        return `<div class="achievement-category"><h3>${categoryName}</h3>${itemsHtml}</div>`;
    }).join('');
}

function checkAreaCompletion(state, area) { const topicsOfArea = state.allTopicsFlat.filter(t => t.area === area); if (topicsOfArea.length === 0) return false; return topicsOfArea.every(t => state.completedTopics[t.theme]); }
function checkWeekdayStreak() { const today = new Date(); if (today.getDay() === 0 || today.getDay() === 6) return false; const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay() + 1); let studiedDays = new Set(); Object.values(appState.lastReviewDates).forEach(d => { const studyDate = new Date(d); if (studyDate >= weekStart && studyDate <= today) { studiedDays.add(studyDate.getDay()); } }); return studiedDays.size >= today.getDay(); }
function checkCurrentWeekCompletion() { const today = new Date(); const weekNum = Math.floor((today - new Date(appState.scheduleConfig.startDate)) / (1000 * 60 * 60 * 24 * 7)) + 1; const schedule = buildNewSchedule(distributeTopics(appState.allTopicsFlat, getStudyDays(appState.scheduleConfig.startDate, appState.scheduleConfig.examDate), appState.scheduleConfig.maxTopicsPerDay).distributedDays); const weekData = schedule.find(w => w.week === weekNum); if (!weekData) return false; return weekData.days.every(d => { if (d.isRest) return true; return d.themes.every(t => appState.completedTopics[t.theme]); }); }
function checkStudyAndSimuladoToday(state) { const todayStr = new Date().toISOString().split('T')[0]; const studiedToday = Object.values(state.lastReviewDates).some(d => d.startsWith(todayStr)); const simuladoToday = state.performanceLog.some(p => p.date === todayStr); return studiedToday && simuladoToday; }

// UI GERAL E INTERA√á√ïES
// ---------------------------------------------------------------------------------
function toggleSidebar() { appState.sidebarOpen = !appState.sidebarOpen; appState.sidebarCollapsed = false; document.getElementById('sidebar').classList.toggle('open'); document.getElementById('main-content').classList.toggle('sidebar-open'); document.getElementById('header').classList.toggle('sidebar-open'); }
function toggleTheme() { appState.darkMode = !appState.darkMode; document.documentElement.setAttribute('data-theme', appState.darkMode ? 'dark' : ''); localStorage.setItem('darkMode', appState.darkMode); document.querySelector('#theme-toggle i').className = appState.darkMode ? 'fas fa-sun' : 'fas fa-moon'; updateAllStatsAndCharts(); }
function toggleMinimalistMode() { appState.minimalistMode = !appState.minimalistMode; document.body.classList.toggle('minimalist-mode', appState.minimalistMode); localStorage.setItem('minimalistMode', appState.minimalistMode); document.querySelector('#minimalist-toggle i').className = appState.minimalistMode ? 'fas fa-expand' : 'fas fa-compress'; }
function showModal(modalId) { document.getElementById(modalId).classList.add('active'); }
function hideModal(modalId) { document.getElementById(modalId).classList.remove('active'); }

function showSection(sectionId) {
    document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
    const section = document.getElementById(`${sectionId}-section`);
    if (section) {
        section.classList.add('active');
        appState.currentSection = sectionId;
        if (sectionId === 'stats') {
            updateAllStatsAndCharts();
            saveSessionTime();
            updateStudyTimeDisplay();
        } else if (sectionId === 'achievements') {
            renderAchievementsPage();
        } else if (sectionId === 'performance') {
            updateStats();
            populatePerformanceTopicSelect();
            renderPerformanceHistory();
        } else if (sectionId === 'progress') {
            updateProgressLists();
        } else if (sectionId === 'review') {
            updateFutureReviews();
        }
    }
    window.scrollTo(0, 0);
}

function updateAllStatsAndCharts() {
    updateStats();
    updateStatusIcons();
    if (appState.currentSection === 'stats') {
        createCompletionChart();
        createPerformanceByAreaChart();
    }
}

// INICIALIZA√á√ÉO
// ---------------------------------------------------------------------------------
document.addEventListener('DOMContentLoaded', function () {
    if (appState.darkMode) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.querySelector('#theme-toggle i').className = 'fas fa-sun';
    }
    document.getElementById('start-date').value = appState.scheduleConfig.startDate;
    document.getElementById('exam-date').value = appState.scheduleConfig.examDate;
    document.getElementById('max-topics-day').value = appState.scheduleConfig.maxTopicsPerDay;
    document.getElementById('perf-date').value = new Date().toISOString().split('T')[0];

    initializeEventListeners();
    initMotivationalQuote();
    prepareAllTopics();
    regenerateAndRenderSchedule();
    resetPomodoro();
    startTotalStudyTimer();

    // Inicializar Chatbot M√©dico
    medicalChatbot.init();

    // Gamification Init
    updateHeaderUI();
    checkAllAchievements({ type: 'load' });
    renderAchievementsPage();

    showSection('stats');
});

function initializeEventListeners() {
    document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    document.getElementById('minimalist-toggle').addEventListener('click', toggleMinimalistMode);
    document.getElementById('pomodoro-start').addEventListener('click', startPomodoro);
    document.getElementById('pomodoro-pause').addEventListener('click', pausePomodoro);
    document.getElementById('pomodoro-reset').addEventListener('click', resetPomodoro);
    document.querySelectorAll('.sidebar-menu a[data-section]').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); showSection(link.dataset.section); }); });
    document.getElementById('reset-progress').addEventListener('click', () => showModal('confirmation-modal'));
    document.getElementById('confirm-reset').addEventListener('click', () => { localStorage.clear(); location.reload(); });
    document.getElementById('cancel-reset').addEventListener('click', () => hideModal('confirmation-modal'));
    document.getElementById('apply-config').addEventListener('click', applyConfigurations);
    document.getElementById('add-custom-theme-btn').addEventListener('click', addCustomTheme);
    document.getElementById('save-performance-entry').addEventListener('click', savePerformanceEntry);
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const difficulty = this.dataset.difficulty;
            if (appState.currentDifficultyTopic) {
                appState.topicDifficulties[appState.currentDifficultyTopic] = difficulty;
                localStorage.setItem('topicDifficulties', JSON.stringify(appState.topicDifficulties));
                saveAndCheck({ type: 'difficulty', topic: appState.currentDifficultyTopic });
                updateAllStatsAndCharts();
            }
            hideModal('difficulty-modal');
        });
    });
}

function initMotivationalQuote() { 
    // This was removed from the header to make space for gamification, but the function can be kept for future use.
}

function startTotalStudyTimer() {
    const STORAGE_KEY = 'totalStudyTime';
    let totalTime = parseInt(localStorage.getItem(STORAGE_KEY) || '0');
    const display = document.getElementById('total-study-time');

    function updateDisplay() {
        const hrs = Math.floor(totalTime / 3600).toString().padStart(2, '0');
        const mins = Math.floor((totalTime % 3600) / 60).toString().padStart(2, '0');
        const secs = (totalTime % 60).toString().padStart(2, '0');
        if (display) display.textContent = `${hrs}:${mins}:${secs}`;
    }

    updateDisplay();

    setInterval(() => {
        totalTime++;
        localStorage.setItem(STORAGE_KEY, totalTime);
        updateDisplay();
    }, 1000);
}

// RESTANTE DAS FUN√á√ïES (HELPER, UI, ETC.)
// ---------------------------------------------------------------------------------
function getAreaName(area) { const names = { preventiva: "PREV", pediatria: "PED", ginecologia: "GIN", obstetricia: "OBS", clinica: "CLM", cirurgia: "CIR", psiquiatria: "PSI", revisao: "REV", rest: "Off" }; return names[area] || "Geral"; }
function getAreaIcon(area) { const icons = { preventiva: "fas fa-users", pediatria: "fas fa-baby", ginecologia: "fas fa-venus", obstetricia: "fas fa-baby-carriage", clinica: "fas fa-stethoscope", cirurgia: "fas fa-scalpel", psiquiatria: "fas fa-brain", revisao: "fas fa-star", rest: "fas fa-couch" }; return icons[area] || "fas fa-book-medical"; }
function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return ""; const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); }

function addTopicEventListeners() {
    document.querySelectorAll('.topic-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const topic = this.dataset.topic;
            const isChecked = this.checked;

            // Sincroniza todas as checkboxes para o mesmo tema
            document.querySelectorAll(`input.topic-checkbox[data-topic="${topic}"]`).forEach(box => {
                const text = box.closest('.topic-row').querySelector('.topic-text');
                box.checked = isChecked;
                if (isChecked) text.classList.add('completed');
                else text.classList.remove('completed');
            });

            if (isChecked) {
                appState.completedTopics[topic] = true;
                appState.lastReviewDates[topic] = new Date().toISOString();
                showModal("difficulty-modal");
                appState.currentDifficultyTopic = topic;
                addXp(XP_VALUES.completeTopic, "topic-complete");
                updateStudyStreak();
            } else {
                delete appState.completedTopics[topic];
                delete appState.lastReviewDates[topic];
                delete appState.topicDifficulties[topic];
            }

            // saveAndCheck({ type: "completion", topic: topic }); // J√° chamado por saveUserData
            saveAndCheck({ type: "completion", topic: topic });
            updateAllStatsAndCharts();
            
            // Save to cloud
            if (currentUser) {
                console.log("Saving user data after topic completion:", appState.completedTopics, appState.lastReviewDates);
                saveUserData();
            }
        });
    });
}

function generateDynamicWeeks(schedule) {
    const weeksContainer = document.getElementById('weeks');
    weeksContainer.innerHTML = '';
    if (!schedule || schedule.length === 0) {
        weeksContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum cronograma para exibir.</p>';
        return;
    }
    const dayNames = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
    schedule.forEach(week => {
        const weekElement = document.createElement('div');
        weekElement.className = 'week-section fade-in';
        const maxThemesInWeek = Math.max(0, ...week.days.map(d => d.isRest ? 0 : (d.themes ? d.themes.length : 0)));
        let tableHeaderHTML = `<thead><tr><th class="day-col">Dia</th>`;
        if (maxThemesInWeek > 0) {
            for (let i = 0; i < maxThemesInWeek; i++) {
                tableHeaderHTML += `<th class="theme-col">Tema ${i + 1}</th>`;
            }
        } else {
            tableHeaderHTML += `<th class="theme-col">Atividade</th>`;
        }
        tableHeaderHTML += `</tr></thead>`;

        let tableBodyHTML = '<tbody>';
        week.days.forEach(day => {
            const dayName = dayNames[day.date.getUTCDay()];
            if (day.isRest) {
                tableBodyHTML += `<tr class="rest-day"><td colspan="${1 + Math.max(1, maxThemesInWeek)}">${day.themes[0].theme}</td></tr>`;
            } else {
                tableBodyHTML += `<tr><td data-label="Dia"><b>${dayName}</b><br>${formatDate(day.date)}</td>`;
                if (maxThemesInWeek > 0) {
                    if (day.themes.length === 0) {
                        tableBodyHTML += `<td colspan="${maxThemesInWeek}"><i>Dia livre</i></td>`;
                    } else {
                        for (let i = 0; i < maxThemesInWeek; i++) {
                            const topic = day.themes ? day.themes[i] : null;
                            if (topic) {
                                const topicId = (topic.theme + i).replace(/[^a-zA-Z0-9]/g, "");
                                tableBodyHTML += `<td data-label="Tema ${i + 1}"><div class="topic-row" data-topic-area="${topic.area}">
  <input type="checkbox" class="topic-checkbox" id="chk-${topicId}" ${appState.completedTopics[topic.theme] ? "checked" : ""} data-topic="${topic.theme}">
  <label for="chk-${topicId}" class="topic-text-label">
    <span class="topic-text ${appState.completedTopics[topic.theme] ? "completed" : ""}">${topic.theme}</span>
    <div class="area-badge area-${topic.area}">${getAreaName(topic.area)}</div>
  </label>
  <button class="btn-ia" onclick="gerarFlashcardIA('${topic.theme}')">ü§ñ Flashcard IA</button>
</div>`;
                            } else {
                                tableBodyHTML += '<td>-</td>';
                            }
                        }
                    }
                } else {
                    tableBodyHTML += `<td><i>Dia livre</i></td>`;
                }
                tableBodyHTML += '</tr>';
            }
        });
        tableBodyHTML += '</tbody>';
        weekElement.innerHTML = `<div class="week-header"><span>${week.title}</span><i class="fas fa-chevron-down"></i></div><div class="week-content"><table class="week-table">${tableHeaderHTML}${tableBodyHTML}</table></div>`;
        weeksContainer.appendChild(weekElement);
        weekElement.querySelector('.week-header').addEventListener('click', function () { this.nextElementSibling.classList.toggle('collapsed'); this.querySelector('i').className = this.nextElementSibling.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-down'; });
    });
    addTopicEventListeners();
    updateStatusIcons();
}

// FUN√á√ïES DO FLASHCARD IA (mantida do c√≥digo original)
async function gerarFlashcardIA(tema) {
  // Elementos do modal
  const modal = document.getElementById('ia-flashcard-modal');
  const titleElement = document.getElementById('ia-flashcard-title');
  const contentElement = document.getElementById('ia-resumo');
  
  // Configura√ß√£o inicial
  titleElement.textContent = tema;
  contentElement.innerHTML = `
    <div style="display: flex; align-items: center; gap: 8px;">
      <span class="rotating-hourglass">‚è≥</span>
      <span>üß† Gerando seu conte√∫do...</span>
    </div>
  `;
  
  // Mostra o modal
  showModal('ia-flashcard-modal');
  
  // Anima√ß√£o de loading
  const style = document.createElement('style');
  style.textContent = `
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .rotating-hourglass {
      display: inline-block;
      animation: rotate 1.5s linear infinite;
    }
  `;
  document.head.appendChild(style);

  try {
    const GEMINI_API_KEY = "AIzaSyDaGaxZj0bLiL1aFM-iFUhxipb9wm4XCaI";
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        "contents": [{
          "parts": [{
            "text": `Forne√ßa um resumo t√©cnico conciso sobre ${tema} para estudo m√©dico, com at√© 5 linhas. 
            Seja direto e use linguagem m√©dica apropriada.`
          }]
        }],
        "generationConfig": {
          "maxOutputTokens": 300,
          "temperature": 0.5
        }
      })
    });

    if (!response.ok) {
      throw new Error(`Erro na API: ${response.status}`);
    }

    const data = await response.json();
    
    // Extra√ß√£o do texto da resposta do Gemini
    const resposta = data?.candidates?.[0]?.content?.parts?.[0]?.text || 
                    "N√£o foi poss√≠vel gerar o conte√∫do.";
    
    // Limpeza do conte√∫do
    const respostaLimpa = resposta.replace(/^\s*[\r\n]+|\s*[\r\n]+\s*$/g, '');
    
    // Exibe o resultado
    contentElement.textContent = respostaLimpa || "Resposta vazia da IA.";

  } catch (err) {
    console.error("Erro na chamada do Gemini:", err);
    contentElement.textContent = `Erro: ${err.message || 'Tente novamente mais tarde.'}`;
    
    // Log detalhado para debug
    if (err.response) {
      err.response.json().then(body => console.error("Detalhes do erro:", body));
    }
  } finally {
    // Remove a anima√ß√£o
    if (document.head.contains(style)) {
      document.head.removeChild(style);
    }
  }
}


// FUN√á√ïES DO POMODORO
// ---------------------------------------------------------------------------------
function startPomodoro() { if (!appState.pomodoroRunning) { appState.pomodoroRunning = true; appState.pomodoroInterval = setInterval(updatePomodoro, 1000); document.getElementById('pomodoro-start').disabled = true; document.getElementById('pomodoro-pause').disabled = false; } }
function pausePomodoro() { if (appState.pomodoroRunning) { clearInterval(appState.pomodoroInterval); appState.pomodoroRunning = false; document.getElementById('pomodoro-start').disabled = false; document.getElementById('pomodoro-pause').disabled = true; } }
function resetPomodoro() { const isFocus = appState.currentPomodoroType === 'focus'; pausePomodoro(); const time = parseInt(document.getElementById(isFocus ? 'focus-time' : 'break-time').value) || (isFocus ? 25 : 5); appState.pomodoroTime = time * 60; updatePomodoroDisplay(); document.getElementById('pomodoro-start').disabled = false; document.getElementById('pomodoro-pause').disabled = true; }
function updatePomodoro() { appState.pomodoroTime--; updatePomodoroDisplay(); if (appState.pomodoroTime < 0) { if (appState.currentPomodoroType === 'focus') { appState.userProfile.completedPomodoros++; addXp(XP_VALUES.pomodoroComplete, 'pomodoro'); appState.currentPomodoroType = 'break'; alert('Foco finalizado! Hora da pausa.'); } else { appState.currentPomodoroType = 'focus'; alert('Pausa finalizada! Hora de focar.'); } saveAndCheck(); resetPomodoro(); } }
function updatePomodoroDisplay() { const minutes = Math.floor(appState.pomodoroTime / 60); const seconds = appState.pomodoroTime % 60; document.getElementById('pomodoro-display').textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`; }

// FUN√á√ïES DE ESTAT√çSTICAS E GR√ÅFICOS
// ---------------------------------------------------------------------------------
function updateStats() { prepareAllTopics(); const totalTopics = appState.allTopicsFlat.filter(t => t.area !== 'rest' && t.area !== 'revisao').length; const completedCount = Object.keys(appState.completedTopics).length; const percentage = totalTopics > 0 ? Math.round((completedCount / totalTopics) * 100) : 0; document.getElementById('completed-count').textContent = completedCount; document.getElementById('progress-fill').style.width = `${percentage}%`; document.getElementById('progress-percentage').textContent = `${percentage}% de ${totalTopics} temas`; updateCountdown(); updateAverageDifficulty(); }
function updateCountdown() { const examDate = new Date(`${appState.scheduleConfig.examDate}T12:00:00Z`); const today = new Date(); const diffTime = examDate - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); document.getElementById('days-left').textContent = diffDays > 0 ? diffDays : 0; }
function updateAverageDifficulty() { const difficulties = Object.values(appState.topicDifficulties); if (difficulties.length === 0) { document.getElementById('avg-difficulty').textContent = '-'; return; } const difficultyMap = { easy: 1, medium: 2, hard: 3 }; const avg = difficulties.reduce((sum, diff) => sum + difficultyMap[diff], 0) / difficulties.length; document.getElementById('avg-difficulty').textContent = avg < 1.5 ? 'F√°cil' : avg < 2.5 ? 'M√©dio' : 'Dif√≠cil'; }
function updateStatusIcons() { document.querySelectorAll('.topic-checkbox').forEach(checkbox => { const topic = checkbox.dataset.topic; if (appState.completedTopics[topic]) { checkbox.checked = true; checkbox.closest('.topic-row').querySelector('.topic-text').classList.add('completed'); } else { checkbox.checked = false; checkbox.closest('.topic-row').querySelector('.topic-text').classList.remove('completed'); } }); }

function createCompletionChart() { const ctx = document.getElementById('graficoPorMateria').getContext('2d'); if (!ctx || !document.getElementById('stats-section').classList.contains('active')) return; if (appState.charts.completionBySubject) appState.charts.completionBySubject.destroy(); const data = {}; const areas = ['preventiva', 'pediatria', 'ginecologia', 'obstetricia', 'clinica', 'cirurgia', 'psiquiatria', 'revisao']; areas.forEach(area => data[area] = { total: 0, feitos: 0, cor: getComputedStyle(document.documentElement).getPropertyValue(`--area-${area}`).trim() || '#607D8B', nome: getAreaName(area) }); appState.allTopicsFlat.forEach(topic => { if (data[topic.area]) { data[topic.area].total++; if (appState.completedTopics[topic.theme]) data[topic.area].feitos++; } }); const labels = [], porcentagens = [], cores = []; for (let key in data) { if (data[key].total > 0) { labels.push(data[key].nome); porcentagens.push(Math.round((data[key].feitos / data[key].total) * 100)); cores.push(data[key].cor); } } const isDarkMode = appState.darkMode; const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'; const tickColor = isDarkMode ? '#f5f5f5' : '#666'; appState.charts.completionBySubject = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '% Conclu√≠do', data: porcentagens, backgroundColor: cores, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { y: { ticks: { color: tickColor }, grid: { display: false } }, x: { beginAtZero: true, max: 100, ticks: { color: tickColor, callback: val => `${val}%` }, grid: { color: gridColor } } } } }); }

function createPerformanceByAreaChart() { const ctx = document.getElementById('graficoDesempenhoPorArea').getContext('2d'); if (!ctx || !document.getElementById('stats-section').classList.contains('active')) return; if (appState.charts.performanceByArea) appState.charts.performanceByArea.destroy(); const perfData = {}; const areas = ['preventiva', 'pediatria', 'ginecologia', 'obstetricia', 'clinica', 'cirurgia', 'psiquiatria', 'revisao']; areas.forEach(area => perfData[area] = { attempted: 0, correct: 0, cor: getComputedStyle(document.documentElement).getPropertyValue(`--area-${area}`).trim() || '#607D8B', nome: getAreaName(area) }); appState.performanceLog.forEach(entry => { const topicDetails = appState.allTopicsFlat.find(t => t.theme === entry.topic); if (topicDetails && perfData[topicDetails.area]) { perfData[topicDetails.area].attempted += entry.attempted; perfData[topicDetails.area].correct += entry.correct; } }); const labels = [], porcentagens = [], cores = []; for (let key in perfData) { if (perfData[key].attempted > 0) { labels.push(perfData[key].nome); porcentagens.push(Math.round((perfData[key].correct / perfData[key].attempted) * 100)); cores.push(perfData[key].cor); } } if (labels.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.font = "16px Roboto"; ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color'); ctx.textAlign = "center"; ctx.fillText("Nenhum dado de desempenho para exibir.", ctx.canvas.width / 2, 50); return; } const isDarkMode = appState.darkMode; const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'; const tickColor = isDarkMode ? '#f5f5f5' : '#666'; appState.charts.performanceByArea = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '% de Acerto', data: porcentagens, backgroundColor: cores, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { color: tickColor, callback: val => `${val}%` }, grid: { color: gridColor } }, x: { ticks: { color: tickColor }, grid: { display: false } } } } }); }

// FUN√á√ïES DE PROGRESSO E REVIS√ÉO
// ---------------------------------------------------------------------------------
function updateProgressLists() { const container = document.getElementById('progress-lists'); if (!container) return; const areas = {}; prepareAllTopics(); for (const topicName in appState.completedTopics) { const topicDetails = appState.allTopicsFlat.find(t => t.theme === topicName); if (topicDetails) { const area = topicDetails.area; if (!areas[area]) { areas[area] = { name: getAreaName(area), icon: getAreaIcon(area), topics: [] }; } const completedDate = new Date(appState.lastReviewDates[topicName]); const daysPassed = Math.floor((new Date() - completedDate) / (1000 * 60 * 60 * 24)); areas[area].topics.push({ name: topicName, daysPassed: daysPassed }); } } let html = ''; for (const areaId in areas) { const area = areas[areaId]; if (area.topics.length === 0) continue; area.topics.sort((a, b) => a.daysPassed - b.daysPassed); const topicsHtml = area.topics.map(topic => { let urgencyClass = topic.daysPassed > 14 ? 'danger' : topic.daysPassed > 7 ? 'warning' : ''; return `<li class="topic-item"><span>${topic.name}</span> <span class="days-badge ${urgencyClass}">${topic.daysPassed} dias</span></li>`; }).join(''); html += `<div class="progress-list"><h4><i class="${area.icon}"></i> ${area.name}</h4><ul>${topicsHtml}</ul></div>`; } container.innerHTML = html || '<p style="text-align: center; padding: 20px;">Nenhum tema conclu√≠do ainda.</p>'; }

function updateFutureReviews() { const container = document.getElementById('future-reviews-container'); if (!container) return; const now = new Date(); const urgentReviews = [], soonReviews = [], scheduledReviews = []; let pendingCount = 0; if (Object.keys(appState.completedTopics).length === 0) { container.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum tema conclu√≠do para gerar revis√µes.</p>'; document.getElementById('reviews-pending').textContent = '0'; return; } for (const topic in appState.completedTopics) { if (!appState.lastReviewDates[topic]) continue; const lastReview = new Date(appState.lastReviewDates[topic]); const difficulty = appState.topicDifficulties[topic] || 'medium'; const reviewIntervalDays = { easy: 15, medium: 7, hard: 3 }[difficulty] || 7; const daysUntilReview = reviewIntervalDays - Math.floor((now - lastReview) / (1000 * 60 * 60 * 24)); const reviewItem = { topic, difficulty, daysUntilReview, lastReview: formatDate(lastReview) }; if (daysUntilReview <= 0) { reviewItem.status = `Atrasada ${Math.abs(daysUntilReview)}d`; reviewItem.statusClass = 'urgent'; urgentReviews.push(reviewItem); pendingCount++; } else if (daysUntilReview <= 3) { reviewItem.status = `Em ${daysUntilReview}d`; reviewItem.statusClass = 'soon'; soonReviews.push(reviewItem); } else { reviewItem.status = `Em ${daysUntilReview}d`; scheduledReviews.push(reviewItem); } } document.getElementById('reviews-pending').textContent = pendingCount; const renderReviewGroup = (title, icon, reviews) => { if (reviews.length === 0) return ''; return `<div class="review-group"><h4><i class="${icon}"></i> ${title} (${reviews.length})</h4>${reviews.map(review => `<div class="review-item"><div class="review-info"><strong>${review.topic}</strong><div>√öltima revis√£o: ${review.lastReview}</div></div><div class="review-actions"><span class="review-due ${review.statusClass}">${review.status}</span><button class="btn" onclick="markAsReviewed('${review.topic.replace(/'/g, "\\'")}')"><i class="fas fa-check"></i> Revisado</button></div></div>`).join('')}</div>`; }; container.innerHTML = `${renderReviewGroup('Revis√µes Atrasadas', 'fas fa-exclamation-triangle', urgentReviews)}${renderReviewGroup('Revis√µes Pr√≥ximas', 'fas fa-hourglass-half', soonReviews)}${renderReviewGroup('Revis√µes Programadas', 'fas fa-calendar-check', scheduledReviews)}` || '<p style="text-align: center; padding: 20px;">Nenhuma revis√£o programada.</p>'; }

// FUN√á√ïES DE PERFORMANCE E CONFIGURA√á√ÉO
// ---------------------------------------------------------------------------------
function populatePerformanceTopicSelect() { const select = document.getElementById('perf-topic-select'); if (!select || select.options.length > 1) return; const areas = {}; appState.allTopicsFlat.forEach(topic => { if (topic.area === 'rest') return; if (!areas[topic.area]) { areas[topic.area] = []; } areas[topic.area].push(topic.theme); }); select.innerHTML = '<option value="">Selecione um tema...</option>'; for (const areaId in areas) { const optgroup = document.createElement('optgroup'); optgroup.label = getAreaName(areaId).toUpperCase(); areas[areaId].sort().forEach(themeName => { const option = document.createElement('option'); option.value = themeName; option.textContent = themeName; optgroup.appendChild(option); }); select.appendChild(optgroup); } }

function savePerformanceEntry() { const date = document.getElementById('perf-date').value; const topic = document.getElementById('perf-topic-select').value; const attempted = parseInt(document.getElementById('perf-questions-attempted').value); const correct = parseInt(document.getElementById('perf-questions-correct').value); if (!date || !topic || isNaN(attempted) || isNaN(correct)) { alert('Preencha todos os campos corretamente.'); return; } if (correct > attempted || attempted <= 0) { alert('Valores inv√°lidos.'); return; } const newEntry = { id: Date.now(), date, topic, attempted, correct }; appState.performanceLog.push(newEntry); localStorage.setItem('performanceLog', JSON.stringify(appState.performanceLog)); renderPerformanceHistory(); addXp(XP_VALUES.performanceEntry, 'performance'); updateStudyStreak(); saveAndCheck({ type: 'simulado' }); document.getElementById('perf-topic-select').value = ""; document.getElementById('perf-questions-attempted').value = ""; document.getElementById('perf-questions-correct').value = ""; alert('Registro salvo!'); }

function renderPerformanceHistory() { const container = document.getElementById('performance-history-container'); if (!container) return; if (appState.performanceLog.length === 0) { container.innerHTML = '<p class="config-hint" style="text-align: center; padding: 20px;">Nenhum registro de desempenho.</p>'; return; } let tableHTML = `<table class="performance-table"><thead><tr><th>Data</th><th>Tema</th><th>√Årea</th><th>Quest√µes</th><th>Acertos</th><th>%</th><th>A√ß√µes</th></tr></thead><tbody>`; const sortedLog = [...appState.performanceLog].sort((a, b) => new Date(b.date) - new Date(a.date)); sortedLog.forEach(entry => { const topicDetails = appState.allTopicsFlat.find(t => t.theme === entry.topic); const area = topicDetails ? topicDetails.area : 'N/A'; const percentage = Math.round((entry.correct / entry.attempted) * 100); let percClass = 'medium'; if (percentage >= 80) percClass = 'good'; else if (percentage < 60) percClass = 'bad'; tableHTML += `<tr><td>${formatDate(new Date(entry.date))}</td><td>${entry.topic}</td><td><span class="area-badge area-${area}">${getAreaName(area)}</span></td><td>${entry.attempted}</td><td>${entry.correct}</td><td class="percentage-col ${percClass}">${percentage}%</td><td><button class="btn btn-danger delete-perf-entry" data-id="${entry.id}"><i class="fas fa-trash"></i></button></td></tr>`; }); tableHTML += '</tbody></table>'; container.innerHTML = tableHTML; document.querySelectorAll('.delete-perf-entry').forEach(btn => { btn.addEventListener('click', function () { const entryId = parseInt(this.dataset.id); deletePerformanceEntry(entryId); }); }); }

function deletePerformanceEntry(id) { if (!confirm('Tem certeza?')) return; appState.performanceLog = appState.performanceLog.filter(entry => entry.id !== id); localStorage.setItem('performanceLog', JSON.stringify(appState.performanceLog)); renderPerformanceHistory(); if (appState.currentSection === 'stats') createPerformanceByAreaChart(); }

function applyConfigurations() { const startDate = document.getElementById('start-date').value; const examDate = document.getElementById('exam-date').value; const maxTopicsPerDay = parseInt(document.getElementById('max-topics-day').value); if (!startDate || !examDate || isNaN(maxTopicsPerDay)) { alert('Preencha tudo.'); return; } if (new Date(startDate) >= new Date(examDate)) { alert('Data de in√≠cio deve ser anterior.'); return; } appState.scheduleConfig = { startDate, examDate, maxTopicsPerDay }; localStorage.setItem('scheduleConfig', JSON.stringify(appState.scheduleConfig)); regenerateAndRenderSchedule(); alert('Cronograma atualizado!'); showSection('weeks'); }

function addCustomTheme() { const nameInput = document.getElementById('custom-theme-name'); const areaSelect = document.getElementById('custom-theme-area'); const themeName = nameInput.value.trim(); const themeArea = areaSelect.value; if (!themeName) { alert('Digite o nome.'); return; } if ([...originalScheduleData, ...appState.customThemes].some(t => t.theme.toLowerCase() === themeName.toLowerCase())) { alert('Tema j√° existe.'); return; } const newTheme = { theme: themeName, area: themeArea }; appState.customThemes.push(newTheme); localStorage.setItem('customThemes', JSON.stringify(appState.customThemes)); nameInput.value = ""; renderCustomThemesList(); }

function removeCustomTheme(themeNameToRemove) { appState.customThemes = appState.customThemes.filter(theme => theme.theme !== themeNameToRemove); localStorage.setItem('customThemes', JSON.stringify(appState.customThemes)); renderCustomThemesList(); }

function renderCustomThemesList() { const listContainer = document.getElementById('custom-themes-list'); listContainer.innerHTML = appState.customThemes.length === 0 ? '<p class="config-hint">Nenhum tema personalizado.</p>' : '<h5>Seus Temas:</h5>'; appState.customThemes.forEach(theme => { const themeElement = document.createElement('div'); themeElement.className = 'custom-theme-item'; themeElement.innerHTML = `<span><span class="area-badge area-${theme.area}">${getAreaName(theme.area)}</span> ${theme.theme}</span> <button class="btn btn-danger remove-custom-theme-btn" data-theme-name="${theme.theme}"><i class="fas fa-times"></i></button>`; listContainer.appendChild(themeElement); }); document.querySelectorAll('.remove-custom-theme-btn').forEach(button => { button.addEventListener('click', function () { removeCustomTheme(this.dataset.themeName); }); }); }

// UTILIT√ÅRIOS E FUN√á√ïES FINAIS
// ---------------------------------------------------------------------------------
window.markAsReviewed = function (topic) { appState.lastReviewDates[topic] = new Date().toISOString(); localStorage.setItem('lastReviewDates', JSON.stringify(appState.lastReviewDates)); if (appState.currentSection === 'review') updateFutureReviews(); addXp(5); updateStudyStreak(); saveAndCheck({ type: 'review', topic: topic }); };

let sessionStartTime = Date.now();

function saveSessionTime() {
    const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
    const stored = parseInt(localStorage.getItem('totalStudyTime') || '0');
    localStorage.setItem('totalStudyTime', stored + elapsed);
    sessionStartTime = Date.now();
}

function formatStudyTime(seconds) {
    const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
    const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    return `${hrs}:${mins}:${secs}`;
}

function updateStudyTimeDisplay() {
    const display = document.getElementById('study-time-display');
    const totalTime = parseInt(localStorage.getItem('totalStudyTime') || '0');
    if (display) display.textContent = `‚è±Ô∏è Tempo de estudo ${formatStudyTime(totalTime)}`;
}

function toggleResposta() {
  const resposta = document.getElementById('ia-resposta');
  resposta.style.display = resposta.style.display === "none" ? "block" : "none";
}

// INICIALIZA√á√ÉO DA APLICA√á√ÉO MODIFICADA PARA AUTENTICA√á√ÉO
// ---------------------------------------------------------------------------------
function initializeApp() {
    loadAppState();
    updateAllDisplays();
    setupEventListeners();
    
    // Configurar data de hoje para registro de desempenho
    const today = new Date().toISOString().split('T')[0];
    const perfDateInput = document.getElementById('perf-date');
    if (perfDateInput) {
        perfDateInput.value = today;
    }
    
    // Inicializar chatbot
    if (typeof medicalChatbot !== 'undefined') {
        medicalChatbot.init();
    }
    
    // Gerar cronograma
    generateSchedule();
}

// Modificar as fun√ß√µes de salvamento para integrar com Supabase
const originalSaveAppState = saveAppState;
saveAppState = function() {
    originalSaveAppState();
    if (currentUser) {
        saveUserData();
    }
};

</script>
</body>
</html>
